<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds         #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts  #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE GADTs             #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase        #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns    #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies      #-}</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Cardano.Node.Socket.Emulator.Server</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#ServerHandler"><span class="hs-identifier">ServerHandler</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#runServerNode"><span class="hs-identifier">runServerNode</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#processBlock"><span class="hs-identifier">processBlock</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#modifySlot"><span class="hs-identifier">modifySlot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#addTx"><span class="hs-identifier">addTx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#processChainEffects"><span class="hs-identifier">processChainEffects</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.BM.Data.Trace</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Trace</span></span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Lazy</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LBS</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Coerce</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier">coerce</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Foldable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">traverse_</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">intersect</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">listToMaybe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.SOP.Strict</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NS</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">S</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Z</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Void</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Void</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Concurrent</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Async</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Exception</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">throwIO</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">over</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(^.)</span></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">runExceptT</span></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Freer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">send</span></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.RWS.Strict</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">runRWST</span></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.ChainSync.Server</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ChainSyncServer</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ServerStIdle</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ServerStIntersect</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>                                                    </span><span class="annot"><span class="hs-identifier">ServerStNext</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.ChainSync.Server</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ChainSync</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.LocalTxSubmission.Server</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TxSubmission</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.LocalTxSubmission.Type</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TxSubmission</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.Monitoring.Util.html"><span class="hs-identifier">Plutus.Monitoring.Util</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LM</span></span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Slotting.Slot</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">SlotNo</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">WithOrigin</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Cardano.Block</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">CardanoBlock</span></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.HardFork.Combinator</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Consensus</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Ledger.SupportsMempool</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ApplyTxErr</span></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Shelley.Eras</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">StandardCrypto</span></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Shelley.Ledger</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Consensus</span></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Shelley.Ledger</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Shelley</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Block</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Point</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">pointSlot</span></span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Block</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">O</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.IOManager</span></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Mux</span></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.NodeToClient</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NodeToClientProtocols</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">nodeToClientCodecCBORTerm</span></span><span class="hs-special">,</span><span>
</span><span id="line-52"></span><span>                                       </span><span class="annot"><span class="hs-identifier">nodeToClientHandshakeCodec</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">nullErrorPolicies</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">versionedNodeToClientProtocols</span></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Point</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">OP</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Block</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.Handshake.Codec</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.Handshake.Version</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Snocket</span></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Socket</span></span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Api</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Api.Shelley</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Node.Emulator.API</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">E</span></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Node.Emulator.Internal.API</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">EmulatorError</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">EmulatorLogs</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">EmulatorMsg</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">EmulatorT</span></span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Node.Emulator.Internal.API</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">E</span></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Node.Emulator.Internal.Node.Chain</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Chain</span></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Node.Emulator.Internal.Node.Params</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Params</span></span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html"><span class="hs-identifier">Cardano.Node.Socket.Emulator.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#AppState"><span class="hs-identifier">AppState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#BlockId"><span class="hs-identifier">BlockId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#BlockId"><span class="hs-identifier">BlockId</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#SocketEmulatorState"><span class="hs-identifier">SocketEmulatorState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#Tip"><span class="hs-identifier">Tip</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#blockId"><span class="hs-identifier">blockId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-68"></span><span>                                           </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#chainSyncCodec"><span class="hs-identifier">chainSyncCodec</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#doNothingResponderProtocol"><span class="hs-identifier">doNothingResponderProtocol</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#emulatorState"><span class="hs-identifier">emulatorState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#getChannel"><span class="hs-identifier">getChannel</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-69"></span><span>                                           </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#getTip"><span class="hs-identifier">getTip</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#nodeToClientVersion"><span class="hs-identifier">nodeToClientVersion</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#nodeToClientVersionData"><span class="hs-identifier">nodeToClientVersionData</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#setTip"><span class="hs-identifier">setTip</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-70"></span><span>                                           </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#socketEmulatorState"><span class="hs-identifier">socketEmulatorState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#toCardanoBlock"><span class="hs-identifier">toCardanoBlock</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#txSubmissionCodec"><span class="hs-identifier">txSubmissionCodec</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Freer.Extras.Log</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">LogMsg</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">LMessage</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Ledger</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Block</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">CardanoTx</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Slot</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span class="hs-keyword">data</span><span> </span><span id="CommandChannel"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#CommandChannel"><span class="hs-identifier hs-var">CommandChannel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CommandChannel"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#CommandChannel"><span class="hs-identifier hs-var">CommandChannel</span></a></span></span><span>
</span><span id="line-75"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="ccCommand"><span class="annot"><span class="annottext">CommandChannel -&gt; TQueue ServerCommand
</span><a href="Cardano.Node.Socket.Emulator.Server.html#ccCommand"><span class="hs-identifier hs-var hs-var">ccCommand</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TQueue</span></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#ServerCommand"><span class="hs-identifier hs-type">ServerCommand</span></a></span><span>
</span><span id="line-76"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="ccResponse"><span class="annot"><span class="annottext">CommandChannel -&gt; TQueue ServerResponse
</span><a href="Cardano.Node.Socket.Emulator.Server.html#ccResponse"><span class="hs-identifier hs-var hs-var">ccResponse</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TQueue</span></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#ServerResponse"><span class="hs-identifier hs-type">ServerResponse</span></a></span><span>
</span><span id="line-77"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span class="hs-comment">{- | Clone the original channel for each connected client, then use
     this wrapper to make sure that no data is consumed from the
     original channel. -}</span><span>
</span><span id="line-82"></span><span class="hs-keyword">newtype</span><span> </span><span id="LocalChannel"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#LocalChannel"><span class="hs-identifier hs-var">LocalChannel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="LocalChannel"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#LocalChannel"><span class="hs-identifier hs-var">LocalChannel</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TChan</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Block</span></span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span class="hs-comment">{- | A handler used to pass around the path to the server
     and channels used for controlling the server. -}</span><span>
</span><span id="line-86"></span><span class="hs-keyword">data</span><span> </span><span id="ServerHandler"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#ServerHandler"><span class="hs-identifier hs-var">ServerHandler</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ServerHandler"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#ServerHandler"><span class="hs-identifier hs-var">ServerHandler</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-87"></span><span>    </span><span id="shSocketPath"><span class="annot"><span class="annottext">ServerHandler -&gt; FilePath
</span><a href="Cardano.Node.Socket.Emulator.Server.html#shSocketPath"><span class="hs-identifier hs-var hs-var">shSocketPath</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-comment">-- The client will send a `ServerCommand` and the server will</span><span>
</span><span id="line-89"></span><span>    </span><span class="hs-comment">-- respond with a `ServerResponse`.</span><span>
</span><span id="line-90"></span><span>    </span><span id="shCommandChannel"><span class="annot"><span class="annottext">ServerHandler -&gt; CommandChannel
</span><a href="Cardano.Node.Socket.Emulator.Server.html#shCommandChannel"><span class="hs-identifier hs-var hs-var">shCommandChannel</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#CommandChannel"><span class="hs-identifier hs-type">CommandChannel</span></a></span><span>
</span><span id="line-91"></span><span class="hs-special">}</span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span class="hs-comment">{- | The commands that control the server. This API is not part of the client
     interface, and in order to call them directly you will need access to the
     returned ServerHandler -}</span><span>
</span><span id="line-96"></span><span class="hs-keyword">data</span><span> </span><span id="ServerCommand"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#ServerCommand"><span class="hs-identifier hs-var">ServerCommand</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-97"></span><span>    </span><span class="hs-comment">-- This command will add a new block by processing</span><span>
</span><span id="line-98"></span><span>    </span><span class="hs-comment">-- transactions in the memory pool.</span><span>
</span><span id="line-99"></span><span>    </span><span id="ProcessBlock"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#ProcessBlock"><span class="hs-identifier hs-var">ProcessBlock</span></a></span></span><span>
</span><span id="line-100"></span><span>    </span><span class="hs-comment">-- Set the slot number</span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="ModifySlot"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#ModifySlot"><span class="hs-identifier hs-var">ModifySlot</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Slot</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Slot</span></span><span class="hs-special">)</span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-comment">-- Append a transaction to the transaction pool.</span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="AddTx"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#AddTx"><span class="hs-identifier hs-var">AddTx</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Tx</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.BabbageEra</span></span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679330581"><span id="local-6989586621679330584"><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#ServerCommand"><span class="hs-identifier hs-type">ServerCommand</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-106"></span><span>    </span><span id="local-6989586621679330579"><span class="annot"><span class="annottext">show :: ServerCommand -&gt; FilePath
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">show</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-107"></span><span>        </span><span class="annot"><span class="annottext">ServerCommand
</span><a href="Cardano.Node.Socket.Emulator.Server.html#ProcessBlock"><span class="hs-identifier hs-var">ProcessBlock</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;ProcessBlock&quot;</span></span><span>
</span><span id="line-108"></span><span>        </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#ModifySlot"><span class="hs-identifier hs-type">ModifySlot</span></a></span><span> </span><span class="annot"><span class="annottext">Slot -&gt; Slot
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;ModifySlot&quot;</span></span><span>
</span><span id="line-109"></span><span>        </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#AddTx"><span class="hs-identifier hs-type">AddTx</span></a></span><span> </span><span id="local-6989586621679330577"><span class="annot"><span class="annottext">Tx BabbageEra
</span><a href="#local-6989586621679330577"><span class="hs-identifier hs-var">t</span></a></span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;AddTx &quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Tx BabbageEra -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Tx BabbageEra
</span><a href="#local-6989586621679330577"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span class="hs-comment">{- | The response from the server. Can be used for the information
     passed back, or for synchronisation.
-}</span><span>
</span><span id="line-114"></span><span class="hs-keyword">data</span><span> </span><span id="ServerResponse"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#ServerResponse"><span class="hs-identifier hs-var">ServerResponse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-115"></span><span>    </span><span class="hs-comment">-- A block was added. We are using this for synchronization.</span><span>
</span><span id="line-116"></span><span>    </span><span id="BlockAdded"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#BlockAdded"><span class="hs-identifier hs-var">BlockAdded</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Block</span></span><span>
</span><span id="line-117"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="SlotChanged"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#SlotChanged"><span class="hs-identifier hs-var">SlotChanged</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Slot</span></span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679330569"><span id="local-6989586621679330571"><span id="local-6989586621679330573"><span class="annot"><span class="annottext">Int -&gt; ServerResponse -&gt; ShowS
[ServerResponse] -&gt; ShowS
ServerResponse -&gt; FilePath
(Int -&gt; ServerResponse -&gt; ShowS)
-&gt; (ServerResponse -&gt; FilePath)
-&gt; ([ServerResponse] -&gt; ShowS)
-&gt; Show ServerResponse
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; FilePath) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ServerResponse] -&gt; ShowS
$cshowList :: [ServerResponse] -&gt; ShowS
show :: ServerResponse -&gt; FilePath
$cshow :: ServerResponse -&gt; FilePath
showsPrec :: Int -&gt; ServerResponse -&gt; ShowS
$cshowsPrec :: Int -&gt; ServerResponse -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span id="local-6989586621679330568"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#processBlock"><span class="hs-identifier hs-type">processBlock</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330568"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#ServerHandler"><span class="hs-identifier hs-type">ServerHandler</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679330568"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Block</span></span></span><span>
</span><span id="line-121"></span><span id="processBlock"><span class="annot"><span class="annottext">processBlock :: ServerHandler -&gt; m Block
</span><a href="Cardano.Node.Socket.Emulator.Server.html#processBlock"><span class="hs-identifier hs-var hs-var">processBlock</span></a></span></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#ServerHandler"><span class="hs-identifier hs-type">ServerHandler</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679330567"><span class="annot"><span class="annottext">CommandChannel
shCommandChannel :: CommandChannel
shCommandChannel :: ServerHandler -&gt; CommandChannel
</span><a href="#local-6989586621679330567"><span class="hs-identifier hs-var hs-var">shCommandChannel</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-122"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue ServerCommand -&gt; ServerCommand -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTQueue</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CommandChannel -&gt; TQueue ServerCommand
</span><a href="Cardano.Node.Socket.Emulator.Server.html#ccCommand"><span class="hs-identifier hs-var hs-var">ccCommand</span></a></span><span> </span><span class="annot"><span class="annottext">CommandChannel
</span><a href="#local-6989586621679330567"><span class="hs-identifier hs-var">shCommandChannel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ServerCommand
</span><a href="Cardano.Node.Socket.Emulator.Server.html#ProcessBlock"><span class="hs-identifier hs-var">ProcessBlock</span></a></span><span>
</span><span id="line-123"></span><span>    </span><span class="hs-comment">-- Wait for the server to finish processing blocks.</span><span>
</span><span id="line-124"></span><span>    </span><span class="annot"><span class="annottext">IO Block -&gt; m Block
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO Block -&gt; m Block) -&gt; IO Block -&gt; m Block
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">STM Block -&gt; IO Block
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM Block -&gt; IO Block) -&gt; STM Block -&gt; IO Block
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue ServerResponse -&gt; STM ServerResponse
forall a. TQueue a -&gt; STM a
</span><span class="hs-identifier hs-var">readTQueue</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CommandChannel -&gt; TQueue ServerResponse
</span><a href="Cardano.Node.Socket.Emulator.Server.html#ccResponse"><span class="hs-identifier hs-var hs-var">ccResponse</span></a></span><span> </span><span class="annot"><span class="annottext">CommandChannel
</span><a href="#local-6989586621679330567"><span class="hs-identifier hs-var">shCommandChannel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">STM ServerResponse -&gt; (ServerResponse -&gt; STM Block) -&gt; STM Block
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-125"></span><span>        </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#BlockAdded"><span class="hs-identifier hs-type">BlockAdded</span></a></span><span> </span><span id="local-6989586621679330562"><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621679330562"><span class="hs-identifier hs-var">block</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Block -&gt; STM Block
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621679330562"><span class="hs-identifier hs-var">block</span></a></span><span>
</span><span id="line-126"></span><span>        </span><span class="annot"><span class="annottext">ServerResponse
</span><span class="hs-identifier">_</span></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM Block
forall a. STM a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">retry</span></a></span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span id="local-6989586621679330560"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#modifySlot"><span class="hs-identifier hs-type">modifySlot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330560"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Slot</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Slot</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#ServerHandler"><span class="hs-identifier hs-type">ServerHandler</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679330560"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Slot</span></span></span><span>
</span><span id="line-129"></span><span id="modifySlot"><span class="annot"><span class="annottext">modifySlot :: (Slot -&gt; Slot) -&gt; ServerHandler -&gt; m Slot
</span><a href="Cardano.Node.Socket.Emulator.Server.html#modifySlot"><span class="hs-identifier hs-var hs-var">modifySlot</span></a></span></span><span> </span><span id="local-6989586621679330559"><span class="annot"><span class="annottext">Slot -&gt; Slot
</span><a href="#local-6989586621679330559"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#ServerHandler"><span class="hs-identifier hs-type">ServerHandler</span></a></span><span class="hs-special">{</span><span id="local-6989586621679330558"><span class="annot"><span class="annottext">CommandChannel
shCommandChannel :: CommandChannel
shCommandChannel :: ServerHandler -&gt; CommandChannel
</span><a href="#local-6989586621679330558"><span class="hs-identifier hs-var hs-var">shCommandChannel</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-130"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue ServerCommand -&gt; ServerCommand -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTQueue</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CommandChannel -&gt; TQueue ServerCommand
</span><a href="Cardano.Node.Socket.Emulator.Server.html#ccCommand"><span class="hs-identifier hs-var hs-var">ccCommand</span></a></span><span> </span><span class="annot"><span class="annottext">CommandChannel
</span><a href="#local-6989586621679330558"><span class="hs-identifier hs-var">shCommandChannel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ServerCommand -&gt; STM ()) -&gt; ServerCommand -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Slot -&gt; Slot) -&gt; ServerCommand
</span><a href="Cardano.Node.Socket.Emulator.Server.html#ModifySlot"><span class="hs-identifier hs-var">ModifySlot</span></a></span><span> </span><span class="annot"><span class="annottext">Slot -&gt; Slot
</span><a href="#local-6989586621679330559"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-131"></span><span>    </span><span class="hs-comment">-- Wait for the server to finish changing the slot.</span><span>
</span><span id="line-132"></span><span>    </span><span class="annot"><span class="annottext">IO Slot -&gt; m Slot
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO Slot -&gt; m Slot) -&gt; IO Slot -&gt; m Slot
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">STM Slot -&gt; IO Slot
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM Slot -&gt; IO Slot) -&gt; STM Slot -&gt; IO Slot
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue ServerResponse -&gt; STM ServerResponse
forall a. TQueue a -&gt; STM a
</span><span class="hs-identifier hs-var">readTQueue</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CommandChannel -&gt; TQueue ServerResponse
</span><a href="Cardano.Node.Socket.Emulator.Server.html#ccResponse"><span class="hs-identifier hs-var hs-var">ccResponse</span></a></span><span> </span><span class="annot"><span class="annottext">CommandChannel
</span><a href="#local-6989586621679330558"><span class="hs-identifier hs-var">shCommandChannel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">STM ServerResponse -&gt; (ServerResponse -&gt; STM Slot) -&gt; STM Slot
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-133"></span><span>        </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#SlotChanged"><span class="hs-identifier hs-type">SlotChanged</span></a></span><span> </span><span id="local-6989586621679330557"><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621679330557"><span class="hs-identifier hs-var">slot</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Slot -&gt; STM Slot
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621679330557"><span class="hs-identifier hs-var">slot</span></a></span><span>
</span><span id="line-134"></span><span>        </span><span class="annot"><span class="annottext">ServerResponse
</span><span class="hs-identifier">_</span></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM Slot
forall a. STM a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">retry</span></a></span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span id="local-6989586621679330556"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#addTx"><span class="hs-identifier hs-type">addTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330556"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#ServerHandler"><span class="hs-identifier hs-type">ServerHandler</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Tx</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.BabbageEra</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679330556"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-137"></span><span id="addTx"><span class="annot"><span class="annottext">addTx :: ServerHandler -&gt; Tx BabbageEra -&gt; m ()
</span><a href="Cardano.Node.Socket.Emulator.Server.html#addTx"><span class="hs-identifier hs-var hs-var">addTx</span></a></span></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#ServerHandler"><span class="hs-identifier hs-type">ServerHandler</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679330555"><span class="annot"><span class="annottext">CommandChannel
shCommandChannel :: CommandChannel
shCommandChannel :: ServerHandler -&gt; CommandChannel
</span><a href="#local-6989586621679330555"><span class="hs-identifier hs-var hs-var">shCommandChannel</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span id="local-6989586621679330554"><span class="annot"><span class="annottext">Tx BabbageEra
</span><a href="#local-6989586621679330554"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-138"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue ServerCommand -&gt; ServerCommand -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTQueue</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CommandChannel -&gt; TQueue ServerCommand
</span><a href="Cardano.Node.Socket.Emulator.Server.html#ccCommand"><span class="hs-identifier hs-var hs-var">ccCommand</span></a></span><span>  </span><span class="annot"><span class="annottext">CommandChannel
</span><a href="#local-6989586621679330555"><span class="hs-identifier hs-var">shCommandChannel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ServerCommand -&gt; STM ()) -&gt; ServerCommand -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Tx BabbageEra -&gt; ServerCommand
</span><a href="Cardano.Node.Socket.Emulator.Server.html#AddTx"><span class="hs-identifier hs-var">AddTx</span></a></span><span> </span><span class="annot"><span class="annottext">Tx BabbageEra
</span><a href="#local-6989586621679330554"><span class="hs-identifier hs-var">tx</span></a></span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span class="hs-comment">{- Create a thread that keeps the number of blocks in the channel to the maximum
   limit of K -}</span><span>
</span><span id="line-142"></span><span id="local-6989586621679330920"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#pruneChain"><span class="hs-identifier hs-type">pruneChain</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330920"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-identifier hs-type">Integer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TChan</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Block</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679330920"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">ThreadId</span></a></span></span><span>
</span><span id="line-143"></span><span id="pruneChain"><span class="annot"><span class="annottext">pruneChain :: Integer -&gt; TChan Block -&gt; m ThreadId
</span><a href="Cardano.Node.Socket.Emulator.Server.html#pruneChain"><span class="hs-identifier hs-var hs-var">pruneChain</span></a></span></span><span> </span><span id="local-6989586621679330552"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679330552"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679330551"><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621679330551"><span class="hs-identifier hs-var">original</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-144"></span><span>  </span><span id="local-6989586621679330550"><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621679330550"><span class="hs-identifier hs-var">localChannel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (TChan Block) -&gt; m (TChan Block)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (TChan Block) -&gt; m (TChan Block))
-&gt; IO (TChan Block) -&gt; m (TChan Block)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">STM (TChan Block) -&gt; IO (TChan Block)
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM (TChan Block) -&gt; IO (TChan Block))
-&gt; STM (TChan Block) -&gt; IO (TChan Block)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TChan Block -&gt; STM (TChan Block)
forall a. TChan a -&gt; STM (TChan a)
</span><span class="hs-identifier hs-var">cloneTChan</span></span><span> </span><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621679330551"><span class="hs-identifier hs-var">original</span></a></span><span>
</span><span id="line-145"></span><span>  </span><span class="annot"><span class="annottext">IO ThreadId -&gt; m ThreadId
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ThreadId -&gt; m ThreadId)
-&gt; (IO () -&gt; IO ThreadId) -&gt; IO () -&gt; m ThreadId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ThreadId
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forkIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ThreadId) -&gt; IO () -&gt; m ThreadId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; TChan Block -&gt; IO ()
forall (m :: * -&gt; *). MonadIO m =&gt; Integer -&gt; TChan Block -&gt; m ()
</span><a href="#local-6989586621679330546"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679330552"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621679330550"><span class="hs-identifier hs-var">localChannel</span></a></span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-147"></span><span>  </span><span id="local-6989586621679331002"><span class="annot"><a href="#local-6989586621679330546"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679331002"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-identifier hs-type">Integer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TChan</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Block</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679331002"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-148"></span><span>  </span><span id="local-6989586621679330546"><span class="annot"><span class="annottext">go :: Integer -&gt; TChan Block -&gt; m ()
</span><a href="#local-6989586621679330546"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679330545"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679330545"><span class="hs-identifier hs-var">k'</span></a></span></span><span> </span><span id="local-6989586621679330544"><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621679330544"><span class="hs-identifier hs-var">localChannel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-149"></span><span>    </span><span class="hs-comment">-- Wait for data on the channel</span><span>
</span><span id="line-150"></span><span>    </span><span class="annot"><span class="annottext">Block
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Block -&gt; m Block
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO Block -&gt; m Block) -&gt; IO Block -&gt; m Block
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">STM Block -&gt; IO Block
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM Block -&gt; IO Block) -&gt; STM Block -&gt; IO Block
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TChan Block -&gt; STM Block
forall a. TChan a -&gt; STM a
</span><span class="hs-identifier hs-var">readTChan</span></span><span> </span><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621679330544"><span class="hs-identifier hs-var">localChannel</span></a></span><span>
</span><span id="line-151"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679330545"><span class="hs-identifier hs-var">k'</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span>
</span><span id="line-152"></span><span>       </span><span class="hs-comment">{- When the counter reaches zero, there are K blocks in the
          original channel and we start to remove the oldest stored
          block by reading it. -}</span><span>
</span><span id="line-155"></span><span>       </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-156"></span><span>           </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">STM Block -&gt; IO Block
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TChan Block -&gt; STM Block
forall a. TChan a -&gt; STM a
</span><span class="hs-identifier hs-var">readTChan</span></span><span> </span><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621679330551"><span class="hs-identifier hs-var">original</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IO Block -&gt; IO () -&gt; IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; TChan Block -&gt; IO ()
forall (m :: * -&gt; *). MonadIO m =&gt; Integer -&gt; TChan Block -&gt; m ()
</span><a href="#local-6989586621679330546"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621679330544"><span class="hs-identifier hs-var">localChannel</span></a></span><span>
</span><span id="line-157"></span><span>       </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-158"></span><span>           </span><span class="annot"><span class="annottext">Integer -&gt; TChan Block -&gt; m ()
forall (m :: * -&gt; *). MonadIO m =&gt; Integer -&gt; TChan Block -&gt; m ()
</span><a href="#local-6989586621679330546"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679330545"><span class="hs-identifier hs-var">k'</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621679330544"><span class="hs-identifier hs-var">localChannel</span></a></span><span>
</span><span id="line-159"></span><span>
</span><span id="line-160"></span><span class="hs-comment">-- | Run all chain effects in the IO Monad</span><span>
</span><span id="line-161"></span><span id="local-6989586621679330970"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#runChainEffects"><span class="hs-identifier hs-type">runChainEffects</span></a></span><span>
</span><span id="line-162"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Params</span></span><span>
</span><span id="line-163"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#AppState"><span class="hs-identifier hs-type">AppState</span></a></span><span>
</span><span id="line-164"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">EmulatorT</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330970"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-165"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">EmulatorLogs</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">EmulatorError</span></span><span> </span><span class="annot"><a href="#local-6989586621679330970"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-166"></span><span id="runChainEffects"><span class="annot"><span class="annottext">runChainEffects :: Params
-&gt; MVar AppState
-&gt; EmulatorT IO a
-&gt; IO (EmulatorLogs, Either EmulatorError a)
</span><a href="Cardano.Node.Socket.Emulator.Server.html#runChainEffects"><span class="hs-identifier hs-var hs-var">runChainEffects</span></a></span></span><span> </span><span id="local-6989586621679330541"><span class="annot"><span class="annottext">Params
</span><a href="#local-6989586621679330541"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621679330540"><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330540"><span class="hs-identifier hs-var">stateVar</span></a></span></span><span> </span><span id="local-6989586621679330539"><span class="annot"><span class="annottext">EmulatorT IO a
</span><a href="#local-6989586621679330539"><span class="hs-identifier hs-var">eff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-167"></span><span>    </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#AppState"><span class="hs-identifier hs-type">AppState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#SocketEmulatorState"><span class="hs-identifier hs-type">SocketEmulatorState</span></a></span><span> </span><span id="local-6989586621679330536"><span class="annot"><span class="annottext">EmulatorState
</span><a href="#local-6989586621679330536"><span class="hs-identifier hs-var">oldState</span></a></span></span><span> </span><span id="local-6989586621679330535"><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621679330535"><span class="hs-identifier hs-var">chan</span></a></span></span><span> </span><span id="local-6989586621679330534"><span class="annot"><span class="annottext">Tip
</span><a href="#local-6989586621679330534"><span class="hs-identifier hs-var">tip</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679330533"><span class="annot"><span class="annottext">EmulatorLogs
</span><a href="#local-6989586621679330533"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO AppState -&gt; IO AppState
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO AppState -&gt; IO AppState) -&gt; IO AppState -&gt; IO AppState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AppState -&gt; IO AppState
forall a. MVar a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">takeMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330540"><span class="hs-identifier hs-var">stateVar</span></a></span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679330531"><span class="annot"><span class="annottext">Either EmulatorError a
</span><a href="#local-6989586621679330531"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679330530"><span class="annot"><span class="annottext">EmulatorState
</span><a href="#local-6989586621679330530"><span class="hs-identifier hs-var">newState</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679330529"><span class="annot"><span class="annottext">EmulatorLogs
</span><a href="#local-6989586621679330529"><span class="hs-identifier hs-var">newEvents</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RWST Params EmulatorLogs EmulatorState IO (Either EmulatorError a)
-&gt; Params
-&gt; EmulatorState
-&gt; IO (Either EmulatorError a, EmulatorState, EmulatorLogs)
forall r w s (m :: * -&gt; *) a.
RWST r w s m a -&gt; r -&gt; s -&gt; m (a, s, w)
</span><span class="hs-identifier hs-var hs-var">runRWST</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EmulatorT IO a
-&gt; RWST
     Params EmulatorLogs EmulatorState IO (Either EmulatorError a)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">EmulatorT IO a
</span><a href="#local-6989586621679330539"><span class="hs-identifier hs-var">eff</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Params
</span><a href="#local-6989586621679330541"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">EmulatorState
</span><a href="#local-6989586621679330536"><span class="hs-identifier hs-var">oldState</span></a></span><span>
</span><span id="line-169"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AppState -&gt; AppState -&gt; IO ()
forall a. MVar a -&gt; a -&gt; IO ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">putMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330540"><span class="hs-identifier hs-var">stateVar</span></a></span><span> </span><span class="annot"><span class="annottext">(AppState -&gt; IO ()) -&gt; AppState -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SocketEmulatorState -&gt; EmulatorLogs -&gt; AppState
</span><a href="Cardano.Node.Socket.Emulator.Types.html#AppState"><span class="hs-identifier hs-var">AppState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EmulatorState -&gt; TChan Block -&gt; Tip -&gt; SocketEmulatorState
</span><a href="Cardano.Node.Socket.Emulator.Types.html#SocketEmulatorState"><span class="hs-identifier hs-var">SocketEmulatorState</span></a></span><span> </span><span class="annot"><span class="annottext">EmulatorState
</span><a href="#local-6989586621679330530"><span class="hs-identifier hs-var">newState</span></a></span><span> </span><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621679330535"><span class="hs-identifier hs-var">chan</span></a></span><span> </span><span class="annot"><span class="annottext">Tip
</span><a href="#local-6989586621679330534"><span class="hs-identifier hs-var">tip</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EmulatorLogs
</span><a href="#local-6989586621679330533"><span class="hs-identifier hs-var">events</span></a></span><span> </span><span class="annot"><span class="annottext">EmulatorLogs -&gt; EmulatorLogs -&gt; EmulatorLogs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">EmulatorLogs
</span><a href="#local-6989586621679330529"><span class="hs-identifier hs-var">newEvents</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span>    </span><span class="annot"><span class="annottext">(EmulatorLogs, Either EmulatorError a)
-&gt; IO (EmulatorLogs, Either EmulatorError a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EmulatorLogs
</span><a href="#local-6989586621679330529"><span class="hs-identifier hs-var">newEvents</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Either EmulatorError a
</span><a href="#local-6989586621679330531"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-171"></span><span>
</span><span id="line-172"></span><span id="local-6989586621679330937"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#processChainEffects"><span class="hs-identifier hs-type">processChainEffects</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-173"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Trace</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">EmulatorMsg</span></span><span>
</span><span id="line-174"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Params</span></span><span>
</span><span id="line-175"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#AppState"><span class="hs-identifier hs-type">AppState</span></a></span><span>
</span><span id="line-176"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">EmulatorT</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330937"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-177"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330937"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-178"></span><span id="processChainEffects"><span class="annot"><span class="annottext">processChainEffects :: Trace IO EmulatorMsg
-&gt; Params -&gt; MVar AppState -&gt; EmulatorT IO a -&gt; IO a
</span><a href="Cardano.Node.Socket.Emulator.Server.html#processChainEffects"><span class="hs-identifier hs-var hs-var">processChainEffects</span></a></span></span><span> </span><span id="local-6989586621679330527"><span class="annot"><span class="annottext">Trace IO EmulatorMsg
</span><a href="#local-6989586621679330527"><span class="hs-identifier hs-var">trace</span></a></span></span><span> </span><span id="local-6989586621679330526"><span class="annot"><span class="annottext">Params
</span><a href="#local-6989586621679330526"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621679330525"><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330525"><span class="hs-identifier hs-var">stateVar</span></a></span></span><span> </span><span id="local-6989586621679330524"><span class="annot"><span class="annottext">EmulatorT IO a
</span><a href="#local-6989586621679330524"><span class="hs-identifier hs-var">eff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-179"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679330523"><span class="annot"><span class="annottext">EmulatorLogs
</span><a href="#local-6989586621679330523"><span class="hs-identifier hs-var">events</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679330522"><span class="annot"><span class="annottext">Either EmulatorError a
</span><a href="#local-6989586621679330522"><span class="hs-identifier hs-var">result</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Params
-&gt; MVar AppState
-&gt; EmulatorT IO a
-&gt; IO (EmulatorLogs, Either EmulatorError a)
forall a.
Params
-&gt; MVar AppState
-&gt; EmulatorT IO a
-&gt; IO (EmulatorLogs, Either EmulatorError a)
</span><a href="Cardano.Node.Socket.Emulator.Server.html#runChainEffects"><span class="hs-identifier hs-var">runChainEffects</span></a></span><span> </span><span class="annot"><span class="annottext">Params
</span><a href="#local-6989586621679330526"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330525"><span class="hs-identifier hs-var">stateVar</span></a></span><span> </span><span class="annot"><span class="annottext">EmulatorT IO a
</span><a href="#local-6989586621679330524"><span class="hs-identifier hs-var">eff</span></a></span><span>
</span><span id="line-180"></span><span>    </span><span class="annot"><span class="annottext">Trace IO EmulatorMsg -&gt; Eff '[LogMsg EmulatorMsg, IO] ~&gt; IO
forall (m :: * -&gt; *) l.
MonadIO m =&gt;
Trace m l -&gt; Eff '[LogMsg l, m] ~&gt; m
</span><a href="Plutus.Monitoring.Util.html#runLogEffects"><span class="hs-identifier hs-var">LM.runLogEffects</span></a></span><span> </span><span class="annot"><span class="annottext">Trace IO EmulatorMsg
</span><a href="#local-6989586621679330527"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="annot"><span class="annottext">(Eff '[LogMsg EmulatorMsg, IO] () -&gt; IO ())
-&gt; Eff '[LogMsg EmulatorMsg, IO] () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(LogMessage EmulatorMsg -&gt; Eff '[LogMsg EmulatorMsg, IO] ())
-&gt; EmulatorLogs -&gt; Eff '[LogMsg EmulatorMsg, IO] ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LogMsg EmulatorMsg () -&gt; Eff '[LogMsg EmulatorMsg, IO] ()
forall (eff :: * -&gt; *) (effs :: [* -&gt; *]) a.
Member eff effs =&gt;
eff a -&gt; Eff effs a
</span><span class="hs-identifier hs-var">send</span></span><span> </span><span class="annot"><span class="annottext">(LogMsg EmulatorMsg () -&gt; Eff '[LogMsg EmulatorMsg, IO] ())
-&gt; (LogMessage EmulatorMsg -&gt; LogMsg EmulatorMsg ())
-&gt; LogMessage EmulatorMsg
-&gt; Eff '[LogMsg EmulatorMsg, IO] ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">LogMessage EmulatorMsg -&gt; LogMsg EmulatorMsg ()
forall a. LogMessage a -&gt; LogMsg a ()
</span><span class="hs-identifier hs-var">LMessage</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">EmulatorLogs
</span><a href="#local-6989586621679330523"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-181"></span><span>    </span><span class="annot"><span class="annottext">(EmulatorError -&gt; IO a)
-&gt; (a -&gt; IO a) -&gt; Either EmulatorError a -&gt; IO a
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">either</span></a></span><span> </span><span class="annot"><span class="annottext">EmulatorError -&gt; IO a
forall e a. Exception e =&gt; e -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">throwIO</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Either EmulatorError a
</span><a href="#local-6989586621679330522"><span class="hs-identifier hs-var">result</span></a></span><span>
</span><span id="line-182"></span><span>
</span><span id="line-183"></span><span id="local-6989586621679330921"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#handleCommand"><span class="hs-identifier hs-type">handleCommand</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-184"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330921"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-185"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Trace</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">EmulatorMsg</span></span><span>
</span><span id="line-186"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#CommandChannel"><span class="hs-identifier hs-type">CommandChannel</span></a></span><span>
</span><span id="line-187"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#AppState"><span class="hs-identifier hs-type">AppState</span></a></span><span>
</span><span id="line-188"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Params</span></span><span>
</span><span id="line-189"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679330921"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-190"></span><span id="handleCommand"><span class="annot"><span class="annottext">handleCommand :: Trace IO EmulatorMsg
-&gt; CommandChannel -&gt; MVar AppState -&gt; Params -&gt; m ()
</span><a href="Cardano.Node.Socket.Emulator.Server.html#handleCommand"><span class="hs-identifier hs-var hs-var">handleCommand</span></a></span></span><span> </span><span id="local-6989586621679330518"><span class="annot"><span class="annottext">Trace IO EmulatorMsg
</span><a href="#local-6989586621679330518"><span class="hs-identifier hs-var">trace</span></a></span></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#CommandChannel"><span class="hs-identifier hs-type">CommandChannel</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679330517"><span class="annot"><span class="annottext">TQueue ServerCommand
ccCommand :: TQueue ServerCommand
ccCommand :: CommandChannel -&gt; TQueue ServerCommand
</span><a href="#local-6989586621679330517"><span class="hs-identifier hs-var hs-var">ccCommand</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679330516"><span class="annot"><span class="annottext">TQueue ServerResponse
ccResponse :: TQueue ServerResponse
ccResponse :: CommandChannel -&gt; TQueue ServerResponse
</span><a href="#local-6989586621679330516"><span class="hs-identifier hs-var hs-var">ccResponse</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679330515"><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330515"><span class="hs-identifier hs-var">mvAppState</span></a></span></span><span> </span><span id="local-6989586621679330514"><span class="annot"><span class="annottext">Params
</span><a href="#local-6989586621679330514"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-191"></span><span>    </span><span class="annot"><span class="annottext">STM ServerCommand -&gt; IO ServerCommand
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TQueue ServerCommand -&gt; STM ServerCommand
forall a. TQueue a -&gt; STM a
</span><span class="hs-identifier hs-var">readTQueue</span></span><span> </span><span class="annot"><span class="annottext">TQueue ServerCommand
</span><a href="#local-6989586621679330517"><span class="hs-identifier hs-var">ccCommand</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IO ServerCommand -&gt; (ServerCommand -&gt; IO ()) -&gt; IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-192"></span><span>            </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#AddTx"><span class="hs-identifier hs-type">AddTx</span></a></span><span> </span><span id="local-6989586621679330513"><span class="annot"><span class="annottext">Tx BabbageEra
</span><a href="#local-6989586621679330513"><span class="hs-identifier hs-var">tx</span></a></span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EmulatorT IO () -&gt; IO ()
forall a. EmulatorT IO a -&gt; IO a
</span><a href="#local-6989586621679330512"><span class="hs-identifier hs-var">process</span></a></span><span> </span><span class="annot"><span class="annottext">(EmulatorT IO () -&gt; IO ()) -&gt; EmulatorT IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CardanoTx -&gt; EmulatorT IO ()
forall (m :: * -&gt; *). MonadEmulator m =&gt; CardanoTx -&gt; m ()
</span><span class="hs-identifier hs-var">E.queueTx</span></span><span> </span><span class="annot"><span class="annottext">(CardanoTx -&gt; EmulatorT IO ()) -&gt; CardanoTx -&gt; EmulatorT IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Tx BabbageEra -&gt; CardanoTx
</span><span class="hs-identifier hs-var">CardanoEmulatorEraTx</span></span><span> </span><span class="annot"><span class="annottext">Tx BabbageEra
</span><a href="#local-6989586621679330513"><span class="hs-identifier hs-var">tx</span></a></span><span>
</span><span id="line-193"></span><span>            </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#ModifySlot"><span class="hs-identifier hs-type">ModifySlot</span></a></span><span> </span><span id="local-6989586621679330509"><span class="annot"><span class="annottext">Slot -&gt; Slot
</span><a href="#local-6989586621679330509"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-194"></span><span>                </span><span id="local-6989586621679330508"><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621679330508"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EmulatorT IO Slot -&gt; IO Slot
forall a. EmulatorT IO a -&gt; IO a
</span><a href="#local-6989586621679330512"><span class="hs-identifier hs-var">process</span></a></span><span> </span><span class="annot"><span class="annottext">(EmulatorT IO Slot -&gt; IO Slot) -&gt; EmulatorT IO Slot -&gt; IO Slot
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Slot -&gt; Slot) -&gt; EmulatorT IO Slot
forall (m :: * -&gt; *). MonadEmulator m =&gt; (Slot -&gt; Slot) -&gt; m Slot
</span><span class="hs-identifier hs-var">E.modifySlot</span></span><span> </span><span class="annot"><span class="annottext">Slot -&gt; Slot
</span><a href="#local-6989586621679330509"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-195"></span><span>                </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-196"></span><span>                    </span><span class="annot"><span class="annottext">TQueue ServerResponse -&gt; ServerResponse -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTQueue</span></span><span> </span><span class="annot"><span class="annottext">TQueue ServerResponse
</span><a href="#local-6989586621679330516"><span class="hs-identifier hs-var">ccResponse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Slot -&gt; ServerResponse
</span><a href="Cardano.Node.Socket.Emulator.Server.html#SlotChanged"><span class="hs-identifier hs-var">SlotChanged</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621679330508"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-197"></span><span>            </span><span class="annot"><span class="annottext">ServerCommand
</span><a href="Cardano.Node.Socket.Emulator.Server.html#ProcessBlock"><span class="hs-identifier hs-var">ProcessBlock</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-198"></span><span>                </span><span id="local-6989586621679330506"><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621679330506"><span class="hs-identifier hs-var">block</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EmulatorT IO Block -&gt; IO Block
forall a. EmulatorT IO a -&gt; IO a
</span><a href="#local-6989586621679330512"><span class="hs-identifier hs-var">process</span></a></span><span> </span><span class="annot"><span class="annottext">EmulatorT IO Block
forall (m :: * -&gt; *). MonadEmulator m =&gt; m Block
</span><span class="hs-identifier hs-var">E.processBlock</span></span><span>
</span><span id="line-199"></span><span>                </span><span class="annot"><span class="annottext">MVar AppState -&gt; Block -&gt; IO ()
forall (m :: * -&gt; *). MonadIO m =&gt; MVar AppState -&gt; Block -&gt; m ()
</span><a href="Cardano.Node.Socket.Emulator.Types.html#setTip"><span class="hs-identifier hs-var">setTip</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330515"><span class="hs-identifier hs-var">mvAppState</span></a></span><span> </span><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621679330506"><span class="hs-identifier hs-var">block</span></a></span><span>
</span><span id="line-200"></span><span>                </span><span id="local-6989586621679330504"><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621679330504"><span class="hs-identifier hs-var">ch</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVar AppState -&gt; IO (TChan Block)
forall (m :: * -&gt; *). MonadIO m =&gt; MVar AppState -&gt; m (TChan Block)
</span><a href="Cardano.Node.Socket.Emulator.Types.html#getChannel"><span class="hs-identifier hs-var">getChannel</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330515"><span class="hs-identifier hs-var">mvAppState</span></a></span><span>
</span><span id="line-201"></span><span>                </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-202"></span><span>                    </span><span class="annot"><span class="annottext">TChan Block -&gt; Block -&gt; STM ()
forall a. TChan a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTChan</span></span><span> </span><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621679330504"><span class="hs-identifier hs-var">ch</span></a></span><span> </span><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621679330506"><span class="hs-identifier hs-var">block</span></a></span><span>
</span><span id="line-203"></span><span>                    </span><span class="annot"><span class="annottext">TQueue ServerResponse -&gt; ServerResponse -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTQueue</span></span><span> </span><span class="annot"><span class="annottext">TQueue ServerResponse
</span><a href="#local-6989586621679330516"><span class="hs-identifier hs-var">ccResponse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Block -&gt; ServerResponse
</span><a href="Cardano.Node.Socket.Emulator.Server.html#BlockAdded"><span class="hs-identifier hs-var">BlockAdded</span></a></span><span> </span><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621679330506"><span class="hs-identifier hs-var">block</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-204"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-205"></span><span>        </span><span id="local-6989586621679330947"><span class="annot"><a href="#local-6989586621679330512"><span class="hs-identifier hs-type">process</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">EmulatorT</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330947"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330947"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-206"></span><span>        </span><span id="local-6989586621679330512"><span class="annot"><span class="annottext">process :: EmulatorT IO a -&gt; IO a
</span><a href="#local-6989586621679330512"><span class="hs-identifier hs-var hs-var">process</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Trace IO EmulatorMsg
-&gt; Params -&gt; MVar AppState -&gt; EmulatorT IO a -&gt; IO a
forall a.
Trace IO EmulatorMsg
-&gt; Params -&gt; MVar AppState -&gt; EmulatorT IO a -&gt; IO a
</span><a href="Cardano.Node.Socket.Emulator.Server.html#processChainEffects"><span class="hs-identifier hs-var">processChainEffects</span></a></span><span> </span><span class="annot"><span class="annottext">Trace IO EmulatorMsg
</span><a href="#local-6989586621679330518"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="annot"><span class="annottext">Params
</span><a href="#local-6989586621679330514"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330515"><span class="hs-identifier hs-var">mvAppState</span></a></span><span>
</span><span id="line-207"></span><span>
</span><span id="line-208"></span><span class="hs-comment">{- | Start the server in a new thread, and return a server handler
     used to control the server -}</span><span>
</span><span id="line-210"></span><span id="local-6989586621679330502"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#runServerNode"><span class="hs-identifier hs-type">runServerNode</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-211"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330502"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-212"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Trace</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">EmulatorMsg</span></span><span>
</span><span id="line-213"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-214"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-identifier hs-type">Integer</span></a></span><span>
</span><span id="line-215"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#AppState"><span class="hs-identifier hs-type">AppState</span></a></span><span>
</span><span id="line-216"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Params</span></span><span>
</span><span id="line-217"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679330502"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#ServerHandler"><span class="hs-identifier hs-type">ServerHandler</span></a></span></span><span>
</span><span id="line-218"></span><span id="runServerNode"><span class="annot"><span class="annottext">runServerNode :: Trace IO EmulatorMsg
-&gt; FilePath -&gt; Integer -&gt; AppState -&gt; Params -&gt; m ServerHandler
</span><a href="Cardano.Node.Socket.Emulator.Server.html#runServerNode"><span class="hs-identifier hs-var hs-var">runServerNode</span></a></span></span><span> </span><span id="local-6989586621679330501"><span class="annot"><span class="annottext">Trace IO EmulatorMsg
</span><a href="#local-6989586621679330501"><span class="hs-identifier hs-var">trace</span></a></span></span><span> </span><span id="local-6989586621679330500"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679330500"><span class="hs-identifier hs-var">shSocketPath</span></a></span></span><span> </span><span id="local-6989586621679330499"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679330499"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679330498"><span class="annot"><span class="annottext">AppState
</span><a href="#local-6989586621679330498"><span class="hs-identifier hs-var">initialState</span></a></span></span><span> </span><span id="local-6989586621679330497"><span class="annot"><span class="annottext">Params
</span><a href="#local-6989586621679330497"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO ServerHandler -&gt; m ServerHandler
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ServerHandler -&gt; m ServerHandler)
-&gt; IO ServerHandler -&gt; m ServerHandler
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-219"></span><span>    </span><span id="local-6989586621679330496"><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330496"><span class="hs-identifier hs-var">serverState</span></a></span></span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AppState -&gt; IO (MVar AppState)
forall a. a -&gt; IO (MVar a)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">newMVar</span></a></span><span> </span><span class="annot"><span class="annottext">AppState
</span><a href="#local-6989586621679330498"><span class="hs-identifier hs-var">initialState</span></a></span><span>
</span><span id="line-220"></span><span>    </span><span id="local-6989586621679330494"><span class="annot"><span class="annottext">CommandChannel
</span><a href="#local-6989586621679330494"><span class="hs-identifier hs-var">shCommandChannel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TQueue ServerCommand -&gt; TQueue ServerResponse -&gt; CommandChannel
</span><a href="Cardano.Node.Socket.Emulator.Server.html#CommandChannel"><span class="hs-identifier hs-var">CommandChannel</span></a></span><span> </span><span class="annot"><span class="annottext">(TQueue ServerCommand -&gt; TQueue ServerResponse -&gt; CommandChannel)
-&gt; IO (TQueue ServerCommand)
-&gt; IO (TQueue ServerResponse -&gt; CommandChannel)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">IO (TQueue ServerCommand)
forall a. IO (TQueue a)
</span><span class="hs-identifier hs-var">newTQueueIO</span></span><span> </span><span class="annot"><span class="annottext">IO (TQueue ServerResponse -&gt; CommandChannel)
-&gt; IO (TQueue ServerResponse) -&gt; IO CommandChannel
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">IO (TQueue ServerResponse)
forall a. IO (TQueue a)
</span><span class="hs-identifier hs-var">newTQueueIO</span></span><span>
</span><span id="line-221"></span><span>    </span><span id="local-6989586621679330491"><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621679330491"><span class="hs-identifier hs-var">globalChannel</span></a></span></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVar AppState -&gt; IO (TChan Block)
forall (m :: * -&gt; *). MonadIO m =&gt; MVar AppState -&gt; m (TChan Block)
</span><a href="Cardano.Node.Socket.Emulator.Types.html#getChannel"><span class="hs-identifier hs-var">getChannel</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330496"><span class="hs-identifier hs-var">serverState</span></a></span><span>
</span><span id="line-222"></span><span>    </span><span class="annot"><span class="annottext">IO ThreadId -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ThreadId -&gt; IO ()) -&gt; IO ThreadId -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ThreadId
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forkIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ThreadId)
-&gt; (IO Void -&gt; IO ()) -&gt; IO Void -&gt; IO ThreadId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IO Void -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span>    </span><span class="annot"><span class="annottext">(IO Void -&gt; IO ThreadId) -&gt; IO Void -&gt; IO ThreadId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; MVar AppState -&gt; IO Void
forall (m :: * -&gt; *).
MonadIO m =&gt;
FilePath -&gt; MVar AppState -&gt; m Void
</span><a href="Cardano.Node.Socket.Emulator.Server.html#protocolLoop"><span class="hs-identifier hs-var">protocolLoop</span></a></span><span>        </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679330500"><span class="hs-identifier hs-var">shSocketPath</span></a></span><span>     </span><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330496"><span class="hs-identifier hs-var">serverState</span></a></span><span>
</span><span id="line-223"></span><span>    </span><span class="annot"><span class="annottext">IO ThreadId -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ThreadId -&gt; IO ()) -&gt; IO ThreadId -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ThreadId
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forkIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ThreadId) -&gt; (IO () -&gt; IO ()) -&gt; IO () -&gt; IO ThreadId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forever</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ThreadId) -&gt; IO () -&gt; IO ThreadId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Trace IO EmulatorMsg
-&gt; CommandChannel -&gt; MVar AppState -&gt; Params -&gt; IO ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
Trace IO EmulatorMsg
-&gt; CommandChannel -&gt; MVar AppState -&gt; Params -&gt; m ()
</span><a href="Cardano.Node.Socket.Emulator.Server.html#handleCommand"><span class="hs-identifier hs-var">handleCommand</span></a></span><span> </span><span class="annot"><span class="annottext">Trace IO EmulatorMsg
</span><a href="#local-6989586621679330501"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="annot"><span class="annottext">CommandChannel
</span><a href="#local-6989586621679330494"><span class="hs-identifier hs-var">shCommandChannel</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330496"><span class="hs-identifier hs-var">serverState</span></a></span><span> </span><span class="annot"><span class="annottext">Params
</span><a href="#local-6989586621679330497"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-224"></span><span>    </span><span class="annot"><span class="annottext">IO ThreadId -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span>                    </span><span class="annot"><span class="annottext">(IO ThreadId -&gt; IO ()) -&gt; IO ThreadId -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; TChan Block -&gt; IO ThreadId
forall (m :: * -&gt; *).
MonadIO m =&gt;
Integer -&gt; TChan Block -&gt; m ThreadId
</span><a href="Cardano.Node.Socket.Emulator.Server.html#pruneChain"><span class="hs-identifier hs-var">pruneChain</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679330499"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621679330491"><span class="hs-identifier hs-var">globalChannel</span></a></span><span>
</span><span id="line-225"></span><span>    </span><span class="annot"><span class="annottext">ServerHandler -&gt; IO ServerHandler
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerHandler -&gt; IO ServerHandler)
-&gt; ServerHandler -&gt; IO ServerHandler
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ServerHandler :: FilePath -&gt; CommandChannel -&gt; ServerHandler
</span><a href="Cardano.Node.Socket.Emulator.Server.html#ServerHandler"><span class="hs-identifier hs-type">ServerHandler</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">FilePath
shSocketPath :: FilePath
shSocketPath :: FilePath
</span><a href="#local-6989586621679330500"><span class="hs-identifier hs-var hs-var">shSocketPath</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CommandChannel
shCommandChannel :: CommandChannel
shCommandChannel :: CommandChannel
</span><a href="#local-6989586621679330494"><span class="hs-identifier hs-var hs-var">shCommandChannel</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-226"></span><span>
</span><span id="line-227"></span><span class="hs-comment">-- * ChainSync protocol</span><span>
</span><span id="line-228"></span><span>
</span><span id="line-229"></span><span class="hs-comment">{- A monad for running all code executed when a state
   transition is invoked. It makes the implementation of
   state transitions easier to read. -}</span><span>
</span><span id="line-232"></span><span>
</span><span id="line-233"></span><span class="hs-keyword">type</span><span> </span><span id="ChainSyncMonad"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#ChainSyncMonad"><span class="hs-identifier hs-var">ChainSyncMonad</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#AppState"><span class="hs-identifier hs-type">AppState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span>
</span><span id="line-234"></span><span>
</span><span id="line-235"></span><span id="local-6989586621679330830"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#runChainSync"><span class="hs-identifier hs-type">runChainSync</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#AppState"><span class="hs-identifier hs-type">AppState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#ChainSyncMonad"><span class="hs-identifier hs-type">ChainSyncMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330830"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330830"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-236"></span><span id="runChainSync"><span class="annot"><span class="annottext">runChainSync :: MVar AppState -&gt; ChainSyncMonad a -&gt; IO a
</span><a href="Cardano.Node.Socket.Emulator.Server.html#runChainSync"><span class="hs-identifier hs-var hs-var">runChainSync</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ChainSyncMonad a -&gt; MVar AppState -&gt; IO a)
-&gt; MVar AppState -&gt; ChainSyncMonad a -&gt; IO a
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncMonad a -&gt; MVar AppState -&gt; IO a
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span>
</span><span id="line-237"></span><span>
</span><span id="line-238"></span><span class="hs-comment">{- The initial state of the protocol. You can move into
   requesting the next block or reset state by searching for an
   intersection. -}</span><span>
</span><span id="line-241"></span><span id="local-6989586621679330847"><span id="local-6989586621679330848"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#idleState"><span class="hs-identifier hs-type">idleState</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-242"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#AppState"><span class="hs-identifier hs-type">AppState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679330848"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-243"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330848"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-244"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679330847"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CardanoBlock</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">StandardCrypto</span></span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#LocalChannel"><span class="hs-identifier hs-type">LocalChannel</span></a></span><span>
</span><span id="line-246"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679330848"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ServerStIdle</span></span><span> </span><span class="annot"><a href="#local-6989586621679330847"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679330847"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330848"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-247"></span><span id="idleState"><span class="annot"><span class="annottext">idleState :: LocalChannel -&gt; m (ServerStIdle block (Point block) Tip m ())
</span><a href="Cardano.Node.Socket.Emulator.Server.html#idleState"><span class="hs-identifier hs-var hs-var">idleState</span></a></span></span><span> </span><span id="local-6989586621679330483"><span class="annot"><span class="annottext">LocalChannel
</span><a href="#local-6989586621679330483"><span class="hs-identifier hs-var">channel'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-248"></span><span>    </span><span class="annot"><span class="annottext">ServerStIdle block (Point block) Tip m ()
-&gt; m (ServerStIdle block (Point block) Tip m ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">ServerStIdle :: forall header point tip (m :: * -&gt; *) a.
m (Either
     (ServerStNext header point tip m a)
     (m (ServerStNext header point tip m a)))
-&gt; ([point] -&gt; m (ServerStIntersect header point tip m a))
-&gt; m a
-&gt; ServerStIdle header point tip m a
</span><span class="hs-identifier hs-type">ServerStIdle</span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-249"></span><span>        </span><span class="annot"><span class="annottext">recvMsgRequestNext :: m (Either
     (ServerStNext block (Point block) Tip m ())
     (m (ServerStNext block (Point block) Tip m ())))
</span><span class="hs-identifier hs-var">recvMsgRequestNext</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LocalChannel
-&gt; m (Either
        (ServerStNext block (Point block) Tip m ())
        (m (ServerStNext block (Point block) Tip m ())))
forall (m :: * -&gt; *) block.
(MonadReader (MVar AppState) m, MonadIO m,
 block ~ CardanoBlock StandardCrypto) =&gt;
LocalChannel
-&gt; m (Either
        (ServerStNext block (Point block) Tip m ())
        (m (ServerStNext block (Point block) Tip m ())))
</span><a href="Cardano.Node.Socket.Emulator.Server.html#nextState"><span class="hs-identifier hs-var">nextState</span></a></span><span> </span><span class="annot"><span class="annottext">LocalChannel
</span><a href="#local-6989586621679330483"><span class="hs-identifier hs-var">channel'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-250"></span><span>        </span><span class="annot"><span class="annottext">recvMsgFindIntersect :: [Point block] -&gt; m (ServerStIntersect block (Point block) Tip m ())
</span><span class="hs-identifier hs-var">recvMsgFindIntersect</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Point block] -&gt; m (ServerStIntersect block (Point block) Tip m ())
forall (m :: * -&gt; *) block.
(MonadReader (MVar AppState) m, MonadIO m,
 block ~ CardanoBlock StandardCrypto) =&gt;
[Point block] -&gt; m (ServerStIntersect block (Point block) Tip m ())
</span><a href="Cardano.Node.Socket.Emulator.Server.html#findIntersect"><span class="hs-identifier hs-var">findIntersect</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-251"></span><span>        </span><span class="annot"><span class="annottext">recvMsgDoneClient :: m ()
</span><span class="hs-identifier hs-var">recvMsgDoneClient</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-253"></span><span>
</span><span id="line-254"></span><span class="hs-comment">{- Get the next block, either immediately (the Just/Left branch)
   or within a monad (IO, in our case) where you can wait for the
   next block (Nothing/Right branch) -}</span><span>
</span><span id="line-257"></span><span id="local-6989586621679330896"><span id="local-6989586621679330898"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#nextState"><span class="hs-identifier hs-type">nextState</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-258"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#AppState"><span class="hs-identifier hs-type">AppState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679330898"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-259"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330898"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-260"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679330896"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CardanoBlock</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">StandardCrypto</span></span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#LocalChannel"><span class="hs-identifier hs-type">LocalChannel</span></a></span><span>
</span><span id="line-262"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679330898"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ServerStNext</span></span><span> </span><span class="annot"><a href="#local-6989586621679330896"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679330896"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330898"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-263"></span><span>              </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679330898"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ServerStNext</span></span><span> </span><span class="annot"><a href="#local-6989586621679330896"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679330896"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330898"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-264"></span><span id="nextState"><span class="annot"><span class="annottext">nextState :: LocalChannel
-&gt; m (Either
        (ServerStNext block (Point block) Tip m ())
        (m (ServerStNext block (Point block) Tip m ())))
</span><a href="Cardano.Node.Socket.Emulator.Server.html#nextState"><span class="hs-identifier hs-var hs-var">nextState</span></a></span></span><span> </span><span id="local-6989586621679330476"><span class="annot"><span class="annottext">localChannel :: LocalChannel
</span><a href="#local-6989586621679330476"><span class="hs-identifier hs-var">localChannel</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#LocalChannel"><span class="hs-identifier hs-type">LocalChannel</span></a></span><span> </span><span id="local-6989586621679330475"><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621679330475"><span class="hs-identifier hs-var">channel'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-265"></span><span>    </span><span id="local-6989586621679330474"><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330474"><span class="hs-identifier hs-var">chainState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (MVar AppState)
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-266"></span><span>    </span><span id="local-6989586621679330472"><span class="annot"><span class="annottext">Tip
</span><a href="#local-6989586621679330472"><span class="hs-identifier hs-var">tip'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVar AppState -&gt; m Tip
forall (m :: * -&gt; *). MonadIO m =&gt; MVar AppState -&gt; m Tip
</span><a href="Cardano.Node.Socket.Emulator.Types.html#getTip"><span class="hs-identifier hs-var">getTip</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330474"><span class="hs-identifier hs-var">chainState</span></a></span><span>
</span><span id="line-267"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679330471"><span class="annot"><span class="annottext">blockHeader :: a
</span><a href="#local-6989586621679330471"><span class="hs-identifier hs-var hs-var">blockHeader</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
forall a. HasCallStack =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">undefined</span></a></span><span> </span><span class="hs-comment">-- TODO</span><span>
</span><span id="line-268"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO (Maybe Block) -&gt; m (Maybe Block)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe Block) -&gt; m (Maybe Block))
-&gt; (STM (Maybe Block) -&gt; IO (Maybe Block))
-&gt; STM (Maybe Block)
-&gt; m (Maybe Block)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">STM (Maybe Block) -&gt; IO (Maybe Block)
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM (Maybe Block) -&gt; m (Maybe Block))
-&gt; STM (Maybe Block) -&gt; m (Maybe Block)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TChan Block -&gt; STM (Maybe Block)
forall a. TChan a -&gt; STM (Maybe a)
</span><span class="hs-identifier hs-var">tryReadTChan</span></span><span> </span><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621679330475"><span class="hs-identifier hs-var">channel'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m (Maybe Block)
-&gt; (Maybe Block
    -&gt; m (Either
            (ServerStNext
               (CardanoBlock StandardCrypto)
               (Point (CardanoBlock StandardCrypto))
               Tip
               m
               ())
            (m (ServerStNext
                  (CardanoBlock StandardCrypto)
                  (Point (CardanoBlock StandardCrypto))
                  Tip
                  m
                  ()))))
-&gt; m (Either
        (ServerStNext
           (CardanoBlock StandardCrypto)
           (Point (CardanoBlock StandardCrypto))
           Tip
           m
           ())
        (m (ServerStNext
              (CardanoBlock StandardCrypto)
              (Point (CardanoBlock StandardCrypto))
              Tip
              m
              ())))
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-269"></span><span>        </span><span class="annot"><span class="annottext">Maybe Block
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-270"></span><span>            </span><span class="annot"><span class="annottext">m (ServerStNext
     (CardanoBlock StandardCrypto)
     (Point (CardanoBlock StandardCrypto))
     Tip
     m
     ())
-&gt; Either
     (ServerStNext
        (CardanoBlock StandardCrypto)
        (Point (CardanoBlock StandardCrypto))
        Tip
        m
        ())
     (m (ServerStNext
           (CardanoBlock StandardCrypto)
           (Point (CardanoBlock StandardCrypto))
           Tip
           m
           ()))
forall a b. b -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">(m (ServerStNext
      (CardanoBlock StandardCrypto)
      (Point (CardanoBlock StandardCrypto))
      Tip
      m
      ())
 -&gt; Either
      (ServerStNext
         (CardanoBlock StandardCrypto)
         (Point (CardanoBlock StandardCrypto))
         Tip
         m
         ())
      (m (ServerStNext
            (CardanoBlock StandardCrypto)
            (Point (CardanoBlock StandardCrypto))
            Tip
            m
            ())))
-&gt; (ServerStNext
      (CardanoBlock StandardCrypto)
      (Point (CardanoBlock StandardCrypto))
      Tip
      m
      ()
    -&gt; m (ServerStNext
            (CardanoBlock StandardCrypto)
            (Point (CardanoBlock StandardCrypto))
            Tip
            m
            ()))
-&gt; ServerStNext
     (CardanoBlock StandardCrypto)
     (Point (CardanoBlock StandardCrypto))
     Tip
     m
     ()
-&gt; Either
     (ServerStNext
        (CardanoBlock StandardCrypto)
        (Point (CardanoBlock StandardCrypto))
        Tip
        m
        ())
     (m (ServerStNext
           (CardanoBlock StandardCrypto)
           (Point (CardanoBlock StandardCrypto))
           Tip
           m
           ()))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ServerStNext
  (CardanoBlock StandardCrypto)
  (Point (CardanoBlock StandardCrypto))
  Tip
  m
  ()
-&gt; m (ServerStNext
        (CardanoBlock StandardCrypto)
        (Point (CardanoBlock StandardCrypto))
        Tip
        m
        ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerStNext
   (CardanoBlock StandardCrypto)
   (Point (CardanoBlock StandardCrypto))
   Tip
   m
   ()
 -&gt; Either
      (ServerStNext
         (CardanoBlock StandardCrypto)
         (Point (CardanoBlock StandardCrypto))
         Tip
         m
         ())
      (m (ServerStNext
            (CardanoBlock StandardCrypto)
            (Point (CardanoBlock StandardCrypto))
            Tip
            m
            ())))
-&gt; m (ServerStNext
        (CardanoBlock StandardCrypto)
        (Point (CardanoBlock StandardCrypto))
        Tip
        m
        ())
-&gt; m (Either
        (ServerStNext
           (CardanoBlock StandardCrypto)
           (Point (CardanoBlock StandardCrypto))
           Tip
           m
           ())
        (m (ServerStNext
              (CardanoBlock StandardCrypto)
              (Point (CardanoBlock StandardCrypto))
              Tip
              m
              ())))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-271"></span><span>                </span><span id="local-6989586621679330468"><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621679330468"><span class="hs-identifier hs-var">nextBlock</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Block -&gt; m Block
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO Block -&gt; m Block)
-&gt; (STM Block -&gt; IO Block) -&gt; STM Block -&gt; m Block
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">STM Block -&gt; IO Block
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM Block -&gt; m Block) -&gt; STM Block -&gt; m Block
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TChan Block -&gt; STM Block
forall a. TChan a -&gt; STM a
</span><span class="hs-identifier hs-var">readTChan</span></span><span> </span><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621679330475"><span class="hs-identifier hs-var">channel'</span></a></span><span>
</span><span id="line-272"></span><span>                </span><span class="annot"><span class="annottext">LocalChannel
-&gt; Tip
-&gt; CardanoBlock StandardCrypto
-&gt; m (ServerStNext
        (CardanoBlock StandardCrypto)
        (Point (CardanoBlock StandardCrypto))
        Tip
        m
        ())
forall (m :: * -&gt; *) block.
(MonadReader (MVar AppState) m, MonadIO m,
 block ~ CardanoBlock StandardCrypto) =&gt;
LocalChannel
-&gt; Tip -&gt; block -&gt; m (ServerStNext block (Point block) Tip m ())
</span><a href="Cardano.Node.Socket.Emulator.Server.html#sendRollForward"><span class="hs-identifier hs-var">sendRollForward</span></a></span><span> </span><span class="annot"><span class="annottext">LocalChannel
</span><a href="#local-6989586621679330476"><span class="hs-identifier hs-var">localChannel</span></a></span><span> </span><span class="annot"><span class="annottext">Tip
</span><a href="#local-6989586621679330472"><span class="hs-identifier hs-var">tip'</span></a></span><span> </span><span class="annot"><span class="annottext">(CardanoBlock StandardCrypto
 -&gt; m (ServerStNext
         (CardanoBlock StandardCrypto)
         (Point (CardanoBlock StandardCrypto))
         Tip
         m
         ()))
-&gt; CardanoBlock StandardCrypto
-&gt; m (ServerStNext
        (CardanoBlock StandardCrypto)
        (Point (CardanoBlock StandardCrypto))
        Tip
        m
        ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Header StandardCrypto -&gt; Block -&gt; CardanoBlock StandardCrypto
</span><a href="Cardano.Node.Socket.Emulator.Types.html#toCardanoBlock"><span class="hs-identifier hs-var">toCardanoBlock</span></a></span><span> </span><span class="annot"><span class="annottext">Header StandardCrypto
forall a. a
</span><a href="#local-6989586621679330471"><span class="hs-identifier hs-var">blockHeader</span></a></span><span> </span><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621679330468"><span class="hs-identifier hs-var">nextBlock</span></a></span><span>
</span><span id="line-273"></span><span>        </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679330466"><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621679330466"><span class="hs-identifier hs-var">nextBlock</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-274"></span><span>            </span><span class="annot"><span class="annottext">ServerStNext
  (CardanoBlock StandardCrypto)
  (Point (CardanoBlock StandardCrypto))
  Tip
  m
  ()
-&gt; Either
     (ServerStNext
        (CardanoBlock StandardCrypto)
        (Point (CardanoBlock StandardCrypto))
        Tip
        m
        ())
     (m (ServerStNext
           (CardanoBlock StandardCrypto)
           (Point (CardanoBlock StandardCrypto))
           Tip
           m
           ()))
forall a b. a -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerStNext
   (CardanoBlock StandardCrypto)
   (Point (CardanoBlock StandardCrypto))
   Tip
   m
   ()
 -&gt; Either
      (ServerStNext
         (CardanoBlock StandardCrypto)
         (Point (CardanoBlock StandardCrypto))
         Tip
         m
         ())
      (m (ServerStNext
            (CardanoBlock StandardCrypto)
            (Point (CardanoBlock StandardCrypto))
            Tip
            m
            ())))
-&gt; m (ServerStNext
        (CardanoBlock StandardCrypto)
        (Point (CardanoBlock StandardCrypto))
        Tip
        m
        ())
-&gt; m (Either
        (ServerStNext
           (CardanoBlock StandardCrypto)
           (Point (CardanoBlock StandardCrypto))
           Tip
           m
           ())
        (m (ServerStNext
              (CardanoBlock StandardCrypto)
              (Point (CardanoBlock StandardCrypto))
              Tip
              m
              ())))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">LocalChannel
-&gt; Tip
-&gt; CardanoBlock StandardCrypto
-&gt; m (ServerStNext
        (CardanoBlock StandardCrypto)
        (Point (CardanoBlock StandardCrypto))
        Tip
        m
        ())
forall (m :: * -&gt; *) block.
(MonadReader (MVar AppState) m, MonadIO m,
 block ~ CardanoBlock StandardCrypto) =&gt;
LocalChannel
-&gt; Tip -&gt; block -&gt; m (ServerStNext block (Point block) Tip m ())
</span><a href="Cardano.Node.Socket.Emulator.Server.html#sendRollForward"><span class="hs-identifier hs-var">sendRollForward</span></a></span><span> </span><span class="annot"><span class="annottext">LocalChannel
</span><a href="#local-6989586621679330476"><span class="hs-identifier hs-var">localChannel</span></a></span><span> </span><span class="annot"><span class="annottext">Tip
</span><a href="#local-6989586621679330472"><span class="hs-identifier hs-var">tip'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header StandardCrypto -&gt; Block -&gt; CardanoBlock StandardCrypto
</span><a href="Cardano.Node.Socket.Emulator.Types.html#toCardanoBlock"><span class="hs-identifier hs-var">toCardanoBlock</span></a></span><span> </span><span class="annot"><span class="annottext">Header StandardCrypto
forall a. a
</span><a href="#local-6989586621679330471"><span class="hs-identifier hs-var">blockHeader</span></a></span><span> </span><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621679330466"><span class="hs-identifier hs-var">nextBlock</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-275"></span><span>
</span><span id="line-276"></span><span class="hs-comment">{- This protocol state will search for a block intersection
   with some client provided blocks. When an intersection is found
   the client state is reset to the new offset (the Just branch)
   or to the genesis block if no intersection was found. -}</span><span>
</span><span id="line-280"></span><span id="local-6989586621679330892"><span id="local-6989586621679330893"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#findIntersect"><span class="hs-identifier hs-type">findIntersect</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-281"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#AppState"><span class="hs-identifier hs-type">AppState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679330893"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-282"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330893"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-283"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679330892"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CardanoBlock</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">StandardCrypto</span></span><span class="hs-special">)</span><span>
</span><span id="line-284"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679330892"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-285"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679330893"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ServerStIntersect</span></span><span> </span><span class="annot"><a href="#local-6989586621679330892"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679330892"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330893"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-286"></span><span id="findIntersect"><span class="annot"><span class="annottext">findIntersect :: [Point block] -&gt; m (ServerStIntersect block (Point block) Tip m ())
</span><a href="Cardano.Node.Socket.Emulator.Server.html#findIntersect"><span class="hs-identifier hs-var hs-var">findIntersect</span></a></span></span><span> </span><span id="local-6989586621679330465"><span class="annot"><span class="annottext">[Point block]
</span><a href="#local-6989586621679330465"><span class="hs-identifier hs-var">clientPoints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-287"></span><span>    </span><span id="local-6989586621679330464"><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330464"><span class="hs-identifier hs-var">mvState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (MVar AppState)
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-288"></span><span>    </span><span id="local-6989586621679330463"><span class="annot"><span class="annottext">AppState
</span><a href="#local-6989586621679330463"><span class="hs-identifier hs-var">appState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO AppState -&gt; m AppState
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO AppState -&gt; m AppState) -&gt; IO AppState -&gt; m AppState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AppState -&gt; IO AppState
forall a. MVar a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">readMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330464"><span class="hs-identifier hs-var">mvState</span></a></span><span>
</span><span id="line-289"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679330461"><span class="annot"><span class="annottext">chainState :: ChainState
</span><a href="#local-6989586621679330461"><span class="hs-identifier hs-var hs-var">chainState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AppState
</span><a href="#local-6989586621679330463"><span class="hs-identifier hs-var">appState</span></a></span><span> </span><span class="annot"><span class="annottext">AppState -&gt; Getting ChainState AppState ChainState -&gt; ChainState
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">(SocketEmulatorState -&gt; Const ChainState SocketEmulatorState)
-&gt; AppState -&gt; Const ChainState AppState
Lens' AppState SocketEmulatorState
</span><a href="Cardano.Node.Socket.Emulator.Types.html#socketEmulatorState"><span class="hs-identifier hs-var">socketEmulatorState</span></a></span><span> </span><span class="annot"><span class="annottext">((SocketEmulatorState -&gt; Const ChainState SocketEmulatorState)
 -&gt; AppState -&gt; Const ChainState AppState)
-&gt; ((ChainState -&gt; Const ChainState ChainState)
    -&gt; SocketEmulatorState -&gt; Const ChainState SocketEmulatorState)
-&gt; Getting ChainState AppState ChainState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(EmulatorState -&gt; Const ChainState EmulatorState)
-&gt; SocketEmulatorState -&gt; Const ChainState SocketEmulatorState
Lens' SocketEmulatorState EmulatorState
</span><a href="Cardano.Node.Socket.Emulator.Types.html#emulatorState"><span class="hs-identifier hs-var">emulatorState</span></a></span><span> </span><span class="annot"><span class="annottext">((EmulatorState -&gt; Const ChainState EmulatorState)
 -&gt; SocketEmulatorState -&gt; Const ChainState SocketEmulatorState)
-&gt; ((ChainState -&gt; Const ChainState ChainState)
    -&gt; EmulatorState -&gt; Const ChainState EmulatorState)
-&gt; (ChainState -&gt; Const ChainState ChainState)
-&gt; SocketEmulatorState
-&gt; Const ChainState SocketEmulatorState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainState -&gt; Const ChainState ChainState)
-&gt; EmulatorState -&gt; Const ChainState EmulatorState
Lens' EmulatorState ChainState
</span><span class="hs-identifier hs-var">E.esChainState</span></span><span>
</span><span id="line-290"></span><span>        </span><span id="local-6989586621679330459"><span class="annot"><span class="annottext">blocks :: Blockchain
</span><a href="#local-6989586621679330459"><span class="hs-identifier hs-var hs-var">blocks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainState -&gt; Blockchain
</span><span class="hs-identifier hs-var hs-var">Chain._chainNewestFirst</span></span><span> </span><span class="annot"><span class="annottext">ChainState
</span><a href="#local-6989586621679330461"><span class="hs-identifier hs-var">chainState</span></a></span><span>
</span><span id="line-291"></span><span>        </span><span id="local-6989586621679330457"><span class="annot"><span class="annottext">slot :: Slot
</span><a href="#local-6989586621679330457"><span class="hs-identifier hs-var hs-var">slot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainState -&gt; Slot
</span><span class="hs-identifier hs-var hs-var">Chain._chainCurrentSlot</span></span><span> </span><span class="annot"><span class="annottext">ChainState
</span><a href="#local-6989586621679330461"><span class="hs-identifier hs-var">chainState</span></a></span><span>
</span><span id="line-292"></span><span>    </span><span id="local-6989586621679330455"><span class="annot"><span class="annottext">[Point block]
</span><a href="#local-6989586621679330455"><span class="hs-identifier hs-var">serverPoints</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Blockchain -&gt; Slot -&gt; m [Point block]
forall (m :: * -&gt; *) block.
(MonadIO m, block ~ CardanoBlock StandardCrypto) =&gt;
Blockchain -&gt; Slot -&gt; m [Point block]
</span><a href="Cardano.Node.Socket.Emulator.Server.html#getChainPoints"><span class="hs-identifier hs-var">getChainPoints</span></a></span><span> </span><span class="annot"><span class="annottext">Blockchain
</span><a href="#local-6989586621679330459"><span class="hs-identifier hs-var">blocks</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621679330457"><span class="hs-identifier hs-var">slot</span></a></span><span>
</span><span id="line-293"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679330453"><span class="annot"><span class="annottext">point :: Maybe (Point block)
</span><a href="#local-6989586621679330453"><span class="hs-identifier hs-var hs-var">point</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Point block] -&gt; Maybe (Point block)
forall a. [a] -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">listToMaybe</span></a></span><span>
</span><span id="line-294"></span><span>              </span><span class="annot"><span class="annottext">([Point block] -&gt; Maybe (Point block))
-&gt; [Point block] -&gt; Maybe (Point block)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Point block] -&gt; [Point block] -&gt; [Point block]
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">intersect</span></a></span><span> </span><span class="annot"><span class="annottext">[Point block]
</span><a href="#local-6989586621679330455"><span class="hs-identifier hs-var">serverPoints</span></a></span><span>
</span><span id="line-295"></span><span>                          </span><span class="annot"><span class="annottext">[Point block]
</span><a href="#local-6989586621679330465"><span class="hs-identifier hs-var">clientPoints</span></a></span><span>
</span><span id="line-296"></span><span>    </span><span id="local-6989586621679330452"><span class="annot"><span class="annottext">Tip
</span><a href="#local-6989586621679330452"><span class="hs-identifier hs-var">tip'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVar AppState -&gt; m Tip
forall (m :: * -&gt; *). MonadIO m =&gt; MVar AppState -&gt; m Tip
</span><a href="Cardano.Node.Socket.Emulator.Types.html#getTip"><span class="hs-identifier hs-var">getTip</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330464"><span class="hs-identifier hs-var">mvState</span></a></span><span>
</span><span id="line-297"></span><span>    </span><span class="annot"><span class="annottext">ServerStIntersect block (Point block) Tip m ()
-&gt; m (ServerStIntersect block (Point block) Tip m ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerStIntersect block (Point block) Tip m ()
 -&gt; m (ServerStIntersect block (Point block) Tip m ()))
-&gt; ServerStIntersect block (Point block) Tip m ()
-&gt; m (ServerStIntersect block (Point block) Tip m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Point block)
</span><a href="#local-6989586621679330453"><span class="hs-identifier hs-var">point</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-298"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Point block)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-299"></span><span>          </span><span class="annot"><span class="annottext">Tip
-&gt; ChainSyncServer block (Point block) Tip m ()
-&gt; ServerStIntersect block (Point block) Tip m ()
forall tip header point (m :: * -&gt; *) a.
tip
-&gt; ChainSyncServer header point tip m a
-&gt; ServerStIntersect header point tip m a
</span><span class="hs-identifier hs-var">SendMsgIntersectNotFound</span></span><span>
</span><span id="line-300"></span><span>            </span><span class="annot"><span class="annottext">Tip
forall b. Tip b
</span><span class="hs-identifier hs-var">O.TipGenesis</span></span><span>
</span><span id="line-301"></span><span>            </span><span class="hs-comment">-- No intersection found. Resume from origin.</span><span>
</span><span id="line-302"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m (ServerStIdle block (Point block) Tip m ())
-&gt; ChainSyncServer block (Point block) Tip m ()
forall header point tip (m :: * -&gt; *) a.
m (ServerStIdle header point tip m a)
-&gt; ChainSyncServer header point tip m a
</span><span class="hs-identifier hs-var">ChainSyncServer</span></span><span> </span><span class="annot"><span class="annottext">(m (ServerStIdle block (Point block) Tip m ())
 -&gt; ChainSyncServer block (Point block) Tip m ())
-&gt; m (ServerStIdle block (Point block) Tip m ())
-&gt; ChainSyncServer block (Point block) Tip m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; m LocalChannel
forall (m :: * -&gt; *).
(MonadReader (MVar AppState) m, MonadIO m) =&gt;
Integer -&gt; m LocalChannel
</span><a href="Cardano.Node.Socket.Emulator.Server.html#cloneChainFrom"><span class="hs-identifier hs-var">cloneChainFrom</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">m LocalChannel
-&gt; (LocalChannel -&gt; m (ServerStIdle block (Point block) Tip m ()))
-&gt; m (ServerStIdle block (Point block) Tip m ())
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">LocalChannel -&gt; m (ServerStIdle block (Point block) Tip m ())
forall (m :: * -&gt; *) block.
(MonadReader (MVar AppState) m, MonadIO m,
 block ~ CardanoBlock StandardCrypto) =&gt;
LocalChannel -&gt; m (ServerStIdle block (Point block) Tip m ())
</span><a href="Cardano.Node.Socket.Emulator.Server.html#idleState"><span class="hs-identifier hs-var">idleState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-303"></span><span>        </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679330447"><span class="annot"><span class="annottext">Point block
</span><a href="#local-6989586621679330447"><span class="hs-identifier hs-var">point'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-304"></span><span>          </span><span class="annot"><span class="annottext">Point block
-&gt; Tip
-&gt; ChainSyncServer block (Point block) Tip m ()
-&gt; ServerStIntersect block (Point block) Tip m ()
forall point tip header (m :: * -&gt; *) a.
point
-&gt; tip
-&gt; ChainSyncServer header point tip m a
-&gt; ServerStIntersect header point tip m a
</span><span class="hs-identifier hs-var">SendMsgIntersectFound</span></span><span>
</span><span id="line-305"></span><span>            </span><span class="annot"><span class="annottext">Point block
</span><a href="#local-6989586621679330447"><span class="hs-identifier hs-var">point'</span></a></span><span>
</span><span id="line-306"></span><span>            </span><span class="annot"><span class="annottext">Tip
</span><a href="#local-6989586621679330452"><span class="hs-identifier hs-var">tip'</span></a></span><span>
</span><span id="line-307"></span><span>            </span><span class="hs-comment">-- Resuming from point'.</span><span>
</span><span id="line-308"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m (ServerStIdle block (Point block) Tip m ())
-&gt; ChainSyncServer block (Point block) Tip m ()
forall header point tip (m :: * -&gt; *) a.
m (ServerStIdle header point tip m a)
-&gt; ChainSyncServer header point tip m a
</span><span class="hs-identifier hs-var">ChainSyncServer</span></span><span> </span><span class="annot"><span class="annottext">(m (ServerStIdle block (Point block) Tip m ())
 -&gt; ChainSyncServer block (Point block) Tip m ())
-&gt; m (ServerStIdle block (Point block) Tip m ())
-&gt; ChainSyncServer block (Point block) Tip m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; m LocalChannel
forall (m :: * -&gt; *).
(MonadReader (MVar AppState) m, MonadIO m) =&gt;
Integer -&gt; m LocalChannel
</span><a href="Cardano.Node.Socket.Emulator.Server.html#cloneChainFrom"><span class="hs-identifier hs-var">cloneChainFrom</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point block -&gt; Integer
forall block. Point block -&gt; Integer
</span><a href="Cardano.Node.Socket.Emulator.Server.html#pointOffset"><span class="hs-identifier hs-var">pointOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Point block
</span><a href="#local-6989586621679330447"><span class="hs-identifier hs-var">point'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m LocalChannel
-&gt; (LocalChannel -&gt; m (ServerStIdle block (Point block) Tip m ()))
-&gt; m (ServerStIdle block (Point block) Tip m ())
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">LocalChannel -&gt; m (ServerStIdle block (Point block) Tip m ())
forall (m :: * -&gt; *) block.
(MonadReader (MVar AppState) m, MonadIO m,
 block ~ CardanoBlock StandardCrypto) =&gt;
LocalChannel -&gt; m (ServerStIdle block (Point block) Tip m ())
</span><a href="Cardano.Node.Socket.Emulator.Server.html#idleState"><span class="hs-identifier hs-var">idleState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-309"></span><span>
</span><span id="line-310"></span><span class="hs-comment">{- This is a wrapper around the creation of a `ServerStNext` -}</span><span>
</span><span id="line-311"></span><span id="local-6989586621679330877"><span id="local-6989586621679330878"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#sendRollForward"><span class="hs-identifier hs-type">sendRollForward</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-312"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#AppState"><span class="hs-identifier hs-type">AppState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679330878"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-313"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330878"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-314"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679330877"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CardanoBlock</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">StandardCrypto</span></span><span class="hs-special">)</span><span>
</span><span id="line-315"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#LocalChannel"><span class="hs-identifier hs-type">LocalChannel</span></a></span><span>
</span><span id="line-316"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="hs-comment">-- tip</span><span>
</span><span id="line-317"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679330877"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="hs-comment">-- current</span><span>
</span><span id="line-318"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679330878"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ServerStNext</span></span><span> </span><span class="annot"><a href="#local-6989586621679330877"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679330877"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330878"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-319"></span><span id="sendRollForward"><span class="annot"><span class="annottext">sendRollForward :: LocalChannel
-&gt; Tip -&gt; block -&gt; m (ServerStNext block (Point block) Tip m ())
</span><a href="Cardano.Node.Socket.Emulator.Server.html#sendRollForward"><span class="hs-identifier hs-var hs-var">sendRollForward</span></a></span></span><span> </span><span id="local-6989586621679330444"><span class="annot"><span class="annottext">LocalChannel
</span><a href="#local-6989586621679330444"><span class="hs-identifier hs-var">channel'</span></a></span></span><span> </span><span id="local-6989586621679330443"><span class="annot"><span class="annottext">Tip
</span><a href="#local-6989586621679330443"><span class="hs-identifier hs-var">tip'</span></a></span></span><span> </span><span id="local-6989586621679330442"><span class="annot"><span class="annottext">block
</span><a href="#local-6989586621679330442"><span class="hs-identifier hs-var">current</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerStNext block (Point block) Tip m ()
-&gt; m (ServerStNext block (Point block) Tip m ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerStNext block (Point block) Tip m ()
 -&gt; m (ServerStNext block (Point block) Tip m ()))
-&gt; ServerStNext block (Point block) Tip m ()
-&gt; m (ServerStNext block (Point block) Tip m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-320"></span><span>    </span><span class="annot"><span class="annottext">block
-&gt; Tip
-&gt; ChainSyncServer block (Point block) Tip m ()
-&gt; ServerStNext block (Point block) Tip m ()
forall header tip point (m :: * -&gt; *) a.
header
-&gt; tip
-&gt; ChainSyncServer header point tip m a
-&gt; ServerStNext header point tip m a
</span><span class="hs-identifier hs-var">SendMsgRollForward</span></span><span>
</span><span id="line-321"></span><span>        </span><span class="annot"><span class="annottext">block
</span><a href="#local-6989586621679330442"><span class="hs-identifier hs-var">current</span></a></span><span>
</span><span id="line-322"></span><span>        </span><span class="annot"><span class="annottext">Tip
</span><a href="#local-6989586621679330443"><span class="hs-identifier hs-var">tip'</span></a></span><span>
</span><span id="line-323"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m (ServerStIdle block (Point block) Tip m ())
-&gt; ChainSyncServer block (Point block) Tip m ()
forall header point tip (m :: * -&gt; *) a.
m (ServerStIdle header point tip m a)
-&gt; ChainSyncServer header point tip m a
</span><span class="hs-identifier hs-var">ChainSyncServer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LocalChannel -&gt; m (ServerStIdle block (Point block) Tip m ())
forall (m :: * -&gt; *) block.
(MonadReader (MVar AppState) m, MonadIO m,
 block ~ CardanoBlock StandardCrypto) =&gt;
LocalChannel -&gt; m (ServerStIdle block (Point block) Tip m ())
</span><a href="Cardano.Node.Socket.Emulator.Server.html#idleState"><span class="hs-identifier hs-var">idleState</span></a></span><span> </span><span class="annot"><span class="annottext">LocalChannel
</span><a href="#local-6989586621679330444"><span class="hs-identifier hs-var">channel'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-324"></span><span>
</span><span id="line-325"></span><span class="hs-comment">{- This is the state for a new connection. For now we start with
   slot 0, and in idleState. This will probably change, since it
   makes more sense to start in the `StIntersect` state. -}</span><span>
</span><span id="line-328"></span><span id="local-6989586621679330690"><span id="local-6989586621679330691"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#chainSyncServer"><span class="hs-identifier hs-type">chainSyncServer</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-329"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#AppState"><span class="hs-identifier hs-type">AppState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679330691"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-330"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330691"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-331"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679330690"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CardanoBlock</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">StandardCrypto</span></span><span class="hs-special">)</span><span>
</span><span id="line-332"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ChainSyncServer</span></span><span> </span><span class="annot"><a href="#local-6989586621679330690"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679330690"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330691"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-333"></span><span id="chainSyncServer"><span class="annot"><span class="annottext">chainSyncServer :: ChainSyncServer block (Point block) Tip m ()
</span><a href="Cardano.Node.Socket.Emulator.Server.html#chainSyncServer"><span class="hs-identifier hs-var hs-var">chainSyncServer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-334"></span><span>    </span><span class="annot"><span class="annottext">m (ServerStIdle block (Point block) Tip m ())
-&gt; ChainSyncServer block (Point block) Tip m ()
forall header point tip (m :: * -&gt; *) a.
m (ServerStIdle header point tip m a)
-&gt; ChainSyncServer header point tip m a
</span><span class="hs-identifier hs-var">ChainSyncServer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; m LocalChannel
forall (m :: * -&gt; *).
(MonadReader (MVar AppState) m, MonadIO m) =&gt;
Integer -&gt; m LocalChannel
</span><a href="Cardano.Node.Socket.Emulator.Server.html#cloneChainFrom"><span class="hs-identifier hs-var">cloneChainFrom</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">m LocalChannel
-&gt; (LocalChannel -&gt; m (ServerStIdle block (Point block) Tip m ()))
-&gt; m (ServerStIdle block (Point block) Tip m ())
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">LocalChannel -&gt; m (ServerStIdle block (Point block) Tip m ())
forall (m :: * -&gt; *) block.
(MonadReader (MVar AppState) m, MonadIO m,
 block ~ CardanoBlock StandardCrypto) =&gt;
LocalChannel -&gt; m (ServerStIdle block (Point block) Tip m ())
</span><a href="Cardano.Node.Socket.Emulator.Server.html#idleState"><span class="hs-identifier hs-var">idleState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-335"></span><span>
</span><span id="line-336"></span><span class="hs-comment">{- Use a `TChan` to model a broadcast channel of which we
   clone (with potentially varying offsets) for clients. -}</span><span>
</span><span id="line-338"></span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#cloneChainFrom"><span class="hs-identifier hs-type">cloneChainFrom</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679330849"><span class="annot"><a href="#local-6989586621679330849"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-339"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#AppState"><span class="hs-identifier hs-type">AppState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679330849"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-340"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330849"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-341"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-identifier hs-type">Integer</span></a></span><span>
</span><span id="line-342"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679330849"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#LocalChannel"><span class="hs-identifier hs-type">LocalChannel</span></a></span><span>
</span><span id="line-343"></span><span id="cloneChainFrom"><span class="annot"><span class="annottext">cloneChainFrom :: Integer -&gt; m LocalChannel
</span><a href="Cardano.Node.Socket.Emulator.Server.html#cloneChainFrom"><span class="hs-identifier hs-var hs-var">cloneChainFrom</span></a></span></span><span> </span><span id="local-6989586621679330439"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679330439"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TChan Block -&gt; LocalChannel
</span><a href="Cardano.Node.Socket.Emulator.Server.html#LocalChannel"><span class="hs-identifier hs-var">LocalChannel</span></a></span><span> </span><span class="annot"><span class="annottext">(TChan Block -&gt; LocalChannel) -&gt; m (TChan Block) -&gt; m LocalChannel
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">m (TChan Block)
</span><a href="#local-6989586621679330438"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-344"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-345"></span><span>    </span><span class="annot"><a href="#local-6989586621679330438"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679330849"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TChan</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Block</span></span><span class="hs-special">)</span><span>
</span><span id="line-346"></span><span>    </span><span id="local-6989586621679330438"><span class="annot"><span class="annottext">go :: m (TChan Block)
</span><a href="#local-6989586621679330438"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-347"></span><span>        </span><span id="local-6989586621679330437"><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621679330437"><span class="hs-identifier hs-var">globalChannel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (MVar AppState)
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span> </span><span class="annot"><span class="annottext">m (MVar AppState)
-&gt; (MVar AppState -&gt; m (TChan Block)) -&gt; m (TChan Block)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AppState -&gt; m (TChan Block)
forall (m :: * -&gt; *). MonadIO m =&gt; MVar AppState -&gt; m (TChan Block)
</span><a href="Cardano.Node.Socket.Emulator.Types.html#getChannel"><span class="hs-identifier hs-var">getChannel</span></a></span><span>
</span><span id="line-348"></span><span>        </span><span class="annot"><span class="annottext">IO (TChan Block) -&gt; m (TChan Block)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (TChan Block) -&gt; m (TChan Block))
-&gt; IO (TChan Block) -&gt; m (TChan Block)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">STM (TChan Block) -&gt; IO (TChan Block)
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM (TChan Block) -&gt; IO (TChan Block))
-&gt; STM (TChan Block) -&gt; IO (TChan Block)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-349"></span><span>            </span><span id="local-6989586621679330436"><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621679330436"><span class="hs-identifier hs-var">localChannel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TChan Block -&gt; STM (TChan Block)
forall a. TChan a -&gt; STM (TChan a)
</span><span class="hs-identifier hs-var">cloneTChan</span></span><span> </span><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621679330437"><span class="hs-identifier hs-var">globalChannel</span></a></span><span>
</span><span id="line-350"></span><span>            </span><span class="annot"><span class="annottext">TChan Block -&gt; Integer -&gt; STM (TChan Block)
forall a. TChan a -&gt; Integer -&gt; STM (TChan a)
</span><a href="#local-6989586621679330435"><span class="hs-identifier hs-var">consume</span></a></span><span> </span><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621679330436"><span class="hs-identifier hs-var">localChannel</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679330439"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-351"></span><span>
</span><span id="line-352"></span><span>    </span><span id="local-6989586621679330835"><span class="annot"><a href="#local-6989586621679330435"><span class="hs-identifier hs-type">consume</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TChan</span></span><span> </span><span class="annot"><a href="#local-6989586621679330835"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-identifier hs-type">Integer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TChan</span></span><span> </span><span class="annot"><a href="#local-6989586621679330835"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-353"></span><span>    </span><span id="local-6989586621679330435"><span class="annot"><span class="annottext">consume :: TChan a -&gt; Integer -&gt; STM (TChan a)
</span><a href="#local-6989586621679330435"><span class="hs-identifier hs-var hs-var">consume</span></a></span></span><span> </span><span id="local-6989586621679330434"><span class="annot"><span class="annottext">TChan a
</span><a href="#local-6989586621679330434"><span class="hs-identifier hs-var">channel'</span></a></span></span><span> </span><span id="local-6989586621679330433"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679330433"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679330433"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TChan a -&gt; STM (TChan a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">TChan a
</span><a href="#local-6989586621679330434"><span class="hs-identifier hs-var">channel'</span></a></span><span>
</span><span id="line-354"></span><span>    </span><span class="annot"><a href="#local-6989586621679330435"><span class="hs-identifier hs-var">consume</span></a></span><span> </span><span id="local-6989586621679330432"><span class="annot"><span class="annottext">TChan a
</span><a href="#local-6989586621679330432"><span class="hs-identifier hs-var">channel'</span></a></span></span><span> </span><span id="local-6989586621679330431"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679330431"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-355"></span><span>        </span><span class="hs-comment">-- We should have all requested blocks available on the</span><span>
</span><span id="line-356"></span><span>        </span><span class="hs-comment">-- channel, for consumption.</span><span>
</span><span id="line-357"></span><span>        </span><span class="annot"><span class="annottext">TChan a -&gt; STM (Maybe a)
forall a. TChan a -&gt; STM (Maybe a)
</span><span class="hs-identifier hs-var">tryReadTChan</span></span><span> </span><span class="annot"><span class="annottext">TChan a
</span><a href="#local-6989586621679330432"><span class="hs-identifier hs-var">channel'</span></a></span><span> </span><span class="annot"><span class="annottext">STM (Maybe a) -&gt; STM (TChan a) -&gt; STM (TChan a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TChan a -&gt; Integer -&gt; STM (TChan a)
forall a. TChan a -&gt; Integer -&gt; STM (TChan a)
</span><a href="#local-6989586621679330435"><span class="hs-identifier hs-var">consume</span></a></span><span> </span><span class="annot"><span class="annottext">TChan a
</span><a href="#local-6989586621679330432"><span class="hs-identifier hs-var">channel'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679330431"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span>
</span><span id="line-359"></span><span class="hs-comment">-- * Protocol setup</span><span>
</span><span id="line-360"></span><span>
</span><span id="line-361"></span><span class="hs-comment">{- The node protocols always run in the IO monad. I wanted to use a
   different monad stack (mainly to be able to pass the internal state
   in a `MonadReader` and future proofing) so I wrote some hoisting
   functions for each of the states which transform the `ChainSyncMonad`
   into IO. -}</span><span>
</span><span id="line-366"></span><span>
</span><span id="line-367"></span><span id="local-6989586621679330804"><span id="local-6989586621679330805"><span id="local-6989586621679330806"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#hoistChainSync"><span class="hs-identifier hs-type">hoistChainSync</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-368"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#AppState"><span class="hs-identifier hs-type">AppState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679330806"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-369"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ChainSyncServer</span></span><span> </span><span class="annot"><a href="#local-6989586621679330805"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679330805"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#ChainSyncMonad"><span class="hs-identifier hs-type">ChainSyncMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330804"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-370"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679330806"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ChainSyncServer</span></span><span> </span><span class="annot"><a href="#local-6989586621679330805"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679330805"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330804"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-371"></span><span id="hoistChainSync"><span class="annot"><span class="annottext">hoistChainSync :: ChainSyncServer block (Point block) Tip ChainSyncMonad a
-&gt; m (ChainSyncServer block (Point block) Tip IO a)
</span><a href="Cardano.Node.Socket.Emulator.Server.html#hoistChainSync"><span class="hs-identifier hs-var hs-var">hoistChainSync</span></a></span></span><span> </span><span id="local-6989586621679330429"><span class="annot"><span class="annottext">ChainSyncServer block (Point block) Tip ChainSyncMonad a
</span><a href="#local-6989586621679330429"><span class="hs-identifier hs-var">machine</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-372"></span><span>    </span><span id="local-6989586621679330428"><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330428"><span class="hs-identifier hs-var">internalState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (MVar AppState)
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-373"></span><span>    </span><span class="annot"><span class="annottext">ChainSyncServer block (Point block) Tip IO a
-&gt; m (ChainSyncServer block (Point block) Tip IO a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncServer :: forall header point tip (m :: * -&gt; *) a.
m (ServerStIdle header point tip m a)
-&gt; ChainSyncServer header point tip m a
</span><span class="hs-identifier hs-type">ChainSyncServer</span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-374"></span><span>        </span><span class="hs-comment">{- The basic idea is running the reader monad to remove it,
           leaving only IO, which is what we need. We do the same for all
           other states. -}</span><span>
</span><span id="line-377"></span><span>        </span><span class="annot"><span class="annottext">runChainSyncServer :: IO (ServerStIdle block (Point block) Tip IO a)
</span><span class="hs-identifier hs-var">runChainSyncServer</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MVar AppState
-&gt; ChainSyncMonad (ServerStIdle block (Point block) Tip IO a)
-&gt; IO (ServerStIdle block (Point block) Tip IO a)
forall a. MVar AppState -&gt; ChainSyncMonad a -&gt; IO a
</span><a href="Cardano.Node.Socket.Emulator.Server.html#runChainSync"><span class="hs-identifier hs-var">runChainSync</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330428"><span class="hs-identifier hs-var">internalState</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainSyncMonad (ServerStIdle block (Point block) Tip IO a)
 -&gt; IO (ServerStIdle block (Point block) Tip IO a))
-&gt; ChainSyncMonad (ServerStIdle block (Point block) Tip IO a)
-&gt; IO (ServerStIdle block (Point block) Tip IO a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-378"></span><span>            </span><span class="annot"><span class="annottext">ChainSyncServer block (Point block) Tip ChainSyncMonad a
-&gt; ChainSyncMonad
     (ServerStIdle block (Point block) Tip ChainSyncMonad a)
forall header point tip (m :: * -&gt; *) a.
ChainSyncServer header point tip m a
-&gt; m (ServerStIdle header point tip m a)
</span><span class="hs-identifier hs-var hs-var">runChainSyncServer</span></span><span> </span><span class="annot"><span class="annottext">ChainSyncServer block (Point block) Tip ChainSyncMonad a
</span><a href="#local-6989586621679330429"><span class="hs-identifier hs-var">machine</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncMonad
  (ServerStIdle block (Point block) Tip ChainSyncMonad a)
-&gt; (ServerStIdle block (Point block) Tip ChainSyncMonad a
    -&gt; ChainSyncMonad (ServerStIdle block (Point block) Tip IO a))
-&gt; ChainSyncMonad (ServerStIdle block (Point block) Tip IO a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">ServerStIdle block (Point block) Tip ChainSyncMonad a
-&gt; ChainSyncMonad (ServerStIdle block (Point block) Tip IO a)
forall (m :: * -&gt; *) block a.
MonadReader (MVar AppState) m =&gt;
ServerStIdle block (Point block) Tip ChainSyncMonad a
-&gt; m (ServerStIdle block (Point block) Tip IO a)
</span><a href="Cardano.Node.Socket.Emulator.Server.html#hoistStIdle"><span class="hs-identifier hs-var">hoistStIdle</span></a></span><span>
</span><span id="line-379"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-380"></span><span>
</span><span id="line-381"></span><span id="local-6989586621679330822"><span id="local-6989586621679330823"><span id="local-6989586621679330824"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#hoistStIdle"><span class="hs-identifier hs-type">hoistStIdle</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-382"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#AppState"><span class="hs-identifier hs-type">AppState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679330824"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-383"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ServerStIdle</span></span><span> </span><span class="annot"><a href="#local-6989586621679330823"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679330823"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#ChainSyncMonad"><span class="hs-identifier hs-type">ChainSyncMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330822"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-384"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679330824"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ServerStIdle</span></span><span> </span><span class="annot"><a href="#local-6989586621679330823"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679330823"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330822"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-385"></span><span id="hoistStIdle"><span class="annot"><span class="annottext">hoistStIdle :: ServerStIdle block (Point block) Tip ChainSyncMonad a
-&gt; m (ServerStIdle block (Point block) Tip IO a)
</span><a href="Cardano.Node.Socket.Emulator.Server.html#hoistStIdle"><span class="hs-identifier hs-var hs-var">hoistStIdle</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ServerStIdle</span></span><span> </span><span id="local-6989586621679330425"><span class="annot"><span class="annottext">ChainSyncMonad
  (Either
     (ServerStNext block (Point block) Tip ChainSyncMonad a)
     (ChainSyncMonad
        (ServerStNext block (Point block) Tip ChainSyncMonad a)))
</span><a href="#local-6989586621679330425"><span class="hs-identifier hs-var">nextState'</span></a></span></span><span> </span><span id="local-6989586621679330424"><span class="annot"><span class="annottext">[Point block]
-&gt; ChainSyncMonad
     (ServerStIntersect block (Point block) Tip ChainSyncMonad a)
</span><a href="#local-6989586621679330424"><span class="hs-identifier hs-var">findIntersect'</span></a></span></span><span> </span><span id="local-6989586621679330423"><span class="annot"><span class="annottext">ChainSyncMonad a
</span><a href="#local-6989586621679330423"><span class="hs-identifier hs-var">done</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-386"></span><span>    </span><span id="local-6989586621679330422"><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330422"><span class="hs-identifier hs-var">internalState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (MVar AppState)
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-387"></span><span>    </span><span class="annot"><span class="annottext">ServerStIdle block (Point block) Tip IO a
-&gt; m (ServerStIdle block (Point block) Tip IO a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">ServerStIdle :: forall header point tip (m :: * -&gt; *) a.
m (Either
     (ServerStNext header point tip m a)
     (m (ServerStNext header point tip m a)))
-&gt; ([point] -&gt; m (ServerStIntersect header point tip m a))
-&gt; m a
-&gt; ServerStIdle header point tip m a
</span><span class="hs-identifier hs-type">ServerStIdle</span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-388"></span><span>        </span><span class="annot"><span class="annottext">recvMsgRequestNext :: IO
  (Either
     (ServerStNext block (Point block) Tip IO a)
     (IO (ServerStNext block (Point block) Tip IO a)))
</span><span class="hs-identifier hs-var">recvMsgRequestNext</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-389"></span><span>            </span><span class="annot"><span class="annottext">MVar AppState
-&gt; ChainSyncMonad
     (Either
        (ServerStNext block (Point block) Tip IO a)
        (IO (ServerStNext block (Point block) Tip IO a)))
-&gt; IO
     (Either
        (ServerStNext block (Point block) Tip IO a)
        (IO (ServerStNext block (Point block) Tip IO a)))
forall a. MVar AppState -&gt; ChainSyncMonad a -&gt; IO a
</span><a href="Cardano.Node.Socket.Emulator.Server.html#runChainSync"><span class="hs-identifier hs-var">runChainSync</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330422"><span class="hs-identifier hs-var">internalState</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainSyncMonad
   (Either
      (ServerStNext block (Point block) Tip IO a)
      (IO (ServerStNext block (Point block) Tip IO a)))
 -&gt; IO
      (Either
         (ServerStNext block (Point block) Tip IO a)
         (IO (ServerStNext block (Point block) Tip IO a))))
-&gt; ChainSyncMonad
     (Either
        (ServerStNext block (Point block) Tip IO a)
        (IO (ServerStNext block (Point block) Tip IO a)))
-&gt; IO
     (Either
        (ServerStNext block (Point block) Tip IO a)
        (IO (ServerStNext block (Point block) Tip IO a)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-390"></span><span>                </span><span class="annot"><span class="annottext">ChainSyncMonad
  (Either
     (ServerStNext block (Point block) Tip ChainSyncMonad a)
     (ChainSyncMonad
        (ServerStNext block (Point block) Tip ChainSyncMonad a)))
</span><a href="#local-6989586621679330425"><span class="hs-identifier hs-var">nextState'</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncMonad
  (Either
     (ServerStNext block (Point block) Tip ChainSyncMonad a)
     (ChainSyncMonad
        (ServerStNext block (Point block) Tip ChainSyncMonad a)))
-&gt; (Either
      (ServerStNext block (Point block) Tip ChainSyncMonad a)
      (ChainSyncMonad
         (ServerStNext block (Point block) Tip ChainSyncMonad a))
    -&gt; ChainSyncMonad
         (Either
            (ServerStNext block (Point block) Tip IO a)
            (IO (ServerStNext block (Point block) Tip IO a))))
-&gt; ChainSyncMonad
     (Either
        (ServerStNext block (Point block) Tip IO a)
        (IO (ServerStNext block (Point block) Tip IO a)))
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-391"></span><span>                    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679330421"><span class="annot"><span class="annottext">ServerStNext block (Point block) Tip ChainSyncMonad a
</span><a href="#local-6989586621679330421"><span class="hs-identifier hs-var">stNext</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ServerStNext block (Point block) Tip IO a
-&gt; Either
     (ServerStNext block (Point block) Tip IO a)
     (IO (ServerStNext block (Point block) Tip IO a))
forall a b. a -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span>         </span><span class="annot"><span class="annottext">(ServerStNext block (Point block) Tip IO a
 -&gt; Either
      (ServerStNext block (Point block) Tip IO a)
      (IO (ServerStNext block (Point block) Tip IO a)))
-&gt; ReaderT
     (MVar AppState) IO (ServerStNext block (Point block) Tip IO a)
-&gt; ChainSyncMonad
     (Either
        (ServerStNext block (Point block) Tip IO a)
        (IO (ServerStNext block (Point block) Tip IO a)))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>  </span><span class="annot"><span class="annottext">ServerStNext block (Point block) Tip ChainSyncMonad a
-&gt; ReaderT
     (MVar AppState) IO (ServerStNext block (Point block) Tip IO a)
forall (m :: * -&gt; *) block a.
MonadReader (MVar AppState) m =&gt;
ServerStNext block (Point block) Tip ChainSyncMonad a
-&gt; m (ServerStNext block (Point block) Tip IO a)
</span><a href="Cardano.Node.Socket.Emulator.Server.html#hoistStNext"><span class="hs-identifier hs-var">hoistStNext</span></a></span><span>     </span><span class="annot"><span class="annottext">ServerStNext block (Point block) Tip ChainSyncMonad a
</span><a href="#local-6989586621679330421"><span class="hs-identifier hs-var">stNext</span></a></span><span>
</span><span id="line-392"></span><span>                    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679330419"><span class="annot"><span class="annottext">ChainSyncMonad
  (ServerStNext block (Point block) Tip ChainSyncMonad a)
</span><a href="#local-6989586621679330419"><span class="hs-identifier hs-var">mNext</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO (ServerStNext block (Point block) Tip IO a)
-&gt; Either
     (ServerStNext block (Point block) Tip IO a)
     (IO (ServerStNext block (Point block) Tip IO a))
forall a b. b -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (ServerStNext block (Point block) Tip IO a)
 -&gt; Either
      (ServerStNext block (Point block) Tip IO a)
      (IO (ServerStNext block (Point block) Tip IO a)))
-&gt; (ServerStNext block (Point block) Tip IO a
    -&gt; IO (ServerStNext block (Point block) Tip IO a))
-&gt; ServerStNext block (Point block) Tip IO a
-&gt; Either
     (ServerStNext block (Point block) Tip IO a)
     (IO (ServerStNext block (Point block) Tip IO a))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ServerStNext block (Point block) Tip IO a
-&gt; IO (ServerStNext block (Point block) Tip IO a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerStNext block (Point block) Tip IO a
 -&gt; Either
      (ServerStNext block (Point block) Tip IO a)
      (IO (ServerStNext block (Point block) Tip IO a)))
-&gt; ReaderT
     (MVar AppState) IO (ServerStNext block (Point block) Tip IO a)
-&gt; ChainSyncMonad
     (Either
        (ServerStNext block (Point block) Tip IO a)
        (IO (ServerStNext block (Point block) Tip IO a)))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerStNext block (Point block) Tip ChainSyncMonad a
-&gt; ReaderT
     (MVar AppState) IO (ServerStNext block (Point block) Tip IO a)
forall (m :: * -&gt; *) block a.
MonadReader (MVar AppState) m =&gt;
ServerStNext block (Point block) Tip ChainSyncMonad a
-&gt; m (ServerStNext block (Point block) Tip IO a)
</span><a href="Cardano.Node.Socket.Emulator.Server.html#hoistStNext"><span class="hs-identifier hs-var">hoistStNext</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerStNext block (Point block) Tip ChainSyncMonad a
 -&gt; ReaderT
      (MVar AppState) IO (ServerStNext block (Point block) Tip IO a))
-&gt; ChainSyncMonad
     (ServerStNext block (Point block) Tip ChainSyncMonad a)
-&gt; ReaderT
     (MVar AppState) IO (ServerStNext block (Point block) Tip IO a)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">=&lt;&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncMonad
  (ServerStNext block (Point block) Tip ChainSyncMonad a)
</span><a href="#local-6989586621679330419"><span class="hs-identifier hs-var">mNext</span></a></span><span> </span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-393"></span><span>        </span><span class="annot"><span class="annottext">recvMsgFindIntersect :: [Point block]
-&gt; IO (ServerStIntersect block (Point block) Tip IO a)
</span><span class="hs-identifier hs-var">recvMsgFindIntersect</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679330417"><span class="annot"><span class="annottext">[Point block]
</span><a href="#local-6989586621679330417"><span class="hs-identifier hs-var">points</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-394"></span><span>            </span><span class="annot"><span class="annottext">MVar AppState
-&gt; ChainSyncMonad (ServerStIntersect block (Point block) Tip IO a)
-&gt; IO (ServerStIntersect block (Point block) Tip IO a)
forall a. MVar AppState -&gt; ChainSyncMonad a -&gt; IO a
</span><a href="Cardano.Node.Socket.Emulator.Server.html#runChainSync"><span class="hs-identifier hs-var">runChainSync</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330422"><span class="hs-identifier hs-var">internalState</span></a></span><span>
</span><span id="line-395"></span><span>                         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Point block]
-&gt; ChainSyncMonad
     (ServerStIntersect block (Point block) Tip ChainSyncMonad a)
</span><a href="#local-6989586621679330424"><span class="hs-identifier hs-var">findIntersect'</span></a></span><span> </span><span class="annot"><span class="annottext">[Point block]
</span><a href="#local-6989586621679330417"><span class="hs-identifier hs-var">points</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncMonad
  (ServerStIntersect block (Point block) Tip ChainSyncMonad a)
-&gt; (ServerStIntersect block (Point block) Tip ChainSyncMonad a
    -&gt; ChainSyncMonad (ServerStIntersect block (Point block) Tip IO a))
-&gt; ChainSyncMonad (ServerStIntersect block (Point block) Tip IO a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">ServerStIntersect block (Point block) Tip ChainSyncMonad a
-&gt; ChainSyncMonad (ServerStIntersect block (Point block) Tip IO a)
forall (m :: * -&gt; *) block a.
MonadReader (MVar AppState) m =&gt;
ServerStIntersect block (Point block) Tip ChainSyncMonad a
-&gt; m (ServerStIntersect block (Point block) Tip IO a)
</span><a href="Cardano.Node.Socket.Emulator.Server.html#hoistStIntersect"><span class="hs-identifier hs-var">hoistStIntersect</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-396"></span><span>        </span><span class="annot"><span class="annottext">recvMsgDoneClient :: IO a
</span><span class="hs-identifier hs-var">recvMsgDoneClient</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MVar AppState -&gt; ChainSyncMonad a -&gt; IO a
forall a. MVar AppState -&gt; ChainSyncMonad a -&gt; IO a
</span><a href="Cardano.Node.Socket.Emulator.Server.html#runChainSync"><span class="hs-identifier hs-var">runChainSync</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330422"><span class="hs-identifier hs-var">internalState</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncMonad a
</span><a href="#local-6989586621679330423"><span class="hs-identifier hs-var">done</span></a></span><span>
</span><span id="line-397"></span><span>   </span><span class="hs-special">}</span><span>
</span><span id="line-398"></span><span>
</span><span id="line-399"></span><span id="local-6989586621679330810"><span id="local-6989586621679330811"><span id="local-6989586621679330812"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#hoistStIntersect"><span class="hs-identifier hs-type">hoistStIntersect</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-400"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#AppState"><span class="hs-identifier hs-type">AppState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679330812"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-401"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ServerStIntersect</span></span><span> </span><span class="annot"><a href="#local-6989586621679330811"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679330811"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#ChainSyncMonad"><span class="hs-identifier hs-type">ChainSyncMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330810"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-402"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679330812"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ServerStIntersect</span></span><span> </span><span class="annot"><a href="#local-6989586621679330811"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679330811"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330810"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-403"></span><span id="hoistStIntersect"><span class="annot"><span class="annottext">hoistStIntersect :: ServerStIntersect block (Point block) Tip ChainSyncMonad a
-&gt; m (ServerStIntersect block (Point block) Tip IO a)
</span><a href="Cardano.Node.Socket.Emulator.Server.html#hoistStIntersect"><span class="hs-identifier hs-var hs-var">hoistStIntersect</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SendMsgIntersectFound</span></span><span> </span><span id="local-6989586621679330415"><span class="annot"><span class="annottext">Point block
</span><a href="#local-6989586621679330415"><span class="hs-identifier hs-var">point</span></a></span></span><span> </span><span id="local-6989586621679330414"><span class="annot"><span class="annottext">Tip
</span><a href="#local-6989586621679330414"><span class="hs-identifier hs-var">tip'</span></a></span></span><span> </span><span id="local-6989586621679330413"><span class="annot"><span class="annottext">ChainSyncServer block (Point block) Tip ChainSyncMonad a
</span><a href="#local-6989586621679330413"><span class="hs-identifier hs-var">nextState'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-404"></span><span>    </span><span class="annot"><span class="annottext">Point block
-&gt; Tip
-&gt; ChainSyncServer block (Point block) Tip IO a
-&gt; ServerStIntersect block (Point block) Tip IO a
forall point tip header (m :: * -&gt; *) a.
point
-&gt; tip
-&gt; ChainSyncServer header point tip m a
-&gt; ServerStIntersect header point tip m a
</span><span class="hs-identifier hs-var">SendMsgIntersectFound</span></span><span> </span><span class="annot"><span class="annottext">Point block
</span><a href="#local-6989586621679330415"><span class="hs-identifier hs-var">point</span></a></span><span> </span><span class="annot"><span class="annottext">Tip
</span><a href="#local-6989586621679330414"><span class="hs-identifier hs-var">tip'</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainSyncServer block (Point block) Tip IO a
 -&gt; ServerStIntersect block (Point block) Tip IO a)
-&gt; m (ChainSyncServer block (Point block) Tip IO a)
-&gt; m (ServerStIntersect block (Point block) Tip IO a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncServer block (Point block) Tip ChainSyncMonad a
-&gt; m (ChainSyncServer block (Point block) Tip IO a)
forall (m :: * -&gt; *) block a.
MonadReader (MVar AppState) m =&gt;
ChainSyncServer block (Point block) Tip ChainSyncMonad a
-&gt; m (ChainSyncServer block (Point block) Tip IO a)
</span><a href="Cardano.Node.Socket.Emulator.Server.html#hoistChainSync"><span class="hs-identifier hs-var">hoistChainSync</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncServer block (Point block) Tip ChainSyncMonad a
</span><a href="#local-6989586621679330413"><span class="hs-identifier hs-var">nextState'</span></a></span><span>
</span><span id="line-405"></span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#hoistStIntersect"><span class="hs-identifier hs-var">hoistStIntersect</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SendMsgIntersectNotFound</span></span><span> </span><span id="local-6989586621679330412"><span class="annot"><span class="annottext">Tip
</span><a href="#local-6989586621679330412"><span class="hs-identifier hs-var">tip'</span></a></span></span><span> </span><span id="local-6989586621679330411"><span class="annot"><span class="annottext">ChainSyncServer block (Point block) Tip ChainSyncMonad a
</span><a href="#local-6989586621679330411"><span class="hs-identifier hs-var">nextState'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-406"></span><span>    </span><span class="annot"><span class="annottext">Tip
-&gt; ChainSyncServer block (Point block) Tip IO a
-&gt; ServerStIntersect block (Point block) Tip IO a
forall tip header point (m :: * -&gt; *) a.
tip
-&gt; ChainSyncServer header point tip m a
-&gt; ServerStIntersect header point tip m a
</span><span class="hs-identifier hs-var">SendMsgIntersectNotFound</span></span><span> </span><span class="annot"><span class="annottext">Tip
</span><a href="#local-6989586621679330412"><span class="hs-identifier hs-var">tip'</span></a></span><span>    </span><span class="annot"><span class="annottext">(ChainSyncServer block (Point block) Tip IO a
 -&gt; ServerStIntersect block (Point block) Tip IO a)
-&gt; m (ChainSyncServer block (Point block) Tip IO a)
-&gt; m (ServerStIntersect block (Point block) Tip IO a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncServer block (Point block) Tip ChainSyncMonad a
-&gt; m (ChainSyncServer block (Point block) Tip IO a)
forall (m :: * -&gt; *) block a.
MonadReader (MVar AppState) m =&gt;
ChainSyncServer block (Point block) Tip ChainSyncMonad a
-&gt; m (ChainSyncServer block (Point block) Tip IO a)
</span><a href="Cardano.Node.Socket.Emulator.Server.html#hoistChainSync"><span class="hs-identifier hs-var">hoistChainSync</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncServer block (Point block) Tip ChainSyncMonad a
</span><a href="#local-6989586621679330411"><span class="hs-identifier hs-var">nextState'</span></a></span><span>
</span><span id="line-407"></span><span>
</span><span id="line-408"></span><span id="local-6989586621679330816"><span id="local-6989586621679330817"><span id="local-6989586621679330818"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#hoistStNext"><span class="hs-identifier hs-type">hoistStNext</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-409"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#AppState"><span class="hs-identifier hs-type">AppState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679330818"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-410"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ServerStNext</span></span><span> </span><span class="annot"><a href="#local-6989586621679330817"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679330817"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#ChainSyncMonad"><span class="hs-identifier hs-type">ChainSyncMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330816"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-411"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679330818"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ServerStNext</span></span><span> </span><span class="annot"><a href="#local-6989586621679330817"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679330817"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330816"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-412"></span><span id="hoistStNext"><span class="annot"><span class="annottext">hoistStNext :: ServerStNext block (Point block) Tip ChainSyncMonad a
-&gt; m (ServerStNext block (Point block) Tip IO a)
</span><a href="Cardano.Node.Socket.Emulator.Server.html#hoistStNext"><span class="hs-identifier hs-var hs-var">hoistStNext</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SendMsgRollForward</span></span><span> </span><span id="local-6989586621679330410"><span class="annot"><span class="annottext">block
</span><a href="#local-6989586621679330410"><span class="hs-identifier hs-var">header</span></a></span></span><span> </span><span id="local-6989586621679330409"><span class="annot"><span class="annottext">Tip
</span><a href="#local-6989586621679330409"><span class="hs-identifier hs-var">tip'</span></a></span></span><span> </span><span id="local-6989586621679330408"><span class="annot"><span class="annottext">ChainSyncServer block (Point block) Tip ChainSyncMonad a
</span><a href="#local-6989586621679330408"><span class="hs-identifier hs-var">nextState'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-413"></span><span>    </span><span class="annot"><span class="annottext">block
-&gt; Tip
-&gt; ChainSyncServer block (Point block) Tip IO a
-&gt; ServerStNext block (Point block) Tip IO a
forall header tip point (m :: * -&gt; *) a.
header
-&gt; tip
-&gt; ChainSyncServer header point tip m a
-&gt; ServerStNext header point tip m a
</span><span class="hs-identifier hs-var">SendMsgRollForward</span></span><span> </span><span class="annot"><span class="annottext">block
</span><a href="#local-6989586621679330410"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">Tip
</span><a href="#local-6989586621679330409"><span class="hs-identifier hs-var">tip'</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainSyncServer block (Point block) Tip IO a
 -&gt; ServerStNext block (Point block) Tip IO a)
-&gt; m (ChainSyncServer block (Point block) Tip IO a)
-&gt; m (ServerStNext block (Point block) Tip IO a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncServer block (Point block) Tip ChainSyncMonad a
-&gt; m (ChainSyncServer block (Point block) Tip IO a)
forall (m :: * -&gt; *) block a.
MonadReader (MVar AppState) m =&gt;
ChainSyncServer block (Point block) Tip ChainSyncMonad a
-&gt; m (ChainSyncServer block (Point block) Tip IO a)
</span><a href="Cardano.Node.Socket.Emulator.Server.html#hoistChainSync"><span class="hs-identifier hs-var">hoistChainSync</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncServer block (Point block) Tip ChainSyncMonad a
</span><a href="#local-6989586621679330408"><span class="hs-identifier hs-var">nextState'</span></a></span><span>
</span><span id="line-414"></span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#hoistStNext"><span class="hs-identifier hs-var">hoistStNext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SendMsgRollBackward</span></span><span> </span><span id="local-6989586621679330406"><span class="annot"><span class="annottext">Point block
</span><a href="#local-6989586621679330406"><span class="hs-identifier hs-var">header</span></a></span></span><span> </span><span id="local-6989586621679330405"><span class="annot"><span class="annottext">Tip
</span><a href="#local-6989586621679330405"><span class="hs-identifier hs-var">tip'</span></a></span></span><span> </span><span id="local-6989586621679330404"><span class="annot"><span class="annottext">ChainSyncServer block (Point block) Tip ChainSyncMonad a
</span><a href="#local-6989586621679330404"><span class="hs-identifier hs-var">nextState'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-415"></span><span>    </span><span class="annot"><span class="annottext">Point block
-&gt; Tip
-&gt; ChainSyncServer block (Point block) Tip IO a
-&gt; ServerStNext block (Point block) Tip IO a
forall point tip header (m :: * -&gt; *) a.
point
-&gt; tip
-&gt; ChainSyncServer header point tip m a
-&gt; ServerStNext header point tip m a
</span><span class="hs-identifier hs-var">SendMsgRollBackward</span></span><span> </span><span class="annot"><span class="annottext">Point block
</span><a href="#local-6989586621679330406"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">Tip
</span><a href="#local-6989586621679330405"><span class="hs-identifier hs-var">tip'</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainSyncServer block (Point block) Tip IO a
 -&gt; ServerStNext block (Point block) Tip IO a)
-&gt; m (ChainSyncServer block (Point block) Tip IO a)
-&gt; m (ServerStNext block (Point block) Tip IO a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncServer block (Point block) Tip ChainSyncMonad a
-&gt; m (ChainSyncServer block (Point block) Tip IO a)
forall (m :: * -&gt; *) block a.
MonadReader (MVar AppState) m =&gt;
ChainSyncServer block (Point block) Tip ChainSyncMonad a
-&gt; m (ChainSyncServer block (Point block) Tip IO a)
</span><a href="Cardano.Node.Socket.Emulator.Server.html#hoistChainSync"><span class="hs-identifier hs-var">hoistChainSync</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncServer block (Point block) Tip ChainSyncMonad a
</span><a href="#local-6989586621679330404"><span class="hs-identifier hs-var">nextState'</span></a></span><span>
</span><span id="line-416"></span><span>
</span><span id="line-417"></span><span class="hs-comment">{- This is boilerplate code that sets up the node protocols,
   you can find in:
     ouroboros-network/ouroboros-network/demo/chain-sync.hs -}</span><span>
</span><span id="line-420"></span><span>
</span><span id="line-421"></span><span id="local-6989586621679330925"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#protocolLoop"><span class="hs-identifier hs-type">protocolLoop</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-422"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330925"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-423"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-424"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#AppState"><span class="hs-identifier hs-type">AppState</span></a></span><span>
</span><span id="line-425"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679330925"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Void</span></a></span></span><span>
</span><span id="line-426"></span><span id="protocolLoop"><span class="annot"><span class="annottext">protocolLoop :: FilePath -&gt; MVar AppState -&gt; m Void
</span><a href="Cardano.Node.Socket.Emulator.Server.html#protocolLoop"><span class="hs-identifier hs-var hs-var">protocolLoop</span></a></span></span><span> </span><span id="local-6989586621679330403"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679330403"><span class="hs-identifier hs-var">socketPath</span></a></span></span><span> </span><span id="local-6989586621679330402"><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330402"><span class="hs-identifier hs-var">internalState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO Void -&gt; m Void
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO Void -&gt; m Void) -&gt; IO Void -&gt; m Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(IOManager -&gt; IO Void) -&gt; IO Void
WithIOManager
</span><span class="hs-identifier hs-var">withIOManager</span></span><span> </span><span class="annot"><span class="annottext">((IOManager -&gt; IO Void) -&gt; IO Void)
-&gt; (IOManager -&gt; IO Void) -&gt; IO Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679330400"><span class="annot"><span class="annottext">IOManager
</span><a href="#local-6989586621679330400"><span class="hs-identifier hs-var">iocp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-427"></span><span>    </span><span id="local-6989586621679330399"><span class="annot"><span class="annottext">NetworkMutableState LocalAddress
</span><a href="#local-6989586621679330399"><span class="hs-identifier hs-var">networkState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (NetworkMutableState LocalAddress)
forall addr. IO (NetworkMutableState addr)
</span><span class="hs-identifier hs-var">newNetworkMutableState</span></span><span>
</span><span id="line-428"></span><span>    </span><span class="annot"><span class="annottext">Async ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO (Async ())
forall a. IO a -&gt; IO (Async a)
</span><span class="hs-identifier hs-var">async</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO (Async ())) -&gt; IO () -&gt; IO (Async ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">NetworkMutableState LocalAddress -&gt; IO ()
forall addr. NetworkMutableState addr -&gt; IO ()
</span><span class="hs-identifier hs-var">cleanNetworkMutableState</span></span><span> </span><span class="annot"><span class="annottext">NetworkMutableState LocalAddress
</span><a href="#local-6989586621679330399"><span class="hs-identifier hs-var">networkState</span></a></span><span>
</span><span id="line-429"></span><span>    </span><span class="annot"><span class="annottext">Snocket IO LocalSocket LocalAddress
-&gt; NetworkServerTracers LocalAddress NodeToClientVersion
-&gt; NetworkMutableState LocalAddress
-&gt; AcceptedConnectionsLimit
-&gt; LocalAddress
-&gt; Codec
     (Handshake NodeToClientVersion Term)
     DeserialiseFailure
     IO
     ByteString
-&gt; ProtocolTimeLimits (Handshake NodeToClientVersion Term)
-&gt; VersionDataCodec
     Term NodeToClientVersion NodeToClientVersionData
-&gt; (NodeToClientVersionData
    -&gt; NodeToClientVersionData -&gt; Accept NodeToClientVersionData)
-&gt; Versions
     NodeToClientVersion
     NodeToClientVersionData
     (SomeResponderApplication LocalAddress ByteString IO ())
-&gt; ErrorPolicies
-&gt; (LocalAddress -&gt; Async Void -&gt; IO Void)
-&gt; IO Void
forall vNumber vData t fd addr b.
(Ord vNumber, Typeable vNumber, Show vNumber, Ord addr) =&gt;
Snocket IO fd addr
-&gt; NetworkServerTracers addr vNumber
-&gt; NetworkMutableState addr
-&gt; AcceptedConnectionsLimit
-&gt; addr
-&gt; Codec (Handshake vNumber Term) DeserialiseFailure IO ByteString
-&gt; ProtocolTimeLimits (Handshake vNumber Term)
-&gt; VersionDataCodec Term vNumber vData
-&gt; (vData -&gt; vData -&gt; Accept vData)
-&gt; Versions
     vNumber vData (SomeResponderApplication addr ByteString IO b)
-&gt; ErrorPolicies
-&gt; (addr -&gt; Async Void -&gt; IO t)
-&gt; IO t
</span><span class="hs-identifier hs-var">withServerNode</span></span><span>
</span><span id="line-430"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IOManager -&gt; Snocket IO LocalSocket LocalAddress
</span><span class="hs-identifier hs-var">localSnocket</span></span><span> </span><span class="annot"><span class="annottext">IOManager
</span><a href="#local-6989586621679330400"><span class="hs-identifier hs-var">iocp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-431"></span><span>      </span><span class="annot"><span class="annottext">NetworkServerTracers LocalAddress NodeToClientVersion
forall addr vNumber. NetworkServerTracers addr vNumber
</span><span class="hs-identifier hs-var">nullNetworkServerTracers</span></span><span>
</span><span id="line-432"></span><span>      </span><span class="annot"><span class="annottext">NetworkMutableState LocalAddress
</span><a href="#local-6989586621679330399"><span class="hs-identifier hs-var">networkState</span></a></span><span>
</span><span id="line-433"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; DiffTime -&gt; AcceptedConnectionsLimit
</span><span class="hs-identifier hs-var">AcceptedConnectionsLimit</span></span><span> </span><span class="annot"><span class="annottext">Word32
forall a. Bounded a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">maxBound</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
forall a. Bounded a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">maxBound</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-434"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; LocalAddress
</span><span class="hs-identifier hs-var">localAddressFromPath</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679330403"><span class="hs-identifier hs-var">socketPath</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-435"></span><span>      </span><span class="annot"><span class="annottext">Codec
  (Handshake NodeToClientVersion Term)
  DeserialiseFailure
  IO
  ByteString
forall (m :: * -&gt; *).
MonadST m =&gt;
Codec
  (Handshake NodeToClientVersion Term)
  DeserialiseFailure
  m
  ByteString
</span><span class="hs-identifier hs-var">nodeToClientHandshakeCodec</span></span><span>
</span><span id="line-436"></span><span>      </span><span class="annot"><span class="annottext">ProtocolTimeLimits (Handshake NodeToClientVersion Term)
forall k (vNumber :: k).
ProtocolTimeLimits (Handshake vNumber Term)
</span><span class="hs-identifier hs-var">noTimeLimitsHandshake</span></span><span>
</span><span id="line-437"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(NodeToClientVersion -&gt; CodecCBORTerm Text NodeToClientVersionData)
-&gt; VersionDataCodec
     Term NodeToClientVersion NodeToClientVersionData
forall vNumber vData.
(vNumber -&gt; CodecCBORTerm Text vData)
-&gt; VersionDataCodec Term vNumber vData
</span><span class="hs-identifier hs-var">cborTermVersionDataCodec</span></span><span> </span><span class="annot"><span class="annottext">NodeToClientVersion -&gt; CodecCBORTerm Text NodeToClientVersionData
</span><span class="hs-identifier hs-var">nodeToClientCodecCBORTerm</span></span><span class="hs-special">)</span><span>
</span><span id="line-438"></span><span>      </span><span class="annot"><span class="annottext">NodeToClientVersionData
-&gt; NodeToClientVersionData -&gt; Accept NodeToClientVersionData
forall v. Acceptable v =&gt; v -&gt; v -&gt; Accept v
</span><span class="hs-identifier hs-var">acceptableVersion</span></span><span>
</span><span id="line-439"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OuroborosApplication
  'ResponderMode LocalAddress ByteString IO Void ()
-&gt; SomeResponderApplication LocalAddress ByteString IO ()
forall (appType :: MuxMode) addr bytes (m :: * -&gt; *) a b.
(HasResponder appType ~ 'True) =&gt;
OuroborosApplication appType addr bytes m a b
-&gt; SomeResponderApplication addr bytes m b
</span><span class="hs-identifier hs-var">SomeResponderApplication</span></span><span> </span><span class="annot"><span class="annottext">(OuroborosApplication
   'ResponderMode LocalAddress ByteString IO Void ()
 -&gt; SomeResponderApplication LocalAddress ByteString IO ())
-&gt; Versions
     NodeToClientVersion
     NodeToClientVersionData
     (OuroborosApplication
        'ResponderMode LocalAddress ByteString IO Void ())
-&gt; Versions
     NodeToClientVersion
     NodeToClientVersionData
     (SomeResponderApplication LocalAddress ByteString IO ())
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-440"></span><span>        </span><span class="annot"><span class="annottext">NodeToClientVersion
-&gt; NodeToClientVersionData
-&gt; (ConnectionId LocalAddress
    -&gt; STM IO ControlMessage
    -&gt; NodeToClientProtocols 'ResponderMode ByteString IO Void ())
-&gt; Versions
     NodeToClientVersion
     NodeToClientVersionData
     (OuroborosApplication
        'ResponderMode LocalAddress ByteString IO Void ())
forall (m :: * -&gt; *) (appType :: MuxMode) bytes a b.
NodeToClientVersion
-&gt; NodeToClientVersionData
-&gt; (ConnectionId LocalAddress
    -&gt; STM m ControlMessage
    -&gt; NodeToClientProtocols appType bytes m a b)
-&gt; Versions
     NodeToClientVersion
     NodeToClientVersionData
     (OuroborosApplication appType LocalAddress bytes m a b)
</span><span class="hs-identifier hs-var">versionedNodeToClientProtocols</span></span><span>
</span><span id="line-441"></span><span>          </span><span class="annot"><span class="annottext">NodeToClientVersion
</span><a href="Cardano.Node.Socket.Emulator.Types.html#nodeToClientVersion"><span class="hs-identifier hs-var">nodeToClientVersion</span></a></span><span>
</span><span id="line-442"></span><span>          </span><span class="annot"><span class="annottext">NodeToClientVersionData
</span><a href="Cardano.Node.Socket.Emulator.Types.html#nodeToClientVersionData"><span class="hs-identifier hs-var">nodeToClientVersionData</span></a></span><span>
</span><span id="line-443"></span><span>          </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">ConnectionId LocalAddress
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">STM IO ControlMessage
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MVar AppState
-&gt; NodeToClientProtocols 'ResponderMode ByteString IO Void ()
</span><a href="Cardano.Node.Socket.Emulator.Server.html#nodeToClientProtocols"><span class="hs-identifier hs-var">nodeToClientProtocols</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330402"><span class="hs-identifier hs-var">internalState</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-444"></span><span>      </span><span class="annot"><span class="annottext">ErrorPolicies
</span><span class="hs-identifier hs-var">nullErrorPolicies</span></span><span>
</span><span id="line-445"></span><span>      </span><span class="annot"><span class="annottext">((LocalAddress -&gt; Async Void -&gt; IO Void) -&gt; IO Void)
-&gt; (LocalAddress -&gt; Async Void -&gt; IO Void) -&gt; IO Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">LocalAddress
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679330384"><span class="annot"><span class="annottext">Async Void
</span><a href="#local-6989586621679330384"><span class="hs-identifier hs-var">serverAsync</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Async Void -&gt; IO Void
forall a. Async a -&gt; IO a
</span><span class="hs-identifier hs-var">wait</span></span><span> </span><span class="annot"><span class="annottext">Async Void
</span><a href="#local-6989586621679330384"><span class="hs-identifier hs-var">serverAsync</span></a></span><span>
</span><span id="line-446"></span><span>
</span><span id="line-447"></span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#nodeToClientProtocols"><span class="hs-identifier hs-type">nodeToClientProtocols</span></a></span><span>
</span><span id="line-448"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#AppState"><span class="hs-identifier hs-type">AppState</span></a></span><span>
</span><span id="line-449"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToClientProtocols</span></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">ResponderMode</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">LBS.ByteString</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Void</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-450"></span><span id="nodeToClientProtocols"><span class="annot"><span class="annottext">nodeToClientProtocols :: MVar AppState
-&gt; NodeToClientProtocols 'ResponderMode ByteString IO Void ()
</span><a href="Cardano.Node.Socket.Emulator.Server.html#nodeToClientProtocols"><span class="hs-identifier hs-var hs-var">nodeToClientProtocols</span></a></span></span><span> </span><span id="local-6989586621679330382"><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330382"><span class="hs-identifier hs-var">internalState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-451"></span><span>  </span><span class="annot"><span class="annottext">NodeToClientProtocols :: forall (appType :: MuxMode) bytes (m :: * -&gt; *) a b.
RunMiniProtocol appType bytes m a b
-&gt; RunMiniProtocol appType bytes m a b
-&gt; RunMiniProtocol appType bytes m a b
-&gt; RunMiniProtocol appType bytes m a b
-&gt; NodeToClientProtocols appType bytes m a b
</span><span class="hs-identifier hs-type">NodeToClientProtocols</span></span><span>
</span><span id="line-452"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">localChainSyncProtocol :: RunMiniProtocol 'ResponderMode ByteString IO Void ()
</span><span class="hs-identifier hs-var">localChainSyncProtocol</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MVar AppState
-&gt; RunMiniProtocol 'ResponderMode ByteString IO Void ()
</span><a href="Cardano.Node.Socket.Emulator.Server.html#chainSync"><span class="hs-identifier hs-var">chainSync</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330382"><span class="hs-identifier hs-var">internalState</span></a></span><span>
</span><span id="line-453"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">localTxSubmissionProtocol :: RunMiniProtocol 'ResponderMode ByteString IO Void ()
</span><span class="hs-identifier hs-var">localTxSubmissionProtocol</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MVar AppState
-&gt; RunMiniProtocol 'ResponderMode ByteString IO Void ()
</span><a href="Cardano.Node.Socket.Emulator.Server.html#txSubmission"><span class="hs-identifier hs-var">txSubmission</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330382"><span class="hs-identifier hs-var">internalState</span></a></span><span>
</span><span id="line-454"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">localStateQueryProtocol :: RunMiniProtocol 'ResponderMode ByteString IO Void ()
</span><span class="hs-identifier hs-var">localStateQueryProtocol</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RunMiniProtocol 'ResponderMode ByteString IO Void ()
forall (m :: * -&gt; *) a.
MonadTimer m =&gt;
RunMiniProtocol 'ResponderMode ByteString m Void a
</span><a href="Cardano.Node.Socket.Emulator.Types.html#doNothingResponderProtocol"><span class="hs-identifier hs-var">doNothingResponderProtocol</span></a></span><span>
</span><span id="line-455"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">localTxMonitorProtocol :: RunMiniProtocol 'ResponderMode ByteString IO Void ()
</span><span class="hs-identifier hs-var">localTxMonitorProtocol</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RunMiniProtocol 'ResponderMode ByteString IO Void ()
forall (m :: * -&gt; *) a.
MonadTimer m =&gt;
RunMiniProtocol 'ResponderMode ByteString m Void a
</span><a href="Cardano.Node.Socket.Emulator.Types.html#doNothingResponderProtocol"><span class="hs-identifier hs-var">doNothingResponderProtocol</span></a></span><span>
</span><span id="line-456"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-457"></span><span>
</span><span id="line-458"></span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#chainSync"><span class="hs-identifier hs-type">chainSync</span></a></span><span>
</span><span id="line-459"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#AppState"><span class="hs-identifier hs-type">AppState</span></a></span><span>
</span><span id="line-460"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">RunMiniProtocol</span></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">ResponderMode</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">LBS.ByteString</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Void</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-461"></span><span id="chainSync"><span class="annot"><span class="annottext">chainSync :: MVar AppState
-&gt; RunMiniProtocol 'ResponderMode ByteString IO Void ()
</span><a href="Cardano.Node.Socket.Emulator.Server.html#chainSync"><span class="hs-identifier hs-var hs-var">chainSync</span></a></span></span><span> </span><span id="local-6989586621679330374"><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330374"><span class="hs-identifier hs-var">mvChainState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-462"></span><span>     </span><span class="annot"><span class="annottext">MuxPeer ByteString IO ()
-&gt; RunMiniProtocol 'ResponderMode ByteString IO Void ()
forall bytes (m :: * -&gt; *) b.
MuxPeer bytes m b -&gt; RunMiniProtocol 'ResponderMode bytes m Void b
</span><span class="hs-identifier hs-var">ResponderProtocolOnly</span></span><span> </span><span class="annot"><span class="annottext">(MuxPeer ByteString IO ()
 -&gt; RunMiniProtocol 'ResponderMode ByteString IO Void ())
-&gt; MuxPeer ByteString IO ()
-&gt; RunMiniProtocol 'ResponderMode ByteString IO Void ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-463"></span><span>     </span><span class="annot"><span class="annottext">Tracer
  IO
  (TraceSendRecv
     (ChainSync
        (CardanoBlock StandardCrypto)
        (Point (CardanoBlock StandardCrypto))
        Tip))
-&gt; Codec
     (ChainSync
        (CardanoBlock StandardCrypto)
        (Point (CardanoBlock StandardCrypto))
        Tip)
     DeserialiseFailure
     IO
     ByteString
-&gt; Peer
     (ChainSync
        (CardanoBlock StandardCrypto)
        (Point (CardanoBlock StandardCrypto))
        Tip)
     'AsServer
     'StIdle
     IO
     ()
-&gt; MuxPeer ByteString IO ()
forall (pr :: PeerRole) ps (st :: ps) failure bytes (m :: * -&gt; *)
       a.
(Show failure, forall (st' :: ps). Show (ClientHasAgency st'),
 forall (st' :: ps). Show (ServerHasAgency st'), ShowProxy ps) =&gt;
Tracer m (TraceSendRecv ps)
-&gt; Codec ps failure m bytes
-&gt; Peer ps pr st m a
-&gt; MuxPeer bytes m a
</span><span class="hs-identifier hs-var">MuxPeer</span></span><span>
</span><span id="line-464"></span><span>       </span><span class="annot"><span class="annottext">Tracer
  IO
  (TraceSendRecv
     (ChainSync
        (CardanoBlock StandardCrypto)
        (Point (CardanoBlock StandardCrypto))
        Tip))
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-465"></span><span>       </span><span class="annot"><span class="annottext">Codec
  (ChainSync
     (CardanoBlock StandardCrypto)
     (Point (CardanoBlock StandardCrypto))
     Tip)
  DeserialiseFailure
  IO
  ByteString
forall block.
(block ~ CardanoBlock StandardCrypto) =&gt;
Codec
  (ChainSync block (Point block) Tip)
  DeserialiseFailure
  IO
  ByteString
</span><a href="Cardano.Node.Socket.Emulator.Types.html#chainSyncCodec"><span class="hs-identifier hs-var">chainSyncCodec</span></a></span><span>
</span><span id="line-466"></span><span>       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainSyncServer
  (CardanoBlock StandardCrypto)
  (Point (CardanoBlock StandardCrypto))
  Tip
  IO
  ()
-&gt; Peer
     (ChainSync
        (CardanoBlock StandardCrypto)
        (Point (CardanoBlock StandardCrypto))
        Tip)
     'AsServer
     'StIdle
     IO
     ()
forall header point tip (m :: * -&gt; *) a.
Monad m =&gt;
ChainSyncServer header point tip m a
-&gt; Peer (ChainSync header point tip) 'AsServer 'StIdle m a
</span><span class="hs-identifier hs-var">ChainSync.chainSyncServerPeer</span></span><span>
</span><span id="line-467"></span><span>           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reader
  (MVar AppState)
  (ChainSyncServer
     (CardanoBlock StandardCrypto)
     (Point (CardanoBlock StandardCrypto))
     Tip
     IO
     ())
-&gt; MVar AppState
-&gt; ChainSyncServer
     (CardanoBlock StandardCrypto)
     (Point (CardanoBlock StandardCrypto))
     Tip
     IO
     ()
forall r a. Reader r a -&gt; r -&gt; a
</span><span class="hs-identifier hs-var">runReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainSyncServer
  (CardanoBlock StandardCrypto)
  (Point (CardanoBlock StandardCrypto))
  Tip
  ChainSyncMonad
  ()
-&gt; Reader
     (MVar AppState)
     (ChainSyncServer
        (CardanoBlock StandardCrypto)
        (Point (CardanoBlock StandardCrypto))
        Tip
        IO
        ())
forall (m :: * -&gt; *) block a.
MonadReader (MVar AppState) m =&gt;
ChainSyncServer block (Point block) Tip ChainSyncMonad a
-&gt; m (ChainSyncServer block (Point block) Tip IO a)
</span><a href="Cardano.Node.Socket.Emulator.Server.html#hoistChainSync"><span class="hs-identifier hs-var">hoistChainSync</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncServer
  (CardanoBlock StandardCrypto)
  (Point (CardanoBlock StandardCrypto))
  Tip
  ChainSyncMonad
  ()
forall (m :: * -&gt; *) block.
(MonadReader (MVar AppState) m, MonadIO m,
 block ~ CardanoBlock StandardCrypto) =&gt;
ChainSyncServer block (Point block) Tip m ()
</span><a href="Cardano.Node.Socket.Emulator.Server.html#chainSyncServer"><span class="hs-identifier hs-var">chainSyncServer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-468"></span><span>                      </span><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330374"><span class="hs-identifier hs-var">mvChainState</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-469"></span><span>
</span><span id="line-470"></span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#txSubmission"><span class="hs-identifier hs-type">txSubmission</span></a></span><span>
</span><span id="line-471"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#AppState"><span class="hs-identifier hs-type">AppState</span></a></span><span>
</span><span id="line-472"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">RunMiniProtocol</span></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">ResponderMode</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">LBS.ByteString</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Void</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-473"></span><span id="txSubmission"><span class="annot"><span class="annottext">txSubmission :: MVar AppState
-&gt; RunMiniProtocol 'ResponderMode ByteString IO Void ()
</span><a href="Cardano.Node.Socket.Emulator.Server.html#txSubmission"><span class="hs-identifier hs-var hs-var">txSubmission</span></a></span></span><span> </span><span id="local-6989586621679330368"><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330368"><span class="hs-identifier hs-var">mvChainState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-474"></span><span>    </span><span class="annot"><span class="annottext">MuxPeer ByteString IO ()
-&gt; RunMiniProtocol 'ResponderMode ByteString IO Void ()
forall bytes (m :: * -&gt; *) b.
MuxPeer bytes m b -&gt; RunMiniProtocol 'ResponderMode bytes m Void b
</span><span class="hs-identifier hs-var">ResponderProtocolOnly</span></span><span> </span><span class="annot"><span class="annottext">(MuxPeer ByteString IO ()
 -&gt; RunMiniProtocol 'ResponderMode ByteString IO Void ())
-&gt; MuxPeer ByteString IO ()
-&gt; RunMiniProtocol 'ResponderMode ByteString IO Void ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-475"></span><span>    </span><span class="annot"><span class="annottext">Tracer
  IO
  (TraceSendRecv
     (LocalTxSubmission
        (GenTx (CardanoBlock StandardCrypto))
        (HardForkApplyTxErr
           (ByronBlock : CardanoShelleyEras StandardCrypto))))
-&gt; Codec
     (LocalTxSubmission
        (GenTx (CardanoBlock StandardCrypto))
        (HardForkApplyTxErr
           (ByronBlock : CardanoShelleyEras StandardCrypto)))
     DeserialiseFailure
     IO
     ByteString
-&gt; Peer
     (LocalTxSubmission
        (GenTx (CardanoBlock StandardCrypto))
        (HardForkApplyTxErr
           (ByronBlock : CardanoShelleyEras StandardCrypto)))
     'AsServer
     'StIdle
     IO
     ()
-&gt; MuxPeer ByteString IO ()
forall (pr :: PeerRole) ps (st :: ps) failure bytes (m :: * -&gt; *)
       a.
(Show failure, forall (st' :: ps). Show (ClientHasAgency st'),
 forall (st' :: ps). Show (ServerHasAgency st'), ShowProxy ps) =&gt;
Tracer m (TraceSendRecv ps)
-&gt; Codec ps failure m bytes
-&gt; Peer ps pr st m a
-&gt; MuxPeer bytes m a
</span><span class="hs-identifier hs-var">MuxPeer</span></span><span>
</span><span id="line-476"></span><span>      </span><span class="annot"><span class="annottext">Tracer
  IO
  (TraceSendRecv
     (LocalTxSubmission
        (GenTx (CardanoBlock StandardCrypto))
        (HardForkApplyTxErr
           (ByronBlock : CardanoShelleyEras StandardCrypto))))
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-477"></span><span>      </span><span class="annot"><span class="annottext">Codec
  (LocalTxSubmission
     (GenTx (CardanoBlock StandardCrypto))
     (HardForkApplyTxErr
        (ByronBlock : CardanoShelleyEras StandardCrypto)))
  DeserialiseFailure
  IO
  ByteString
forall block.
(block ~ CardanoBlock StandardCrypto) =&gt;
Codec
  (LocalTxSubmission (GenTx block) (ApplyTxErr block))
  DeserialiseFailure
  IO
  ByteString
</span><a href="Cardano.Node.Socket.Emulator.Types.html#txSubmissionCodec"><span class="hs-identifier hs-var">txSubmissionCodec</span></a></span><span>
</span><span id="line-478"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO
  (LocalTxSubmissionServer
     (GenTx (CardanoBlock StandardCrypto))
     (HardForkApplyTxErr
        (ByronBlock : CardanoShelleyEras StandardCrypto))
     IO
     ())
-&gt; Peer
     (LocalTxSubmission
        (GenTx (CardanoBlock StandardCrypto))
        (HardForkApplyTxErr
           (ByronBlock : CardanoShelleyEras StandardCrypto)))
     'AsServer
     'StIdle
     IO
     ()
forall tx reject (m :: * -&gt; *) a.
Monad m =&gt;
m (LocalTxSubmissionServer tx reject m a)
-&gt; Peer (LocalTxSubmission tx reject) 'AsServer 'StIdle m a
</span><span class="hs-identifier hs-var">TxSubmission.localTxSubmissionServerPeer</span></span><span>
</span><span id="line-479"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LocalTxSubmissionServer
  (GenTx (CardanoBlock StandardCrypto))
  (HardForkApplyTxErr
     (ByronBlock : CardanoShelleyEras StandardCrypto))
  IO
  ()
-&gt; IO
     (LocalTxSubmissionServer
        (GenTx (CardanoBlock StandardCrypto))
        (HardForkApplyTxErr
           (ByronBlock : CardanoShelleyEras StandardCrypto))
        IO
        ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(LocalTxSubmissionServer
   (GenTx (CardanoBlock StandardCrypto))
   (HardForkApplyTxErr
      (ByronBlock : CardanoShelleyEras StandardCrypto))
   IO
   ()
 -&gt; IO
      (LocalTxSubmissionServer
         (GenTx (CardanoBlock StandardCrypto))
         (HardForkApplyTxErr
            (ByronBlock : CardanoShelleyEras StandardCrypto))
         IO
         ()))
-&gt; LocalTxSubmissionServer
     (GenTx (CardanoBlock StandardCrypto))
     (HardForkApplyTxErr
        (ByronBlock : CardanoShelleyEras StandardCrypto))
     IO
     ()
-&gt; IO
     (LocalTxSubmissionServer
        (GenTx (CardanoBlock StandardCrypto))
        (HardForkApplyTxErr
           (ByronBlock : CardanoShelleyEras StandardCrypto))
        IO
        ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AppState
-&gt; LocalTxSubmissionServer
     (GenTx (CardanoBlock StandardCrypto))
     (ApplyTxErr (CardanoBlock StandardCrypto))
     IO
     ()
forall block.
(block ~ CardanoBlock StandardCrypto) =&gt;
MVar AppState
-&gt; LocalTxSubmissionServer (GenTx block) (ApplyTxErr block) IO ()
</span><a href="Cardano.Node.Socket.Emulator.Server.html#txSubmissionServer"><span class="hs-identifier hs-var">txSubmissionServer</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330368"><span class="hs-identifier hs-var">mvChainState</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-480"></span><span>
</span><span id="line-481"></span><span class="hs-comment">-- * Computing intersections</span><span>
</span><span id="line-482"></span><span>
</span><span id="line-483"></span><span class="hs-comment">-- Given a `Point` find its offset into the chain.</span><span>
</span><span id="line-484"></span><span id="local-6989586621679330846"><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#pointOffset"><span class="hs-identifier hs-type">pointOffset</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679330846"><span class="hs-identifier hs-type">block</span></a></span><span>
</span><span id="line-485"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-identifier hs-type">Integer</span></a></span></span><span>
</span><span id="line-486"></span><span id="pointOffset"><span class="annot"><span class="annottext">pointOffset :: Point block -&gt; Integer
</span><a href="Cardano.Node.Socket.Emulator.Server.html#pointOffset"><span class="hs-identifier hs-var hs-var">pointOffset</span></a></span></span><span> </span><span id="local-6989586621679330365"><span class="annot"><span class="annottext">Point block
</span><a href="#local-6989586621679330365"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-487"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Point block -&gt; WithOrigin SlotNo
forall block. Point block -&gt; WithOrigin SlotNo
</span><span class="hs-identifier hs-var">pointSlot</span></span><span> </span><span class="annot"><span class="annottext">Point block
</span><a href="#local-6989586621679330365"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-488"></span><span>    </span><span class="annot"><span class="annottext">WithOrigin SlotNo
</span><span class="hs-identifier hs-var">Origin</span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span>
</span><span id="line-489"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">At</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span id="local-6989586621679330361"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679330361"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Integer
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679330361"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-490"></span><span>
</span><span id="line-491"></span><span class="hs-comment">-- Currently selects all points from the blockchain.</span><span>
</span><span id="line-492"></span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#getChainPoints"><span class="hs-identifier hs-type">getChainPoints</span></a></span><span>
</span><span id="line-493"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679330866"><span class="annot"><a href="#local-6989586621679330866"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679330865"><span class="annot"><a href="#local-6989586621679330865"><span class="hs-identifier hs-type">block</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679330866"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679330865"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CardanoBlock</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">StandardCrypto</span></span><span class="hs-special">)</span><span>
</span><span id="line-494"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Block</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Slot</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679330866"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679330865"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-495"></span><span id="getChainPoints"><span class="annot"><span class="annottext">getChainPoints :: Blockchain -&gt; Slot -&gt; m [Point block]
</span><a href="Cardano.Node.Socket.Emulator.Server.html#getChainPoints"><span class="hs-identifier hs-var hs-var">getChainPoints</span></a></span></span><span> </span><span id="local-6989586621679330360"><span class="annot"><span class="annottext">Blockchain
</span><a href="#local-6989586621679330360"><span class="hs-identifier hs-var">chain</span></a></span></span><span> </span><span id="local-6989586621679330359"><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621679330359"><span class="hs-identifier hs-var">slot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-496"></span><span>  </span><span class="annot"><span class="annottext">[Point block] -&gt; m [Point block]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">([Point block] -&gt; m [Point block])
-&gt; [Point block] -&gt; m [Point block]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Slot -&gt; Block -&gt; Point block)
-&gt; [Slot] -&gt; Blockchain -&gt; [Point block]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">zipWith</span></a></span><span> </span><span class="annot"><span class="annottext">Slot -&gt; Block -&gt; Point block
</span><a href="#local-6989586621679330357"><span class="hs-identifier hs-var">mkPoint</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621679330359"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621679330359"><span class="hs-identifier hs-var">slot</span></a></span><span> </span><span class="annot"><span class="annottext">Slot -&gt; Slot -&gt; Slot
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Slot
</span><span class="hs-number">0</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Blockchain
</span><a href="#local-6989586621679330360"><span class="hs-identifier hs-var">chain</span></a></span><span>
</span><span id="line-497"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-498"></span><span>    </span><span class="annot"><a href="#local-6989586621679330357"><span class="hs-identifier hs-type">mkPoint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Slot</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Block</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679330865"><span class="hs-identifier hs-type">block</span></a></span><span>
</span><span id="line-499"></span><span>    </span><span id="local-6989586621679330357"><span class="annot"><span class="annottext">mkPoint :: Slot -&gt; Block -&gt; Point block
</span><a href="#local-6989586621679330357"><span class="hs-identifier hs-var hs-var">mkPoint</span></a></span></span><span> </span><span id="local-6989586621679330356"><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621679330356"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679330355"><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621679330355"><span class="hs-identifier hs-var">block</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-500"></span><span>      </span><span class="annot"><span class="annottext">WithOrigin (Block SlotNo (HeaderHash block)) -&gt; Point block
forall block.
WithOrigin (Block SlotNo (HeaderHash block)) -&gt; Point block
</span><span class="hs-identifier hs-var">Point</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Block
  SlotNo
  (OneEraHash (ByronBlock : CardanoShelleyEras StandardCrypto))
-&gt; WithOrigin
     (Block
        SlotNo
        (OneEraHash (ByronBlock : CardanoShelleyEras StandardCrypto)))
forall t. t -&gt; WithOrigin t
</span><span class="hs-identifier hs-var">At</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
-&gt; OneEraHash (ByronBlock : CardanoShelleyEras StandardCrypto)
-&gt; Block
     SlotNo
     (OneEraHash (ByronBlock : CardanoShelleyEras StandardCrypto))
forall slot hash. slot -&gt; hash -&gt; Block slot hash
</span><span class="hs-identifier hs-var">OP.Block</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Slot -&gt; SlotNo
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621679330356"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-501"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockId
-&gt; OneEraHash (ByronBlock : CardanoShelleyEras StandardCrypto)
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">coerce</span></a></span><span> </span><span class="annot"><span class="annottext">(BlockId
 -&gt; OneEraHash (ByronBlock : CardanoShelleyEras StandardCrypto))
-&gt; BlockId
-&gt; OneEraHash (ByronBlock : CardanoShelleyEras StandardCrypto)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Block -&gt; BlockId
</span><a href="Cardano.Node.Socket.Emulator.Types.html#blockId"><span class="hs-identifier hs-var">blockId</span></a></span><span> </span><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621679330355"><span class="hs-identifier hs-var">block</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-502"></span><span>
</span><span id="line-503"></span><span class="hs-comment">-- * TxSubmission protocol</span><span>
</span><span id="line-504"></span><span>
</span><span id="line-505"></span><span class="hs-comment">{- I did not use the same approach for this protocol as I did
   for the `ChainSync`. This protocol has only one state and
   it is much simpler. -}</span><span>
</span><span id="line-508"></span><span>
</span><span id="line-509"></span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Server.html#txSubmissionServer"><span class="hs-identifier hs-type">txSubmissionServer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679330676"><span class="annot"><a href="#local-6989586621679330676"><span class="hs-identifier hs-type">block</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679330676"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CardanoBlock</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">StandardCrypto</span></span><span class="hs-special">)</span><span>
</span><span id="line-510"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Socket.Emulator.Types.html#AppState"><span class="hs-identifier hs-type">AppState</span></a></span><span>
</span><span id="line-511"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TxSubmission.LocalTxSubmissionServer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Shelley.GenTx</span></span><span> </span><span class="annot"><a href="#local-6989586621679330676"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ApplyTxErr</span></span><span> </span><span class="annot"><a href="#local-6989586621679330676"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-512"></span><span id="txSubmissionServer"><span class="annot"><span class="annottext">txSubmissionServer :: MVar AppState
-&gt; LocalTxSubmissionServer (GenTx block) (ApplyTxErr block) IO ()
</span><a href="Cardano.Node.Socket.Emulator.Server.html#txSubmissionServer"><span class="hs-identifier hs-var hs-var">txSubmissionServer</span></a></span></span><span> </span><span id="local-6989586621679330352"><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330352"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LocalTxSubmissionServer (GenTx block) (ApplyTxErr block) IO ()
</span><a href="#local-6989586621679330351"><span class="hs-identifier hs-var">txSubmissionState</span></a></span><span>
</span><span id="line-513"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-514"></span><span>      </span><span class="annot"><a href="#local-6989586621679330351"><span class="hs-identifier hs-type">txSubmissionState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TxSubmission.LocalTxSubmissionServer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Shelley.GenTx</span></span><span> </span><span class="annot"><a href="#local-6989586621679330676"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ApplyTxErr</span></span><span> </span><span class="annot"><a href="#local-6989586621679330676"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-515"></span><span>      </span><span id="local-6989586621679330351"><span class="annot"><span class="annottext">txSubmissionState :: LocalTxSubmissionServer (GenTx block) (ApplyTxErr block) IO ()
</span><a href="#local-6989586621679330351"><span class="hs-identifier hs-var hs-var">txSubmissionState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-516"></span><span>        </span><span class="annot"><span class="annottext">LocalTxSubmissionServer :: forall tx reject (m :: * -&gt; *) a.
(tx
 -&gt; m (SubmitResult reject, LocalTxSubmissionServer tx reject m a))
-&gt; a -&gt; LocalTxSubmissionServer tx reject m a
</span><span class="hs-identifier hs-type">TxSubmission.LocalTxSubmissionServer</span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-517"></span><span>          </span><span class="annot"><span class="annottext">recvMsgSubmitTx :: GenTx block
-&gt; IO
     (SubmitResult
        (HardForkApplyTxErr
           (ByronBlock : CardanoShelleyEras StandardCrypto)),
      LocalTxSubmissionServer
        (GenTx block)
        (HardForkApplyTxErr
           (ByronBlock : CardanoShelleyEras StandardCrypto))
        IO
        ())
</span><span class="hs-identifier hs-var">TxSubmission.recvMsgSubmitTx</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-518"></span><span>            </span><span class="hs-glyph">\</span><span id="local-6989586621679330348"><span class="annot"><span class="annottext">GenTx block
</span><a href="#local-6989586621679330348"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-519"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">GenTx block
</span><a href="#local-6989586621679330348"><span class="hs-identifier hs-var">tx</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-520"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Consensus.HardForkGenTx</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Consensus.OneEraGenTx</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Z</span></span><span> </span><span id="local-6989586621679330345"><span class="annot"><a href="#local-6989586621679330345"><span class="hs-identifier hs-var">tx'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-521"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Consensus.ShelleyTx</span></span><span> </span><span id="local-6989586621679330343"><span class="annot"><a href="#local-6989586621679330343"><span class="hs-identifier hs-var">_txid</span></a></span></span><span> </span><span id="local-6989586621679330342"><span class="annot"><a href="#local-6989586621679330342"><span class="hs-identifier hs-var">shelleyEraTx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GenTx x
GenTx
  (ShelleyBlock (Praos StandardCrypto) (BabbageEra StandardCrypto))
</span><a href="#local-6989586621679330345"><span class="hs-identifier hs-var">tx'</span></a></span><span>
</span><span id="line-522"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679330341"><span class="annot"><span class="annottext">ctx :: CardanoTx
</span><a href="#local-6989586621679330341"><span class="hs-identifier hs-var hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tx BabbageEra -&gt; CardanoTx
</span><span class="hs-identifier hs-var">CardanoEmulatorEraTx</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ShelleyBasedEra BabbageEra
-&gt; Tx (ShelleyLedgerEra BabbageEra) -&gt; Tx BabbageEra
forall era.
ShelleyBasedEra era -&gt; Tx (ShelleyLedgerEra era) -&gt; Tx era
</span><span class="hs-identifier hs-var">C.ShelleyTx</span></span><span> </span><span class="annot"><span class="annottext">ShelleyBasedEra BabbageEra
</span><span class="hs-identifier hs-var">C.ShelleyBasedEraBabbage</span></span><span> </span><span class="annot"><span class="annottext">Tx (BabbageEra StandardCrypto)
Tx (ShelleyLedgerEra BabbageEra)
</span><a href="#local-6989586621679330342"><span class="hs-identifier hs-var">shelleyEraTx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-523"></span><span>                        </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVar AppState -&gt; (AppState -&gt; IO AppState) -&gt; IO ()
forall a. MVar a -&gt; (a -&gt; IO a) -&gt; IO ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">modifyMVar_</span></a></span><span> </span><span class="annot"><span class="annottext">MVar AppState
</span><a href="#local-6989586621679330352"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AppState -&gt; IO AppState
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(AppState -&gt; IO AppState)
-&gt; (AppState -&gt; AppState) -&gt; AppState -&gt; IO AppState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter AppState AppState ChainState ChainState
-&gt; (ChainState -&gt; ChainState) -&gt; AppState -&gt; AppState
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-identifier hs-var">over</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SocketEmulatorState -&gt; Identity SocketEmulatorState)
-&gt; AppState -&gt; Identity AppState
Lens' AppState SocketEmulatorState
</span><a href="Cardano.Node.Socket.Emulator.Types.html#socketEmulatorState"><span class="hs-identifier hs-var">socketEmulatorState</span></a></span><span> </span><span class="annot"><span class="annottext">((SocketEmulatorState -&gt; Identity SocketEmulatorState)
 -&gt; AppState -&gt; Identity AppState)
-&gt; ((ChainState -&gt; Identity ChainState)
    -&gt; SocketEmulatorState -&gt; Identity SocketEmulatorState)
-&gt; ASetter AppState AppState ChainState ChainState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(EmulatorState -&gt; Identity EmulatorState)
-&gt; SocketEmulatorState -&gt; Identity SocketEmulatorState
Lens' SocketEmulatorState EmulatorState
</span><a href="Cardano.Node.Socket.Emulator.Types.html#emulatorState"><span class="hs-identifier hs-var">emulatorState</span></a></span><span> </span><span class="annot"><span class="annottext">((EmulatorState -&gt; Identity EmulatorState)
 -&gt; SocketEmulatorState -&gt; Identity SocketEmulatorState)
-&gt; ((ChainState -&gt; Identity ChainState)
    -&gt; EmulatorState -&gt; Identity EmulatorState)
-&gt; (ChainState -&gt; Identity ChainState)
-&gt; SocketEmulatorState
-&gt; Identity SocketEmulatorState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainState -&gt; Identity ChainState)
-&gt; EmulatorState -&gt; Identity EmulatorState
Lens' EmulatorState ChainState
</span><span class="hs-identifier hs-var">E.esChainState</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CardanoTx -&gt; ChainState -&gt; ChainState
</span><span class="hs-identifier hs-var">Chain.addTxToPool</span></span><span> </span><span class="annot"><span class="annottext">CardanoTx
</span><a href="#local-6989586621679330341"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-524"></span><span>                        </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-525"></span><span>                    </span><span class="annot"><span class="annottext">GenTx block
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-526"></span><span>                </span><span class="annot"><span class="annottext">(SubmitResult
   (HardForkApplyTxErr
      (ByronBlock : CardanoShelleyEras StandardCrypto)),
 LocalTxSubmissionServer
   (GenTx block)
   (HardForkApplyTxErr
      (ByronBlock : CardanoShelleyEras StandardCrypto))
   IO
   ())
-&gt; IO
     (SubmitResult
        (HardForkApplyTxErr
           (ByronBlock : CardanoShelleyEras StandardCrypto)),
      LocalTxSubmissionServer
        (GenTx block)
        (HardForkApplyTxErr
           (ByronBlock : CardanoShelleyEras StandardCrypto))
        IO
        ())
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubmitResult
  (HardForkApplyTxErr
     (ByronBlock : CardanoShelleyEras StandardCrypto))
forall reason. SubmitResult reason
</span><span class="hs-identifier hs-var">TxSubmission.SubmitSuccess</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LocalTxSubmissionServer (GenTx block) (ApplyTxErr block) IO ()
LocalTxSubmissionServer
  (GenTx block)
  (HardForkApplyTxErr
     (ByronBlock : CardanoShelleyEras StandardCrypto))
  IO
  ()
</span><a href="#local-6989586621679330351"><span class="hs-identifier hs-var">txSubmissionState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-527"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">recvMsgDone :: ()
</span><span class="hs-identifier hs-var">TxSubmission.recvMsgDone</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-528"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-529"></span></pre></body></html>