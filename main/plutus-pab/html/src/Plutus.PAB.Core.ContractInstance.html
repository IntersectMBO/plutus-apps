<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE AllowAmbiguousTypes #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE ConstraintKinds     #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DataKinds           #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE DerivingVia         #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts    #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE MonoLocalBinds      #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns      #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings   #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications    #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators       #-}</span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span class="hs-comment">{-

Start the threads for contract instances

-}</span><span>
</span><span id="line-19"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Plutus.PAB.Core.ContractInstance</span><span class="hs-special">(</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.RequestHandlers.html#ContractInstanceMsg"><span class="hs-identifier">RequestHandlers.ContractInstanceMsg</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#activateContractSTM"><span class="hs-identifier">activateContractSTM</span></a></span><span>
</span><span id="line-22"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#activateContractSTM%27"><span class="hs-identifier">activateContractSTM'</span></a></span><span>
</span><span id="line-23"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#initContractInstanceState"><span class="hs-identifier">initContractInstanceState</span></a></span><span>
</span><span id="line-24"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#ContractInstanceState"><span class="hs-identifier">ContractInstanceState</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#updateState"><span class="hs-identifier">updateState</span></a></span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><span class="hs-comment">-- * STM instances</span></span><span>
</span><span id="line-27"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#startSTMInstanceThread"><span class="hs-identifier">startSTMInstanceThread</span></a></span><span>
</span><span id="line-28"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#startContractInstanceThread%27"><span class="hs-identifier">startContractInstanceThread'</span></a></span><span>
</span><span id="line-29"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#AppBackendConstraints"><span class="hs-identifier">AppBackendConstraints</span></a></span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Calling endpoints</span></span><span>
</span><span id="line-31"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#callEndpointOnInstance"><span class="hs-identifier">callEndpointOnInstance</span></a></span><span>
</span><span id="line-32"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Indexed block</span></span><span>
</span><span id="line-33"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Applicative</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Alternative</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">empty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator">(&lt;|&gt;)</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Arrow</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator">(&gt;&gt;&gt;)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Concurrent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">forkIO</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">STM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">STM</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">preview</span></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens.Operators</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">forM_</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Freer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Eff</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">LastMember</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Member</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">raise</span></span><span class="hs-special">,</span><span> </span><span class="hs-keyword">type</span><span> </span><span class="annot"><span class="hs-operator">(~&gt;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Freer.Error</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Error</span></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Freer.Extras.Log</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">LogMessage</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">LogMsg</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">LogObserve</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">logDebug</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">logInfo</span></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Freer.NonDet</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NonDet</span></span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Freer.Reader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Reader</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ask</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">runReader</span></span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Monad.IO.Class</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">MonadIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">liftIO</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Value</span></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.IORef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">IORef</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">readIORef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">fromMaybe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Monoid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Sum</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Sum</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Proxy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Proxy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Proxy</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Text</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Ledger</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">TxOutRef</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Ledger.Tx.CardanoAPI</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">fromCardanoTxId</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">fromCardanoTxIn</span></span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Marconi.Core.Index.VSplit</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Ix</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Plutus.ChainIndex</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ChainIndexQueryEffect</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Depth</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">RollbackState</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">TxConfirmedState</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">TxOutState</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-59"></span><span>                          </span><span class="annot"><span class="hs-identifier">TxOutStatus</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">TxStatus</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">TxValidity</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">transactionOutputState</span></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Plutus.ChainIndex.UtxoState</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">UtxoState</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_usTxUtxoData</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">utxoState</span></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Plutus.Contract.Effects</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ActiveEndpoint</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">aeDescription</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-62"></span><span>                                </span><span class="annot"><span class="hs-identifier">PABReq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">AwaitUtxoProducedReq</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">AwaitUtxoSpentReq</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ExposeEndpointReq</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-63"></span><span>                                </span><span class="annot"><span class="hs-identifier">PABResp</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">AwaitSlotResp</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">AwaitTimeResp</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">AwaitTxOutStatusChangeResp</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">AwaitTxStatusChangeResp</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">AwaitUtxoProducedResp</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">AwaitUtxoSpentResp</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ExposeEndpointResp</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Plutus.Contract.Effects</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Contract.Effects</span></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Plutus.Contract.Resumable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Request</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Request</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">itID</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">rqID</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">rqRequest</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Response</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Response</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Plutus.Contract.State</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ContractResponse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ContractResponse</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">err</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">hooks</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">newState</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">State</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">State</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">observableState</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Plutus.Contract.Trace</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">RequestHandler</span></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Plutus.Contract.Trace.RequestHandler</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">RequestHandler</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">RequestHandler</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">RequestHandlerLogMsg</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">extract</span></span><span class="hs-special">,</span><span>
</span><span id="line-69"></span><span>                                             </span><span class="annot"><span class="hs-identifier">maybeToHandler</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">tryHandler'</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">wrapHandler</span></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.RequestHandlers.html"><span class="hs-identifier">Plutus.PAB.Core.ContractInstance.RequestHandlers</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.RequestHandlers.html#ContractInstanceMsg"><span class="hs-identifier">ContractInstanceMsg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.RequestHandlers.html#ActivatedContractInstance"><span class="hs-identifier">ActivatedContractInstance</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.RequestHandlers.html#HandlingRequests"><span class="hs-identifier">HandlingRequests</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.RequestHandlers.html#InitialisingContract"><span class="hs-identifier">InitialisingContract</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.RequestHandlers.html"><span class="hs-identifier">Plutus.PAB.Core.ContractInstance.RequestHandlers</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">RequestHandlers</span></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html"><span class="hs-identifier">Plutus.PAB.Core.ContractInstance.STM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#Activity"><span class="hs-identifier">Activity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#Done"><span class="hs-identifier">Done</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#Stopped"><span class="hs-identifier">Stopped</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier">BlockchainEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-73"></span><span>                                             </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier">InstanceState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier">InstanceState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#issStop"><span class="hs-identifier">issStop</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstancesState"><span class="hs-identifier">InstancesState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-74"></span><span>                                             </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#callEndpointOnInstance"><span class="hs-identifier">callEndpointOnInstance</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#emptyInstanceState"><span class="hs-identifier">emptyInstanceState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html"><span class="hs-identifier">Plutus.PAB.Core.ContractInstance.STM</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">InstanceState</span></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.Indexer.TxConfirmationStatus.html"><span class="hs-identifier">Plutus.PAB.Core.Indexer.TxConfirmationStatus</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Core.Indexer.TxConfirmationStatus.html#TCSIndex"><span class="hs-identifier">TCSIndex</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html"><span class="hs-identifier">Plutus.PAB.Effects.Contract</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#ContractEffect"><span class="hs-identifier">ContractEffect</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#ContractStore"><span class="hs-identifier">ContractStore</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#PABContract"><span class="hs-identifier">PABContract</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#ContractDef"><span class="hs-identifier">ContractDef</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#serialisableState"><span class="hs-identifier">serialisableState</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html"><span class="hs-identifier">Plutus.PAB.Effects.Contract</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Contract</span></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.PAB.Effects.UUID.html"><span class="hs-identifier">Plutus.PAB.Effects.UUID</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Effects.UUID.html#UUIDEffect"><span class="hs-identifier">UUIDEffect</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Effects.UUID.html#uuidNextRandom"><span class="hs-identifier">uuidNextRandom</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.PAB.Events.Contract.html"><span class="hs-identifier">Plutus.PAB.Events.Contract</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ContractInstanceId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ContractInstanceId</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.PAB.Types.html"><span class="hs-identifier">Plutus.PAB.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Types.html#PABError"><span class="hs-identifier">PABError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.PAB.Webserver.Types.html"><span class="hs-identifier">Plutus.PAB.Webserver.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Webserver.Types.html#ContractActivationArgs"><span class="hs-identifier">ContractActivationArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Webserver.Types.html#ContractActivationArgs"><span class="hs-identifier">ContractActivationArgs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Webserver.Types.html#caID"><span class="hs-identifier">caID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Webserver.Types.html#caWallet"><span class="hs-identifier">caWallet</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Plutus.V1.Ledger.Api</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">TxId</span></span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Wallet.Effects</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NodeClientEffect</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">WalletEffect</span></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Wallet.Emulator.LogMessages</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">TxBalanceMsg</span></span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Wallet.Emulator.Wallet</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Wallet</span></span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span class="hs-comment">-- | Container for holding a few bits of state related to the contract</span><span>
</span><span id="line-89"></span><span class="hs-comment">-- instance that we may want to pass in.</span><span>
</span><span id="line-90"></span><span class="hs-keyword">data</span><span> </span><span id="ContractInstanceState"><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#ContractInstanceState"><span class="hs-identifier hs-var">ContractInstanceState</span></a></span></span><span> </span><span id="local-6989586621680273554"><span class="annot"><a href="#local-6989586621680273554"><span class="hs-identifier hs-type">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-91"></span><span>  </span><span id="ContractInstanceState"><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#ContractInstanceState"><span class="hs-identifier hs-var">ContractInstanceState</span></a></span></span><span>
</span><span id="line-92"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="contractState"><span class="annot"><span class="annottext">ContractInstanceState t -&gt; State t
</span><a href="Plutus.PAB.Core.ContractInstance.html#contractState"><span class="hs-identifier hs-var hs-var">contractState</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#State"><span class="hs-identifier hs-type">Contract.State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273554"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="stmState"><span class="annot"><span class="annottext">ContractInstanceState t -&gt; STM InstanceState
</span><a href="Plutus.PAB.Core.ContractInstance.html#stmState"><span class="hs-identifier hs-var hs-var">stmState</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-95"></span><span>
</span><span id="line-96"></span><span class="hs-comment">-- | Create a new instance of the contract, but where the</span><span>
</span><span id="line-97"></span><span class="hs-comment">-- activeContractInstanceId and the initial state are provided.</span><span>
</span><span id="line-98"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#activateContractSTM%27"><span class="hs-identifier hs-type">activateContractSTM'</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-99"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680273500"><span class="annot"><a href="#local-6989586621680273500"><span class="hs-identifier hs-type">t</span></a></span></span><span> </span><span id="local-6989586621680273498"><span class="annot"><a href="#local-6989586621680273498"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680273497"><span class="annot"><a href="#local-6989586621680273497"><span class="hs-identifier hs-type">appBackend</span></a></span></span><span> </span><span id="local-6989586621680273499"><span class="annot"><a href="#local-6989586621680273499"><span class="hs-identifier hs-type">effs</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-100"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">LogMsg</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.RequestHandlers.html#ContractInstanceMsg"><span class="hs-identifier hs-type">ContractInstanceMsg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273500"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273499"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#ContractStore"><span class="hs-identifier hs-type">ContractStore</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273500"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273499"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstancesState"><span class="hs-identifier hs-type">InstancesState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273499"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-103"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#PABContract"><span class="hs-identifier hs-type">Contract.PABContract</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273500"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-104"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#AppBackendConstraints"><span class="hs-identifier hs-type">AppBackendConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273500"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273498"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273497"><span class="hs-identifier hs-type">appBackend</span></a></span><span>
</span><span id="line-105"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LastMember</span></span><span> </span><span class="annot"><a href="#local-6989586621680273498"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ContractInstanceId</span></span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><span class="annot"><a href="#local-6989586621680273497"><span class="hs-identifier hs-type">appBackend</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LastMember</span></span><span> </span><span class="annot"><a href="#local-6989586621680273498"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273499"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-107"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#ContractInstanceState"><span class="hs-identifier hs-type">ContractInstanceState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273500"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ContractInstanceId</span></span><span>
</span><span id="line-110"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ContractInstanceId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680273497"><span class="hs-identifier hs-type">appBackend</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~&gt;</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Webserver.Types.html#ContractActivationArgs"><span class="hs-identifier hs-type">ContractActivationArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#ContractDef"><span class="hs-identifier hs-type">ContractDef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273500"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680273499"><span class="hs-identifier hs-type">effs</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ContractInstanceId</span></span><span>
</span><span id="line-113"></span><span id="activateContractSTM%27"><span class="annot"><span class="annottext">activateContractSTM' :: ContractInstanceState t
-&gt; ContractInstanceId
-&gt; (ContractInstanceId -&gt; Eff appBackend ~&gt; IO)
-&gt; ContractActivationArgs (ContractDef t)
-&gt; Eff effs ContractInstanceId
</span><a href="Plutus.PAB.Core.ContractInstance.html#activateContractSTM%27"><span class="hs-identifier hs-var hs-var">activateContractSTM'</span></a></span></span><span> </span><span id="local-6989586621680273191"><span class="annot"><span class="annottext">c :: ContractInstanceState t
</span><a href="#local-6989586621680273191"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#ContractInstanceState"><span class="hs-identifier hs-type">ContractInstanceState</span></a></span><span class="hs-special">{</span><span id="local-6989586621680273190"><span class="annot"><span class="annottext">State t
contractState :: State t
contractState :: forall t. ContractInstanceState t -&gt; State t
</span><a href="#local-6989586621680273190"><span class="hs-identifier hs-var hs-var">contractState</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680273189"><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273189"><span class="hs-identifier hs-var">activeContractInstanceId</span></a></span></span><span> </span><span id="local-6989586621680273188"><span class="annot"><span class="annottext">ContractInstanceId -&gt; Eff appBackend ~&gt; IO
</span><a href="#local-6989586621680273188"><span class="hs-identifier hs-var">runAppBackend</span></a></span></span><span> </span><span id="local-6989586621680273187"><span class="annot"><span class="annottext">a :: ContractActivationArgs (ContractDef t)
</span><a href="#local-6989586621680273187"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Plutus.PAB.Webserver.Types.html#ContractActivationArgs"><span class="hs-identifier hs-type">ContractActivationArgs</span></a></span><span class="hs-special">{</span><span id="local-6989586621680273186"><span class="annot"><span class="annottext">ContractDef t
caID :: ContractDef t
caID :: forall t. ContractActivationArgs t -&gt; t
</span><a href="#local-6989586621680273186"><span class="hs-identifier hs-var hs-var">caID</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680273185"><span class="annot"><span class="annottext">Maybe Wallet
caWallet :: Maybe Wallet
caWallet :: forall t. ContractActivationArgs t -&gt; Maybe Wallet
</span><a href="#local-6989586621680273185"><span class="hs-identifier hs-var hs-var">caWallet</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-114"></span><span>  </span><span class="annot"><span class="annottext">forall (effs :: [* -&gt; *]).
Member (LogMsg (ContractInstanceMsg t)) effs =&gt;
ContractInstanceMsg t -&gt; Eff effs ()
forall a (effs :: [* -&gt; *]).
Member (LogMsg a) effs =&gt;
a -&gt; Eff effs ()
</span><span class="hs-identifier hs-var">logInfo</span></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.RequestHandlers.html#ContractInstanceMsg"><span class="hs-identifier hs-type">ContractInstanceMsg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273500"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ContractInstanceMsg t -&gt; Eff effs ())
-&gt; ContractInstanceMsg t -&gt; Eff effs ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ContractDef t -&gt; ContractInstanceId -&gt; ContractInstanceMsg t
forall t.
ContractDef t -&gt; ContractInstanceId -&gt; ContractInstanceMsg t
</span><a href="Plutus.PAB.Core.ContractInstance.RequestHandlers.html#InitialisingContract"><span class="hs-identifier hs-var">InitialisingContract</span></a></span><span> </span><span class="annot"><span class="annottext">ContractDef t
</span><a href="#local-6989586621680273186"><span class="hs-identifier hs-var">caID</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273189"><span class="hs-identifier hs-var">activeContractInstanceId</span></a></span><span>
</span><span id="line-115"></span><span>  </span><span class="annot"><span class="annottext">ContractActivationArgs (ContractDef t)
-&gt; ContractInstanceId -&gt; Eff effs ()
forall t (effs :: [* -&gt; *]).
Member (ContractStore t) effs =&gt;
ContractActivationArgs (ContractDef t)
-&gt; ContractInstanceId -&gt; Eff effs ()
</span><a href="Plutus.PAB.Effects.Contract.html#putStartInstance"><span class="hs-identifier hs-var">Contract.putStartInstance</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273500"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><span class="annottext">ContractActivationArgs (ContractDef t)
</span><a href="#local-6989586621680273187"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273189"><span class="hs-identifier hs-var">activeContractInstanceId</span></a></span><span>
</span><span id="line-116"></span><span>  </span><span class="annot"><span class="annottext">ContractActivationArgs (ContractDef t)
-&gt; ContractInstanceId -&gt; State t -&gt; Eff effs ()
forall t (effs :: [* -&gt; *]).
Member (ContractStore t) effs =&gt;
ContractActivationArgs (ContractDef t)
-&gt; ContractInstanceId -&gt; State t -&gt; Eff effs ()
</span><a href="Plutus.PAB.Effects.Contract.html#putState"><span class="hs-identifier hs-var">Contract.putState</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273500"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><span class="annottext">ContractActivationArgs (ContractDef t)
</span><a href="#local-6989586621680273187"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273189"><span class="hs-identifier hs-var">activeContractInstanceId</span></a></span><span> </span><span class="annot"><span class="annottext">State t
</span><a href="#local-6989586621680273190"><span class="hs-identifier hs-var">contractState</span></a></span><span>
</span><span id="line-117"></span><span>  </span><span id="local-6989586621680273182"><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273182"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ContractInstanceState t
-&gt; ContractInstanceId
-&gt; (ContractInstanceId -&gt; Eff appBackend ~&gt; IO)
-&gt; ContractActivationArgs (ContractDef t)
-&gt; Eff effs ContractInstanceId
forall t (m :: * -&gt; *) (appBackend :: [* -&gt; *]) (effs :: [* -&gt; *]).
(Member (Reader InstancesState) effs, PABContract t,
 AppBackendConstraints t m appBackend,
 LastMember m (Reader ContractInstanceId : appBackend),
 LastMember m effs) =&gt;
ContractInstanceState t
-&gt; ContractInstanceId
-&gt; (ContractInstanceId -&gt; Eff appBackend ~&gt; IO)
-&gt; ContractActivationArgs (ContractDef t)
-&gt; Eff effs ContractInstanceId
</span><a href="Plutus.PAB.Core.ContractInstance.html#startContractInstanceThread%27"><span class="hs-identifier hs-var">startContractInstanceThread'</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceState t
</span><a href="#local-6989586621680273191"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273189"><span class="hs-identifier hs-var">activeContractInstanceId</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId -&gt; Eff appBackend ~&gt; IO
</span><a href="#local-6989586621680273188"><span class="hs-identifier hs-var">runAppBackend</span></a></span><span> </span><span class="annot"><span class="annottext">ContractActivationArgs (ContractDef t)
</span><a href="#local-6989586621680273187"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-118"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680273181"><span class="annot"><span class="annottext">wallet :: Wallet
</span><a href="#local-6989586621680273181"><span class="hs-identifier hs-var hs-var">wallet</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Wallet -&gt; Maybe Wallet -&gt; Wallet
forall a. a -&gt; Maybe a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; Wallet
</span><span class="hs-identifier hs-var">Wallet.knownWallet</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Wallet
</span><a href="#local-6989586621680273185"><span class="hs-identifier hs-var">caWallet</span></a></span><span>
</span><span id="line-119"></span><span>  </span><span class="annot"><span class="annottext">forall (effs :: [* -&gt; *]).
Member (LogMsg (ContractInstanceMsg t)) effs =&gt;
ContractInstanceMsg t -&gt; Eff effs ()
forall a (effs :: [* -&gt; *]).
Member (LogMsg a) effs =&gt;
a -&gt; Eff effs ()
</span><span class="hs-identifier hs-var">logInfo</span></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.RequestHandlers.html#ContractInstanceMsg"><span class="hs-identifier hs-type">ContractInstanceMsg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273500"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ContractInstanceMsg t -&gt; Eff effs ())
-&gt; ContractInstanceMsg t -&gt; Eff effs ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ContractDef t
-&gt; Wallet -&gt; ContractInstanceId -&gt; ContractInstanceMsg t
forall t.
ContractDef t
-&gt; Wallet -&gt; ContractInstanceId -&gt; ContractInstanceMsg t
</span><a href="Plutus.PAB.Core.ContractInstance.RequestHandlers.html#ActivatedContractInstance"><span class="hs-identifier hs-var">ActivatedContractInstance</span></a></span><span> </span><span class="annot"><span class="annottext">ContractDef t
</span><a href="#local-6989586621680273186"><span class="hs-identifier hs-var">caID</span></a></span><span> </span><span class="annot"><span class="annottext">Wallet
</span><a href="#local-6989586621680273181"><span class="hs-identifier hs-var">wallet</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273189"><span class="hs-identifier hs-var">activeContractInstanceId</span></a></span><span>
</span><span id="line-120"></span><span>  </span><span class="annot"><span class="annottext">ContractInstanceId -&gt; Eff effs ContractInstanceId
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273182"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-121"></span><span>
</span><span id="line-122"></span><span class="hs-comment">-- | Spin up the STM Instance thread for the provided contract and add it to</span><span>
</span><span id="line-123"></span><span class="hs-comment">-- the STM instance state.</span><span>
</span><span id="line-124"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#startContractInstanceThread%27"><span class="hs-identifier hs-type">startContractInstanceThread'</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-125"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680273534"><span class="annot"><a href="#local-6989586621680273534"><span class="hs-identifier hs-type">t</span></a></span></span><span> </span><span id="local-6989586621680273532"><span class="annot"><a href="#local-6989586621680273532"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680273531"><span class="annot"><a href="#local-6989586621680273531"><span class="hs-identifier hs-type">appBackend</span></a></span></span><span> </span><span id="local-6989586621680273535"><span class="annot"><a href="#local-6989586621680273535"><span class="hs-identifier hs-type">effs</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-126"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstancesState"><span class="hs-identifier hs-type">InstancesState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273535"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-127"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#PABContract"><span class="hs-identifier hs-type">Contract.PABContract</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273534"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-128"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#AppBackendConstraints"><span class="hs-identifier hs-type">AppBackendConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273534"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273532"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273531"><span class="hs-identifier hs-type">appBackend</span></a></span><span>
</span><span id="line-129"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LastMember</span></span><span> </span><span class="annot"><a href="#local-6989586621680273532"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ContractInstanceId</span></span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><span class="annot"><a href="#local-6989586621680273531"><span class="hs-identifier hs-type">appBackend</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-130"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LastMember</span></span><span> </span><span class="annot"><a href="#local-6989586621680273532"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273535"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-131"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#ContractInstanceState"><span class="hs-identifier hs-type">ContractInstanceState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273534"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-133"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ContractInstanceId</span></span><span>
</span><span id="line-134"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ContractInstanceId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680273531"><span class="hs-identifier hs-type">appBackend</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~&gt;</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-135"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Webserver.Types.html#ContractActivationArgs"><span class="hs-identifier hs-type">ContractActivationArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#ContractDef"><span class="hs-identifier hs-type">ContractDef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273534"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-136"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680273535"><span class="hs-identifier hs-type">effs</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ContractInstanceId</span></span><span>
</span><span id="line-137"></span><span id="startContractInstanceThread%27"><span class="annot"><span class="annottext">startContractInstanceThread' :: ContractInstanceState t
-&gt; ContractInstanceId
-&gt; (ContractInstanceId -&gt; Eff appBackend ~&gt; IO)
-&gt; ContractActivationArgs (ContractDef t)
-&gt; Eff effs ContractInstanceId
</span><a href="Plutus.PAB.Core.ContractInstance.html#startContractInstanceThread%27"><span class="hs-identifier hs-var hs-var">startContractInstanceThread'</span></a></span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#ContractInstanceState"><span class="hs-identifier hs-type">ContractInstanceState</span></a></span><span class="hs-special">{</span><span id="local-6989586621680273179"><span class="annot"><span class="annottext">STM InstanceState
stmState :: STM InstanceState
stmState :: forall t. ContractInstanceState t -&gt; STM InstanceState
</span><a href="#local-6989586621680273179"><span class="hs-identifier hs-var hs-var">stmState</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680273178"><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273178"><span class="hs-identifier hs-var">activeContractInstanceId</span></a></span></span><span> </span><span id="local-6989586621680273177"><span class="annot"><span class="annottext">ContractInstanceId -&gt; Eff appBackend ~&gt; IO
</span><a href="#local-6989586621680273177"><span class="hs-identifier hs-var">runAppBackend</span></a></span></span><span> </span><span id="local-6989586621680273176"><span class="annot"><span class="annottext">ContractActivationArgs (ContractDef t)
</span><a href="#local-6989586621680273176"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-138"></span><span>  </span><span id="local-6989586621680273175"><span class="annot"><span class="annottext">InstanceState
</span><a href="#local-6989586621680273175"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM InstanceState
-&gt; (ContractInstanceId -&gt; Eff appBackend ~&gt; IO)
-&gt; ContractActivationArgs (ContractDef t)
-&gt; ContractInstanceId
-&gt; Eff effs InstanceState
forall t (m :: * -&gt; *) (appBackend :: [* -&gt; *]) (effs :: [* -&gt; *]).
(LastMember m effs, PABContract t,
 AppBackendConstraints t m appBackend,
 LastMember
   m
   (Reader InstanceState : Reader ContractInstanceId : appBackend)) =&gt;
STM InstanceState
-&gt; (ContractInstanceId -&gt; Eff appBackend ~&gt; IO)
-&gt; ContractActivationArgs (ContractDef t)
-&gt; ContractInstanceId
-&gt; Eff effs InstanceState
</span><a href="Plutus.PAB.Core.ContractInstance.html#startSTMInstanceThread%27"><span class="hs-identifier hs-var">startSTMInstanceThread'</span></a></span><span>
</span><span id="line-139"></span><span>    </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273534"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273532"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="annottext">STM InstanceState
</span><a href="#local-6989586621680273179"><span class="hs-identifier hs-var">stmState</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId -&gt; Eff appBackend ~&gt; IO
</span><a href="#local-6989586621680273177"><span class="hs-identifier hs-var">runAppBackend</span></a></span><span> </span><span class="annot"><span class="annottext">ContractActivationArgs (ContractDef t)
</span><a href="#local-6989586621680273176"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273178"><span class="hs-identifier hs-var">activeContractInstanceId</span></a></span><span>
</span><span id="line-140"></span><span>  </span><span class="annot"><span class="annottext">Eff effs InstancesState
forall r (effs :: [* -&gt; *]). Member (Reader r) effs =&gt; Eff effs r
</span><span class="hs-identifier hs-var">ask</span></span><span> </span><span class="annot"><span class="annottext">Eff effs InstancesState
-&gt; (InstancesState -&gt; Eff effs ()) -&gt; Eff effs ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; Eff effs ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; Eff effs ())
-&gt; (InstancesState -&gt; IO ()) -&gt; InstancesState -&gt; Eff effs ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId -&gt; InstanceState -&gt; InstancesState -&gt; IO ()
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#insertInstance"><span class="hs-identifier hs-var">InstanceState.insertInstance</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273178"><span class="hs-identifier hs-var">activeContractInstanceId</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceState
</span><a href="#local-6989586621680273175"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-141"></span><span>  </span><span class="annot"><span class="annottext">ContractInstanceId -&gt; Eff effs ContractInstanceId
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273178"><span class="hs-identifier hs-var">activeContractInstanceId</span></a></span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span class="hs-comment">-- | Create a new instance of the contract</span><span>
</span><span id="line-144"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#activateContractSTM"><span class="hs-identifier hs-type">activateContractSTM</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-145"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680273171"><span class="annot"><a href="#local-6989586621680273171"><span class="hs-identifier hs-type">t</span></a></span></span><span> </span><span id="local-6989586621680273170"><span class="annot"><a href="#local-6989586621680273170"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680273169"><span class="annot"><a href="#local-6989586621680273169"><span class="hs-identifier hs-type">appBackend</span></a></span></span><span> </span><span id="local-6989586621680273168"><span class="annot"><a href="#local-6989586621680273168"><span class="hs-identifier hs-type">effs</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">LogMsg</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.RequestHandlers.html#ContractInstanceMsg"><span class="hs-identifier hs-type">ContractInstanceMsg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273171"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273168"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-147"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="annot"><a href="Plutus.PAB.Effects.UUID.html#UUIDEffect"><span class="hs-identifier hs-type">UUIDEffect</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273168"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#ContractEffect"><span class="hs-identifier hs-type">ContractEffect</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273171"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273168"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-149"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#ContractStore"><span class="hs-identifier hs-type">ContractStore</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273171"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273168"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-150"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstancesState"><span class="hs-identifier hs-type">InstancesState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273168"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-151"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#PABContract"><span class="hs-identifier hs-type">Contract.PABContract</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273171"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-152"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#AppBackendConstraints"><span class="hs-identifier hs-type">AppBackendConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273171"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273170"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273169"><span class="hs-identifier hs-type">appBackend</span></a></span><span>
</span><span id="line-153"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LastMember</span></span><span> </span><span class="annot"><a href="#local-6989586621680273170"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ContractInstanceId</span></span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><span class="annot"><a href="#local-6989586621680273169"><span class="hs-identifier hs-type">appBackend</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LastMember</span></span><span> </span><span class="annot"><a href="#local-6989586621680273170"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273168"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-155"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-156"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ContractInstanceId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680273169"><span class="hs-identifier hs-type">appBackend</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~&gt;</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Webserver.Types.html#ContractActivationArgs"><span class="hs-identifier hs-type">ContractActivationArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#ContractDef"><span class="hs-identifier hs-type">ContractDef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273171"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680273168"><span class="hs-identifier hs-type">effs</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ContractInstanceId</span></span><span>
</span><span id="line-159"></span><span id="activateContractSTM"><span class="annot"><span class="annottext">activateContractSTM :: (ContractInstanceId -&gt; Eff appBackend ~&gt; IO)
-&gt; ContractActivationArgs (ContractDef t)
-&gt; Eff effs ContractInstanceId
</span><a href="Plutus.PAB.Core.ContractInstance.html#activateContractSTM"><span class="hs-identifier hs-var hs-var">activateContractSTM</span></a></span></span><span> </span><span id="local-6989586621680273167"><span class="annot"><span class="annottext">ContractInstanceId -&gt; Eff appBackend ~&gt; IO
</span><a href="#local-6989586621680273167"><span class="hs-identifier hs-var">runAppBackend</span></a></span></span><span> </span><span id="local-6989586621680273166"><span class="annot"><span class="annottext">ContractActivationArgs (ContractDef t)
</span><a href="#local-6989586621680273166"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-160"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621680273165"><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273165"><span class="hs-identifier hs-var">cid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680273164"><span class="annot"><span class="annottext">ContractInstanceState t
</span><a href="#local-6989586621680273164"><span class="hs-identifier hs-var">initState</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ContractActivationArgs (ContractDef t)
-&gt; Eff effs (ContractInstanceId, ContractInstanceState t)
forall t (effs :: [* -&gt; *]).
(Member UUIDEffect effs, Member (ContractEffect t) effs,
 PABContract t) =&gt;
ContractActivationArgs (ContractDef t)
-&gt; Eff effs (ContractInstanceId, ContractInstanceState t)
</span><a href="Plutus.PAB.Core.ContractInstance.html#initContractInstanceState"><span class="hs-identifier hs-var">initContractInstanceState</span></a></span><span> </span><span class="annot"><span class="annottext">ContractActivationArgs (ContractDef t)
</span><a href="#local-6989586621680273166"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-161"></span><span>  </span><span class="annot"><span class="annottext">ContractInstanceState t
-&gt; ContractInstanceId
-&gt; (ContractInstanceId -&gt; Eff appBackend ~&gt; IO)
-&gt; ContractActivationArgs (ContractDef t)
-&gt; Eff effs ContractInstanceId
forall t (m :: * -&gt; *) (appBackend :: [* -&gt; *]) (effs :: [* -&gt; *]).
(Member (LogMsg (ContractInstanceMsg t)) effs,
 Member (ContractStore t) effs, Member (Reader InstancesState) effs,
 PABContract t, AppBackendConstraints t m appBackend,
 LastMember m (Reader ContractInstanceId : appBackend),
 LastMember m effs) =&gt;
ContractInstanceState t
-&gt; ContractInstanceId
-&gt; (ContractInstanceId -&gt; Eff appBackend ~&gt; IO)
-&gt; ContractActivationArgs (ContractDef t)
-&gt; Eff effs ContractInstanceId
</span><a href="Plutus.PAB.Core.ContractInstance.html#activateContractSTM%27"><span class="hs-identifier hs-var">activateContractSTM'</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273171"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273170"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273169"><span class="hs-identifier hs-type">appBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273168"><span class="hs-identifier hs-type">effs</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceState t
</span><a href="#local-6989586621680273164"><span class="hs-identifier hs-var">initState</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273165"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId -&gt; Eff appBackend ~&gt; IO
</span><a href="#local-6989586621680273167"><span class="hs-identifier hs-var">runAppBackend</span></a></span><span> </span><span class="annot"><span class="annottext">ContractActivationArgs (ContractDef t)
</span><a href="#local-6989586621680273166"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span class="hs-comment">-- | Build a new ContractInstanceState and return it, along with</span><span>
</span><span id="line-164"></span><span class="hs-comment">-- the corresponding new intsance id.</span><span>
</span><span id="line-165"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#initContractInstanceState"><span class="hs-identifier hs-type">initContractInstanceState</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-166"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680273502"><span class="annot"><a href="#local-6989586621680273502"><span class="hs-identifier hs-type">t</span></a></span></span><span> </span><span id="local-6989586621680273503"><span class="annot"><a href="#local-6989586621680273503"><span class="hs-identifier hs-type">effs</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-167"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="annot"><a href="Plutus.PAB.Effects.UUID.html#UUIDEffect"><span class="hs-identifier hs-type">UUIDEffect</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273503"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#ContractEffect"><span class="hs-identifier hs-type">ContractEffect</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273502"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273503"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-169"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#PABContract"><span class="hs-identifier hs-type">Contract.PABContract</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273502"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-170"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-171"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Webserver.Types.html#ContractActivationArgs"><span class="hs-identifier hs-type">ContractActivationArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#ContractDef"><span class="hs-identifier hs-type">ContractDef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273502"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-172"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680273503"><span class="hs-identifier hs-type">effs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ContractInstanceId</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#ContractInstanceState"><span class="hs-identifier hs-type">ContractInstanceState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273502"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-173"></span><span id="initContractInstanceState"><span class="annot"><span class="annottext">initContractInstanceState :: ContractActivationArgs (ContractDef t)
-&gt; Eff effs (ContractInstanceId, ContractInstanceState t)
</span><a href="Plutus.PAB.Core.ContractInstance.html#initContractInstanceState"><span class="hs-identifier hs-var hs-var">initContractInstanceState</span></a></span></span><span> </span><span class="annot"><a href="Plutus.PAB.Webserver.Types.html#ContractActivationArgs"><span class="hs-identifier hs-type">ContractActivationArgs</span></a></span><span class="hs-special">{</span><span id="local-6989586621680273163"><span class="annot"><span class="annottext">ContractDef t
caID :: ContractDef t
caID :: forall t. ContractActivationArgs t -&gt; t
</span><a href="#local-6989586621680273163"><span class="hs-identifier hs-var hs-var">caID</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-174"></span><span>  </span><span id="local-6989586621680273162"><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273162"><span class="hs-identifier hs-var">activeContractInstanceId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UUID -&gt; ContractInstanceId
</span><span class="hs-identifier hs-var">ContractInstanceId</span></span><span> </span><span class="annot"><span class="annottext">(UUID -&gt; ContractInstanceId)
-&gt; Eff effs UUID -&gt; Eff effs ContractInstanceId
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Eff effs UUID
forall (effs :: [* -&gt; *]). Member UUIDEffect effs =&gt; Eff effs UUID
</span><a href="Plutus.PAB.Effects.UUID.html#uuidNextRandom"><span class="hs-identifier hs-var">uuidNextRandom</span></a></span><span>
</span><span id="line-175"></span><span>  </span><span id="local-6989586621680273160"><span class="annot"><span class="annottext">State t
</span><a href="#local-6989586621680273160"><span class="hs-identifier hs-var">initialState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ContractInstanceId -&gt; ContractDef t -&gt; Eff effs (State t)
forall t (effs :: [* -&gt; *]).
(Member (ContractEffect t) effs, PABContract t) =&gt;
ContractInstanceId -&gt; ContractDef t -&gt; Eff effs (State t)
</span><a href="Plutus.PAB.Effects.Contract.html#initialState"><span class="hs-identifier hs-var">Contract.initialState</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273502"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273162"><span class="hs-identifier hs-var">activeContractInstanceId</span></a></span><span> </span><span class="annot"><span class="annottext">ContractDef t
</span><a href="#local-6989586621680273163"><span class="hs-identifier hs-var">caID</span></a></span><span>
</span><span id="line-176"></span><span>  </span><span class="annot"><span class="annottext">(ContractInstanceId, ContractInstanceState t)
-&gt; Eff effs (ContractInstanceId, ContractInstanceState t)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273162"><span class="hs-identifier hs-var">activeContractInstanceId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">State t -&gt; STM InstanceState -&gt; ContractInstanceState t
forall t. State t -&gt; STM InstanceState -&gt; ContractInstanceState t
</span><a href="Plutus.PAB.Core.ContractInstance.html#ContractInstanceState"><span class="hs-identifier hs-var">ContractInstanceState</span></a></span><span> </span><span class="annot"><span class="annottext">State t
</span><a href="#local-6989586621680273160"><span class="hs-identifier hs-var">initialState</span></a></span><span> </span><span class="annot"><span class="annottext">STM InstanceState
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#emptyInstanceState"><span class="hs-identifier hs-var">emptyInstanceState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#processAwaitSlotRequestsSTM"><span class="hs-identifier hs-type">processAwaitSlotRequestsSTM</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-179"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680273339"><span class="annot"><a href="#local-6989586621680273339"><span class="hs-identifier hs-type">effs</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-180"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier hs-type">BlockchainEnv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273339"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-181"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">RequestHandler</span></span><span> </span><span class="annot"><a href="#local-6989586621680273339"><span class="hs-identifier hs-type">effs</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PABReq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PABResp</span></span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span id="processAwaitSlotRequestsSTM"><span class="annot"><span class="annottext">processAwaitSlotRequestsSTM :: RequestHandler effs PABReq (STM PABResp)
</span><a href="Plutus.PAB.Core.ContractInstance.html#processAwaitSlotRequestsSTM"><span class="hs-identifier hs-var hs-var">processAwaitSlotRequestsSTM</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-184"></span><span>    </span><span class="annot"><span class="annottext">(PABReq -&gt; Maybe Slot) -&gt; RequestHandler effs PABReq Slot
forall req resp (effs :: [* -&gt; *]).
(req -&gt; Maybe resp) -&gt; RequestHandler effs req resp
</span><span class="hs-identifier hs-var">maybeToHandler</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Prism' PABReq Slot -&gt; PABReq -&gt; Maybe Slot
forall (f :: * -&gt; *) a b. Alternative f =&gt; Prism' a b -&gt; a -&gt; f b
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Prism' PABReq Slot
</span><span class="hs-identifier hs-var">Contract.Effects._AwaitSlotReq</span></span><span class="hs-special">)</span><span>
</span><span id="line-185"></span><span>    </span><span class="annot"><span class="annottext">RequestHandler effs PABReq Slot
-&gt; RequestHandler effs Slot (STM PABResp)
-&gt; RequestHandler effs PABReq (STM PABResp)
forall k (cat :: k -&gt; k -&gt; *) (a :: k) (b :: k) (c :: k).
Category cat =&gt;
cat a b -&gt; cat b c -&gt; cat a c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Slot -&gt; Eff (NonDet : effs) (STM PABResp))
-&gt; RequestHandler effs Slot (STM PABResp)
forall (effs :: [* -&gt; *]) req resp.
(req -&gt; Eff (NonDet : effs) resp) -&gt; RequestHandler effs req resp
</span><span class="hs-identifier hs-var">RequestHandler</span></span><span> </span><span class="annot"><span class="annottext">((Slot -&gt; Eff (NonDet : effs) (STM PABResp))
 -&gt; RequestHandler effs Slot (STM PABResp))
-&gt; (Slot -&gt; Eff (NonDet : effs) (STM PABResp))
-&gt; RequestHandler effs Slot (STM PABResp)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680273156"><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621680273156"><span class="hs-identifier hs-var">targetSlot_</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Slot -&gt; PABResp) -&gt; STM Slot -&gt; STM PABResp
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">Slot -&gt; PABResp
</span><span class="hs-identifier hs-var">AwaitSlotResp</span></span><span> </span><span class="annot"><span class="annottext">(STM Slot -&gt; STM PABResp)
-&gt; (BlockchainEnv -&gt; STM Slot) -&gt; BlockchainEnv -&gt; STM PABResp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Slot -&gt; BlockchainEnv -&gt; STM Slot
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#awaitSlot"><span class="hs-identifier hs-var">InstanceState.awaitSlot</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621680273156"><span class="hs-identifier hs-var">targetSlot_</span></a></span><span> </span><span class="annot"><span class="annottext">(BlockchainEnv -&gt; STM PABResp)
-&gt; Eff (NonDet : effs) BlockchainEnv
-&gt; Eff (NonDet : effs) (STM PABResp)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Eff (NonDet : effs) BlockchainEnv
forall r (effs :: [* -&gt; *]). Member (Reader r) effs =&gt; Eff effs r
</span><span class="hs-identifier hs-var">ask</span></span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span>
</span><span id="line-187"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#processAwaitTimeRequestsSTM"><span class="hs-identifier hs-type">processAwaitTimeRequestsSTM</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-188"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680273153"><span class="annot"><a href="#local-6989586621680273153"><span class="hs-identifier hs-type">effs</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-189"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier hs-type">BlockchainEnv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273153"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-190"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">RequestHandler</span></span><span> </span><span class="annot"><a href="#local-6989586621680273153"><span class="hs-identifier hs-type">effs</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PABReq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PABResp</span></span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span id="processAwaitTimeRequestsSTM"><span class="annot"><span class="annottext">processAwaitTimeRequestsSTM :: RequestHandler effs PABReq (STM PABResp)
</span><a href="Plutus.PAB.Core.ContractInstance.html#processAwaitTimeRequestsSTM"><span class="hs-identifier hs-var hs-var">processAwaitTimeRequestsSTM</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-193"></span><span>    </span><span class="annot"><span class="annottext">(PABReq -&gt; Maybe POSIXTime) -&gt; RequestHandler effs PABReq POSIXTime
forall req resp (effs :: [* -&gt; *]).
(req -&gt; Maybe resp) -&gt; RequestHandler effs req resp
</span><span class="hs-identifier hs-var">maybeToHandler</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Prism' PABReq POSIXTime -&gt; PABReq -&gt; Maybe POSIXTime
forall (f :: * -&gt; *) a b. Alternative f =&gt; Prism' a b -&gt; a -&gt; f b
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Prism' PABReq POSIXTime
</span><span class="hs-identifier hs-var">Contract.Effects._AwaitTimeReq</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">RequestHandler effs PABReq POSIXTime
-&gt; RequestHandler effs POSIXTime (STM PABResp)
-&gt; RequestHandler effs PABReq (STM PABResp)
forall k (cat :: k -&gt; k -&gt; *) (a :: k) (b :: k) (c :: k).
Category cat =&gt;
cat a b -&gt; cat b c -&gt; cat a c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;&gt;</span></a></span><span>
</span><span id="line-194"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(POSIXTime -&gt; Eff (NonDet : effs) (STM PABResp))
-&gt; RequestHandler effs POSIXTime (STM PABResp)
forall (effs :: [* -&gt; *]) req resp.
(req -&gt; Eff (NonDet : effs) resp) -&gt; RequestHandler effs req resp
</span><span class="hs-identifier hs-var">RequestHandler</span></span><span> </span><span class="annot"><span class="annottext">((POSIXTime -&gt; Eff (NonDet : effs) (STM PABResp))
 -&gt; RequestHandler effs POSIXTime (STM PABResp))
-&gt; (POSIXTime -&gt; Eff (NonDet : effs) (STM PABResp))
-&gt; RequestHandler effs POSIXTime (STM PABResp)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680273151"><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621680273151"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-195"></span><span>            </span><span class="annot"><span class="annottext">(POSIXTime -&gt; PABResp) -&gt; STM POSIXTime -&gt; STM PABResp
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime -&gt; PABResp
</span><span class="hs-identifier hs-var">AwaitTimeResp</span></span><span> </span><span class="annot"><span class="annottext">(STM POSIXTime -&gt; STM PABResp)
-&gt; (BlockchainEnv -&gt; STM POSIXTime) -&gt; BlockchainEnv -&gt; STM PABResp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime -&gt; BlockchainEnv -&gt; STM POSIXTime
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#awaitTime"><span class="hs-identifier hs-var">InstanceState.awaitTime</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621680273151"><span class="hs-identifier hs-var">time</span></a></span><span> </span><span class="annot"><span class="annottext">(BlockchainEnv -&gt; STM PABResp)
-&gt; Eff (NonDet : effs) BlockchainEnv
-&gt; Eff (NonDet : effs) (STM PABResp)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Eff (NonDet : effs) BlockchainEnv
forall r (effs :: [* -&gt; *]). Member (Reader r) effs =&gt; Eff effs r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-196"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#processTxStatusChangeRequestsSTM"><span class="hs-identifier hs-type">processTxStatusChangeRequestsSTM</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-199"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680273337"><span class="annot"><a href="#local-6989586621680273337"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680273336"><span class="annot"><a href="#local-6989586621680273336"><span class="hs-identifier hs-type">effs</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-200"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LastMember</span></span><span> </span><span class="annot"><a href="#local-6989586621680273337"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273336"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-201"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273337"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-202"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier hs-type">BlockchainEnv</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">NonDet</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">:</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273336"><span class="hs-identifier hs-type">effs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-204"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">RequestHandler</span></span><span> </span><span class="annot"><a href="#local-6989586621680273336"><span class="hs-identifier hs-type">effs</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PABReq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PABResp</span></span><span class="hs-special">)</span><span>
</span><span id="line-205"></span><span id="processTxStatusChangeRequestsSTM"><span class="annot"><span class="annottext">processTxStatusChangeRequestsSTM :: RequestHandler effs PABReq (STM PABResp)
</span><a href="Plutus.PAB.Core.ContractInstance.html#processTxStatusChangeRequestsSTM"><span class="hs-identifier hs-var hs-var">processTxStatusChangeRequestsSTM</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-206"></span><span>    </span><span class="annot"><span class="annottext">(PABReq -&gt; Maybe TxId) -&gt; RequestHandler effs PABReq TxId
forall req resp (effs :: [* -&gt; *]).
(req -&gt; Maybe resp) -&gt; RequestHandler effs req resp
</span><span class="hs-identifier hs-var">maybeToHandler</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Prism' PABReq TxId -&gt; PABReq -&gt; Maybe TxId
forall (f :: * -&gt; *) a b. Alternative f =&gt; Prism' a b -&gt; a -&gt; f b
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Prism' PABReq TxId
</span><span class="hs-identifier hs-var">Contract.Effects._AwaitTxStatusChangeReq</span></span><span class="hs-special">)</span><span>
</span><span id="line-207"></span><span>    </span><span class="annot"><span class="annottext">RequestHandler effs PABReq TxId
-&gt; RequestHandler effs TxId (STM PABResp)
-&gt; RequestHandler effs PABReq (STM PABResp)
forall k (cat :: k -&gt; k -&gt; *) (a :: k) (b :: k) (c :: k).
Category cat =&gt;
cat a b -&gt; cat b c -&gt; cat a c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(TxId -&gt; Eff (NonDet : effs) (STM PABResp))
-&gt; RequestHandler effs TxId (STM PABResp)
forall (effs :: [* -&gt; *]) req resp.
(req -&gt; Eff (NonDet : effs) resp) -&gt; RequestHandler effs req resp
</span><span class="hs-identifier hs-var">RequestHandler</span></span><span> </span><span class="annot"><span class="annottext">TxId -&gt; Eff (NonDet : effs) (STM PABResp)
forall (e :: * -&gt; *) (effs :: [* -&gt; *]) (m :: * -&gt; *).
(IfNotFound (Reader BlockchainEnv) (e : effs) (e : effs),
 MonadIO m, LastMember m effs,
 FindElem (Reader BlockchainEnv) (e : effs)) =&gt;
TxId -&gt; Eff (e : effs) (STM PABResp)
</span><a href="#local-6989586621680273147"><span class="hs-identifier hs-var">handler</span></a></span><span>
</span><span id="line-208"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-209"></span><span>        </span><span id="local-6989586621680273147"><span class="annot"><span class="annottext">handler :: TxId -&gt; Eff (e : effs) (STM PABResp)
</span><a href="#local-6989586621680273147"><span class="hs-identifier hs-var hs-var">handler</span></a></span></span><span> </span><span id="local-6989586621680273146"><span class="annot"><span class="annottext">TxId
</span><a href="#local-6989586621680273146"><span class="hs-identifier hs-var">txId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-210"></span><span>            </span><span id="local-6989586621680273145"><span class="annot"><span class="annottext">BlockchainEnv
</span><a href="#local-6989586621680273145"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eff (e : effs) BlockchainEnv
forall r (effs :: [* -&gt; *]). Member (Reader r) effs =&gt; Eff effs r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-211"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">BlockchainEnv
-&gt; Either (TVar (UtxoIndex TxIdState)) (IORef TCSIndex)
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#beTxChanges"><span class="hs-identifier hs-var hs-var">InstanceState.beTxChanges</span></a></span><span> </span><span class="annot"><span class="annottext">BlockchainEnv
</span><a href="#local-6989586621680273145"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-212"></span><span>              </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (UtxoIndex TxIdState)
</span><span class="hs-identifier">_</span></span><span>      </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-213"></span><span>                  </span><span class="annot"><span class="annottext">STM PABResp -&gt; Eff (e : effs) (STM PABResp)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxId -&gt; TxStatus -&gt; PABResp
</span><span class="hs-identifier hs-var">AwaitTxStatusChangeResp</span></span><span> </span><span class="annot"><span class="annottext">TxId
</span><a href="#local-6989586621680273146"><span class="hs-identifier hs-var">txId</span></a></span><span> </span><span class="annot"><span class="annottext">(TxStatus -&gt; PABResp) -&gt; STM TxStatus -&gt; STM PABResp
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TxStatus -&gt; TxId -&gt; BlockchainEnv -&gt; STM TxStatus
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#waitForTxStatusChange"><span class="hs-identifier hs-var">InstanceState.waitForTxStatusChange</span></a></span><span> </span><span class="annot"><span class="annottext">TxStatus
forall a. RollbackState a
</span><span class="hs-identifier hs-var">Unknown</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxId -&gt; TxId
</span><span class="hs-identifier hs-var">fromCardanoTxId</span></span><span> </span><span class="annot"><span class="annottext">TxId
</span><a href="#local-6989586621680273146"><span class="hs-identifier hs-var">txId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">BlockchainEnv
</span><a href="#local-6989586621680273145"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span>              </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621680273141"><span class="annot"><span class="annottext">IORef TCSIndex
</span><a href="#local-6989586621680273141"><span class="hs-identifier hs-var">ixRef</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-215"></span><span>                  </span><span id="local-6989586621680273140"><span class="annot"><span class="annottext">STM TxStatus
</span><a href="#local-6989586621680273140"><span class="hs-identifier hs-var">txStatus</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eff effs (STM TxStatus) -&gt; Eff (e : effs) (STM TxStatus)
forall (effs :: [* -&gt; *]) a (e :: * -&gt; *).
Eff effs a -&gt; Eff (e : effs) a
</span><span class="hs-identifier hs-var">raise</span></span><span> </span><span class="annot"><span class="annottext">(Eff effs (STM TxStatus) -&gt; Eff (e : effs) (STM TxStatus))
-&gt; (IO (STM TxStatus) -&gt; Eff effs (STM TxStatus))
-&gt; IO (STM TxStatus)
-&gt; Eff (e : effs) (STM TxStatus)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IO (STM TxStatus) -&gt; Eff effs (STM TxStatus)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (STM TxStatus) -&gt; Eff (e : effs) (STM TxStatus))
-&gt; IO (STM TxStatus) -&gt; Eff (e : effs) (STM TxStatus)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IORef TCSIndex -&gt; BlockchainEnv -&gt; TxId -&gt; IO (STM TxStatus)
</span><a href="Plutus.PAB.Core.ContractInstance.html#processTxStatusChangeRequestIO"><span class="hs-identifier hs-var">processTxStatusChangeRequestIO</span></a></span><span> </span><span class="annot"><span class="annottext">IORef TCSIndex
</span><a href="#local-6989586621680273141"><span class="hs-identifier hs-var">ixRef</span></a></span><span> </span><span class="annot"><span class="annottext">BlockchainEnv
</span><a href="#local-6989586621680273145"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxId -&gt; TxId
</span><span class="hs-identifier hs-var">fromCardanoTxId</span></span><span> </span><span class="annot"><span class="annottext">TxId
</span><a href="#local-6989586621680273146"><span class="hs-identifier hs-var">txId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-216"></span><span>                  </span><span class="annot"><span class="annottext">STM PABResp -&gt; Eff (e : effs) (STM PABResp)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxId -&gt; TxStatus -&gt; PABResp
</span><span class="hs-identifier hs-var">AwaitTxStatusChangeResp</span></span><span> </span><span class="annot"><span class="annottext">TxId
</span><a href="#local-6989586621680273146"><span class="hs-identifier hs-var">txId</span></a></span><span> </span><span class="annot"><span class="annottext">(TxStatus -&gt; PABResp) -&gt; STM TxStatus -&gt; STM PABResp
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">STM TxStatus
</span><a href="#local-6989586621680273140"><span class="hs-identifier hs-var">txStatus</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#processTxStatusChangeRequestIO"><span class="hs-identifier hs-type">processTxStatusChangeRequestIO</span></a></span><span>
</span><span id="line-219"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.Indexer.TxConfirmationStatus.html#TCSIndex"><span class="hs-identifier hs-type">TCSIndex</span></a></span><span>
</span><span id="line-220"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier hs-type">BlockchainEnv</span></a></span><span>
</span><span id="line-221"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TxId</span></span><span>
</span><span id="line-222"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TxStatus</span></span><span class="hs-special">)</span><span>
</span><span id="line-223"></span><span id="processTxStatusChangeRequestIO"><span class="annot"><span class="annottext">processTxStatusChangeRequestIO :: IORef TCSIndex -&gt; BlockchainEnv -&gt; TxId -&gt; IO (STM TxStatus)
</span><a href="Plutus.PAB.Core.ContractInstance.html#processTxStatusChangeRequestIO"><span class="hs-identifier hs-var hs-var">processTxStatusChangeRequestIO</span></a></span></span><span> </span><span id="local-6989586621680273138"><span class="annot"><span class="annottext">IORef TCSIndex
</span><a href="#local-6989586621680273138"><span class="hs-identifier hs-var">ixRef</span></a></span></span><span> </span><span id="local-6989586621680273137"><span class="annot"><span class="annottext">BlockchainEnv
</span><a href="#local-6989586621680273137"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621680273136"><span class="annot"><span class="annottext">TxId
</span><a href="#local-6989586621680273136"><span class="hs-identifier hs-var">txId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-224"></span><span>    </span><span id="local-6989586621680273135"><span class="annot"><span class="annottext">TCSIndex
</span><a href="#local-6989586621680273135"><span class="hs-identifier hs-var">ix</span></a></span></span><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef TCSIndex -&gt; IO TCSIndex
forall a. IORef a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">readIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef TCSIndex
</span><a href="#local-6989586621680273138"><span class="hs-identifier hs-var">ixRef</span></a></span><span>
</span><span id="line-225"></span><span>    </span><span id="local-6989586621680273134"><span class="annot"><span class="annottext">BlockNumber
</span><a href="#local-6989586621680273134"><span class="hs-identifier hs-var">_blockNumber</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar BlockNumber -&gt; IO BlockNumber
forall a. TVar a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.readTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">(TVar BlockNumber -&gt; IO BlockNumber)
-&gt; TVar BlockNumber -&gt; IO BlockNumber
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">BlockchainEnv -&gt; TVar BlockNumber
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#beLastSyncedBlockNo"><span class="hs-identifier hs-var hs-var">InstanceState.beLastSyncedBlockNo</span></a></span><span> </span><span class="annot"><span class="annottext">BlockchainEnv
</span><a href="#local-6989586621680273137"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-226"></span><span>    </span><span id="local-6989586621680273131"><span class="annot"><span class="annottext">[Event]
</span><a href="#local-6989586621680273131"><span class="hs-identifier hs-var">events</span></a></span></span><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Storage Vector IO Event -&gt; IO [Event]
forall (v :: * -&gt; *) (m :: * -&gt; *) e.
(MVector (Mutable v) e, PrimMonad m, Show e) =&gt;
Storage v m e -&gt; m [e]
</span><span class="hs-identifier hs-var">Ix.getEvents</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TCSIndex
</span><a href="#local-6989586621680273135"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">TCSIndex
-&gt; Getting
     (Storage Vector IO Event) TCSIndex (Storage Vector IO Event)
-&gt; Storage Vector IO Event
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting
  (Storage Vector IO Event) TCSIndex (Storage Vector IO Event)
forall (m :: * -&gt; *) h (v :: * -&gt; *) e n q r.
Lens' (SplitIndex m h v e n q r) (Storage v m e)
</span><span class="hs-identifier hs-var">Ix.storage</span></span><span class="hs-special">)</span><span>
</span><span id="line-227"></span><span>    </span><span id="local-6989586621680273127"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621680273127"><span class="hs-identifier hs-var">queryResult</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TCSIndex
</span><a href="#local-6989586621680273135"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">TCSIndex
-&gt; Getting
     (TCSIndex -&gt; TxId -&gt; [Event] -&gt; IO Result)
     TCSIndex
     (TCSIndex -&gt; TxId -&gt; [Event] -&gt; IO Result)
-&gt; TCSIndex
-&gt; TxId
-&gt; [Event]
-&gt; IO Result
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting
  (TCSIndex -&gt; TxId -&gt; [Event] -&gt; IO Result)
  TCSIndex
  (TCSIndex -&gt; TxId -&gt; [Event] -&gt; IO Result)
forall (m :: * -&gt; *) h (v :: * -&gt; *) e n q r.
Lens'
  (SplitIndex m h v e n q r)
  (SplitIndex m h v e n q r -&gt; q -&gt; [e] -&gt; m r)
</span><span class="hs-identifier hs-var">Ix.query</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TCSIndex
</span><a href="#local-6989586621680273135"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">TxId
</span><a href="#local-6989586621680273136"><span class="hs-identifier hs-var">txId</span></a></span><span> </span><span class="annot"><span class="annottext">[Event]
</span><a href="#local-6989586621680273131"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-228"></span><span>    </span><span class="annot"><span class="annottext">STM TxStatus -&gt; IO (STM TxStatus)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(STM TxStatus -&gt; IO (STM TxStatus))
-&gt; (TxStatus -&gt; STM TxStatus) -&gt; TxStatus -&gt; IO (STM TxStatus)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TxStatus -&gt; STM TxStatus
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(TxStatus -&gt; IO (STM TxStatus)) -&gt; TxStatus -&gt; IO (STM TxStatus)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621680273127"><span class="hs-identifier hs-var">queryResult</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-229"></span><span>        </span><span class="hs-comment">-- On this branch the transaction has not yet been indexed. This means</span><span>
</span><span id="line-230"></span><span>        </span><span class="hs-comment">-- that the transaction status has not changed from `Unknown` which is</span><span>
</span><span id="line-231"></span><span>        </span><span class="hs-comment">-- why we wait and re-poll.</span><span>
</span><span id="line-232"></span><span>        </span><span class="annot"><span class="annottext">Result
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TxStatus
forall a. RollbackState a
</span><span class="hs-identifier hs-var">Unknown</span></span><span>
</span><span id="line-233"></span><span>        </span><span class="hs-comment">-- If we get any kind of update we can return. Due to the way the indexer</span><span>
</span><span id="line-234"></span><span>        </span><span class="hs-comment">-- works we can compute if the tx has been confirmed or not.</span><span>
</span><span id="line-235"></span><span>        </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TxConfirmedState</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Sum</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Last BlockNumber
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Last TxValidity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TxValidity -&gt; () -&gt; TxStatus
forall a. TxValidity -&gt; a -&gt; RollbackState a
</span><span class="hs-identifier hs-var">Committed</span></span><span> </span><span class="annot"><span class="annottext">TxValidity
</span><span class="hs-identifier hs-var">TxValid</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-236"></span><span>        </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TxConfirmedState</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Sum</span></a></span><span> </span><span id="local-6989586621680273122"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680273122"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Last BlockNumber
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Last TxValidity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-237"></span><span>            </span><span class="annot"><span class="annottext">Depth -&gt; TxValidity -&gt; () -&gt; TxStatus
forall a. Depth -&gt; TxValidity -&gt; a -&gt; RollbackState a
</span><span class="hs-identifier hs-var">TentativelyConfirmed</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Depth
</span><span class="hs-identifier hs-var">Depth</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680273122"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TxValidity
</span><span class="hs-identifier hs-var">TxValid</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#processTxOutStatusChangeRequestsSTM"><span class="hs-identifier hs-type">processTxOutStatusChangeRequestsSTM</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-240"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680273335"><span class="annot"><a href="#local-6989586621680273335"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680273334"><span class="annot"><a href="#local-6989586621680273334"><span class="hs-identifier hs-type">effs</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-241"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LastMember</span></span><span> </span><span class="annot"><a href="#local-6989586621680273335"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273334"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-242"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273335"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-243"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier hs-type">BlockchainEnv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273334"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-244"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">RequestHandler</span></span><span> </span><span class="annot"><a href="#local-6989586621680273334"><span class="hs-identifier hs-type">effs</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PABReq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PABResp</span></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span id="processTxOutStatusChangeRequestsSTM"><span class="annot"><span class="annottext">processTxOutStatusChangeRequestsSTM :: RequestHandler effs PABReq (STM PABResp)
</span><a href="Plutus.PAB.Core.ContractInstance.html#processTxOutStatusChangeRequestsSTM"><span class="hs-identifier hs-var hs-var">processTxOutStatusChangeRequestsSTM</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-247"></span><span>    </span><span class="annot"><span class="annottext">(PABReq -&gt; Maybe TxIn) -&gt; RequestHandler effs PABReq TxIn
forall req resp (effs :: [* -&gt; *]).
(req -&gt; Maybe resp) -&gt; RequestHandler effs req resp
</span><span class="hs-identifier hs-var">maybeToHandler</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Prism' PABReq TxIn -&gt; PABReq -&gt; Maybe TxIn
forall (f :: * -&gt; *) a b. Alternative f =&gt; Prism' a b -&gt; a -&gt; f b
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Prism' PABReq TxIn
</span><span class="hs-identifier hs-var">Contract.Effects._AwaitTxOutStatusChangeReq</span></span><span class="hs-special">)</span><span>
</span><span id="line-248"></span><span>    </span><span class="annot"><span class="annottext">RequestHandler effs PABReq TxIn
-&gt; RequestHandler effs TxIn (STM PABResp)
-&gt; RequestHandler effs PABReq (STM PABResp)
forall k (cat :: k -&gt; k -&gt; *) (a :: k) (b :: k) (c :: k).
Category cat =&gt;
cat a b -&gt; cat b c -&gt; cat a c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(TxIn -&gt; Eff (NonDet : effs) (STM PABResp))
-&gt; RequestHandler effs TxIn (STM PABResp)
forall (effs :: [* -&gt; *]) req resp.
(req -&gt; Eff (NonDet : effs) resp) -&gt; RequestHandler effs req resp
</span><span class="hs-identifier hs-var">RequestHandler</span></span><span> </span><span class="annot"><span class="annottext">TxIn -&gt; Eff (NonDet : effs) (STM PABResp)
forall (e :: * -&gt; *) (effs :: [* -&gt; *]) (m :: * -&gt; *).
(IfNotFound (Reader BlockchainEnv) (e : effs) (e : effs),
 MonadIO m, LastMember m effs,
 FindElem (Reader BlockchainEnv) (e : effs)) =&gt;
TxIn -&gt; Eff (e : effs) (STM PABResp)
</span><a href="#local-6989586621680273117"><span class="hs-identifier hs-var">handler</span></a></span><span>
</span><span id="line-249"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-250"></span><span>        </span><span id="local-6989586621680273117"><span class="annot"><span class="annottext">handler :: TxIn -&gt; Eff (e : effs) (STM PABResp)
</span><a href="#local-6989586621680273117"><span class="hs-identifier hs-var hs-var">handler</span></a></span></span><span> </span><span id="local-6989586621680273116"><span class="annot"><span class="annottext">TxIn
</span><a href="#local-6989586621680273116"><span class="hs-identifier hs-var">txOutRef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-251"></span><span>            </span><span id="local-6989586621680273115"><span class="annot"><span class="annottext">BlockchainEnv
</span><a href="#local-6989586621680273115"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eff (e : effs) BlockchainEnv
forall r (effs :: [* -&gt; *]). Member (Reader r) effs =&gt; Eff effs r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-252"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">BlockchainEnv
-&gt; Either (TVar (UtxoIndex TxIdState)) (IORef TCSIndex)
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#beTxChanges"><span class="hs-identifier hs-var hs-var">InstanceState.beTxChanges</span></a></span><span> </span><span class="annot"><span class="annottext">BlockchainEnv
</span><a href="#local-6989586621680273115"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-253"></span><span>              </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (UtxoIndex TxIdState)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-254"></span><span>                </span><span class="annot"><span class="annottext">STM PABResp -&gt; Eff (e : effs) (STM PABResp)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxIn -&gt; TxOutStatus -&gt; PABResp
</span><span class="hs-identifier hs-var">AwaitTxOutStatusChangeResp</span></span><span> </span><span class="annot"><span class="annottext">TxIn
</span><a href="#local-6989586621680273116"><span class="hs-identifier hs-var">txOutRef</span></a></span><span> </span><span class="annot"><span class="annottext">(TxOutStatus -&gt; PABResp) -&gt; STM TxOutStatus -&gt; STM PABResp
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TxOutStatus -&gt; TxOutRef -&gt; BlockchainEnv -&gt; STM TxOutStatus
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#waitForTxOutStatusChange"><span class="hs-identifier hs-var">InstanceState.waitForTxOutStatusChange</span></a></span><span> </span><span class="annot"><span class="annottext">TxOutStatus
forall a. RollbackState a
</span><span class="hs-identifier hs-var">Unknown</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxIn -&gt; TxOutRef
</span><span class="hs-identifier hs-var">fromCardanoTxIn</span></span><span> </span><span class="annot"><span class="annottext">TxIn
</span><a href="#local-6989586621680273116"><span class="hs-identifier hs-var">txOutRef</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">BlockchainEnv
</span><a href="#local-6989586621680273115"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>              </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621680273113"><span class="annot"><span class="annottext">IORef TCSIndex
</span><a href="#local-6989586621680273113"><span class="hs-identifier hs-var">txChange</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-256"></span><span>                 </span><span id="local-6989586621680273112"><span class="annot"><span class="annottext">STM TxOutStatus
</span><a href="#local-6989586621680273112"><span class="hs-identifier hs-var">txOutStatus</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eff effs (STM TxOutStatus) -&gt; Eff (e : effs) (STM TxOutStatus)
forall (effs :: [* -&gt; *]) a (e :: * -&gt; *).
Eff effs a -&gt; Eff (e : effs) a
</span><span class="hs-identifier hs-var">raise</span></span><span> </span><span class="annot"><span class="annottext">(Eff effs (STM TxOutStatus) -&gt; Eff (e : effs) (STM TxOutStatus))
-&gt; (IO (STM TxOutStatus) -&gt; Eff effs (STM TxOutStatus))
-&gt; IO (STM TxOutStatus)
-&gt; Eff (e : effs) (STM TxOutStatus)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IO (STM TxOutStatus) -&gt; Eff effs (STM TxOutStatus)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (STM TxOutStatus) -&gt; Eff (e : effs) (STM TxOutStatus))
-&gt; IO (STM TxOutStatus) -&gt; Eff (e : effs) (STM TxOutStatus)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IORef TCSIndex -&gt; BlockchainEnv -&gt; TxOutRef -&gt; IO (STM TxOutStatus)
</span><a href="Plutus.PAB.Core.ContractInstance.html#processTxOutStatusChangeRequestsIO"><span class="hs-identifier hs-var">processTxOutStatusChangeRequestsIO</span></a></span><span> </span><span class="annot"><span class="annottext">IORef TCSIndex
</span><a href="#local-6989586621680273113"><span class="hs-identifier hs-var">txChange</span></a></span><span> </span><span class="annot"><span class="annottext">BlockchainEnv
</span><a href="#local-6989586621680273115"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxIn -&gt; TxOutRef
</span><span class="hs-identifier hs-var">fromCardanoTxIn</span></span><span> </span><span class="annot"><span class="annottext">TxIn
</span><a href="#local-6989586621680273116"><span class="hs-identifier hs-var">txOutRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-257"></span><span>                 </span><span class="annot"><span class="annottext">STM PABResp -&gt; Eff (e : effs) (STM PABResp)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxIn -&gt; TxOutStatus -&gt; PABResp
</span><span class="hs-identifier hs-var">AwaitTxOutStatusChangeResp</span></span><span> </span><span class="annot"><span class="annottext">TxIn
</span><a href="#local-6989586621680273116"><span class="hs-identifier hs-var">txOutRef</span></a></span><span> </span><span class="annot"><span class="annottext">(TxOutStatus -&gt; PABResp) -&gt; STM TxOutStatus -&gt; STM PABResp
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">STM TxOutStatus
</span><a href="#local-6989586621680273112"><span class="hs-identifier hs-var">txOutStatus</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#processTxOutStatusChangeRequestsIO"><span class="hs-identifier hs-type">processTxOutStatusChangeRequestsIO</span></a></span><span>
</span><span id="line-260"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.Indexer.TxConfirmationStatus.html#TCSIndex"><span class="hs-identifier hs-type">TCSIndex</span></a></span><span>
</span><span id="line-261"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier hs-type">BlockchainEnv</span></a></span><span>
</span><span id="line-262"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TxOutRef</span></span><span>
</span><span id="line-263"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TxOutStatus</span></span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span id="processTxOutStatusChangeRequestsIO"><span class="annot"><span class="annottext">processTxOutStatusChangeRequestsIO :: IORef TCSIndex -&gt; BlockchainEnv -&gt; TxOutRef -&gt; IO (STM TxOutStatus)
</span><a href="Plutus.PAB.Core.ContractInstance.html#processTxOutStatusChangeRequestsIO"><span class="hs-identifier hs-var hs-var">processTxOutStatusChangeRequestsIO</span></a></span></span><span> </span><span id="local-6989586621680273110"><span class="annot"><span class="annottext">IORef TCSIndex
</span><a href="#local-6989586621680273110"><span class="hs-identifier hs-var">tcsIx</span></a></span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier hs-type">BlockchainEnv</span></a></span><span class="hs-special">{</span><span id="local-6989586621680273108"><span class="annot"><span class="annottext">TVar (UtxoIndex TxOutBalance)
beTxOutChanges :: BlockchainEnv -&gt; TVar (UtxoIndex TxOutBalance)
beTxOutChanges :: TVar (UtxoIndex TxOutBalance)
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#beTxOutChanges"><span class="hs-identifier hs-var hs-var">beTxOutChanges</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680273106"><span class="annot"><span class="annottext">TxOutRef
</span><a href="#local-6989586621680273106"><span class="hs-identifier hs-var">txOutRef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-265"></span><span>  </span><span id="local-6989586621680273105"><span class="annot"><span class="annottext">TxOutBalance
</span><a href="#local-6989586621680273105"><span class="hs-identifier hs-var">txOutBalance</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UtxoState TxOutBalance -&gt; TxOutBalance
forall a. UtxoState a -&gt; a
</span><span class="hs-identifier hs-var hs-var">_usTxUtxoData</span></span><span> </span><span class="annot"><span class="annottext">(UtxoState TxOutBalance -&gt; TxOutBalance)
-&gt; (UtxoIndex TxOutBalance -&gt; UtxoState TxOutBalance)
-&gt; UtxoIndex TxOutBalance
-&gt; TxOutBalance
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">UtxoIndex TxOutBalance -&gt; UtxoState TxOutBalance
forall a. Monoid a =&gt; UtxoIndex a -&gt; UtxoState a
</span><span class="hs-identifier hs-var">utxoState</span></span><span> </span><span class="annot"><span class="annottext">(UtxoIndex TxOutBalance -&gt; TxOutBalance)
-&gt; IO (UtxoIndex TxOutBalance) -&gt; IO TxOutBalance
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">STM (UtxoIndex TxOutBalance) -&gt; IO (UtxoIndex TxOutBalance)
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.atomically</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar (UtxoIndex TxOutBalance) -&gt; STM (UtxoIndex TxOutBalance)
forall a. TVar a -&gt; STM a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (UtxoIndex TxOutBalance)
</span><a href="#local-6989586621680273108"><span class="hs-identifier hs-var">beTxOutChanges</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TxOutBalance -&gt; TxOutRef -&gt; Maybe TxOutState
</span><span class="hs-identifier hs-var">transactionOutputState</span></span><span> </span><span class="annot"><span class="annottext">TxOutBalance
</span><a href="#local-6989586621680273105"><span class="hs-identifier hs-var">txOutBalance</span></a></span><span> </span><span class="annot"><span class="annottext">TxOutRef
</span><a href="#local-6989586621680273106"><span class="hs-identifier hs-var">txOutRef</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-267"></span><span>    </span><span class="annot"><span class="annottext">Maybe TxOutState
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM TxOutStatus -&gt; IO (STM TxOutStatus)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">STM TxOutStatus
forall (f :: * -&gt; *) a. Alternative f =&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">empty</span></a></span><span>
</span><span id="line-268"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621680273102"><span class="annot"><span class="annottext">s :: TxOutState
</span><a href="#local-6989586621680273102"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Spent</span></span><span> </span><span id="local-6989586621680273100"><span class="annot"><span class="annottext">TxId
</span><a href="#local-6989586621680273100"><span class="hs-identifier hs-var">txId</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TxOutState -&gt; TxId -&gt; IO (STM TxOutStatus)
</span><a href="#local-6989586621680273099"><span class="hs-identifier hs-var">queryTx</span></a></span><span> </span><span class="annot"><span class="annottext">TxOutState
</span><a href="#local-6989586621680273102"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">TxId
</span><a href="#local-6989586621680273100"><span class="hs-identifier hs-var">txId</span></a></span><span>
</span><span id="line-269"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621680273098"><span class="annot"><span class="annottext">s :: TxOutState
</span><a href="#local-6989586621680273098"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">TxOutState
</span><span class="hs-identifier hs-var">Unspent</span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TxOutState -&gt; TxId -&gt; IO (STM TxOutStatus)
</span><a href="#local-6989586621680273099"><span class="hs-identifier hs-var">queryTx</span></a></span><span> </span><span class="annot"><span class="annottext">TxOutState
</span><a href="#local-6989586621680273098"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">(TxId -&gt; IO (STM TxOutStatus)) -&gt; TxId -&gt; IO (STM TxOutStatus)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TxOutRef -&gt; TxId
</span><span class="hs-identifier hs-var hs-var">txOutRefId</span></span><span> </span><span class="annot"><span class="annottext">TxOutRef
</span><a href="#local-6989586621680273106"><span class="hs-identifier hs-var">txOutRef</span></a></span><span>
</span><span id="line-270"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-271"></span><span>    </span><span class="annot"><a href="#local-6989586621680273099"><span class="hs-identifier hs-type">queryTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TxOutState</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TxId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TxOutStatus</span></span><span class="hs-special">)</span><span>
</span><span id="line-272"></span><span>    </span><span id="local-6989586621680273099"><span class="annot"><span class="annottext">queryTx :: TxOutState -&gt; TxId -&gt; IO (STM TxOutStatus)
</span><a href="#local-6989586621680273099"><span class="hs-identifier hs-var hs-var">queryTx</span></a></span></span><span> </span><span id="local-6989586621680273095"><span class="annot"><span class="annottext">TxOutState
</span><a href="#local-6989586621680273095"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621680273094"><span class="annot"><span class="annottext">TxId
</span><a href="#local-6989586621680273094"><span class="hs-identifier hs-var">txId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-273"></span><span>      </span><span id="local-6989586621680273093"><span class="annot"><span class="annottext">TCSIndex
</span><a href="#local-6989586621680273093"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef TCSIndex -&gt; IO TCSIndex
forall a. IORef a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">readIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef TCSIndex
</span><a href="#local-6989586621680273110"><span class="hs-identifier hs-var">tcsIx</span></a></span><span>
</span><span id="line-274"></span><span>      </span><span id="local-6989586621680273092"><span class="annot"><span class="annottext">[Event]
</span><a href="#local-6989586621680273092"><span class="hs-identifier hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Storage Vector IO Event -&gt; IO [Event]
forall (v :: * -&gt; *) (m :: * -&gt; *) e.
(MVector (Mutable v) e, PrimMonad m, Show e) =&gt;
Storage v m e -&gt; m [e]
</span><span class="hs-identifier hs-var">Ix.getEvents</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TCSIndex
</span><a href="#local-6989586621680273093"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">TCSIndex
-&gt; Getting
     (Storage Vector IO Event) TCSIndex (Storage Vector IO Event)
-&gt; Storage Vector IO Event
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting
  (Storage Vector IO Event) TCSIndex (Storage Vector IO Event)
forall (m :: * -&gt; *) h (v :: * -&gt; *) e n q r.
Lens' (SplitIndex m h v e n q r) (Storage v m e)
</span><span class="hs-identifier hs-var">Ix.storage</span></span><span class="hs-special">)</span><span>
</span><span id="line-275"></span><span>      </span><span id="local-6989586621680273091"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621680273091"><span class="hs-identifier hs-var">queryResult</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TCSIndex
</span><a href="#local-6989586621680273093"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">TCSIndex
-&gt; Getting
     (TCSIndex -&gt; TxId -&gt; [Event] -&gt; IO Result)
     TCSIndex
     (TCSIndex -&gt; TxId -&gt; [Event] -&gt; IO Result)
-&gt; TCSIndex
-&gt; TxId
-&gt; [Event]
-&gt; IO Result
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting
  (TCSIndex -&gt; TxId -&gt; [Event] -&gt; IO Result)
  TCSIndex
  (TCSIndex -&gt; TxId -&gt; [Event] -&gt; IO Result)
forall (m :: * -&gt; *) h (v :: * -&gt; *) e n q r.
Lens'
  (SplitIndex m h v e n q r)
  (SplitIndex m h v e n q r -&gt; q -&gt; [e] -&gt; m r)
</span><span class="hs-identifier hs-var">Ix.query</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TCSIndex
</span><a href="#local-6989586621680273093"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">TxId
</span><a href="#local-6989586621680273094"><span class="hs-identifier hs-var">txId</span></a></span><span> </span><span class="annot"><span class="annottext">[Event]
</span><a href="#local-6989586621680273092"><span class="hs-identifier hs-var">events</span></a></span><span>
</span><span id="line-276"></span><span>      </span><span class="annot"><span class="annottext">STM TxOutStatus -&gt; IO (STM TxOutStatus)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(STM TxOutStatus -&gt; IO (STM TxOutStatus))
-&gt; (TxOutStatus -&gt; STM TxOutStatus)
-&gt; TxOutStatus
-&gt; IO (STM TxOutStatus)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TxOutStatus -&gt; STM TxOutStatus
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(TxOutStatus -&gt; IO (STM TxOutStatus))
-&gt; TxOutStatus -&gt; IO (STM TxOutStatus)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621680273091"><span class="hs-identifier hs-var">queryResult</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-277"></span><span>        </span><span class="annot"><span class="annottext">Result
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TxOutStatus
forall a. RollbackState a
</span><span class="hs-identifier hs-var">Unknown</span></span><span>
</span><span id="line-278"></span><span>        </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TxConfirmedState</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Sum</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Last BlockNumber
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Last TxValidity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TxValidity -&gt; TxOutState -&gt; TxOutStatus
forall a. TxValidity -&gt; a -&gt; RollbackState a
</span><span class="hs-identifier hs-var">Committed</span></span><span> </span><span class="annot"><span class="annottext">TxValidity
</span><span class="hs-identifier hs-var">TxValid</span></span><span> </span><span class="annot"><span class="annottext">TxOutState
</span><a href="#local-6989586621680273095"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-279"></span><span>        </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TxConfirmedState</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Sum</span></a></span><span> </span><span id="local-6989586621680273090"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680273090"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Last BlockNumber
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Last TxValidity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-280"></span><span>          </span><span class="annot"><span class="annottext">Depth -&gt; TxValidity -&gt; TxOutState -&gt; TxOutStatus
forall a. Depth -&gt; TxValidity -&gt; a -&gt; RollbackState a
</span><span class="hs-identifier hs-var">TentativelyConfirmed</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Depth
</span><span class="hs-identifier hs-var">Depth</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680273090"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TxValidity
</span><span class="hs-identifier hs-var">TxValid</span></span><span> </span><span class="annot"><span class="annottext">TxOutState
</span><a href="#local-6989586621680273095"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-281"></span><span>
</span><span id="line-282"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#processUtxoSpentRequestsSTM"><span class="hs-identifier hs-type">processUtxoSpentRequestsSTM</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-283"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680273088"><span class="annot"><a href="#local-6989586621680273088"><span class="hs-identifier hs-type">effs</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-284"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273088"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-285"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-286"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">RequestHandler</span></span><span> </span><span class="annot"><a href="#local-6989586621680273088"><span class="hs-identifier hs-type">effs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Request</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PABReq</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Response</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PABResp</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span id="processUtxoSpentRequestsSTM"><span class="annot"><span class="annottext">processUtxoSpentRequestsSTM :: RequestHandler effs (Request PABReq) (Response (STM PABResp))
</span><a href="Plutus.PAB.Core.ContractInstance.html#processUtxoSpentRequestsSTM"><span class="hs-identifier hs-var hs-var">processUtxoSpentRequestsSTM</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Request PABReq -&gt; Eff (NonDet : effs) (Response (STM PABResp)))
-&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp))
forall (effs :: [* -&gt; *]) req resp.
(req -&gt; Eff (NonDet : effs) resp) -&gt; RequestHandler effs req resp
</span><span class="hs-identifier hs-var">RequestHandler</span></span><span> </span><span class="annot"><span class="annottext">((Request PABReq -&gt; Eff (NonDet : effs) (Response (STM PABResp)))
 -&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp)))
-&gt; (Request PABReq -&gt; Eff (NonDet : effs) (Response (STM PABResp)))
-&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680273087"><span class="annot"><span class="annottext">Request PABReq
</span><a href="#local-6989586621680273087"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-288"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(PABReq -&gt; Maybe TxIn) -&gt; Request PABReq -&gt; Maybe (Request TxIn)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Getting (First TxIn) PABReq TxIn -&gt; PABReq -&gt; Maybe TxIn
forall s (m :: * -&gt; *) a.
MonadReader s m =&gt;
Getting (First a) s a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var">preview</span></span><span> </span><span class="annot"><span class="annottext">Getting (First TxIn) PABReq TxIn
Prism' PABReq TxIn
</span><span class="hs-identifier hs-var">Contract.Effects._AwaitUtxoSpentReq</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Request PABReq
</span><a href="#local-6989586621680273087"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-289"></span><span>        </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621680273084"><span class="annot"><span class="annottext">request :: Request TxIn
</span><a href="#local-6989586621680273084"><span class="hs-identifier hs-var">request</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">Request</span></span><span class="hs-special">{</span><span id="local-6989586621680273083"><span class="annot"><span class="annottext">RequestID
rqID :: RequestID
rqID :: forall o. Request o -&gt; RequestID
</span><a href="#local-6989586621680273083"><span class="hs-identifier hs-var hs-var">rqID</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680273082"><span class="annot"><span class="annottext">IterationID
itID :: IterationID
itID :: forall o. Request o -&gt; IterationID
</span><a href="#local-6989586621680273082"><span class="hs-identifier hs-var hs-var">itID</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-290"></span><span>            </span><span id="local-6989586621680273081"><span class="annot"><span class="annottext">InstanceState
</span><a href="#local-6989586621680273081"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eff (NonDet : effs) InstanceState
forall r (effs :: [* -&gt; *]). Member (Reader r) effs =&gt; Eff effs r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-291"></span><span>            </span><span class="annot"><span class="annottext">Response (STM PABResp)
-&gt; Eff (NonDet : effs) (Response (STM PABResp))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Response (STM PABResp)
 -&gt; Eff (NonDet : effs) (Response (STM PABResp)))
-&gt; Response (STM PABResp)
-&gt; Eff (NonDet : effs) (Response (STM PABResp))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RequestID -&gt; IterationID -&gt; STM PABResp -&gt; Response (STM PABResp)
forall i. RequestID -&gt; IterationID -&gt; i -&gt; Response i
</span><span class="hs-identifier hs-var">Response</span></span><span> </span><span class="annot"><span class="annottext">RequestID
</span><a href="#local-6989586621680273083"><span class="hs-identifier hs-var">rqID</span></a></span><span> </span><span class="annot"><span class="annottext">IterationID
</span><a href="#local-6989586621680273082"><span class="hs-identifier hs-var">itID</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainIndexTx -&gt; PABResp
</span><span class="hs-identifier hs-var">AwaitUtxoSpentResp</span></span><span> </span><span class="annot"><span class="annottext">(ChainIndexTx -&gt; PABResp) -&gt; STM ChainIndexTx -&gt; STM PABResp
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Request TxOutRef -&gt; InstanceState -&gt; STM ChainIndexTx
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#waitForUtxoSpent"><span class="hs-identifier hs-var">InstanceState.waitForUtxoSpent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TxIn -&gt; TxOutRef) -&gt; Request TxIn -&gt; Request TxOutRef
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">TxIn -&gt; TxOutRef
</span><span class="hs-identifier hs-var">fromCardanoTxIn</span></span><span> </span><span class="annot"><span class="annottext">Request TxIn
</span><a href="#local-6989586621680273084"><span class="hs-identifier hs-var">request</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InstanceState
</span><a href="#local-6989586621680273081"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-292"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Request TxIn)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Eff (NonDet : effs) (Response (STM PABResp))
forall (f :: * -&gt; *) a. Alternative f =&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">empty</span></a></span><span>
</span><span id="line-293"></span><span>
</span><span id="line-294"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#processUtxoProducedRequestsSTM"><span class="hs-identifier hs-type">processUtxoProducedRequestsSTM</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-295"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680273078"><span class="annot"><a href="#local-6989586621680273078"><span class="hs-identifier hs-type">effs</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-296"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273078"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-297"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-298"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">RequestHandler</span></span><span> </span><span class="annot"><a href="#local-6989586621680273078"><span class="hs-identifier hs-type">effs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Request</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PABReq</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Response</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PABResp</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-299"></span><span id="processUtxoProducedRequestsSTM"><span class="annot"><span class="annottext">processUtxoProducedRequestsSTM :: RequestHandler effs (Request PABReq) (Response (STM PABResp))
</span><a href="Plutus.PAB.Core.ContractInstance.html#processUtxoProducedRequestsSTM"><span class="hs-identifier hs-var hs-var">processUtxoProducedRequestsSTM</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Request PABReq -&gt; Eff (NonDet : effs) (Response (STM PABResp)))
-&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp))
forall (effs :: [* -&gt; *]) req resp.
(req -&gt; Eff (NonDet : effs) resp) -&gt; RequestHandler effs req resp
</span><span class="hs-identifier hs-var">RequestHandler</span></span><span> </span><span class="annot"><span class="annottext">((Request PABReq -&gt; Eff (NonDet : effs) (Response (STM PABResp)))
 -&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp)))
-&gt; (Request PABReq -&gt; Eff (NonDet : effs) (Response (STM PABResp)))
-&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680273077"><span class="annot"><span class="annottext">Request PABReq
</span><a href="#local-6989586621680273077"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-300"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(PABReq -&gt; Maybe CardanoAddress)
-&gt; Request PABReq -&gt; Maybe (Request CardanoAddress)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Getting (First CardanoAddress) PABReq CardanoAddress
-&gt; PABReq -&gt; Maybe CardanoAddress
forall s (m :: * -&gt; *) a.
MonadReader s m =&gt;
Getting (First a) s a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var">preview</span></span><span> </span><span class="annot"><span class="annottext">Getting (First CardanoAddress) PABReq CardanoAddress
Prism' PABReq CardanoAddress
</span><span class="hs-identifier hs-var">Contract.Effects._AwaitUtxoProducedReq</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Request PABReq
</span><a href="#local-6989586621680273077"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-301"></span><span>        </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621680273075"><span class="annot"><span class="annottext">request :: Request CardanoAddress
</span><a href="#local-6989586621680273075"><span class="hs-identifier hs-var">request</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">Request</span></span><span class="hs-special">{</span><span id="local-6989586621680273074"><span class="annot"><span class="annottext">RequestID
rqID :: RequestID
rqID :: forall o. Request o -&gt; RequestID
</span><a href="#local-6989586621680273074"><span class="hs-identifier hs-var hs-var">rqID</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680273073"><span class="annot"><span class="annottext">IterationID
itID :: IterationID
itID :: forall o. Request o -&gt; IterationID
</span><a href="#local-6989586621680273073"><span class="hs-identifier hs-var hs-var">itID</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-302"></span><span>            </span><span id="local-6989586621680273072"><span class="annot"><span class="annottext">InstanceState
</span><a href="#local-6989586621680273072"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eff (NonDet : effs) InstanceState
forall r (effs :: [* -&gt; *]). Member (Reader r) effs =&gt; Eff effs r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-303"></span><span>            </span><span class="annot"><span class="annottext">Response (STM PABResp)
-&gt; Eff (NonDet : effs) (Response (STM PABResp))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Response (STM PABResp)
 -&gt; Eff (NonDet : effs) (Response (STM PABResp)))
-&gt; Response (STM PABResp)
-&gt; Eff (NonDet : effs) (Response (STM PABResp))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RequestID -&gt; IterationID -&gt; STM PABResp -&gt; Response (STM PABResp)
forall i. RequestID -&gt; IterationID -&gt; i -&gt; Response i
</span><span class="hs-identifier hs-var">Response</span></span><span> </span><span class="annot"><span class="annottext">RequestID
</span><a href="#local-6989586621680273074"><span class="hs-identifier hs-var">rqID</span></a></span><span> </span><span class="annot"><span class="annottext">IterationID
</span><a href="#local-6989586621680273073"><span class="hs-identifier hs-var">itID</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty ChainIndexTx -&gt; PABResp
</span><span class="hs-identifier hs-var">AwaitUtxoProducedResp</span></span><span> </span><span class="annot"><span class="annottext">(NonEmpty ChainIndexTx -&gt; PABResp)
-&gt; STM (NonEmpty ChainIndexTx) -&gt; STM PABResp
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Request CardanoAddress
-&gt; InstanceState -&gt; STM (NonEmpty ChainIndexTx)
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#waitForUtxoProduced"><span class="hs-identifier hs-var">InstanceState.waitForUtxoProduced</span></a></span><span> </span><span class="annot"><span class="annottext">Request CardanoAddress
</span><a href="#local-6989586621680273075"><span class="hs-identifier hs-var">request</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceState
</span><a href="#local-6989586621680273072"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Request CardanoAddress)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Eff (NonDet : effs) (Response (STM PABResp))
forall (f :: * -&gt; *) a. Alternative f =&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">empty</span></a></span><span>
</span><span id="line-305"></span><span>
</span><span id="line-306"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#processEndpointRequestsSTM"><span class="hs-identifier hs-type">processEndpointRequestsSTM</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-307"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680273333"><span class="annot"><a href="#local-6989586621680273333"><span class="hs-identifier hs-type">effs</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-308"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273333"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-309"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-310"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">RequestHandler</span></span><span> </span><span class="annot"><a href="#local-6989586621680273333"><span class="hs-identifier hs-type">effs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Request</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PABReq</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Response</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PABResp</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-311"></span><span id="processEndpointRequestsSTM"><span class="annot"><span class="annottext">processEndpointRequestsSTM :: RequestHandler effs (Request PABReq) (Response (STM PABResp))
</span><a href="Plutus.PAB.Core.ContractInstance.html#processEndpointRequestsSTM"><span class="hs-identifier hs-var hs-var">processEndpointRequestsSTM</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-312"></span><span>    </span><span class="annot"><span class="annottext">(Request PABReq -&gt; Maybe (Request ActiveEndpoint))
-&gt; RequestHandler effs (Request PABReq) (Request ActiveEndpoint)
forall req resp (effs :: [* -&gt; *]).
(req -&gt; Maybe resp) -&gt; RequestHandler effs req resp
</span><span class="hs-identifier hs-var">maybeToHandler</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PABReq -&gt; Maybe ActiveEndpoint)
-&gt; Request PABReq -&gt; Maybe (Request ActiveEndpoint)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Prism' PABReq ActiveEndpoint -&gt; PABReq -&gt; Maybe ActiveEndpoint
forall (f :: * -&gt; *) a b. Alternative f =&gt; Prism' a b -&gt; a -&gt; f b
</span><span class="hs-identifier hs-var">extract</span></span><span> </span><span class="annot"><span class="annottext">Prism' PABReq ActiveEndpoint
</span><span class="hs-identifier hs-var">Contract.Effects._ExposeEndpointReq</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span>    </span><span class="annot"><span class="annottext">RequestHandler effs (Request PABReq) (Request ActiveEndpoint)
-&gt; RequestHandler
     effs (Request ActiveEndpoint) (Response (STM PABResp))
-&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp))
forall k (cat :: k -&gt; k -&gt; *) (a :: k) (b :: k) (c :: k).
Category cat =&gt;
cat a b -&gt; cat b c -&gt; cat a c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Request ActiveEndpoint
 -&gt; Eff (NonDet : effs) (Response (STM PABResp)))
-&gt; RequestHandler
     effs (Request ActiveEndpoint) (Response (STM PABResp))
forall (effs :: [* -&gt; *]) req resp.
(req -&gt; Eff (NonDet : effs) resp) -&gt; RequestHandler effs req resp
</span><span class="hs-identifier hs-var">RequestHandler</span></span><span> </span><span class="annot"><span class="annottext">((Request ActiveEndpoint
  -&gt; Eff (NonDet : effs) (Response (STM PABResp)))
 -&gt; RequestHandler
      effs (Request ActiveEndpoint) (Response (STM PABResp)))
-&gt; (Request ActiveEndpoint
    -&gt; Eff (NonDet : effs) (Response (STM PABResp)))
-&gt; RequestHandler
     effs (Request ActiveEndpoint) (Response (STM PABResp))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680273068"><span class="annot"><span class="annottext">q :: Request ActiveEndpoint
</span><a href="#local-6989586621680273068"><span class="hs-identifier hs-var">q</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">Request</span></span><span class="hs-special">{</span><span id="local-6989586621680273067"><span class="annot"><span class="annottext">RequestID
rqID :: RequestID
rqID :: forall o. Request o -&gt; RequestID
</span><a href="#local-6989586621680273067"><span class="hs-identifier hs-var hs-var">rqID</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680273066"><span class="annot"><span class="annottext">IterationID
itID :: IterationID
itID :: forall o. Request o -&gt; IterationID
</span><a href="#local-6989586621680273066"><span class="hs-identifier hs-var hs-var">itID</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680273065"><span class="annot"><span class="annottext">ActiveEndpoint
rqRequest :: ActiveEndpoint
rqRequest :: forall o. Request o -&gt; o
</span><a href="#local-6989586621680273065"><span class="hs-identifier hs-var hs-var">rqRequest</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(STM PABResp -&gt; Response (STM PABResp))
-&gt; Eff (NonDet : effs) (STM PABResp)
-&gt; Eff (NonDet : effs) (Response (STM PABResp))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestID -&gt; IterationID -&gt; STM PABResp -&gt; Response (STM PABResp)
forall i. RequestID -&gt; IterationID -&gt; i -&gt; Response i
</span><span class="hs-identifier hs-var">Response</span></span><span> </span><span class="annot"><span class="annottext">RequestID
</span><a href="#local-6989586621680273067"><span class="hs-identifier hs-var">rqID</span></a></span><span> </span><span class="annot"><span class="annottext">IterationID
</span><a href="#local-6989586621680273066"><span class="hs-identifier hs-var">itID</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(EndpointValue Value -&gt; PABResp)
-&gt; STM (EndpointValue Value) -&gt; STM PABResp
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EndpointDescription -&gt; EndpointValue Value -&gt; PABResp
</span><span class="hs-identifier hs-var">ExposeEndpointResp</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ActiveEndpoint -&gt; EndpointDescription
</span><span class="hs-identifier hs-var hs-var">aeDescription</span></span><span> </span><span class="annot"><span class="annottext">ActiveEndpoint
</span><a href="#local-6989586621680273065"><span class="hs-identifier hs-var">rqRequest</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(STM (EndpointValue Value) -&gt; STM PABResp)
-&gt; (InstanceState -&gt; STM (EndpointValue Value))
-&gt; InstanceState
-&gt; STM PABResp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Request ActiveEndpoint
-&gt; InstanceState -&gt; STM (EndpointValue Value)
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#awaitEndpointResponse"><span class="hs-identifier hs-var">InstanceState.awaitEndpointResponse</span></a></span><span> </span><span class="annot"><span class="annottext">Request ActiveEndpoint
</span><a href="#local-6989586621680273068"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">(InstanceState -&gt; STM PABResp)
-&gt; Eff (NonDet : effs) InstanceState
-&gt; Eff (NonDet : effs) (STM PABResp)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Eff (NonDet : effs) InstanceState
forall r (effs :: [* -&gt; *]). Member (Reader r) effs =&gt; Eff effs r
</span><span class="hs-identifier hs-var">ask</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-314"></span><span>
</span><span id="line-315"></span><span class="hs-comment">-- | 'RequestHandler' that uses TVars to wait for events</span><span>
</span><span id="line-316"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#stmRequestHandler"><span class="hs-identifier hs-type">stmRequestHandler</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-317"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680273268"><span class="annot"><a href="#local-6989586621680273268"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680273267"><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-318"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LastMember</span></span><span> </span><span class="annot"><a href="#local-6989586621680273268"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-319"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273268"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-320"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ChainIndexQueryEffect</span></span><span> </span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-321"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">WalletEffect</span></span><span> </span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-322"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeClientEffect</span></span><span> </span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-323"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">LogMsg</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">RequestHandlerLogMsg</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-324"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">LogObserve</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">LogMessage</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text.Text</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-325"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ContractInstanceId</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-326"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier hs-type">BlockchainEnv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-327"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-328"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-329"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">RequestHandler</span></span><span> </span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Request</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PABReq</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Response</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PABResp</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-330"></span><span id="stmRequestHandler"><span class="annot"><span class="annottext">stmRequestHandler :: RequestHandler effs (Request PABReq) (STM (Response PABResp))
</span><a href="Plutus.PAB.Core.ContractInstance.html#stmRequestHandler"><span class="hs-identifier hs-var hs-var">stmRequestHandler</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Response (STM PABResp) -&gt; STM (Response PABResp))
-&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp))
-&gt; RequestHandler effs (Request PABReq) (STM (Response PABResp))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">Response (STM PABResp) -&gt; STM (Response PABResp)
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Traversable t, Monad m) =&gt;
t (m a) -&gt; m (t a)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">sequence</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestHandler effs PABReq (STM PABResp)
-&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp))
forall (effs :: [* -&gt; *]) req resp.
RequestHandler effs req resp
-&gt; RequestHandler effs (Request req) (Response resp)
</span><span class="hs-identifier hs-var">wrapHandler</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PABResp -&gt; STM PABResp)
-&gt; RequestHandler effs PABReq PABResp
-&gt; RequestHandler effs PABReq (STM PABResp)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">PABResp -&gt; STM PABResp
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">RequestHandler effs PABReq PABResp
</span><a href="#local-6989586621680273061"><span class="hs-identifier hs-var">nonBlockingRequests</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">RequestHandler effs (Request PABReq) (Response (STM PABResp))
-&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp))
-&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp))
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">RequestHandler effs (Request PABReq) (Response (STM PABResp))
</span><a href="#local-6989586621680273060"><span class="hs-identifier hs-var">blockingRequests</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-331"></span><span>
</span><span id="line-332"></span><span>    </span><span class="hs-comment">-- requests that can be handled by 'WalletEffect', 'ChainIndexQueryEffect', etc.</span><span>
</span><span id="line-333"></span><span>    </span><span id="local-6989586621680273061"><span class="annot"><span class="annottext">nonBlockingRequests :: RequestHandler effs PABReq PABResp
</span><a href="#local-6989586621680273061"><span class="hs-identifier hs-var hs-var">nonBlockingRequests</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-334"></span><span>        </span><span class="annot"><span class="annottext">(Member (LogObserve (LogMessage Text)) effs,
 Member WalletEffect effs) =&gt;
RequestHandler effs PABReq PABResp
forall (effs :: [* -&gt; *]).
(Member (LogObserve (LogMessage Text)) effs,
 Member WalletEffect effs) =&gt;
RequestHandler effs PABReq PABResp
</span><span class="hs-identifier hs-var">RequestHandler.handleOwnAddressesQueries</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-335"></span><span>        </span><span class="annot"><span class="annottext">RequestHandler effs PABReq PABResp
-&gt; RequestHandler effs PABReq PABResp
-&gt; RequestHandler effs PABReq PABResp
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(Member (LogObserve (LogMessage Text)) effs,
 Member ChainIndexQueryEffect effs) =&gt;
RequestHandler effs PABReq PABResp
forall (effs :: [* -&gt; *]).
(Member (LogObserve (LogMessage Text)) effs,
 Member ChainIndexQueryEffect effs) =&gt;
RequestHandler effs PABReq PABResp
</span><span class="hs-identifier hs-var">RequestHandler.handleChainIndexQueries</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-336"></span><span>        </span><span class="annot"><span class="annottext">RequestHandler effs PABReq PABResp
-&gt; RequestHandler effs PABReq PABResp
-&gt; RequestHandler effs PABReq PABResp
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(Member (LogObserve (LogMessage Text)) effs,
 Member (LogMsg RequestHandlerLogMsg) effs,
 Member WalletEffect effs) =&gt;
RequestHandler effs PABReq PABResp
forall (effs :: [* -&gt; *]).
(Member (LogObserve (LogMessage Text)) effs,
 Member (LogMsg RequestHandlerLogMsg) effs,
 Member WalletEffect effs) =&gt;
RequestHandler effs PABReq PABResp
</span><span class="hs-identifier hs-var">RequestHandler.handleUnbalancedTransactions</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-337"></span><span>        </span><span class="annot"><span class="annottext">RequestHandler effs PABReq PABResp
-&gt; RequestHandler effs PABReq PABResp
-&gt; RequestHandler effs PABReq PABResp
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(Member (LogObserve (LogMessage Text)) effs,
 Member (LogMsg RequestHandlerLogMsg) effs,
 Member WalletEffect effs) =&gt;
RequestHandler effs PABReq PABResp
forall (effs :: [* -&gt; *]).
(Member (LogObserve (LogMessage Text)) effs,
 Member (LogMsg RequestHandlerLogMsg) effs,
 Member WalletEffect effs) =&gt;
RequestHandler effs PABReq PABResp
</span><span class="hs-identifier hs-var">RequestHandler.handlePendingTransactions</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-338"></span><span>        </span><span class="annot"><span class="annottext">RequestHandler effs PABReq PABResp
-&gt; RequestHandler effs PABReq PABResp
-&gt; RequestHandler effs PABReq PABResp
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(Member (LogObserve (LogMessage Text)) effs,
 Member (Reader ContractInstanceId) effs) =&gt;
RequestHandler effs PABReq PABResp
forall (effs :: [* -&gt; *]).
(Member (LogObserve (LogMessage Text)) effs,
 Member (Reader ContractInstanceId) effs) =&gt;
RequestHandler effs PABReq PABResp
</span><span class="hs-identifier hs-var">RequestHandler.handleOwnInstanceIdQueries</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-339"></span><span>        </span><span class="annot"><span class="annottext">RequestHandler effs PABReq PABResp
-&gt; RequestHandler effs PABReq PABResp
-&gt; RequestHandler effs PABReq PABResp
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(Member (LogObserve (LogMessage Text)) effs,
 Member NodeClientEffect effs) =&gt;
RequestHandler effs PABReq PABResp
forall (effs :: [* -&gt; *]).
(Member (LogObserve (LogMessage Text)) effs,
 Member NodeClientEffect effs) =&gt;
RequestHandler effs PABReq PABResp
</span><span class="hs-identifier hs-var">RequestHandler.handleCurrentNodeClientSlotQueries</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-340"></span><span>        </span><span class="annot"><span class="annottext">RequestHandler effs PABReq PABResp
-&gt; RequestHandler effs PABReq PABResp
-&gt; RequestHandler effs PABReq PABResp
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(Member (LogObserve (LogMessage Text)) effs,
 Member ChainIndexQueryEffect effs) =&gt;
RequestHandler effs PABReq PABResp
forall (effs :: [* -&gt; *]).
(Member (LogObserve (LogMessage Text)) effs,
 Member ChainIndexQueryEffect effs) =&gt;
RequestHandler effs PABReq PABResp
</span><span class="hs-identifier hs-var">RequestHandler.handleCurrentChainIndexSlotQueries</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-341"></span><span>        </span><span class="annot"><span class="annottext">RequestHandler effs PABReq PABResp
-&gt; RequestHandler effs PABReq PABResp
-&gt; RequestHandler effs PABReq PABResp
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(Member (LogObserve (LogMessage Text)) effs,
 Member NodeClientEffect effs) =&gt;
RequestHandler effs PABReq PABResp
forall (effs :: [* -&gt; *]).
(Member (LogObserve (LogMessage Text)) effs,
 Member NodeClientEffect effs) =&gt;
RequestHandler effs PABReq PABResp
</span><span class="hs-identifier hs-var">RequestHandler.handleCurrentNodeClientTimeRangeQueries</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-342"></span><span>        </span><span class="annot"><span class="annottext">RequestHandler effs PABReq PABResp
-&gt; RequestHandler effs PABReq PABResp
-&gt; RequestHandler effs PABReq PABResp
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(Member (LogObserve (LogMessage Text)) effs,
 Member WalletEffect effs) =&gt;
RequestHandler effs PABReq PABResp
forall (effs :: [* -&gt; *]).
(Member (LogObserve (LogMessage Text)) effs,
 Member WalletEffect effs) =&gt;
RequestHandler effs PABReq PABResp
</span><span class="hs-identifier hs-var">RequestHandler.handleYieldedUnbalancedTx</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-343"></span><span>        </span><span class="annot"><span class="annottext">RequestHandler effs PABReq PABResp
-&gt; RequestHandler effs PABReq PABResp
-&gt; RequestHandler effs PABReq PABResp
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(Member (LogObserve (LogMessage Text)) effs,
 Member (LogMsg RequestHandlerLogMsg) effs,
 Member NodeClientEffect effs) =&gt;
RequestHandler effs PABReq PABResp
forall (effs :: [* -&gt; *]).
(Member (LogObserve (LogMessage Text)) effs,
 Member (LogMsg RequestHandlerLogMsg) effs,
 Member NodeClientEffect effs) =&gt;
RequestHandler effs PABReq PABResp
</span><span class="hs-identifier hs-var">RequestHandler.handleAdjustUnbalancedTx</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-344"></span><span>        </span><span class="annot"><span class="annottext">RequestHandler effs PABReq PABResp
-&gt; RequestHandler effs PABReq PABResp
-&gt; RequestHandler effs PABReq PABResp
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(Member (LogObserve (LogMessage Text)) effs,
 Member NodeClientEffect effs) =&gt;
RequestHandler effs PABReq PABResp
forall (effs :: [* -&gt; *]).
(Member (LogObserve (LogMessage Text)) effs,
 Member NodeClientEffect effs) =&gt;
RequestHandler effs PABReq PABResp
</span><span class="hs-identifier hs-var">RequestHandler.handleGetParams</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-345"></span><span>
</span><span id="line-346"></span><span>    </span><span class="hs-comment">-- requests that wait for changes to happen</span><span>
</span><span id="line-347"></span><span>    </span><span id="local-6989586621680273060"><span class="annot"><span class="annottext">blockingRequests :: RequestHandler effs (Request PABReq) (Response (STM PABResp))
</span><a href="#local-6989586621680273060"><span class="hs-identifier hs-var hs-var">blockingRequests</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-348"></span><span>        </span><span class="annot"><span class="annottext">RequestHandler effs PABReq (STM PABResp)
-&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp))
forall (effs :: [* -&gt; *]) req resp.
RequestHandler effs req resp
-&gt; RequestHandler effs (Request req) (Response resp)
</span><span class="hs-identifier hs-var">wrapHandler</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Member (Reader BlockchainEnv) effs =&gt;
RequestHandler effs PABReq (STM PABResp)
forall (effs :: [* -&gt; *]).
Member (Reader BlockchainEnv) effs =&gt;
RequestHandler effs PABReq (STM PABResp)
</span><a href="Plutus.PAB.Core.ContractInstance.html#processAwaitSlotRequestsSTM"><span class="hs-identifier hs-var">processAwaitSlotRequestsSTM</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-349"></span><span>        </span><span class="annot"><span class="annottext">RequestHandler effs (Request PABReq) (Response (STM PABResp))
-&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp))
-&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp))
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">RequestHandler effs PABReq (STM PABResp)
-&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp))
forall (effs :: [* -&gt; *]) req resp.
RequestHandler effs req resp
-&gt; RequestHandler effs (Request req) (Response resp)
</span><span class="hs-identifier hs-var">wrapHandler</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Member (Reader BlockchainEnv) effs =&gt;
RequestHandler effs PABReq (STM PABResp)
forall (effs :: [* -&gt; *]).
Member (Reader BlockchainEnv) effs =&gt;
RequestHandler effs PABReq (STM PABResp)
</span><a href="Plutus.PAB.Core.ContractInstance.html#processAwaitTimeRequestsSTM"><span class="hs-identifier hs-var">processAwaitTimeRequestsSTM</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-350"></span><span>        </span><span class="annot"><span class="annottext">RequestHandler effs (Request PABReq) (Response (STM PABResp))
-&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp))
-&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp))
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">RequestHandler effs PABReq (STM PABResp)
-&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp))
forall (effs :: [* -&gt; *]) req resp.
RequestHandler effs req resp
-&gt; RequestHandler effs (Request req) (Response resp)
</span><span class="hs-identifier hs-var">wrapHandler</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(LastMember m effs, MonadIO m,
 Member (Reader BlockchainEnv) (NonDet : effs)) =&gt;
RequestHandler effs PABReq (STM PABResp)
forall (m :: * -&gt; *) (effs :: [* -&gt; *]).
(LastMember m effs, MonadIO m,
 Member (Reader BlockchainEnv) (NonDet : effs)) =&gt;
RequestHandler effs PABReq (STM PABResp)
</span><a href="Plutus.PAB.Core.ContractInstance.html#processTxStatusChangeRequestsSTM"><span class="hs-identifier hs-var">processTxStatusChangeRequestsSTM</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-351"></span><span>        </span><span class="annot"><span class="annottext">RequestHandler effs (Request PABReq) (Response (STM PABResp))
-&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp))
-&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp))
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">RequestHandler effs PABReq (STM PABResp)
-&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp))
forall (effs :: [* -&gt; *]) req resp.
RequestHandler effs req resp
-&gt; RequestHandler effs (Request req) (Response resp)
</span><span class="hs-identifier hs-var">wrapHandler</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(LastMember m effs, MonadIO m,
 Member (Reader BlockchainEnv) effs) =&gt;
RequestHandler effs PABReq (STM PABResp)
forall (m :: * -&gt; *) (effs :: [* -&gt; *]).
(LastMember m effs, MonadIO m,
 Member (Reader BlockchainEnv) effs) =&gt;
RequestHandler effs PABReq (STM PABResp)
</span><a href="Plutus.PAB.Core.ContractInstance.html#processTxOutStatusChangeRequestsSTM"><span class="hs-identifier hs-var">processTxOutStatusChangeRequestsSTM</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-352"></span><span>        </span><span class="annot"><span class="annottext">RequestHandler effs (Request PABReq) (Response (STM PABResp))
-&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp))
-&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp))
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Member (Reader InstanceState) effs =&gt;
RequestHandler effs (Request PABReq) (Response (STM PABResp))
forall (effs :: [* -&gt; *]).
Member (Reader InstanceState) effs =&gt;
RequestHandler effs (Request PABReq) (Response (STM PABResp))
</span><a href="Plutus.PAB.Core.ContractInstance.html#processEndpointRequestsSTM"><span class="hs-identifier hs-var">processEndpointRequestsSTM</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-353"></span><span>        </span><span class="annot"><span class="annottext">RequestHandler effs (Request PABReq) (Response (STM PABResp))
-&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp))
-&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp))
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Member (Reader InstanceState) effs =&gt;
RequestHandler effs (Request PABReq) (Response (STM PABResp))
forall (effs :: [* -&gt; *]).
Member (Reader InstanceState) effs =&gt;
RequestHandler effs (Request PABReq) (Response (STM PABResp))
</span><a href="Plutus.PAB.Core.ContractInstance.html#processUtxoSpentRequestsSTM"><span class="hs-identifier hs-var">processUtxoSpentRequestsSTM</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-354"></span><span>        </span><span class="annot"><span class="annottext">RequestHandler effs (Request PABReq) (Response (STM PABResp))
-&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp))
-&gt; RequestHandler effs (Request PABReq) (Response (STM PABResp))
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Member (Reader InstanceState) effs =&gt;
RequestHandler effs (Request PABReq) (Response (STM PABResp))
forall (effs :: [* -&gt; *]).
Member (Reader InstanceState) effs =&gt;
RequestHandler effs (Request PABReq) (Response (STM PABResp))
</span><a href="Plutus.PAB.Core.ContractInstance.html#processUtxoProducedRequestsSTM"><span class="hs-identifier hs-var">processUtxoProducedRequestsSTM</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273267"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-355"></span><span>
</span><span id="line-356"></span><span class="hs-comment">-- | Start the thread for the contract instance</span><span>
</span><span id="line-357"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#startSTMInstanceThread%27"><span class="hs-identifier hs-type">startSTMInstanceThread'</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-358"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680273520"><span class="annot"><a href="#local-6989586621680273520"><span class="hs-identifier hs-type">t</span></a></span></span><span> </span><span id="local-6989586621680273522"><span class="annot"><a href="#local-6989586621680273522"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680273519"><span class="annot"><a href="#local-6989586621680273519"><span class="hs-identifier hs-type">appBackend</span></a></span></span><span> </span><span id="local-6989586621680273521"><span class="annot"><a href="#local-6989586621680273521"><span class="hs-identifier hs-type">effs</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-359"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LastMember</span></span><span> </span><span class="annot"><a href="#local-6989586621680273522"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273521"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-360"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#PABContract"><span class="hs-identifier hs-type">Contract.PABContract</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273520"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-361"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#AppBackendConstraints"><span class="hs-identifier hs-type">AppBackendConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273520"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273522"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273519"><span class="hs-identifier hs-type">appBackend</span></a></span><span>
</span><span id="line-362"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LastMember</span></span><span> </span><span class="annot"><a href="#local-6989586621680273522"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ContractInstanceId</span></span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><span class="annot"><a href="#local-6989586621680273519"><span class="hs-identifier hs-type">appBackend</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-363"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-364"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span>
</span><span id="line-365"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ContractInstanceId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680273519"><span class="hs-identifier hs-type">appBackend</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~&gt;</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-366"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Webserver.Types.html#ContractActivationArgs"><span class="hs-identifier hs-type">ContractActivationArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#ContractDef"><span class="hs-identifier hs-type">ContractDef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273520"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-367"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ContractInstanceId</span></span><span>
</span><span id="line-368"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680273521"><span class="hs-identifier hs-type">effs</span></a></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span>
</span><span id="line-369"></span><span id="startSTMInstanceThread%27"><span class="annot"><span class="annottext">startSTMInstanceThread' :: STM InstanceState
-&gt; (ContractInstanceId -&gt; Eff appBackend ~&gt; IO)
-&gt; ContractActivationArgs (ContractDef t)
-&gt; ContractInstanceId
-&gt; Eff effs InstanceState
</span><a href="Plutus.PAB.Core.ContractInstance.html#startSTMInstanceThread%27"><span class="hs-identifier hs-var hs-var">startSTMInstanceThread'</span></a></span></span><span> </span><span id="local-6989586621680273048"><span class="annot"><span class="annottext">STM InstanceState
</span><a href="#local-6989586621680273048"><span class="hs-identifier hs-var">stmState</span></a></span></span><span> </span><span id="local-6989586621680273047"><span class="annot"><span class="annottext">ContractInstanceId -&gt; Eff appBackend ~&gt; IO
</span><a href="#local-6989586621680273047"><span class="hs-identifier hs-var">runAppBackend</span></a></span></span><span> </span><span id="local-6989586621680273046"><span class="annot"><span class="annottext">ContractActivationArgs (ContractDef t)
</span><a href="#local-6989586621680273046"><span class="hs-identifier hs-var">def</span></a></span></span><span> </span><span id="local-6989586621680273045"><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273045"><span class="hs-identifier hs-var">instanceID</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-keyword">do</span><span>
</span><span id="line-370"></span><span>    </span><span id="local-6989586621680273044"><span class="annot"><span class="annottext">InstanceState
</span><a href="#local-6989586621680273044"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO InstanceState -&gt; Eff effs InstanceState
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO InstanceState -&gt; Eff effs InstanceState)
-&gt; IO InstanceState -&gt; Eff effs InstanceState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">STM InstanceState -&gt; IO InstanceState
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.atomically</span></a></span><span> </span><span class="annot"><span class="annottext">STM InstanceState
</span><a href="#local-6989586621680273048"><span class="hs-identifier hs-var">stmState</span></a></span><span>
</span><span id="line-371"></span><span>    </span><span class="annot"><span class="annottext">ThreadId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ThreadId -&gt; Eff effs ThreadId
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span>
</span><span id="line-372"></span><span>        </span><span class="annot"><span class="annottext">(IO ThreadId -&gt; Eff effs ThreadId)
-&gt; IO ThreadId -&gt; Eff effs ThreadId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ThreadId
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forkIO</span></a></span><span>
</span><span id="line-373"></span><span>        </span><span class="annot"><span class="annottext">(IO () -&gt; IO ThreadId) -&gt; IO () -&gt; IO ThreadId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId -&gt; Eff appBackend ~&gt; IO
</span><a href="#local-6989586621680273047"><span class="hs-identifier hs-var">runAppBackend</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273045"><span class="hs-identifier hs-var">instanceID</span></a></span><span>
</span><span id="line-374"></span><span>        </span><span class="annot"><span class="annottext">(Eff appBackend () -&gt; IO ()) -&gt; Eff appBackend () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
-&gt; Eff (Reader ContractInstanceId : appBackend) ()
-&gt; Eff appBackend ()
forall r (effs :: [* -&gt; *]) a.
r -&gt; Eff (Reader r : effs) a -&gt; Eff effs a
</span><span class="hs-identifier hs-var">runReader</span></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273045"><span class="hs-identifier hs-var">instanceID</span></a></span><span>
</span><span id="line-375"></span><span>        </span><span class="annot"><span class="annottext">(Eff (Reader ContractInstanceId : appBackend) ()
 -&gt; Eff appBackend ())
-&gt; Eff (Reader ContractInstanceId : appBackend) ()
-&gt; Eff appBackend ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceState
-&gt; Eff
     (Reader InstanceState : Reader ContractInstanceId : appBackend) ()
-&gt; Eff (Reader ContractInstanceId : appBackend) ()
forall r (effs :: [* -&gt; *]) a.
r -&gt; Eff (Reader r : effs) a -&gt; Eff effs a
</span><span class="hs-identifier hs-var">runReader</span></span><span> </span><span class="annot"><span class="annottext">InstanceState
</span><a href="#local-6989586621680273044"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-376"></span><span>        </span><span class="annot"><span class="annottext">(Eff
   (Reader InstanceState : Reader ContractInstanceId : appBackend) ()
 -&gt; Eff (Reader ContractInstanceId : appBackend) ())
-&gt; Eff
     (Reader InstanceState : Reader ContractInstanceId : appBackend) ()
-&gt; Eff (Reader ContractInstanceId : appBackend) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ContractActivationArgs (ContractDef t)
-&gt; ContractInstanceId
-&gt; Eff
     (Reader InstanceState : Reader ContractInstanceId : appBackend) ()
forall t (m :: * -&gt; *) (effs :: [* -&gt; *]).
(AppBackendConstraints t m effs,
 Member (Reader InstanceState) effs,
 Member (Reader ContractInstanceId) effs, PABContract t) =&gt;
ContractActivationArgs (ContractDef t)
-&gt; ContractInstanceId -&gt; Eff effs ()
</span><a href="Plutus.PAB.Core.ContractInstance.html#stmInstanceLoop"><span class="hs-identifier hs-var">stmInstanceLoop</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273520"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273522"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ContractInstanceId</span></span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><span class="annot"><a href="#local-6989586621680273519"><span class="hs-identifier hs-type">appBackend</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ContractActivationArgs (ContractDef t)
</span><a href="#local-6989586621680273046"><span class="hs-identifier hs-var">def</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273045"><span class="hs-identifier hs-var">instanceID</span></a></span><span>
</span><span id="line-377"></span><span>    </span><span class="annot"><span class="annottext">InstanceState -&gt; Eff effs InstanceState
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceState
</span><a href="#local-6989586621680273044"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-378"></span><span>
</span><span id="line-379"></span><span class="hs-comment">-- | Start the thread for the contract instance</span><span>
</span><span id="line-380"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#startSTMInstanceThread"><span class="hs-identifier hs-type">startSTMInstanceThread</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-381"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680273042"><span class="annot"><a href="#local-6989586621680273042"><span class="hs-identifier hs-type">t</span></a></span></span><span> </span><span id="local-6989586621680273041"><span class="annot"><a href="#local-6989586621680273041"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680273040"><span class="annot"><a href="#local-6989586621680273040"><span class="hs-identifier hs-type">appBackend</span></a></span></span><span> </span><span id="local-6989586621680273039"><span class="annot"><a href="#local-6989586621680273039"><span class="hs-identifier hs-type">effs</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-382"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LastMember</span></span><span> </span><span class="annot"><a href="#local-6989586621680273041"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273039"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-383"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#PABContract"><span class="hs-identifier hs-type">Contract.PABContract</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273042"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-384"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#AppBackendConstraints"><span class="hs-identifier hs-type">AppBackendConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273042"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273041"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273040"><span class="hs-identifier hs-type">appBackend</span></a></span><span>
</span><span id="line-385"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LastMember</span></span><span> </span><span class="annot"><a href="#local-6989586621680273041"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ContractInstanceId</span></span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><span class="annot"><a href="#local-6989586621680273040"><span class="hs-identifier hs-type">appBackend</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-386"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-387"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ContractInstanceId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680273040"><span class="hs-identifier hs-type">appBackend</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~&gt;</span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-388"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Webserver.Types.html#ContractActivationArgs"><span class="hs-identifier hs-type">ContractActivationArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#ContractDef"><span class="hs-identifier hs-type">ContractDef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273042"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-389"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ContractInstanceId</span></span><span>
</span><span id="line-390"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680273039"><span class="hs-identifier hs-type">effs</span></a></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span>
</span><span id="line-391"></span><span id="startSTMInstanceThread"><span class="annot"><span class="annottext">startSTMInstanceThread :: (ContractInstanceId -&gt; Eff appBackend ~&gt; IO)
-&gt; ContractActivationArgs (ContractDef t)
-&gt; ContractInstanceId
-&gt; Eff effs InstanceState
</span><a href="Plutus.PAB.Core.ContractInstance.html#startSTMInstanceThread"><span class="hs-identifier hs-var hs-var">startSTMInstanceThread</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM InstanceState
-&gt; (ContractInstanceId -&gt; Eff appBackend ~&gt; IO)
-&gt; ContractActivationArgs (ContractDef t)
-&gt; ContractInstanceId
-&gt; Eff effs InstanceState
forall t (m :: * -&gt; *) (appBackend :: [* -&gt; *]) (effs :: [* -&gt; *]).
(LastMember m effs, PABContract t,
 AppBackendConstraints t m appBackend,
 LastMember
   m
   (Reader InstanceState : Reader ContractInstanceId : appBackend)) =&gt;
STM InstanceState
-&gt; (ContractInstanceId -&gt; Eff appBackend ~&gt; IO)
-&gt; ContractActivationArgs (ContractDef t)
-&gt; ContractInstanceId
-&gt; Eff effs InstanceState
</span><a href="Plutus.PAB.Core.ContractInstance.html#startSTMInstanceThread%27"><span class="hs-identifier hs-var">startSTMInstanceThread'</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273042"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273041"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273040"><span class="hs-identifier hs-type">appBackend</span></a></span><span> </span><span class="annot"><span class="annottext">STM InstanceState
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#emptyInstanceState"><span class="hs-identifier hs-var">emptyInstanceState</span></a></span><span>
</span><span id="line-392"></span><span>
</span><span id="line-393"></span><span class="hs-keyword">type</span><span> </span><span id="AppBackendConstraints"><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#AppBackendConstraints"><span class="hs-identifier hs-var">AppBackendConstraints</span></a></span></span><span> </span><span id="local-6989586621680273038"><span class="annot"><a href="#local-6989586621680273038"><span class="hs-identifier hs-type">t</span></a></span></span><span> </span><span id="local-6989586621680273037"><span class="annot"><a href="#local-6989586621680273037"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680273036"><span class="annot"><a href="#local-6989586621680273036"><span class="hs-identifier hs-type">effs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-394"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LastMember</span></span><span> </span><span class="annot"><a href="#local-6989586621680273037"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273036"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-395"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273037"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-396"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Error</span></span><span> </span><span class="annot"><a href="Plutus.PAB.Types.html#PABError"><span class="hs-identifier hs-type">PABError</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273036"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-397"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">LogMsg</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.RequestHandlers.html#ContractInstanceMsg"><span class="hs-identifier hs-type">ContractInstanceMsg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273038"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273036"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-398"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ChainIndexQueryEffect</span></span><span> </span><span class="annot"><a href="#local-6989586621680273036"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-399"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">WalletEffect</span></span><span> </span><span class="annot"><a href="#local-6989586621680273036"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-400"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeClientEffect</span></span><span> </span><span class="annot"><a href="#local-6989586621680273036"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-401"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">LogMsg</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">RequestHandlerLogMsg</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273036"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-402"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">LogObserve</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">LogMessage</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text.Text</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273036"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-403"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">LogMsg</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TxBalanceMsg</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273036"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-404"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier hs-type">BlockchainEnv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273036"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-405"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#ContractEffect"><span class="hs-identifier hs-type">ContractEffect</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273038"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273036"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-406"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#ContractStore"><span class="hs-identifier hs-type">ContractStore</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273038"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273036"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-407"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-408"></span><span>
</span><span id="line-409"></span><span class="hs-comment">-- | Handle requests using 'respondToRequestsSTM' until the contract is done.</span><span>
</span><span id="line-410"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#stmInstanceLoop"><span class="hs-identifier hs-type">stmInstanceLoop</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-411"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680273325"><span class="annot"><a href="#local-6989586621680273325"><span class="hs-identifier hs-type">t</span></a></span></span><span> </span><span id="local-6989586621680273324"><span class="annot"><a href="#local-6989586621680273324"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680273323"><span class="annot"><a href="#local-6989586621680273323"><span class="hs-identifier hs-type">effs</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-412"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#AppBackendConstraints"><span class="hs-identifier hs-type">AppBackendConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273325"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273324"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273323"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-413"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273323"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-414"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ContractInstanceId</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273323"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-415"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#PABContract"><span class="hs-identifier hs-type">Contract.PABContract</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273325"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-416"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-417"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Webserver.Types.html#ContractActivationArgs"><span class="hs-identifier hs-type">ContractActivationArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#ContractDef"><span class="hs-identifier hs-type">ContractDef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273325"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-418"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ContractInstanceId</span></span><span>
</span><span id="line-419"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680273323"><span class="hs-identifier hs-type">effs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-420"></span><span id="stmInstanceLoop"><span class="annot"><span class="annottext">stmInstanceLoop :: ContractActivationArgs (ContractDef t)
-&gt; ContractInstanceId -&gt; Eff effs ()
</span><a href="Plutus.PAB.Core.ContractInstance.html#stmInstanceLoop"><span class="hs-identifier hs-var hs-var">stmInstanceLoop</span></a></span></span><span> </span><span id="local-6989586621680273035"><span class="annot"><span class="annottext">ContractActivationArgs (ContractDef t)
</span><a href="#local-6989586621680273035"><span class="hs-identifier hs-var">def</span></a></span></span><span> </span><span id="local-6989586621680273034"><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273034"><span class="hs-identifier hs-var">instanceId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-421"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621680273033"><span class="annot"><a href="#local-6989586621680273033"><span class="hs-identifier hs-var">currentState</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#State"><span class="hs-identifier hs-type">Contract.State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273325"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ContractInstanceId -&gt; Eff effs (State t)
forall t (effs :: [* -&gt; *]).
Member (ContractStore t) effs =&gt;
ContractInstanceId -&gt; Eff effs (State t)
</span><a href="Plutus.PAB.Effects.Contract.html#getState"><span class="hs-identifier hs-var">Contract.getState</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273325"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273034"><span class="hs-identifier hs-var">instanceId</span></a></span><span>
</span><span id="line-422"></span><span>    </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span class="hs-special">{</span><span id="local-6989586621680273031"><span class="annot"><span class="annottext">TMVar ()
issStop :: TMVar ()
issStop :: InstanceState -&gt; TMVar ()
</span><a href="#local-6989586621680273031"><span class="hs-identifier hs-var hs-var">issStop</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eff effs InstanceState
forall r (effs :: [* -&gt; *]). Member (Reader r) effs =&gt; Eff effs r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-423"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680273030"><span class="annot"><span class="annottext">resp :: ContractResponse Value Value PABResp PABReq
</span><a href="#local-6989586621680273030"><span class="hs-identifier hs-var hs-var">resp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Proxy t -&gt; State t -&gt; ContractResponse Value Value PABResp PABReq
forall contract.
PABContract contract =&gt;
Proxy contract
-&gt; State contract -&gt; ContractResponse Value Value PABResp PABReq
</span><a href="Plutus.PAB.Effects.Contract.html#serialisableState"><span class="hs-identifier hs-var">serialisableState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy t
forall k (t :: k). Proxy t
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273325"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">State t
</span><a href="#local-6989586621680273033"><span class="hs-identifier hs-var">currentState</span></a></span><span>
</span><span id="line-424"></span><span>    </span><span class="annot"><span class="annottext">ContractResponse Value Value PABResp PABReq -&gt; Eff effs ()
forall (m :: * -&gt; *) (effs :: [* -&gt; *]).
(LastMember m effs, MonadIO m,
 Member (Reader InstanceState) effs) =&gt;
ContractResponse Value Value PABResp PABReq -&gt; Eff effs ()
</span><a href="Plutus.PAB.Core.ContractInstance.html#updateState"><span class="hs-identifier hs-var">updateState</span></a></span><span> </span><span class="annot"><span class="annottext">ContractResponse Value Value PABResp PABReq
</span><a href="#local-6989586621680273030"><span class="hs-identifier hs-var">resp</span></a></span><span>
</span><span id="line-425"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">State t -&gt; [Request PABReq]
forall contract.
PABContract contract =&gt;
State contract -&gt; [Request PABReq]
</span><a href="Plutus.PAB.Effects.Contract.html#requests"><span class="hs-identifier hs-var">Contract.requests</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273325"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><span class="annottext">State t
</span><a href="#local-6989586621680273033"><span class="hs-identifier hs-var">currentState</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-426"></span><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-427"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ContractResponse</span></span><span class="hs-special">{</span><span id="local-6989586621680273028"><span class="annot"><span class="annottext">Maybe Value
err :: Maybe Value
err :: forall w e s h. ContractResponse w e s h -&gt; Maybe e
</span><a href="#local-6989586621680273028"><span class="hs-identifier hs-var hs-var">err</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ContractResponse Value Value PABResp PABReq
</span><a href="#local-6989586621680273030"><span class="hs-identifier hs-var">resp</span></a></span><span>
</span><span id="line-428"></span><span>            </span><span class="annot"><span class="annottext">Eff effs InstanceState
forall r (effs :: [* -&gt; *]). Member (Reader r) effs =&gt; Eff effs r
</span><span class="hs-identifier hs-var">ask</span></span><span> </span><span class="annot"><span class="annottext">Eff effs InstanceState
-&gt; (InstanceState -&gt; Eff effs ()) -&gt; Eff effs ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; Eff effs ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; Eff effs ())
-&gt; (InstanceState -&gt; IO ()) -&gt; InstanceState -&gt; Eff effs ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ())
-&gt; (InstanceState -&gt; STM ()) -&gt; InstanceState -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Activity -&gt; InstanceState -&gt; STM ()
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#setActivity"><span class="hs-identifier hs-var">InstanceState.setActivity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Value -&gt; Activity
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#Done"><span class="hs-identifier hs-var">Done</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Value
</span><a href="#local-6989586621680273028"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-429"></span><span>        </span><span class="annot"><span class="annottext">[Request PABReq]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-430"></span><span>            </span><span id="local-6989586621680273026"><span class="annot"><span class="annottext">STM (Response PABResp)
</span><a href="#local-6989586621680273026"><span class="hs-identifier hs-var">response</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ContractInstanceId -&gt; State t -&gt; Eff effs (STM (Response PABResp))
forall (m :: * -&gt; *) t (effs :: [* -&gt; *]).
(LastMember m effs, MonadIO m, Member ChainIndexQueryEffect effs,
 Member WalletEffect effs, Member NodeClientEffect effs,
 Member (LogMsg RequestHandlerLogMsg) effs,
 Member (LogObserve (LogMessage Text)) effs,
 Member (LogMsg (ContractInstanceMsg t)) effs,
 Member (Reader ContractInstanceId) effs,
 Member (Reader BlockchainEnv) effs,
 Member (Reader InstanceState) effs, PABContract t) =&gt;
ContractInstanceId -&gt; State t -&gt; Eff effs (STM (Response PABResp))
</span><a href="Plutus.PAB.Core.ContractInstance.html#respondToRequestsSTM"><span class="hs-identifier hs-var">respondToRequestsSTM</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273325"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273034"><span class="hs-identifier hs-var">instanceId</span></a></span><span> </span><span class="annot"><span class="annottext">State t
</span><a href="#local-6989586621680273033"><span class="hs-identifier hs-var">currentState</span></a></span><span>
</span><span id="line-431"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680273024"><span class="annot"><span class="annottext">rsp' :: STM (Either () (Response PABResp))
</span><a href="#local-6989586621680273024"><span class="hs-identifier hs-var hs-var">rsp'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Response PABResp -&gt; Either () (Response PABResp)
forall a b. b -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">(Response PABResp -&gt; Either () (Response PABResp))
-&gt; STM (Response PABResp) -&gt; STM (Either () (Response PABResp))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">STM (Response PABResp)
</span><a href="#local-6989586621680273026"><span class="hs-identifier hs-var">response</span></a></span><span>
</span><span id="line-432"></span><span>                </span><span id="local-6989586621680273023"><span class="annot"><span class="annottext">stop :: STM (Either () (Response PABResp))
</span><a href="#local-6989586621680273023"><span class="hs-identifier hs-var hs-var">stop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; Either () (Response PABResp)
forall a b. a -&gt; Either a b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(() -&gt; Either () (Response PABResp))
-&gt; STM () -&gt; STM (Either () (Response PABResp))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar () -&gt; STM ()
forall a. TMVar a -&gt; STM a
</span><span class="hs-identifier hs-var">STM.takeTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar ()
</span><a href="#local-6989586621680273031"><span class="hs-identifier hs-var">issStop</span></a></span><span>
</span><span id="line-433"></span><span>            </span><span id="local-6989586621680273021"><span class="annot"><span class="annottext">Either () (Response PABResp)
</span><a href="#local-6989586621680273021"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Either () (Response PABResp))
-&gt; Eff effs (Either () (Response PABResp))
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (Either () (Response PABResp))
 -&gt; Eff effs (Either () (Response PABResp)))
-&gt; IO (Either () (Response PABResp))
-&gt; Eff effs (Either () (Response PABResp))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">STM (Either () (Response PABResp))
-&gt; IO (Either () (Response PABResp))
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.atomically</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">STM (Either () (Response PABResp))
</span><a href="#local-6989586621680273023"><span class="hs-identifier hs-var">stop</span></a></span><span> </span><span class="annot"><span class="annottext">STM (Either () (Response PABResp))
-&gt; STM (Either () (Response PABResp))
-&gt; STM (Either () (Response PABResp))
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;|&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">STM (Either () (Response PABResp))
</span><a href="#local-6989586621680273024"><span class="hs-identifier hs-var">rsp'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-434"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either () (Response PABResp)
</span><a href="#local-6989586621680273021"><span class="hs-identifier hs-var">event</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-435"></span><span>                </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-436"></span><span>                    </span><span class="annot"><span class="annottext">Eff effs InstanceState
forall r (effs :: [* -&gt; *]). Member (Reader r) effs =&gt; Eff effs r
</span><span class="hs-identifier hs-var">ask</span></span><span> </span><span class="annot"><span class="annottext">Eff effs InstanceState
-&gt; (InstanceState -&gt; Eff effs ()) -&gt; Eff effs ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; Eff effs ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; Eff effs ())
-&gt; (InstanceState -&gt; IO ()) -&gt; InstanceState -&gt; Eff effs ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ())
-&gt; (InstanceState -&gt; STM ()) -&gt; InstanceState -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Activity -&gt; InstanceState -&gt; STM ()
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#setActivity"><span class="hs-identifier hs-var">InstanceState.setActivity</span></a></span><span> </span><span class="annot"><span class="annottext">Activity
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#Stopped"><span class="hs-identifier hs-var">Stopped</span></a></span><span>
</span><span id="line-437"></span><span>                </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621680273020"><span class="annot"><span class="annottext">Response PABResp
</span><a href="#local-6989586621680273020"><span class="hs-identifier hs-var">event'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-438"></span><span>                    </span><span class="hs-special">(</span><span id="local-6989586621680273019"><span class="annot"><a href="#local-6989586621680273019"><span class="hs-identifier hs-var">newState</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#State"><span class="hs-identifier hs-type">Contract.State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273325"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
-&gt; ContractDef t
-&gt; State t
-&gt; Response PABResp
-&gt; Eff effs (State t)
forall t (effs :: [* -&gt; *]).
(Member (ContractEffect t) effs, PABContract t) =&gt;
ContractInstanceId
-&gt; ContractDef t
-&gt; State t
-&gt; Response PABResp
-&gt; Eff effs (State t)
</span><a href="Plutus.PAB.Effects.Contract.html#updateContract"><span class="hs-identifier hs-var">Contract.updateContract</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273325"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273034"><span class="hs-identifier hs-var">instanceId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ContractActivationArgs (ContractDef t) -&gt; ContractDef t
forall t. ContractActivationArgs t -&gt; t
</span><a href="Plutus.PAB.Webserver.Types.html#caID"><span class="hs-identifier hs-var hs-var">caID</span></a></span><span> </span><span class="annot"><span class="annottext">ContractActivationArgs (ContractDef t)
</span><a href="#local-6989586621680273035"><span class="hs-identifier hs-var">def</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">State t
</span><a href="#local-6989586621680273033"><span class="hs-identifier hs-var">currentState</span></a></span><span> </span><span class="annot"><span class="annottext">Response PABResp
</span><a href="#local-6989586621680273020"><span class="hs-identifier hs-var">event'</span></a></span><span>
</span><span id="line-439"></span><span>                    </span><span class="annot"><span class="annottext">ContractActivationArgs (ContractDef t)
-&gt; ContractInstanceId -&gt; State t -&gt; Eff effs ()
forall t (effs :: [* -&gt; *]).
Member (ContractStore t) effs =&gt;
ContractActivationArgs (ContractDef t)
-&gt; ContractInstanceId -&gt; State t -&gt; Eff effs ()
</span><a href="Plutus.PAB.Effects.Contract.html#putState"><span class="hs-identifier hs-var">Contract.putState</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273325"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><span class="annottext">ContractActivationArgs (ContractDef t)
</span><a href="#local-6989586621680273035"><span class="hs-identifier hs-var">def</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273034"><span class="hs-identifier hs-var">instanceId</span></a></span><span> </span><span class="annot"><span class="annottext">State t
</span><a href="#local-6989586621680273019"><span class="hs-identifier hs-var">newState</span></a></span><span>
</span><span id="line-440"></span><span>                    </span><span class="annot"><span class="annottext">ContractActivationArgs (ContractDef t)
-&gt; ContractInstanceId -&gt; Eff effs ()
forall t (m :: * -&gt; *) (effs :: [* -&gt; *]).
(AppBackendConstraints t m effs,
 Member (Reader InstanceState) effs,
 Member (Reader ContractInstanceId) effs, PABContract t) =&gt;
ContractActivationArgs (ContractDef t)
-&gt; ContractInstanceId -&gt; Eff effs ()
</span><a href="Plutus.PAB.Core.ContractInstance.html#stmInstanceLoop"><span class="hs-identifier hs-var">stmInstanceLoop</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273325"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><span class="annottext">ContractActivationArgs (ContractDef t)
</span><a href="#local-6989586621680273035"><span class="hs-identifier hs-var">def</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273034"><span class="hs-identifier hs-var">instanceId</span></a></span><span>
</span><span id="line-441"></span><span>
</span><span id="line-442"></span><span class="hs-comment">-- | Update the TVars in the 'InstanceState' with data from the list</span><span>
</span><span id="line-443"></span><span class="hs-comment">--   of requests.</span><span>
</span><span id="line-444"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#updateState"><span class="hs-identifier hs-type">updateState</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-445"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680273309"><span class="annot"><a href="#local-6989586621680273309"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680273308"><span class="annot"><a href="#local-6989586621680273308"><span class="hs-identifier hs-type">effs</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-446"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LastMember</span></span><span> </span><span class="annot"><a href="#local-6989586621680273309"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273308"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-447"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273309"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-448"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273308"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-449"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-450"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ContractResponse</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Value</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PABResp</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PABReq</span></span><span>
</span><span id="line-451"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680273308"><span class="hs-identifier hs-type">effs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-452"></span><span id="updateState"><span class="annot"><span class="annottext">updateState :: ContractResponse Value Value PABResp PABReq -&gt; Eff effs ()
</span><a href="Plutus.PAB.Core.ContractInstance.html#updateState"><span class="hs-identifier hs-var hs-var">updateState</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ContractResponse</span></span><span class="hs-special">{</span><span class="annot"><span class="annottext">newState :: forall w e s h.
ContractResponse w e s h -&gt; State w (CheckpointKey, s)
</span><span class="hs-identifier hs-var">newState</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">State</span></span><span class="hs-special">{</span><span id="local-6989586621680273017"><span class="annot"><span class="annottext">Value
observableState :: Value
observableState :: forall w e. State w e -&gt; w
</span><a href="#local-6989586621680273017"><span class="hs-identifier hs-var hs-var">observableState</span></a></span></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span id="local-6989586621680273016"><span class="annot"><span class="annottext">[Request PABReq]
hooks :: [Request PABReq]
hooks :: forall w e s h. ContractResponse w e s h -&gt; [Request h]
</span><a href="#local-6989586621680273016"><span class="hs-identifier hs-var hs-var">hooks</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-453"></span><span>    </span><span id="local-6989586621680273015"><span class="annot"><span class="annottext">InstanceState
</span><a href="#local-6989586621680273015"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Eff effs InstanceState
forall r (effs :: [* -&gt; *]). Member (Reader r) effs =&gt; Eff effs r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-454"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; Eff effs ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; Eff effs ()) -&gt; IO () -&gt; Eff effs ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-455"></span><span>        </span><span class="annot"><span class="annottext">InstanceState -&gt; STM ()
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#clearEndpoints"><span class="hs-identifier hs-var">InstanceState.clearEndpoints</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceState
</span><a href="#local-6989586621680273015"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-456"></span><span>        </span><span class="annot"><span class="annottext">[Request PABReq] -&gt; (Request PABReq -&gt; STM ()) -&gt; STM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[Request PABReq]
</span><a href="#local-6989586621680273016"><span class="hs-identifier hs-var">hooks</span></a></span><span> </span><span class="annot"><span class="annottext">((Request PABReq -&gt; STM ()) -&gt; STM ())
-&gt; (Request PABReq -&gt; STM ()) -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680273013"><span class="annot"><span class="annottext">Request PABReq
</span><a href="#local-6989586621680273013"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-457"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Request PABReq -&gt; PABReq
forall o. Request o -&gt; o
</span><span class="hs-identifier hs-var hs-var">rqRequest</span></span><span> </span><span class="annot"><span class="annottext">Request PABReq
</span><a href="#local-6989586621680273013"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-458"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">ExposeEndpointReq</span></span><span> </span><span id="local-6989586621680273012"><span class="annot"><span class="annottext">ActiveEndpoint
</span><a href="#local-6989586621680273012"><span class="hs-identifier hs-var">endpoint</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Request ActiveEndpoint -&gt; InstanceState -&gt; STM ()
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#addEndpoint"><span class="hs-identifier hs-var">InstanceState.addEndpoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Request PABReq
</span><a href="#local-6989586621680273013"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">rqRequest :: ActiveEndpoint
</span><span class="hs-identifier hs-var">rqRequest</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ActiveEndpoint
</span><a href="#local-6989586621680273012"><span class="hs-identifier hs-var">endpoint</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InstanceState
</span><a href="#local-6989586621680273015"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-459"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">AwaitUtxoSpentReq</span></span><span> </span><span id="local-6989586621680273010"><span class="annot"><span class="annottext">TxIn
</span><a href="#local-6989586621680273010"><span class="hs-identifier hs-var">txOutRef</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Request TxOutRef -&gt; InstanceState -&gt; STM ()
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#addUtxoSpentReq"><span class="hs-identifier hs-var">InstanceState.addUtxoSpentReq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Request PABReq
</span><a href="#local-6989586621680273013"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">rqRequest :: TxOutRef
</span><span class="hs-identifier hs-var">rqRequest</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxIn -&gt; TxOutRef
</span><span class="hs-identifier hs-var">fromCardanoTxIn</span></span><span> </span><span class="annot"><span class="annottext">TxIn
</span><a href="#local-6989586621680273010"><span class="hs-identifier hs-var">txOutRef</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InstanceState
</span><a href="#local-6989586621680273015"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-460"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">AwaitUtxoProducedReq</span></span><span> </span><span id="local-6989586621680273008"><span class="annot"><span class="annottext">CardanoAddress
</span><a href="#local-6989586621680273008"><span class="hs-identifier hs-var">addr</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Request CardanoAddress -&gt; InstanceState -&gt; STM ()
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#addUtxoProducedReq"><span class="hs-identifier hs-var">InstanceState.addUtxoProducedReq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Request PABReq
</span><a href="#local-6989586621680273013"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">rqRequest :: CardanoAddress
</span><span class="hs-identifier hs-var">rqRequest</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CardanoAddress
</span><a href="#local-6989586621680273008"><span class="hs-identifier hs-var">addr</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InstanceState
</span><a href="#local-6989586621680273015"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-461"></span><span>                </span><span class="annot"><span class="annottext">PABReq
</span><span class="hs-identifier">_</span></span><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; STM ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-462"></span><span>        </span><span class="annot"><span class="annottext">Value -&gt; InstanceState -&gt; STM ()
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#setObservableState"><span class="hs-identifier hs-var">InstanceState.setObservableState</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680273017"><span class="hs-identifier hs-var">observableState</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceState
</span><a href="#local-6989586621680273015"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-463"></span><span>
</span><span id="line-464"></span><span class="hs-comment">-- | Run the STM-based request handler on a non-empty list</span><span>
</span><span id="line-465"></span><span class="hs-comment">--   of requests.</span><span>
</span><span id="line-466"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.html#respondToRequestsSTM"><span class="hs-identifier hs-type">respondToRequestsSTM</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-467"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680273301"><span class="annot"><a href="#local-6989586621680273301"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680273299"><span class="annot"><a href="#local-6989586621680273299"><span class="hs-identifier hs-type">t</span></a></span></span><span> </span><span id="local-6989586621680273300"><span class="annot"><a href="#local-6989586621680273300"><span class="hs-identifier hs-type">effs</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-468"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LastMember</span></span><span> </span><span class="annot"><a href="#local-6989586621680273301"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273300"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-469"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273301"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-470"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ChainIndexQueryEffect</span></span><span> </span><span class="annot"><a href="#local-6989586621680273300"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-471"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">WalletEffect</span></span><span> </span><span class="annot"><a href="#local-6989586621680273300"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-472"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeClientEffect</span></span><span> </span><span class="annot"><a href="#local-6989586621680273300"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-473"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">LogMsg</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">RequestHandlerLogMsg</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273300"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-474"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">LogObserve</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">LogMessage</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text.Text</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273300"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-475"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">LogMsg</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.RequestHandlers.html#ContractInstanceMsg"><span class="hs-identifier hs-type">ContractInstanceMsg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273299"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273300"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-476"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ContractInstanceId</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273300"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-477"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier hs-type">BlockchainEnv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273300"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-478"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680273300"><span class="hs-identifier hs-type">effs</span></a></span><span>
</span><span id="line-479"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#PABContract"><span class="hs-identifier hs-type">Contract.PABContract</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273299"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-480"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-481"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ContractInstanceId</span></span><span>
</span><span id="line-482"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Effects.Contract.html#State"><span class="hs-identifier hs-type">Contract.State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273299"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-483"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eff</span></span><span> </span><span class="annot"><a href="#local-6989586621680273300"><span class="hs-identifier hs-type">effs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Response</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PABResp</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-484"></span><span id="respondToRequestsSTM"><span class="annot"><span class="annottext">respondToRequestsSTM :: ContractInstanceId -&gt; State t -&gt; Eff effs (STM (Response PABResp))
</span><a href="Plutus.PAB.Core.ContractInstance.html#respondToRequestsSTM"><span class="hs-identifier hs-var hs-var">respondToRequestsSTM</span></a></span></span><span> </span><span id="local-6989586621680273005"><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273005"><span class="hs-identifier hs-var">instanceId</span></a></span></span><span> </span><span id="local-6989586621680273004"><span class="annot"><span class="annottext">State t
</span><a href="#local-6989586621680273004"><span class="hs-identifier hs-var">currentState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-485"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680273003"><span class="annot"><span class="annottext">rqs :: [Request PABReq]
</span><a href="#local-6989586621680273003"><span class="hs-identifier hs-var hs-var">rqs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State t -&gt; [Request PABReq]
forall contract.
PABContract contract =&gt;
State contract -&gt; [Request PABReq]
</span><a href="Plutus.PAB.Effects.Contract.html#requests"><span class="hs-identifier hs-var">Contract.requests</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680273299"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><span class="annottext">State t
</span><a href="#local-6989586621680273004"><span class="hs-identifier hs-var">currentState</span></a></span><span>
</span><span id="line-486"></span><span>    </span><span class="annot"><span class="annottext">forall (effs :: [* -&gt; *]).
Member (LogMsg (ContractInstanceMsg t)) effs =&gt;
ContractInstanceMsg t -&gt; Eff effs ()
forall a (effs :: [* -&gt; *]).
Member (LogMsg a) effs =&gt;
a -&gt; Eff effs ()
</span><span class="hs-identifier hs-var">logDebug</span></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.RequestHandlers.html#ContractInstanceMsg"><span class="hs-identifier hs-type">ContractInstanceMsg</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680273299"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ContractInstanceMsg t -&gt; Eff effs ())
-&gt; ContractInstanceMsg t -&gt; Eff effs ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId -&gt; [Request PABReq] -&gt; ContractInstanceMsg t
forall t.
ContractInstanceId -&gt; [Request PABReq] -&gt; ContractInstanceMsg t
</span><a href="Plutus.PAB.Core.ContractInstance.RequestHandlers.html#HandlingRequests"><span class="hs-identifier hs-var">HandlingRequests</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680273005"><span class="hs-identifier hs-var">instanceId</span></a></span><span> </span><span class="annot"><span class="annottext">[Request PABReq]
</span><a href="#local-6989586621680273003"><span class="hs-identifier hs-var">rqs</span></a></span><span>
</span><span id="line-487"></span><span>    </span><span class="annot"><span class="annottext">RequestHandler effs (Request PABReq) (STM (Response PABResp))
-&gt; [Request PABReq] -&gt; Eff effs (STM (Response PABResp))
forall (f :: * -&gt; *) (effs :: [* -&gt; *]) req resp.
(Alternative f, Monad f) =&gt;
RequestHandler effs req (f resp) -&gt; [req] -&gt; Eff effs (f resp)
</span><span class="hs-identifier hs-var">tryHandler'</span></span><span> </span><span class="annot"><span class="annottext">RequestHandler effs (Request PABReq) (STM (Response PABResp))
forall (m :: * -&gt; *) (effs :: [* -&gt; *]).
(LastMember m effs, MonadIO m, Member ChainIndexQueryEffect effs,
 Member WalletEffect effs, Member NodeClientEffect effs,
 Member (LogMsg RequestHandlerLogMsg) effs,
 Member (LogObserve (LogMessage Text)) effs,
 Member (Reader ContractInstanceId) effs,
 Member (Reader BlockchainEnv) effs,
 Member (Reader InstanceState) effs) =&gt;
RequestHandler effs (Request PABReq) (STM (Response PABResp))
</span><a href="Plutus.PAB.Core.ContractInstance.html#stmRequestHandler"><span class="hs-identifier hs-var">stmRequestHandler</span></a></span><span> </span><span class="annot"><span class="annottext">[Request PABReq]
</span><a href="#local-6989586621680273003"><span class="hs-identifier hs-var">rqs</span></a></span><span>
</span><span id="line-488"></span></pre></body></html>