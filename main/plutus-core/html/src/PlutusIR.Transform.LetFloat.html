<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span id="%24con2tag_5DhacGFo1Iz26bG6b6vUEa"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase          #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell     #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies        #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE ViewPatterns        #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-unused-top-binds #-}</span><span>
</span><span id="line-7"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">PlutusIR.Transform.LetFloat</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#floatTerm"><span class="hs-identifier">floatTerm</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Arrow</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator">(&gt;&gt;&gt;)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Strict</span></span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Writer</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Coerce</span></a></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Foldable</span></a></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.List.NonEmpty</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NE</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Monoidal</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MM</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Semigroup.Foldable</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Semigroup.Generic</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set.Lens</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">setOf</span></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">GHC.Generics</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.html"><span class="hs-identifier">PlutusCore</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PLC</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.html"><span class="hs-identifier">PlutusCore.Builtin</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PLC</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Name.html"><span class="hs-identifier">PlutusCore.Name</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PLC</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusIR.html"><span class="hs-identifier">PlutusIR</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusIR.Purity.html"><span class="hs-identifier">PlutusIR.Purity</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusIR.Subst.html"><span class="hs-identifier">PlutusIR.Subst</span></a></span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-comment">{- Note [Let Floating pass]

The goal of this pass is to move (float) let-bindings as outwards as possible,
without breaking the scoping &amp; meaning of the original PIR term.

This transformation (a.k.a. full laziness), together with a possible implementation
is described in Peyton Jones, Simon, Will Partain, and Andre Santos. &quot;Let-Floating: Moving Bindings to Give Faster Programs.&quot;
In Proceedings of the First ACM SIGPLAN International Conference on Functional Programming, 1-12.
ICFP '96. New York, NY, USA: ACM, 1996. https://doi.org/10.1145/232627.232630.

An implementation, as described in the paper, is comprised of two &quot;passes&quot;:

1) a &quot;mark&quot; pass to traverse the term tree and
  - in case of lam/Lam, mark this lam/Lam name with current depth, and
    increase the depth for the lam/Lam's-abstraction body term and recurse.
  - in case of a Letrecgroup, collect the free term&amp;type variables and mark every let-introduced name
    with the maximum depth among all the free variables (the free variables should be already marked)
  - in case of letnonrec group, you can treat it the same as (letrec g in letrec gs)

2) a &quot;float-back&quot; pass which, given the collected marks,
   traverses the term tree again and whenever a let(rec or nonrec) is encountered,
   decides locally if it is worth to float the current let outwards at its marked depth.
   If yes, the let-group's binding is floated exactly outside a lambda abstraction that has lam_depth=let_depth+1

There are some  differences with the paper's described implementation above, namely:

a) we use 3 passes. the 1st pass is similar to the original; a second pass
&quot;cleans&quot; the term from all the to-be-floated lets and stores them in a separate table.
the 3rd pass is responsible to float back the removed lets inside the cleaned term
according to their markers. So we use an extra pass because we float back lets in a global fashion,
instead of deciding locally.

b) Since the 3rd (float-back) pass operates on the cleaned term, we have lost
the original location of the lets, so we cannot float them &quot;right outside&quot; the **maximum-independent lambda-abstraction**,
but we float them &quot;right inside&quot; the maximum **dependent** lambda-abstraction's body. This has the downside
of allocating&amp;holding the lets for longer than needed, but will not alter the meaning of the original PIR term.

c) Since PIR has strict (compared to the paper's lazy-only lang), we have to make
sure that any let-group containing at least one **effectful** (i.e. non-pure) strict binding is
not floated at all. See the implementation of 'hasNoEffects'.

This does not mean that such an &quot;effectful&quot; let
will appear in the same absolute location as the original term:
An outside/parent let may float around, changing the child's (effectful let) absolute location;
however, the child's relative location to the parent *must* remain the same. Consider this example:

`... let (nonstrict) x1= (let (strict) x2 = error in rhs1) in body1`

The parent of x2 is x1 and it is floatable
The child of x1 is x2 and it is unmovable
The x2 binding will not move with respect to x1, but its original absolute program location may change,
because the parent may float upwards somewhere else.

Since another let variable may depend on such *effectful* let, and to preserve the execution order,
we treat an effectful also as an &quot;anchor&quot;, by increasing the current depth
both on entering any of its rhs'es *and* inside its inTerm.
-}</span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span class="hs-keyword">newtype</span><span> </span><span id="Depth"><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#Depth"><span class="hs-identifier hs-var">Depth</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Depth"><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#Depth"><span class="hs-identifier hs-var">Depth</span></a></span></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-89"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">newtype</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680956631"><span id="local-6989586621680956633"><span class="annot"><span class="annottext">Depth -&gt; Depth -&gt; Bool
(Depth -&gt; Depth -&gt; Bool) -&gt; (Depth -&gt; Depth -&gt; Bool) -&gt; Eq Depth
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: Depth -&gt; Depth -&gt; Bool
$c/= :: Depth -&gt; Depth -&gt; Bool
== :: Depth -&gt; Depth -&gt; Bool
$c== :: Depth -&gt; Depth -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680956615"><span id="local-6989586621680956617"><span id="local-6989586621680956619"><span id="local-6989586621680956621"><span id="local-6989586621680956623"><span id="local-6989586621680956625"><span id="local-6989586621680956627"><span class="annot"><span class="annottext">Eq Depth
Eq Depth
-&gt; (Depth -&gt; Depth -&gt; Ordering)
-&gt; (Depth -&gt; Depth -&gt; Bool)
-&gt; (Depth -&gt; Depth -&gt; Bool)
-&gt; (Depth -&gt; Depth -&gt; Bool)
-&gt; (Depth -&gt; Depth -&gt; Bool)
-&gt; (Depth -&gt; Depth -&gt; Depth)
-&gt; (Depth -&gt; Depth -&gt; Depth)
-&gt; Ord Depth
Depth -&gt; Depth -&gt; Bool
Depth -&gt; Depth -&gt; Ordering
Depth -&gt; Depth -&gt; Depth
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
min :: Depth -&gt; Depth -&gt; Depth
$cmin :: Depth -&gt; Depth -&gt; Depth
max :: Depth -&gt; Depth -&gt; Depth
$cmax :: Depth -&gt; Depth -&gt; Depth
&gt;= :: Depth -&gt; Depth -&gt; Bool
$c&gt;= :: Depth -&gt; Depth -&gt; Bool
&gt; :: Depth -&gt; Depth -&gt; Bool
$c&gt; :: Depth -&gt; Depth -&gt; Bool
&lt;= :: Depth -&gt; Depth -&gt; Bool
$c&lt;= :: Depth -&gt; Depth -&gt; Bool
&lt; :: Depth -&gt; Depth -&gt; Bool
$c&lt; :: Depth -&gt; Depth -&gt; Bool
compare :: Depth -&gt; Depth -&gt; Ordering
$ccompare :: Depth -&gt; Depth -&gt; Ordering
$cp1Ord :: Eq Depth
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></a></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680956608"><span id="local-6989586621680956610"><span id="local-6989586621680956612"><span class="annot"><span class="annottext">Int -&gt; Depth -&gt; ShowS
[Depth] -&gt; ShowS
Depth -&gt; String
(Int -&gt; Depth -&gt; ShowS)
-&gt; (Depth -&gt; String) -&gt; ([Depth] -&gt; ShowS) -&gt; Show Depth
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Depth] -&gt; ShowS
$cshowList :: [Depth] -&gt; ShowS
show :: Depth -&gt; String
$cshow :: Depth -&gt; String
showsPrec :: Int -&gt; Depth -&gt; ShowS
$cshowsPrec :: Int -&gt; Depth -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680956593"><span id="local-6989586621680956595"><span id="local-6989586621680956597"><span id="local-6989586621680956599"><span id="local-6989586621680956601"><span id="local-6989586621680956603"><span id="local-6989586621680956605"><span class="annot"><span class="annottext">Integer -&gt; Depth
Depth -&gt; Depth
Depth -&gt; Depth -&gt; Depth
(Depth -&gt; Depth -&gt; Depth)
-&gt; (Depth -&gt; Depth -&gt; Depth)
-&gt; (Depth -&gt; Depth -&gt; Depth)
-&gt; (Depth -&gt; Depth)
-&gt; (Depth -&gt; Depth)
-&gt; (Depth -&gt; Depth)
-&gt; (Integer -&gt; Depth)
-&gt; Num Depth
forall a.
(a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a)
-&gt; (a -&gt; a)
-&gt; (a -&gt; a)
-&gt; (Integer -&gt; a)
-&gt; Num a
fromInteger :: Integer -&gt; Depth
$cfromInteger :: Integer -&gt; Depth
signum :: Depth -&gt; Depth
$csignum :: Depth -&gt; Depth
abs :: Depth -&gt; Depth
$cabs :: Depth -&gt; Depth
negate :: Depth -&gt; Depth
$cnegate :: Depth -&gt; Depth
* :: Depth -&gt; Depth -&gt; Depth
$c* :: Depth -&gt; Depth -&gt; Depth
- :: Depth -&gt; Depth -&gt; Depth
$c- :: Depth -&gt; Depth -&gt; Depth
+ :: Depth -&gt; Depth -&gt; Depth
$c+ :: Depth -&gt; Depth -&gt; Depth
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Num</span></a></span></span></span></span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="hs-comment">{-| Position of an anchor (lam,Lam,unfloatable-let or Top).
The original paper's algorithm relies just on using the depth as the anchor's position;
for us this is no enough, because we act mark/remove/float globally and the depth is not globally-unique.
To fix this, we use an extra &quot;representative&quot; identifier (PLC.Unique) of the anchor.
Since (unfloatable) lets can also be anchors, we also use an extra 'PosType' to differentiate
between two cases of a let-anchor, see 'PosType'.
-}</span><span>
</span><span id="line-98"></span><span class="hs-keyword">data</span><span> </span><span id="Pos"><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#Pos"><span class="hs-identifier hs-var">Pos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Pos"><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#Pos"><span class="hs-identifier hs-var">Pos</span></a></span></span><span>
</span><span id="line-99"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="_posDepth"><span class="annot"><span class="annottext">Pos -&gt; Depth
</span><a href="PlutusIR.Transform.LetFloat.html#_posDepth"><span class="hs-identifier hs-var hs-var">_posDepth</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#Depth"><span class="hs-identifier hs-type">Depth</span></a></span><span>
</span><span id="line-100"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_posUnique"><span class="annot"><span class="annottext">Pos -&gt; Unique
</span><a href="PlutusIR.Transform.LetFloat.html#_posUnique"><span class="hs-identifier hs-var hs-var">_posUnique</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#Unique"><span class="hs-identifier hs-type">PLC.Unique</span></a></span><span> </span><span class="hs-comment">-- ^ The lam name or Lam tyname or Let's representative unique</span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_posType"><span class="annot"><span class="annottext">Pos -&gt; PosType
</span><a href="PlutusIR.Transform.LetFloat.html#_posType"><span class="hs-identifier hs-var hs-var">_posType</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#PosType"><span class="hs-identifier hs-type">PosType</span></a></span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-103"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680956584"><span id="local-6989586621680956586"><span class="annot"><span class="annottext">Pos -&gt; Pos -&gt; Bool
(Pos -&gt; Pos -&gt; Bool) -&gt; (Pos -&gt; Pos -&gt; Bool) -&gt; Eq Pos
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: Pos -&gt; Pos -&gt; Bool
$c/= :: Pos -&gt; Pos -&gt; Bool
== :: Pos -&gt; Pos -&gt; Bool
$c== :: Pos -&gt; Pos -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680956569"><span id="local-6989586621680956571"><span id="local-6989586621680956573"><span id="local-6989586621680956575"><span id="local-6989586621680956577"><span id="local-6989586621680956579"><span id="local-6989586621680956581"><span class="annot"><span class="annottext">Eq Pos
Eq Pos
-&gt; (Pos -&gt; Pos -&gt; Ordering)
-&gt; (Pos -&gt; Pos -&gt; Bool)
-&gt; (Pos -&gt; Pos -&gt; Bool)
-&gt; (Pos -&gt; Pos -&gt; Bool)
-&gt; (Pos -&gt; Pos -&gt; Bool)
-&gt; (Pos -&gt; Pos -&gt; Pos)
-&gt; (Pos -&gt; Pos -&gt; Pos)
-&gt; Ord Pos
Pos -&gt; Pos -&gt; Bool
Pos -&gt; Pos -&gt; Ordering
Pos -&gt; Pos -&gt; Pos
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
min :: Pos -&gt; Pos -&gt; Pos
$cmin :: Pos -&gt; Pos -&gt; Pos
max :: Pos -&gt; Pos -&gt; Pos
$cmax :: Pos -&gt; Pos -&gt; Pos
&gt;= :: Pos -&gt; Pos -&gt; Bool
$c&gt;= :: Pos -&gt; Pos -&gt; Bool
&gt; :: Pos -&gt; Pos -&gt; Bool
$c&gt; :: Pos -&gt; Pos -&gt; Bool
&lt;= :: Pos -&gt; Pos -&gt; Bool
$c&lt;= :: Pos -&gt; Pos -&gt; Bool
&lt; :: Pos -&gt; Pos -&gt; Bool
$c&lt; :: Pos -&gt; Pos -&gt; Bool
compare :: Pos -&gt; Pos -&gt; Ordering
$ccompare :: Pos -&gt; Pos -&gt; Ordering
$cp1Ord :: Eq Pos
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></a></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680956563"><span id="local-6989586621680956565"><span id="local-6989586621680956567"><span class="annot"><span class="annottext">Int -&gt; Pos -&gt; ShowS
[Pos] -&gt; ShowS
Pos -&gt; String
(Int -&gt; Pos -&gt; ShowS)
-&gt; (Pos -&gt; String) -&gt; ([Pos] -&gt; ShowS) -&gt; Show Pos
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Pos] -&gt; ShowS
$cshowList :: [Pos] -&gt; ShowS
show :: Pos -&gt; String
$cshow :: Pos -&gt; String
showsPrec :: Int -&gt; Pos -&gt; ShowS
$cshowsPrec :: Int -&gt; Pos -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="hs-comment">{-| The type of the anchor's position. We only need this because
we need to differentiate between two cases of a 'let-anchor' position:

A floatable let-binding can (maximally) depend on an (unfloatable, effectful) let anchor,
which means that it will either float in two different places, depending upon the floatable let's original location:

a) floated *next to* the let-anchor it depends upon (inside its let-group), if it originated from the rhs of the let-anchor
b) floated directly under the `in` of the let-anchor it depends upon, if it originated from the inTerm of the let-anchor.
-}</span><span>
</span><span id="line-114"></span><span class="hs-keyword">data</span><span> </span><span id="PosType"><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#PosType"><span class="hs-identifier hs-var">PosType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="LamBody"><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#LamBody"><span class="hs-identifier hs-var">LamBody</span></a></span></span><span> </span><span class="hs-comment">-- ^ lam, Lam, let body, or Top</span><span>
</span><span id="line-115"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span id="LetRhs"><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#LetRhs"><span class="hs-identifier hs-var">LetRhs</span></a></span></span><span> </span><span class="hs-comment">-- ^ let rhs</span><span>
</span><span id="line-116"></span><span>             </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680956557"><span id="local-6989586621680956559"><span class="annot"><span class="annottext">PosType -&gt; PosType -&gt; Bool
(PosType -&gt; PosType -&gt; Bool)
-&gt; (PosType -&gt; PosType -&gt; Bool) -&gt; Eq PosType
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: PosType -&gt; PosType -&gt; Bool
$c/= :: PosType -&gt; PosType -&gt; Bool
== :: PosType -&gt; PosType -&gt; Bool
$c== :: PosType -&gt; PosType -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680956542"><span id="local-6989586621680956544"><span id="local-6989586621680956546"><span id="local-6989586621680956548"><span id="local-6989586621680956550"><span id="local-6989586621680956552"><span id="local-6989586621680956554"><span class="annot"><span class="annottext">Eq PosType
Eq PosType
-&gt; (PosType -&gt; PosType -&gt; Ordering)
-&gt; (PosType -&gt; PosType -&gt; Bool)
-&gt; (PosType -&gt; PosType -&gt; Bool)
-&gt; (PosType -&gt; PosType -&gt; Bool)
-&gt; (PosType -&gt; PosType -&gt; Bool)
-&gt; (PosType -&gt; PosType -&gt; PosType)
-&gt; (PosType -&gt; PosType -&gt; PosType)
-&gt; Ord PosType
PosType -&gt; PosType -&gt; Bool
PosType -&gt; PosType -&gt; Ordering
PosType -&gt; PosType -&gt; PosType
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
min :: PosType -&gt; PosType -&gt; PosType
$cmin :: PosType -&gt; PosType -&gt; PosType
max :: PosType -&gt; PosType -&gt; PosType
$cmax :: PosType -&gt; PosType -&gt; PosType
&gt;= :: PosType -&gt; PosType -&gt; Bool
$c&gt;= :: PosType -&gt; PosType -&gt; Bool
&gt; :: PosType -&gt; PosType -&gt; Bool
$c&gt; :: PosType -&gt; PosType -&gt; Bool
&lt;= :: PosType -&gt; PosType -&gt; Bool
$c&lt;= :: PosType -&gt; PosType -&gt; Bool
&lt; :: PosType -&gt; PosType -&gt; Bool
$c&lt; :: PosType -&gt; PosType -&gt; Bool
compare :: PosType -&gt; PosType -&gt; Ordering
$ccompare :: PosType -&gt; PosType -&gt; Ordering
$cp1Ord :: Eq PosType
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></a></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680956536"><span id="local-6989586621680956538"><span id="local-6989586621680956540"><span class="annot"><span class="annottext">Int -&gt; PosType -&gt; ShowS
[PosType] -&gt; ShowS
PosType -&gt; String
(Int -&gt; PosType -&gt; ShowS)
-&gt; (PosType -&gt; String) -&gt; ([PosType] -&gt; ShowS) -&gt; Show PosType
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [PosType] -&gt; ShowS
$cshowList :: [PosType] -&gt; ShowS
show :: PosType -&gt; String
$cshow :: PosType -&gt; String
showsPrec :: Int -&gt; PosType -&gt; ShowS
$cshowsPrec :: Int -&gt; PosType -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-117"></span><span>
</span><span id="line-118"></span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#topPos"><span class="hs-identifier hs-type">topPos</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span>
</span><span id="line-119"></span><span id="topPos"><span class="annot"><span class="annottext">topPos :: Pos
</span><a href="PlutusIR.Transform.LetFloat.html#topPos"><span class="hs-identifier hs-var hs-var">topPos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Depth -&gt; Unique -&gt; PosType -&gt; Pos
</span><a href="PlutusIR.Transform.LetFloat.html#Pos"><span class="hs-identifier hs-var">Pos</span></a></span><span> </span><span class="annot"><span class="annottext">Depth
</span><a href="PlutusIR.Transform.LetFloat.html#topDepth"><span class="hs-identifier hs-var">topDepth</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="PlutusIR.Transform.LetFloat.html#topUnique"><span class="hs-identifier hs-var">topUnique</span></a></span><span> </span><span class="annot"><span class="annottext">PosType
</span><a href="PlutusIR.Transform.LetFloat.html#topType"><span class="hs-identifier hs-var">topType</span></a></span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span class="hs-comment">-- | For simplicity, the top position is also linked to a unique number</span><span>
</span><span id="line-122"></span><span class="hs-comment">-- chosen to not clash with any actual uniques of names/tynames of the program</span><span>
</span><span id="line-123"></span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#topUnique"><span class="hs-identifier hs-type">topUnique</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#Unique"><span class="hs-identifier hs-type">PLC.Unique</span></a></span><span>
</span><span id="line-124"></span><span id="topUnique"><span class="annot"><span class="annottext">topUnique :: Unique
</span><a href="PlutusIR.Transform.LetFloat.html#topUnique"><span class="hs-identifier hs-var hs-var">topUnique</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Unique
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">coerce</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span>
</span><span id="line-126"></span><span class="hs-comment">-- | arbitrarily chosen</span><span>
</span><span id="line-127"></span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#topDepth"><span class="hs-identifier hs-type">topDepth</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#Depth"><span class="hs-identifier hs-type">Depth</span></a></span><span>
</span><span id="line-128"></span><span id="topDepth"><span class="annot"><span class="annottext">topDepth :: Depth
</span><a href="PlutusIR.Transform.LetFloat.html#topDepth"><span class="hs-identifier hs-var hs-var">topDepth</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">Depth
</span><span class="hs-number">1</span></span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span class="hs-comment">-- | arbitrary chosen as LamBody, because top can be imagined as a global inbody (of an empty letterm)</span><span>
</span><span id="line-131"></span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#topType"><span class="hs-identifier hs-type">topType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#PosType"><span class="hs-identifier hs-type">PosType</span></a></span><span>
</span><span id="line-132"></span><span id="topType"><span class="annot"><span class="annottext">topType :: PosType
</span><a href="PlutusIR.Transform.LetFloat.html#topType"><span class="hs-identifier hs-var hs-var">topType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PosType
</span><a href="PlutusIR.Transform.LetFloat.html#LamBody"><span class="hs-identifier hs-var">LamBody</span></a></span><span>
</span><span id="line-133"></span><span>
</span><span id="line-134"></span><span class="hs-comment">-- | Arbitrary: return a single unique among all the introduced uniques of the given letgroup.</span><span>
</span><span id="line-135"></span><span id="local-6989586621680956898"><span id="local-6989586621680956899"><span id="local-6989586621680956900"><span id="local-6989586621680956901"><span id="local-6989586621680956902"><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#representativeBindingUnique"><span class="hs-identifier hs-type">representativeBindingUnique</span></a></span><span>
</span><span id="line-136"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956902"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TermUnique"><span class="hs-identifier hs-type">PLC.TermUnique</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956901"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TypeUnique"><span class="hs-identifier hs-type">PLC.TypeUnique</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">NE.NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956901"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956902"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956900"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956899"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956898"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#Unique"><span class="hs-identifier hs-type">PLC.Unique</span></a></span></span></span></span></span></span><span>
</span><span id="line-138"></span><span id="representativeBindingUnique"><span class="annot"><span class="annottext">representativeBindingUnique :: NonEmpty (Binding tyname name uni fun a) -&gt; Unique
</span><a href="PlutusIR.Transform.LetFloat.html#representativeBindingUnique"><span class="hs-identifier hs-var hs-var">representativeBindingUnique</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-139"></span><span>    </span><span class="hs-comment">-- Arbitrary: select the first unique from the representative binding</span><span>
</span><span id="line-140"></span><span>    </span><span class="annot"><span class="annottext">Getting (First Unique) (Binding tyname name uni fun a) Unique
-&gt; Binding tyname name uni fun a -&gt; Unique
forall a s. Getting (First a) s a -&gt; s -&gt; a
</span><span class="hs-identifier hs-var">first1Of</span></span><span> </span><span class="annot"><span class="annottext">Getting (First Unique) (Binding tyname name uni fun a) Unique
forall tyname name (uni :: * -&gt; *) fun a.
(HasUnique tyname TypeUnique, HasUnique name TermUnique) =&gt;
Traversal1' (Binding tyname name uni fun a) Unique
</span><a href="PlutusIR.Core.Plated.html#bindingIds"><span class="hs-identifier hs-var">bindingIds</span></a></span><span> </span><span class="annot"><span class="annottext">(Binding tyname name uni fun a -&gt; Unique)
-&gt; (NonEmpty (Binding tyname name uni fun a)
    -&gt; Binding tyname name uni fun a)
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; Unique
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
-&gt; Binding tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
NonEmpty (Binding tyname name uni fun a)
-&gt; Binding tyname name uni fun a
</span><a href="#local-6989586621680956527"><span class="hs-identifier hs-var">representativeBinding</span></a></span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-comment">--  Arbitrary: a binding to be used as representative binding in MARKING the group of bindings.</span><span>
</span><span id="line-143"></span><span>    </span><span id="local-6989586621680957021"><span id="local-6989586621680957022"><span id="local-6989586621680957023"><span id="local-6989586621680957024"><span id="local-6989586621680957025"><span class="annot"><a href="#local-6989586621680956527"><span class="hs-identifier hs-type">representativeBinding</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">NE.NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680957025"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680957024"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680957023"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680957022"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680957021"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680957025"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680957024"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680957023"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680957022"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680957021"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span></span><span>
</span><span id="line-144"></span><span>    </span><span id="local-6989586621680956527"><span class="annot"><span class="annottext">representativeBinding :: NonEmpty (Binding tyname name uni fun a)
-&gt; Binding tyname name uni fun a
</span><a href="#local-6989586621680956527"><span class="hs-identifier hs-var hs-var">representativeBinding</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
-&gt; Binding tyname name uni fun a
forall a. NonEmpty a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">NE.head</span></a></span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span class="hs-comment">-- | Every term and type variable in current scope</span><span>
</span><span id="line-147"></span><span class="hs-comment">-- is paired with its own computed marker (maximum dependent position)</span><span>
</span><span id="line-148"></span><span class="hs-comment">-- OPTIMIZE: use UniqueMap instead</span><span>
</span><span id="line-149"></span><span class="hs-keyword">type</span><span> </span><span id="Scope"><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#Scope"><span class="hs-identifier hs-var">Scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#Unique"><span class="hs-identifier hs-type">PLC.Unique</span></a></span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span class="hs-comment">-- | The first pass has a reader context of current depth, and (term&amp;type)variables in scope.</span><span>
</span><span id="line-152"></span><span class="hs-keyword">data</span><span> </span><span id="MarkCtx"><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#MarkCtx"><span class="hs-identifier hs-var">MarkCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="MarkCtx"><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#MarkCtx"><span class="hs-identifier hs-var">MarkCtx</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="_markCtxDepth"><span class="annot"><span class="annottext">MarkCtx -&gt; Depth
</span><a href="PlutusIR.Transform.LetFloat.html#_markCtxDepth"><span class="hs-identifier hs-var hs-var">_markCtxDepth</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#Depth"><span class="hs-identifier hs-type">Depth</span></a></span><span class="hs-special">,</span><span> </span><span id="_markCtxScope"><span class="annot"><span class="annottext">MarkCtx -&gt; Scope
</span><a href="PlutusIR.Transform.LetFloat.html#_markCtxScope"><span class="hs-identifier hs-var hs-var">_markCtxScope</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-153"></span><span id="markCtxScope"><span id="markCtxDepth"><span class="hs-identifier">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">MarkCtx</span></span></span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span class="hs-comment">-- | The result of the first pass is a subset(union of all computed scopes).</span><span>
</span><span id="line-156"></span><span class="hs-comment">-- This subset contains only the marks of the floatable lets.</span><span>
</span><span id="line-157"></span><span class="hs-keyword">type</span><span> </span><span id="Marks"><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#Marks"><span class="hs-identifier hs-var">Marks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span>
</span><span id="line-158"></span><span>
</span><span id="line-159"></span><span class="hs-comment">{-|
A 'BindingGrp' is a group of bindings and a *minimum* recursivity for the group.
We use this intermediate structure when tracking groups of bindings to be floated or re-inserted.

It's convenient when doing this work to be able to combine binding groups (with the 'Semigroup') instance.
However, appending 'BindingGrp's does not account for the possibility that binding groups may *share*
variables. This means that the combination of multiple non-recursive binding groups may be recursive.
As such, if you have reason to believe that the variables used by the combined binding groups may not be disjoint,
you should manually require the term to be recursive when you convert back to a let term with 'bindingGrpToLet'.
-}</span><span>
</span><span id="line-169"></span><span id="local-6989586621680956518"><span id="local-6989586621680956519"></span></span><span class="hs-keyword">data</span><span> </span><span id="BindingGrp"><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#BindingGrp"><span class="hs-identifier hs-var">BindingGrp</span></a></span></span><span> </span><span id="local-6989586621680956896"><span class="annot"><a href="#local-6989586621680956896"><span class="hs-identifier hs-type">tyname</span></a></span></span><span> </span><span id="local-6989586621680956895"><span class="annot"><a href="#local-6989586621680956895"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621680956894"><span class="annot"><a href="#local-6989586621680956894"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621680956893"><span class="annot"><a href="#local-6989586621680956893"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621680956897"><span class="annot"><a href="#local-6989586621680956897"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="BindingGrp"><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#BindingGrp"><span class="hs-identifier hs-var">BindingGrp</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-170"></span><span>    </span><span id="_bgAnn"><span class="annot"><span class="annottext">BindingGrp tyname name uni fun a -&gt; a
</span><a href="PlutusIR.Transform.LetFloat.html#_bgAnn"><span class="hs-identifier hs-var hs-var">_bgAnn</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621680956897"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-171"></span><span>    </span><span id="_bgRec"><span class="annot"><span class="annottext">BindingGrp tyname name uni fun a -&gt; Recursivity
</span><a href="PlutusIR.Transform.LetFloat.html#_bgRec"><span class="hs-identifier hs-var hs-var">_bgRec</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Recursivity"><span class="hs-identifier hs-type">Recursivity</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-172"></span><span>    </span><span id="_bgBindings"><span class="annot"><span class="annottext">BindingGrp tyname name uni fun a
-&gt; NonEmpty (Binding tyname name uni fun a)
</span><a href="PlutusIR.Transform.LetFloat.html#_bgBindings"><span class="hs-identifier hs-var hs-var">_bgBindings</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">NE.NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956896"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956895"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956894"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956893"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956897"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-173"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-174"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="annot"><span class="annottext">(forall x.
 BindingGrp tyname name uni fun a
 -&gt; Rep (BindingGrp tyname name uni fun a) x)
-&gt; (forall x.
    Rep (BindingGrp tyname name uni fun a) x
    -&gt; BindingGrp tyname name uni fun a)
-&gt; Generic (BindingGrp tyname name uni fun a)
forall x.
Rep (BindingGrp tyname name uni fun a) x
-&gt; BindingGrp tyname name uni fun a
forall x.
BindingGrp tyname name uni fun a
-&gt; Rep (BindingGrp tyname name uni fun a) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall tyname name (uni :: * -&gt; *) fun a x.
Rep (BindingGrp tyname name uni fun a) x
-&gt; BindingGrp tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a x.
BindingGrp tyname name uni fun a
-&gt; Rep (BindingGrp tyname name uni fun a) x
$cto :: forall tyname name (uni :: * -&gt; *) fun a x.
Rep (BindingGrp tyname name uni fun a) x
-&gt; BindingGrp tyname name uni fun a
$cfrom :: forall tyname name (uni :: * -&gt; *) fun a x.
BindingGrp tyname name uni fun a
-&gt; Rep (BindingGrp tyname name uni fun a) x
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span>
</span><span id="line-175"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621680956505"><span id="local-6989586621680956507"><span id="local-6989586621680956509"><span class="annot"><span class="annottext">b
-&gt; BindingGrp tyname name uni fun a
-&gt; BindingGrp tyname name uni fun a
NonEmpty (BindingGrp tyname name uni fun a)
-&gt; BindingGrp tyname name uni fun a
BindingGrp tyname name uni fun a
-&gt; BindingGrp tyname name uni fun a
-&gt; BindingGrp tyname name uni fun a
(BindingGrp tyname name uni fun a
 -&gt; BindingGrp tyname name uni fun a
 -&gt; BindingGrp tyname name uni fun a)
-&gt; (NonEmpty (BindingGrp tyname name uni fun a)
    -&gt; BindingGrp tyname name uni fun a)
-&gt; (forall b.
    Integral b =&gt;
    b
    -&gt; BindingGrp tyname name uni fun a
    -&gt; BindingGrp tyname name uni fun a)
-&gt; Semigroup (BindingGrp tyname name uni fun a)
forall b.
Integral b =&gt;
b
-&gt; BindingGrp tyname name uni fun a
-&gt; BindingGrp tyname name uni fun a
forall a.
(a -&gt; a -&gt; a)
-&gt; (NonEmpty a -&gt; a)
-&gt; (forall b. Integral b =&gt; b -&gt; a -&gt; a)
-&gt; Semigroup a
forall tyname name (uni :: * -&gt; *) fun a.
Semigroup a =&gt;
NonEmpty (BindingGrp tyname name uni fun a)
-&gt; BindingGrp tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
Semigroup a =&gt;
BindingGrp tyname name uni fun a
-&gt; BindingGrp tyname name uni fun a
-&gt; BindingGrp tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a b.
(Semigroup a, Integral b) =&gt;
b
-&gt; BindingGrp tyname name uni fun a
-&gt; BindingGrp tyname name uni fun a
stimes :: b
-&gt; BindingGrp tyname name uni fun a
-&gt; BindingGrp tyname name uni fun a
$cstimes :: forall tyname name (uni :: * -&gt; *) fun a b.
(Semigroup a, Integral b) =&gt;
b
-&gt; BindingGrp tyname name uni fun a
-&gt; BindingGrp tyname name uni fun a
sconcat :: NonEmpty (BindingGrp tyname name uni fun a)
-&gt; BindingGrp tyname name uni fun a
$csconcat :: forall tyname name (uni :: * -&gt; *) fun a.
Semigroup a =&gt;
NonEmpty (BindingGrp tyname name uni fun a)
-&gt; BindingGrp tyname name uni fun a
&lt;&gt; :: BindingGrp tyname name uni fun a
-&gt; BindingGrp tyname name uni fun a
-&gt; BindingGrp tyname name uni fun a
$c&lt;&gt; :: forall tyname name (uni :: * -&gt; *) fun a.
Semigroup a =&gt;
BindingGrp tyname name uni fun a
-&gt; BindingGrp tyname name uni fun a
-&gt; BindingGrp tyname name uni fun a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Semigroup</span></a></span></span></span></span><span> </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GenericSemigroupMonoid</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#BindingGrp"><span class="hs-identifier hs-type">BindingGrp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956896"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956895"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956894"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956893"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956897"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span class="hs-comment">-- Note on Semigroup: appending bindingGroups will not try to fix the well-scopedness by</span><span>
</span><span id="line-177"></span><span class="hs-comment">-- rearranging any bindings or promoting to a Rec if bindings in case some bindinings refer to each other.</span><span>
</span><span id="line-178"></span><span id="bgRec"><span id="bgBindings"><span id="bgAnn"><span id="local-6989586621680956723"><span id="local-6989586621680956724"><span id="local-6989586621680956725"><span id="local-6989586621680956726"><span id="local-6989586621680956893"><span id="local-6989586621680956894"><span id="local-6989586621680956895"><span id="local-6989586621680956896"><span id="local-6989586621680956897"><span class="hs-identifier">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">BindingGrp</span></span></span></span></span></span></span></span></span></span></span></span></span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span class="hs-comment">-- | Turn a 'BindingGrp' into a let, when given a minimum recursivity and let body.</span><span>
</span><span id="line-181"></span><span id="local-6989586621680956735"><span id="local-6989586621680956736"><span id="local-6989586621680956737"><span id="local-6989586621680956738"><span id="local-6989586621680956739"><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#bindingGrpToLet"><span class="hs-identifier hs-type">bindingGrpToLet</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Recursivity"><span class="hs-identifier hs-type">Recursivity</span></a></span><span>
</span><span id="line-182"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#BindingGrp"><span class="hs-identifier hs-type">BindingGrp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956739"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956738"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956737"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956736"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956735"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-183"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956739"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956738"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956737"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956736"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956735"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956739"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956738"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956737"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956736"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956735"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-184"></span><span id="bindingGrpToLet"><span class="annot"><span class="annottext">bindingGrpToLet :: Recursivity
-&gt; BindingGrp tyname name uni fun a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Transform.LetFloat.html#bindingGrpToLet"><span class="hs-identifier hs-var hs-var">bindingGrpToLet</span></a></span></span><span> </span><span id="local-6989586621680956498"><span class="annot"><span class="annottext">Recursivity
</span><a href="#local-6989586621680956498"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#BindingGrp"><span class="hs-identifier hs-type">BindingGrp</span></a></span><span> </span><span id="local-6989586621680956497"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956497"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621680956496"><span class="annot"><span class="annottext">Recursivity
</span><a href="#local-6989586621680956496"><span class="hs-identifier hs-var">r'</span></a></span></span><span> </span><span id="local-6989586621680956495"><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621680956495"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
-&gt; Recursivity
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Recursivity
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956497"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Recursivity
</span><a href="#local-6989586621680956498"><span class="hs-identifier hs-var">r</span></a></span><span class="annot"><span class="annottext">Recursivity -&gt; Recursivity -&gt; Recursivity
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span class="annot"><span class="annottext">Recursivity
</span><a href="#local-6989586621680956496"><span class="hs-identifier hs-var">r'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621680956495"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span class="hs-comment">-- | A store of lets to be floated at their new position</span><span>
</span><span id="line-187"></span><span class="hs-keyword">type</span><span> </span><span id="FloatTable"><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#FloatTable"><span class="hs-identifier hs-var">FloatTable</span></a></span></span><span> </span><span id="local-6989586621680956493"><span class="annot"><a href="#local-6989586621680956493"><span class="hs-identifier hs-type">tyname</span></a></span></span><span> </span><span id="local-6989586621680956492"><span class="annot"><a href="#local-6989586621680956492"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621680956491"><span class="annot"><a href="#local-6989586621680956491"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621680956490"><span class="annot"><a href="#local-6989586621680956490"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621680956489"><span class="annot"><a href="#local-6989586621680956489"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MM.MonoidalMap</span></span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">NE.NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#BindingGrp"><span class="hs-identifier hs-type">BindingGrp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956493"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956492"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956491"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956490"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956489"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-188"></span><span>
</span><span id="line-189"></span><span class="hs-comment">-- | The 1st pass of marking floatable lets</span><span>
</span><span id="line-190"></span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#mark"><span class="hs-identifier hs-type">mark</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680956715"><span class="annot"><a href="#local-6989586621680956715"><span class="hs-identifier hs-type">tyname</span></a></span></span><span> </span><span id="local-6989586621680956714"><span class="annot"><a href="#local-6989586621680956714"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621680956713"><span class="annot"><a href="#local-6989586621680956713"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621680956712"><span class="annot"><a href="#local-6989586621680956712"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621680956711"><span class="annot"><a href="#local-6989586621680956711"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-191"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956715"><span class="hs-identifier hs-type">tyname</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956714"><span class="hs-identifier hs-type">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956715"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TypeUnique"><span class="hs-identifier hs-type">PLC.TypeUnique</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956714"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TermUnique"><span class="hs-identifier hs-type">PLC.TermUnique</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#ToBuiltinMeaning"><span class="hs-identifier hs-type">PLC.ToBuiltinMeaning</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956713"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956712"><span class="hs-identifier hs-type">fun</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>     </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956715"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956714"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956713"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956712"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956711"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-193"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#Marks"><span class="hs-identifier hs-type">Marks</span></a></span><span>
</span><span id="line-194"></span><span id="mark"><span class="annot"><span class="annottext">mark :: Term tyname name uni fun a -&gt; Scope
</span><a href="PlutusIR.Transform.LetFloat.html#mark"><span class="hs-identifier hs-var hs-var">mark</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((), Scope) -&gt; Scope
forall a b. (a, b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="annot"><span class="annottext">(((), Scope) -&gt; Scope)
-&gt; (Term tyname name uni fun a -&gt; ((), Scope))
-&gt; Term tyname name uni fun a
-&gt; Scope
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Writer Scope () -&gt; ((), Scope)
forall w a. Writer w a -&gt; (a, w)
</span><span class="hs-identifier hs-var">runWriter</span></span><span> </span><span class="annot"><span class="annottext">(Writer Scope () -&gt; ((), Scope))
-&gt; (Term tyname name uni fun a -&gt; Writer Scope ())
-&gt; Term tyname name uni fun a
-&gt; ((), Scope)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT MarkCtx (Writer Scope) () -&gt; MarkCtx -&gt; Writer Scope ())
-&gt; MarkCtx -&gt; ReaderT MarkCtx (Writer Scope) () -&gt; Writer Scope ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">ReaderT MarkCtx (Writer Scope) () -&gt; MarkCtx -&gt; Writer Scope ()
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Depth -&gt; Scope -&gt; MarkCtx
</span><a href="PlutusIR.Transform.LetFloat.html#MarkCtx"><span class="hs-identifier hs-var">MarkCtx</span></a></span><span> </span><span class="annot"><span class="annottext">Depth
</span><a href="PlutusIR.Transform.LetFloat.html#topDepth"><span class="hs-identifier hs-var">topDepth</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ReaderT MarkCtx (Writer Scope) () -&gt; Writer Scope ())
-&gt; (Term tyname name uni fun a
    -&gt; ReaderT MarkCtx (Writer Scope) ())
-&gt; Term tyname name uni fun a
-&gt; Writer Scope ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; ReaderT MarkCtx (Writer Scope) ()
</span><a href="#local-6989586621680956484"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-195"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-196"></span><span>    </span><span class="annot"><a href="#local-6989586621680956484"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956715"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956714"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956713"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956712"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956711"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#MarkCtx"><span class="hs-identifier hs-type">MarkCtx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Writer</span></span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#Marks"><span class="hs-identifier hs-type">Marks</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-197"></span><span>    </span><span id="local-6989586621680956484"><span class="annot"><span class="annottext">go :: Term tyname name uni fun a -&gt; ReaderT MarkCtx (Writer Scope) ()
</span><a href="#local-6989586621680956484"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; Term tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun a -&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Transform.LetFloat.html#breakNonRec"><span class="hs-identifier hs-var">breakNonRec</span></a></span><span> </span><span class="annot"><span class="annottext">(Term tyname name uni fun a -&gt; Term tyname name uni fun a)
-&gt; (Term tyname name uni fun a
    -&gt; ReaderT MarkCtx (Writer Scope) ())
-&gt; Term tyname name uni fun a
-&gt; ReaderT MarkCtx (Writer Scope) ()
forall k (cat :: k -&gt; k -&gt; *) (a :: k) (b :: k) (c :: k).
Category cat =&gt;
cat a b -&gt; cat b c -&gt; cat a c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;&gt;</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-198"></span><span>        </span><span class="hs-comment">-- lam/Lam are treated the same.</span><span>
</span><span id="line-199"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#LamAbs"><span class="hs-identifier hs-type">LamAbs</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680956481"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680956481"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680956480"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956480"><span class="hs-identifier hs-var">tBody</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">name
-&gt; ReaderT MarkCtx (Writer Scope) ()
-&gt; ReaderT MarkCtx (Writer Scope) ()
forall r (m :: * -&gt; *) name unique a.
(r ~ MarkCtx, MonadReader r m, HasUnique name unique) =&gt;
name -&gt; m a -&gt; m a
</span><a href="PlutusIR.Transform.LetFloat.html#withLam"><span class="hs-identifier hs-var">withLam</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680956481"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT MarkCtx (Writer Scope) ()
 -&gt; ReaderT MarkCtx (Writer Scope) ())
-&gt; ReaderT MarkCtx (Writer Scope) ()
-&gt; ReaderT MarkCtx (Writer Scope) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; ReaderT MarkCtx (Writer Scope) ()
</span><a href="#local-6989586621680956484"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956480"><span class="hs-identifier hs-var">tBody</span></a></span><span>
</span><span id="line-200"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#TyAbs"><span class="hs-identifier hs-type">TyAbs</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680956477"><span class="annot"><span class="annottext">tyname
</span><a href="#local-6989586621680956477"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="annottext">Kind a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680956476"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956476"><span class="hs-identifier hs-var">tBody</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">tyname
-&gt; ReaderT MarkCtx (Writer Scope) ()
-&gt; ReaderT MarkCtx (Writer Scope) ()
forall r (m :: * -&gt; *) name unique a.
(r ~ MarkCtx, MonadReader r m, HasUnique name unique) =&gt;
name -&gt; m a -&gt; m a
</span><a href="PlutusIR.Transform.LetFloat.html#withLam"><span class="hs-identifier hs-var">withLam</span></a></span><span> </span><span class="annot"><span class="annottext">tyname
</span><a href="#local-6989586621680956477"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT MarkCtx (Writer Scope) ()
 -&gt; ReaderT MarkCtx (Writer Scope) ())
-&gt; ReaderT MarkCtx (Writer Scope) ()
-&gt; ReaderT MarkCtx (Writer Scope) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; ReaderT MarkCtx (Writer Scope) ()
</span><a href="#local-6989586621680956484"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956476"><span class="hs-identifier hs-var">tBody</span></a></span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span>        </span><span class="hs-comment">-- main operation: for letrec or single letnonrec</span><span>
</span><span id="line-203"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621680956475"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956475"><span class="hs-identifier hs-var">ann</span></a></span></span><span> </span><span id="local-6989586621680956474"><span class="annot"><span class="annottext">Recursivity
</span><a href="#local-6989586621680956474"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621680956473"><span class="annot"><span class="annottext">bs :: NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621680956473"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a) -&gt; Unique
forall name tyname (uni :: * -&gt; *) fun a.
(HasUnique name TermUnique, HasUnique tyname TypeUnique) =&gt;
NonEmpty (Binding tyname name uni fun a) -&gt; Unique
</span><a href="PlutusIR.Transform.LetFloat.html#representativeBindingUnique"><span class="hs-identifier hs-var">representativeBindingUnique</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621680956472"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621680956472"><span class="hs-identifier hs-var">letU</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680956471"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956471"><span class="hs-identifier hs-var">tIn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-204"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680956470"><span class="annot"><span class="annottext">letN :: BindingGrp tyname name uni fun a
</span><a href="#local-6989586621680956470"><span class="hs-identifier hs-var hs-var">letN</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
-&gt; Recursivity
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; BindingGrp tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Recursivity
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; BindingGrp tyname name uni fun a
</span><a href="PlutusIR.Transform.LetFloat.html#BindingGrp"><span class="hs-identifier hs-var">BindingGrp</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956475"><span class="hs-identifier hs-var">ann</span></a></span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><a href="#local-6989586621680956474"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621680956473"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-205"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">BindingGrp tyname name uni fun a -&gt; Bool
forall (uni :: * -&gt; *) fun tyname name a.
ToBuiltinMeaning uni fun =&gt;
BindingGrp tyname name uni fun a -&gt; Bool
</span><a href="PlutusIR.Transform.LetFloat.html#floatable"><span class="hs-identifier hs-var">floatable</span></a></span><span> </span><span class="annot"><span class="annottext">BindingGrp tyname name uni fun a
</span><a href="#local-6989586621680956470"><span class="hs-identifier hs-var">letN</span></a></span><span>
</span><span id="line-206"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-207"></span><span>            </span><span id="local-6989586621680956468"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621680956468"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(MarkCtx -&gt; Scope) -&gt; ReaderT MarkCtx (Writer Scope) Scope
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">MarkCtx -&gt; Scope
</span><a href="PlutusIR.Transform.LetFloat.html#_markCtxScope"><span class="hs-identifier hs-var hs-var">_markCtxScope</span></a></span><span>
</span><span id="line-208"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680956466"><span class="annot"><span class="annottext">freeVars :: Set Unique
</span><a href="#local-6989586621680956466"><span class="hs-identifier hs-var hs-var">freeVars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-209"></span><span>                    </span><span class="hs-comment">-- if Rec, remove the here-bindings from free</span><span>
</span><span id="line-210"></span><span>                    </span><span class="annot"><span class="annottext">Recursivity
-&gt; (Set Unique -&gt; Set Unique) -&gt; Set Unique -&gt; Set Unique
forall a. Recursivity -&gt; (a -&gt; a) -&gt; a -&gt; a
</span><a href="PlutusIR.Transform.LetFloat.html#ifRec"><span class="hs-identifier hs-var">ifRec</span></a></span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><a href="#local-6989586621680956474"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set Unique -&gt; Set Unique -&gt; Set Unique
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><span class="hs-operator hs-var">S.\\</span></span><span> </span><span class="annot"><span class="annottext">Getting
  (Set Unique) (NonEmpty (Binding tyname name uni fun a)) Unique
-&gt; NonEmpty (Binding tyname name uni fun a) -&gt; Set Unique
forall a s. Getting (Set a) s a -&gt; s -&gt; Set a
</span><span class="hs-identifier hs-var">setOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Binding tyname name uni fun a
 -&gt; Const (Set Unique) (Binding tyname name uni fun a))
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; Const (Set Unique) (NonEmpty (Binding tyname name uni fun a))
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
</span><span class="hs-identifier hs-var">traversed</span></span><span class="annot"><span class="annottext">((Binding tyname name uni fun a
  -&gt; Const (Set Unique) (Binding tyname name uni fun a))
 -&gt; NonEmpty (Binding tyname name uni fun a)
 -&gt; Const (Set Unique) (NonEmpty (Binding tyname name uni fun a)))
-&gt; ((Unique -&gt; Const (Set Unique) Unique)
    -&gt; Binding tyname name uni fun a
    -&gt; Const (Set Unique) (Binding tyname name uni fun a))
-&gt; Getting
     (Set Unique) (NonEmpty (Binding tyname name uni fun a)) Unique
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span class="annot"><span class="annottext">(Unique -&gt; Const (Set Unique) Unique)
-&gt; Binding tyname name uni fun a
-&gt; Const (Set Unique) (Binding tyname name uni fun a)
forall tyname name (uni :: * -&gt; *) fun a.
(HasUnique tyname TypeUnique, HasUnique name TermUnique) =&gt;
Traversal1' (Binding tyname name uni fun a) Unique
</span><a href="PlutusIR.Core.Plated.html#bindingIds"><span class="hs-identifier hs-var">bindingIds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621680956473"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Set Unique -&gt; Set Unique) -&gt; Set Unique -&gt; Set Unique
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-211"></span><span>                       </span><span class="annot"><span class="annottext">BindingGrp tyname name uni fun a -&gt; Set Unique
forall tyname name (uni :: * -&gt; *) fun a.
(Ord tyname, Ord name, HasUnique tyname TypeUnique,
 HasUnique name TermUnique) =&gt;
BindingGrp tyname name uni fun a -&gt; Set Unique
</span><a href="PlutusIR.Transform.LetFloat.html#calcFreeVars"><span class="hs-identifier hs-var">calcFreeVars</span></a></span><span> </span><span class="annot"><span class="annottext">BindingGrp tyname name uni fun a
</span><a href="#local-6989586621680956470"><span class="hs-identifier hs-var">letN</span></a></span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span>            </span><span class="hs-comment">-- The &quot;heart&quot; of the algorithm: the future position to float this let to</span><span>
</span><span id="line-214"></span><span>            </span><span class="hs-comment">-- is determined as the maximum among its dependencies (free vars).</span><span>
</span><span id="line-215"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680956461"><span class="annot"><span class="annottext">floatPos :: Pos
</span><a href="#local-6989586621680956461"><span class="hs-identifier hs-var">floatPos</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span> </span><span id="local-6989586621680956460"><span class="annot"><span class="annottext">Depth
</span><a href="#local-6989586621680956460"><span class="hs-identifier hs-var">floatDepth</span></a></span></span><span> </span><span class="annot"><span class="annottext">Unique
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PosType
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Scope -&gt; Pos
forall k. Map k Pos -&gt; Pos
</span><a href="PlutusIR.Transform.LetFloat.html#maxPos"><span class="hs-identifier hs-var">maxPos</span></a></span><span> </span><span class="annot"><span class="annottext">(Scope -&gt; Pos) -&gt; Scope -&gt; Pos
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621680956468"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope -&gt; Set Unique -&gt; Scope
forall k a. Ord k =&gt; Map k a -&gt; Set k -&gt; Map k a
</span><span class="hs-operator hs-var">`M.restrictKeys`</span></span><span> </span><span class="annot"><span class="annottext">Set Unique
</span><a href="#local-6989586621680956466"><span class="hs-identifier hs-var">freeVars</span></a></span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span>            </span><span class="hs-comment">-- visit the rhs'es</span><span>
</span><span id="line-218"></span><span>            </span><span class="hs-comment">-- IMPORTANT: inside the rhs, act like the current depth</span><span>
</span><span id="line-219"></span><span>            </span><span class="hs-comment">-- is the future floated depth of this rhs.</span><span>
</span><span id="line-220"></span><span>            </span><span class="annot"><span class="annottext">(Depth -&gt; Depth)
-&gt; ReaderT MarkCtx (Writer Scope) ()
-&gt; ReaderT MarkCtx (Writer Scope) ()
forall r (m :: * -&gt; *) a.
(r ~ MarkCtx, MonadReader r m) =&gt;
(Depth -&gt; Depth) -&gt; m a -&gt; m a
</span><a href="PlutusIR.Transform.LetFloat.html#withDepth"><span class="hs-identifier hs-var">withDepth</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Depth -&gt; Depth -&gt; Depth
forall a b. a -&gt; b -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Depth
</span><a href="#local-6989586621680956460"><span class="hs-identifier hs-var">floatDepth</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ReaderT MarkCtx (Writer Scope) ()
 -&gt; ReaderT MarkCtx (Writer Scope) ())
-&gt; ReaderT MarkCtx (Writer Scope) ()
-&gt; ReaderT MarkCtx (Writer Scope) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-221"></span><span>                </span><span class="hs-comment">-- if rec, then its bindings are in scope in the rhs'es</span><span>
</span><span id="line-222"></span><span>                </span><span class="annot"><span class="annottext">Recursivity
-&gt; (ReaderT MarkCtx (Writer Scope) ()
    -&gt; ReaderT MarkCtx (Writer Scope) ())
-&gt; ReaderT MarkCtx (Writer Scope) ()
-&gt; ReaderT MarkCtx (Writer Scope) ()
forall a. Recursivity -&gt; (a -&gt; a) -&gt; a -&gt; a
</span><a href="PlutusIR.Transform.LetFloat.html#ifRec"><span class="hs-identifier hs-var">ifRec</span></a></span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><a href="#local-6989586621680956474"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
-&gt; Pos
-&gt; ReaderT MarkCtx (Writer Scope) ()
-&gt; ReaderT MarkCtx (Writer Scope) ()
forall r (m :: * -&gt; *) name tyname (uni :: * -&gt; *) fun a3 a.
(r ~ MarkCtx, MonadReader r m, HasUnique name TermUnique,
 HasUnique tyname TypeUnique) =&gt;
NonEmpty (Binding tyname name uni fun a3) -&gt; Pos -&gt; m a -&gt; m a
</span><a href="PlutusIR.Transform.LetFloat.html#withBs"><span class="hs-identifier hs-var">withBs</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621680956473"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680956461"><span class="hs-identifier hs-var">floatPos</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ReaderT MarkCtx (Writer Scope) ()
 -&gt; ReaderT MarkCtx (Writer Scope) ())
-&gt; ReaderT MarkCtx (Writer Scope) ()
-&gt; ReaderT MarkCtx (Writer Scope) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-223"></span><span>                    </span><span class="annot"><span class="annottext">(Term tyname name uni fun a -&gt; ReaderT MarkCtx (Writer Scope) ())
-&gt; [Term tyname name uni fun a]
-&gt; ReaderT MarkCtx (Writer Scope) ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse_</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; ReaderT MarkCtx (Writer Scope) ()
</span><a href="#local-6989586621680956484"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621680956473"><span class="hs-identifier hs-var">bs</span></a></span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
-&gt; Getting
     (Endo [Term tyname name uni fun a])
     (NonEmpty (Binding tyname name uni fun a))
     (Term tyname name uni fun a)
-&gt; [Term tyname name uni fun a]
forall s a. s -&gt; Getting (Endo [a]) s a -&gt; [a]
</span><span class="hs-operator hs-var">^..</span></span><span class="annot"><span class="annottext">(Binding tyname name uni fun a
 -&gt; Const
      (Endo [Term tyname name uni fun a])
      (Binding tyname name uni fun a))
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; Const
     (Endo [Term tyname name uni fun a])
     (NonEmpty (Binding tyname name uni fun a))
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
</span><span class="hs-identifier hs-var">traversed</span></span><span class="annot"><span class="annottext">((Binding tyname name uni fun a
  -&gt; Const
       (Endo [Term tyname name uni fun a])
       (Binding tyname name uni fun a))
 -&gt; NonEmpty (Binding tyname name uni fun a)
 -&gt; Const
      (Endo [Term tyname name uni fun a])
      (NonEmpty (Binding tyname name uni fun a)))
-&gt; ((Term tyname name uni fun a
     -&gt; Const
          (Endo [Term tyname name uni fun a]) (Term tyname name uni fun a))
    -&gt; Binding tyname name uni fun a
    -&gt; Const
         (Endo [Term tyname name uni fun a])
         (Binding tyname name uni fun a))
-&gt; Getting
     (Endo [Term tyname name uni fun a])
     (NonEmpty (Binding tyname name uni fun a))
     (Term tyname name uni fun a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span class="annot"><span class="annottext">(Term tyname name uni fun a
 -&gt; Const
      (Endo [Term tyname name uni fun a]) (Term tyname name uni fun a))
-&gt; Binding tyname name uni fun a
-&gt; Const
     (Endo [Term tyname name uni fun a]) (Binding tyname name uni fun a)
forall tyname name (uni :: * -&gt; *) fun a.
Traversal'
  (Binding tyname name uni fun a) (Term tyname name uni fun a)
</span><a href="PlutusIR.Core.Plated.html#bindingSubterms"><span class="hs-identifier hs-var">bindingSubterms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span>            </span><span class="hs-comment">-- visit the inTerm</span><span>
</span><span id="line-226"></span><span>            </span><span class="hs-comment">-- bindings are inscope in the InTerm for both rec&amp;nonrec</span><span>
</span><span id="line-227"></span><span>            </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
-&gt; Pos
-&gt; ReaderT MarkCtx (Writer Scope) ()
-&gt; ReaderT MarkCtx (Writer Scope) ()
forall r (m :: * -&gt; *) name tyname (uni :: * -&gt; *) fun a3 a.
(r ~ MarkCtx, MonadReader r m, HasUnique name TermUnique,
 HasUnique tyname TypeUnique) =&gt;
NonEmpty (Binding tyname name uni fun a3) -&gt; Pos -&gt; m a -&gt; m a
</span><a href="PlutusIR.Transform.LetFloat.html#withBs"><span class="hs-identifier hs-var">withBs</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621680956473"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680956461"><span class="hs-identifier hs-var">floatPos</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT MarkCtx (Writer Scope) ()
 -&gt; ReaderT MarkCtx (Writer Scope) ())
-&gt; ReaderT MarkCtx (Writer Scope) ()
-&gt; ReaderT MarkCtx (Writer Scope) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; ReaderT MarkCtx (Writer Scope) ()
</span><a href="#local-6989586621680956484"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956471"><span class="hs-identifier hs-var">tIn</span></a></span><span>
</span><span id="line-228"></span><span>
</span><span id="line-229"></span><span>            </span><span class="hs-comment">-- collect here the new mark and propagate all</span><span>
</span><span id="line-230"></span><span>            </span><span class="annot"><span class="annottext">Scope -&gt; ReaderT MarkCtx (Writer Scope) ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="annot"><span class="annottext">(Scope -&gt; ReaderT MarkCtx (Writer Scope) ())
-&gt; Scope -&gt; ReaderT MarkCtx (Writer Scope) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Unique -&gt; Pos -&gt; Scope
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621680956472"><span class="hs-identifier hs-var">letU</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680956461"><span class="hs-identifier hs-var">floatPos</span></a></span><span>
</span><span id="line-231"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-232"></span><span>            </span><span class="hs-comment">-- since it is unfloatable (effectful), this let is a new anchor</span><span>
</span><span id="line-233"></span><span>            </span><span class="hs-comment">-- acts as anchor both in rhs'es and inTerm</span><span>
</span><span id="line-234"></span><span>            </span><span class="annot"><span class="annottext">(Depth -&gt; Depth)
-&gt; ReaderT MarkCtx (Writer Scope) ()
-&gt; ReaderT MarkCtx (Writer Scope) ()
forall r (m :: * -&gt; *) a.
(r ~ MarkCtx, MonadReader r m) =&gt;
(Depth -&gt; Depth) -&gt; m a -&gt; m a
</span><a href="PlutusIR.Transform.LetFloat.html#withDepth"><span class="hs-identifier hs-var">withDepth</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Depth -&gt; Depth -&gt; Depth
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">Depth
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ReaderT MarkCtx (Writer Scope) ()
 -&gt; ReaderT MarkCtx (Writer Scope) ())
-&gt; ReaderT MarkCtx (Writer Scope) ()
-&gt; ReaderT MarkCtx (Writer Scope) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-235"></span><span>                </span><span id="local-6989586621680956448"><span class="annot"><span class="annottext">Depth
</span><a href="#local-6989586621680956448"><span class="hs-identifier hs-var">depth</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(MarkCtx -&gt; Depth) -&gt; ReaderT MarkCtx (Writer Scope) Depth
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">MarkCtx -&gt; Depth
</span><a href="PlutusIR.Transform.LetFloat.html#_markCtxDepth"><span class="hs-identifier hs-var hs-var">_markCtxDepth</span></a></span><span>
</span><span id="line-236"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680956447"><span class="annot"><span class="annottext">toPos :: PosType -&gt; Pos
</span><a href="#local-6989586621680956447"><span class="hs-identifier hs-var hs-var">toPos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Depth -&gt; Unique -&gt; PosType -&gt; Pos
</span><a href="PlutusIR.Transform.LetFloat.html#Pos"><span class="hs-identifier hs-var">Pos</span></a></span><span> </span><span class="annot"><span class="annottext">Depth
</span><a href="#local-6989586621680956448"><span class="hs-identifier hs-var">depth</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621680956472"><span class="hs-identifier hs-var">letU</span></a></span><span>
</span><span id="line-237"></span><span>                </span><span class="hs-comment">-- visit the rhs'es</span><span>
</span><span id="line-238"></span><span>                </span><span class="hs-comment">-- if rec, then its bindings are in scope in the rhs'es</span><span>
</span><span id="line-239"></span><span>                </span><span class="annot"><span class="annottext">Recursivity
-&gt; (ReaderT MarkCtx (Writer Scope) ()
    -&gt; ReaderT MarkCtx (Writer Scope) ())
-&gt; ReaderT MarkCtx (Writer Scope) ()
-&gt; ReaderT MarkCtx (Writer Scope) ()
forall a. Recursivity -&gt; (a -&gt; a) -&gt; a -&gt; a
</span><a href="PlutusIR.Transform.LetFloat.html#ifRec"><span class="hs-identifier hs-var">ifRec</span></a></span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><a href="#local-6989586621680956474"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
-&gt; Pos
-&gt; ReaderT MarkCtx (Writer Scope) ()
-&gt; ReaderT MarkCtx (Writer Scope) ()
forall r (m :: * -&gt; *) name tyname (uni :: * -&gt; *) fun a3 a.
(r ~ MarkCtx, MonadReader r m, HasUnique name TermUnique,
 HasUnique tyname TypeUnique) =&gt;
NonEmpty (Binding tyname name uni fun a3) -&gt; Pos -&gt; m a -&gt; m a
</span><a href="PlutusIR.Transform.LetFloat.html#withBs"><span class="hs-identifier hs-var">withBs</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621680956473"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">(Pos
 -&gt; ReaderT MarkCtx (Writer Scope) ()
 -&gt; ReaderT MarkCtx (Writer Scope) ())
-&gt; Pos
-&gt; ReaderT MarkCtx (Writer Scope) ()
-&gt; ReaderT MarkCtx (Writer Scope) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">PosType -&gt; Pos
</span><a href="#local-6989586621680956447"><span class="hs-identifier hs-var">toPos</span></a></span><span> </span><span class="annot"><span class="annottext">PosType
</span><a href="PlutusIR.Transform.LetFloat.html#LetRhs"><span class="hs-identifier hs-var">LetRhs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ReaderT MarkCtx (Writer Scope) ()
 -&gt; ReaderT MarkCtx (Writer Scope) ())
-&gt; ReaderT MarkCtx (Writer Scope) ()
-&gt; ReaderT MarkCtx (Writer Scope) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Term tyname name uni fun a -&gt; ReaderT MarkCtx (Writer Scope) ())
-&gt; [Term tyname name uni fun a]
-&gt; ReaderT MarkCtx (Writer Scope) ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse_</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; ReaderT MarkCtx (Writer Scope) ()
</span><a href="#local-6989586621680956484"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621680956473"><span class="hs-identifier hs-var">bs</span></a></span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
-&gt; Getting
     (Endo [Term tyname name uni fun a])
     (NonEmpty (Binding tyname name uni fun a))
     (Term tyname name uni fun a)
-&gt; [Term tyname name uni fun a]
forall s a. s -&gt; Getting (Endo [a]) s a -&gt; [a]
</span><span class="hs-operator hs-var">^..</span></span><span class="annot"><span class="annottext">(Binding tyname name uni fun a
 -&gt; Const
      (Endo [Term tyname name uni fun a])
      (Binding tyname name uni fun a))
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; Const
     (Endo [Term tyname name uni fun a])
     (NonEmpty (Binding tyname name uni fun a))
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
</span><span class="hs-identifier hs-var">traversed</span></span><span class="annot"><span class="annottext">((Binding tyname name uni fun a
  -&gt; Const
       (Endo [Term tyname name uni fun a])
       (Binding tyname name uni fun a))
 -&gt; NonEmpty (Binding tyname name uni fun a)
 -&gt; Const
      (Endo [Term tyname name uni fun a])
      (NonEmpty (Binding tyname name uni fun a)))
-&gt; ((Term tyname name uni fun a
     -&gt; Const
          (Endo [Term tyname name uni fun a]) (Term tyname name uni fun a))
    -&gt; Binding tyname name uni fun a
    -&gt; Const
         (Endo [Term tyname name uni fun a])
         (Binding tyname name uni fun a))
-&gt; Getting
     (Endo [Term tyname name uni fun a])
     (NonEmpty (Binding tyname name uni fun a))
     (Term tyname name uni fun a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span class="annot"><span class="annottext">(Term tyname name uni fun a
 -&gt; Const
      (Endo [Term tyname name uni fun a]) (Term tyname name uni fun a))
-&gt; Binding tyname name uni fun a
-&gt; Const
     (Endo [Term tyname name uni fun a]) (Binding tyname name uni fun a)
forall tyname name (uni :: * -&gt; *) fun a.
Traversal'
  (Binding tyname name uni fun a) (Term tyname name uni fun a)
</span><a href="PlutusIR.Core.Plated.html#bindingSubterms"><span class="hs-identifier hs-var">bindingSubterms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-240"></span><span>
</span><span id="line-241"></span><span>                </span><span class="hs-comment">-- bindings are inscope in the InTerm for both rec&amp;nonrec</span><span>
</span><span id="line-242"></span><span>                </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
-&gt; Pos
-&gt; ReaderT MarkCtx (Writer Scope) ()
-&gt; ReaderT MarkCtx (Writer Scope) ()
forall r (m :: * -&gt; *) name tyname (uni :: * -&gt; *) fun a3 a.
(r ~ MarkCtx, MonadReader r m, HasUnique name TermUnique,
 HasUnique tyname TypeUnique) =&gt;
NonEmpty (Binding tyname name uni fun a3) -&gt; Pos -&gt; m a -&gt; m a
</span><a href="PlutusIR.Transform.LetFloat.html#withBs"><span class="hs-identifier hs-var">withBs</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621680956473"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PosType -&gt; Pos
</span><a href="#local-6989586621680956447"><span class="hs-identifier hs-var">toPos</span></a></span><span> </span><span class="annot"><span class="annottext">PosType
</span><a href="PlutusIR.Transform.LetFloat.html#LamBody"><span class="hs-identifier hs-var">LamBody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ReaderT MarkCtx (Writer Scope) ()
 -&gt; ReaderT MarkCtx (Writer Scope) ())
-&gt; ReaderT MarkCtx (Writer Scope) ()
-&gt; ReaderT MarkCtx (Writer Scope) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; ReaderT MarkCtx (Writer Scope) ()
</span><a href="#local-6989586621680956484"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956471"><span class="hs-identifier hs-var">tIn</span></a></span><span>
</span><span id="line-243"></span><span>
</span><span id="line-244"></span><span>        </span><span class="hs-comment">-- descend and collect</span><span>
</span><span id="line-245"></span><span>        </span><span id="local-6989586621680956446"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956446"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Getting
  (Traversed () (ReaderT MarkCtx (Writer Scope)))
  (Term tyname name uni fun a)
  (Term tyname name uni fun a)
-&gt; (Term tyname name uni fun a
    -&gt; ReaderT MarkCtx (Writer Scope) ())
-&gt; Term tyname name uni fun a
-&gt; ReaderT MarkCtx (Writer Scope) ()
forall (f :: * -&gt; *) r s a.
Functor f =&gt;
Getting (Traversed r f) s a -&gt; (a -&gt; f r) -&gt; s -&gt; f ()
</span><span class="hs-identifier hs-var">traverseOf_</span></span><span> </span><span class="annot"><span class="annottext">Getting
  (Traversed () (ReaderT MarkCtx (Writer Scope)))
  (Term tyname name uni fun a)
  (Term tyname name uni fun a)
forall tyname name (uni :: * -&gt; *) fun a.
Traversal'
  (Term tyname name uni fun a) (Term tyname name uni fun a)
</span><a href="PlutusIR.Core.Plated.html#termSubterms"><span class="hs-identifier hs-var">termSubterms</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; ReaderT MarkCtx (Writer Scope) ()
</span><a href="#local-6989586621680956484"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956446"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-246"></span><span>
</span><span id="line-247"></span><span class="hs-comment">-- | Given a 'BindingGrp', calculate its free vars and free tyvars and collect them in a set.</span><span>
</span><span id="line-248"></span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#calcFreeVars"><span class="hs-identifier hs-type">calcFreeVars</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680956873"><span class="annot"><a href="#local-6989586621680956873"><span class="hs-identifier hs-type">tyname</span></a></span></span><span> </span><span id="local-6989586621680956872"><span class="annot"><a href="#local-6989586621680956872"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621680956871"><span class="annot"><a href="#local-6989586621680956871"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621680956870"><span class="annot"><a href="#local-6989586621680956870"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621680956869"><span class="annot"><a href="#local-6989586621680956869"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-249"></span><span>             </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956873"><span class="hs-identifier hs-type">tyname</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956872"><span class="hs-identifier hs-type">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956873"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TypeUnique"><span class="hs-identifier hs-type">PLC.TypeUnique</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956872"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TermUnique"><span class="hs-identifier hs-type">PLC.TermUnique</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span>             </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#BindingGrp"><span class="hs-identifier hs-type">BindingGrp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956873"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956872"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956871"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956870"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956869"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-251"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#Unique"><span class="hs-identifier hs-type">PLC.Unique</span></a></span><span>
</span><span id="line-252"></span><span id="calcFreeVars"><span class="annot"><span class="annottext">calcFreeVars :: BindingGrp tyname name uni fun a -&gt; Set Unique
</span><a href="PlutusIR.Transform.LetFloat.html#calcFreeVars"><span class="hs-identifier hs-var hs-var">calcFreeVars</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#BindingGrp"><span class="hs-identifier hs-type">BindingGrp</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680956443"><span class="annot"><span class="annottext">Recursivity
</span><a href="#local-6989586621680956443"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621680956442"><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621680956442"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Binding tyname name uni fun a -&gt; Set Unique)
-&gt; NonEmpty (Binding tyname name uni fun a) -&gt; Set Unique
forall (t :: * -&gt; *) m a.
(Foldable1 t, Semigroup m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap1</span></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun a -&gt; Set Unique
</span><a href="#local-6989586621680956440"><span class="hs-identifier hs-var">calcBinding</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621680956442"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-254"></span><span>    </span><span class="hs-comment">-- given a binding return all its free term *AND* free type variables</span><span>
</span><span id="line-255"></span><span>    </span><span class="annot"><a href="#local-6989586621680956440"><span class="hs-identifier hs-type">calcBinding</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956873"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956872"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956871"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956870"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956869"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#Unique"><span class="hs-identifier hs-type">PLC.Unique</span></a></span><span>
</span><span id="line-256"></span><span>    </span><span id="local-6989586621680956440"><span class="annot"><span class="annottext">calcBinding :: Binding tyname name uni fun a -&gt; Set Unique
</span><a href="#local-6989586621680956440"><span class="hs-identifier hs-var hs-var">calcBinding</span></a></span></span><span> </span><span id="local-6989586621680956439"><span class="annot"><span class="annottext">Binding tyname name uni fun a
</span><a href="#local-6989586621680956439"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-257"></span><span>        </span><span class="hs-comment">-- OPTIMIZE: safe to change to S.mapMonotonic?</span><span>
</span><span id="line-258"></span><span>        </span><span class="annot"><span class="annottext">(name -&gt; Unique) -&gt; Set name -&gt; Set Unique
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">S.map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">name -&gt; Getting Unique name Unique -&gt; Unique
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span class="annot"><span class="annottext">Getting Unique name Unique
forall name unique. HasUnique name unique =&gt; Lens' name Unique
</span><a href="PlutusCore.Name.html#theUnique"><span class="hs-identifier hs-var">PLC.theUnique</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Binding tyname name uni fun a -&gt; Set name
forall name tyname (uni :: * -&gt; *) fun ann.
Ord name =&gt;
Binding tyname name uni fun ann -&gt; Set name
</span><a href="PlutusIR.Subst.html#fvBinding"><span class="hs-identifier hs-var">fvBinding</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun a
</span><a href="#local-6989586621680956439"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span>        </span><span class="annot"><span class="annottext">Set Unique -&gt; Set Unique -&gt; Set Unique
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(tyname -&gt; Unique) -&gt; Set tyname -&gt; Set Unique
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">S.map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">tyname -&gt; Getting Unique tyname Unique -&gt; Unique
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span class="annot"><span class="annottext">Getting Unique tyname Unique
forall name unique. HasUnique name unique =&gt; Lens' name Unique
</span><a href="PlutusCore.Name.html#theUnique"><span class="hs-identifier hs-var">PLC.theUnique</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Recursivity -&gt; Binding tyname name uni fun a -&gt; Set tyname
forall tyname name (uni :: * -&gt; *) fun ann.
Ord tyname =&gt;
Recursivity -&gt; Binding tyname name uni fun ann -&gt; Set tyname
</span><a href="PlutusIR.Subst.html#ftvBinding"><span class="hs-identifier hs-var">ftvBinding</span></a></span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><a href="#local-6989586621680956443"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun a
</span><a href="#local-6989586621680956439"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span>
</span><span id="line-261"></span><span class="hs-comment">-- | The second pass of cleaning the term of the floatable lets, and placing them in a separate map</span><span>
</span><span id="line-262"></span><span class="hs-comment">-- OPTIMIZE: use State for building the FloatTable, and for reducing the Marks</span><span>
</span><span id="line-263"></span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#removeLets"><span class="hs-identifier hs-type">removeLets</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680956709"><span class="annot"><a href="#local-6989586621680956709"><span class="hs-identifier hs-type">tyname</span></a></span></span><span> </span><span id="local-6989586621680956708"><span class="annot"><a href="#local-6989586621680956708"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621680956707"><span class="annot"><a href="#local-6989586621680956707"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621680956706"><span class="annot"><a href="#local-6989586621680956706"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621680956705"><span class="annot"><a href="#local-6989586621680956705"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621680956710"><span class="annot"><a href="#local-6989586621680956710"><span class="hs-identifier hs-type">term</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-264"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680956710"><span class="hs-identifier hs-type">term</span></a></span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956709"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956708"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956707"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956706"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956705"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-265"></span><span>            </span><span class="hs-special">,</span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956709"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TypeUnique"><span class="hs-identifier hs-type">PLC.TypeUnique</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956708"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TermUnique"><span class="hs-identifier hs-type">PLC.TermUnique</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>           </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#Marks"><span class="hs-identifier hs-type">Marks</span></a></span><span>
</span><span id="line-267"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680956710"><span class="hs-identifier hs-type">term</span></a></span><span>
</span><span id="line-268"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680956710"><span class="hs-identifier hs-type">term</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#FloatTable"><span class="hs-identifier hs-type">FloatTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956709"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956708"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956707"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956706"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956705"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-269"></span><span id="removeLets"><span class="annot"><span class="annottext">removeLets :: Scope -&gt; term -&gt; (term, FloatTable tyname name uni fun a)
</span><a href="PlutusIR.Transform.LetFloat.html#removeLets"><span class="hs-identifier hs-var hs-var">removeLets</span></a></span></span><span> </span><span id="local-6989586621680956432"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621680956432"><span class="hs-identifier hs-var">marks</span></a></span></span><span> </span><span id="local-6989586621680956431"><span class="annot"><span class="annottext">term
</span><a href="#local-6989586621680956431"><span class="hs-identifier hs-var">term</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Writer (FloatTable tyname name uni fun a) term
-&gt; (term, FloatTable tyname name uni fun a)
forall w a. Writer w a -&gt; (a, w)
</span><span class="hs-identifier hs-var">runWriter</span></span><span> </span><span class="annot"><span class="annottext">(Writer (FloatTable tyname name uni fun a) term
 -&gt; (term, FloatTable tyname name uni fun a))
-&gt; Writer (FloatTable tyname name uni fun a) term
-&gt; (term, FloatTable tyname name uni fun a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">term -&gt; Writer (FloatTable tyname name uni fun a) term
</span><a href="#local-6989586621680956430"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">term
</span><a href="#local-6989586621680956431"><span class="hs-identifier hs-var">term</span></a></span><span>
</span><span id="line-270"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-271"></span><span>    </span><span class="hs-comment">-- TODO: use State for the Marks to safeguard against any bugs where floatable lets are not removed as they should to.</span><span>
</span><span id="line-272"></span><span>    </span><span class="annot"><a href="#local-6989586621680956430"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621680956710"><span class="hs-identifier hs-type">term</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Writer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#FloatTable"><span class="hs-identifier hs-type">FloatTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956709"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956708"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956707"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956706"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956705"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680956710"><span class="hs-identifier hs-type">term</span></a></span><span>
</span><span id="line-273"></span><span>    </span><span id="local-6989586621680956430"><span class="annot"><span class="annottext">go :: term -&gt; Writer (FloatTable tyname name uni fun a) term
</span><a href="#local-6989586621680956430"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; Term tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun a -&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Transform.LetFloat.html#breakNonRec"><span class="hs-identifier hs-var">breakNonRec</span></a></span><span> </span><span class="annot"><span class="annottext">(Term tyname name uni fun a -&gt; Term tyname name uni fun a)
-&gt; (Term tyname name uni fun a
    -&gt; WriterT
         (FloatTable tyname name uni fun a)
         Identity
         (Term tyname name uni fun a))
-&gt; Term tyname name uni fun a
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Term tyname name uni fun a)
forall k (cat :: k -&gt; k -&gt; *) (a :: k) (b :: k) (c :: k).
Category cat =&gt;
cat a b -&gt; cat b c -&gt; cat a c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;&gt;</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-274"></span><span>        </span><span class="hs-comment">-- main operation: for letrec or single letnonrec</span><span>
</span><span id="line-275"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621680956429"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956429"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621680956428"><span class="annot"><span class="annottext">Recursivity
</span><a href="#local-6989586621680956428"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621680956427"><span class="annot"><span class="annottext">bs :: NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621680956427"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a) -&gt; Unique
forall name tyname (uni :: * -&gt; *) fun a.
(HasUnique name TermUnique, HasUnique tyname TypeUnique) =&gt;
NonEmpty (Binding tyname name uni fun a) -&gt; Unique
</span><a href="PlutusIR.Transform.LetFloat.html#representativeBindingUnique"><span class="hs-identifier hs-var">representativeBindingUnique</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621680956426"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621680956426"><span class="hs-identifier hs-var">letU</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680956425"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956425"><span class="hs-identifier hs-var">tIn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-276"></span><span>            </span><span class="hs-comment">-- go to rhs'es and collect their floattable + cleanedterm</span><span>
</span><span id="line-277"></span><span>            </span><span id="local-6989586621680956424"><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621680956424"><span class="hs-identifier hs-var">bs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Binding tyname name uni fun a
 -&gt; WriterT
      (FloatTable tyname name uni fun a)
      Identity
      (Binding tyname name uni fun a))
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (NonEmpty (Binding tyname name uni fun a))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun a
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Binding tyname name uni fun a)
</span><a href="#local-6989586621680956422"><span class="hs-identifier hs-var">goBinding</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621680956427"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-278"></span><span>            </span><span class="hs-comment">-- go to inTerm and collect its floattable + cleanedterm</span><span>
</span><span id="line-279"></span><span>            </span><span id="local-6989586621680956421"><span class="annot"><span class="annottext">term
</span><a href="#local-6989586621680956421"><span class="hs-identifier hs-var">tIn'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">term -&gt; Writer (FloatTable tyname name uni fun a) term
</span><a href="#local-6989586621680956430"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">term
Term tyname name uni fun a
</span><a href="#local-6989586621680956425"><span class="hs-identifier hs-var">tIn</span></a></span><span>
</span><span id="line-280"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Unique -&gt; Scope -&gt; Maybe Pos
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621680956426"><span class="hs-identifier hs-var">letU</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621680956432"><span class="hs-identifier hs-var">marks</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-281"></span><span>                </span><span class="hs-comment">-- this is not a floatable let</span><span>
</span><span id="line-282"></span><span>                </span><span class="annot"><span class="annottext">Maybe Pos
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Term tyname name uni fun a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Term tyname name uni fun a
 -&gt; WriterT
      (FloatTable tyname name uni fun a)
      Identity
      (Term tyname name uni fun a))
-&gt; Term tyname name uni fun a
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Term tyname name uni fun a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">a
-&gt; Recursivity
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Recursivity
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956429"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><a href="#local-6989586621680956428"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621680956424"><span class="hs-identifier hs-var">bs'</span></a></span><span> </span><span class="annot"><span class="annottext">term
Term tyname name uni fun a
</span><a href="#local-6989586621680956421"><span class="hs-identifier hs-var">tIn'</span></a></span><span>
</span><span id="line-283"></span><span>                </span><span class="hs-comment">-- floatable let found.</span><span>
</span><span id="line-284"></span><span>                </span><span class="hs-comment">-- move this let to the floattable, and just return the body</span><span>
</span><span id="line-285"></span><span>                </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621680956419"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680956419"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-286"></span><span>                    </span><span class="annot"><span class="annottext">FloatTable tyname name uni fun a
-&gt; WriterT (FloatTable tyname name uni fun a) Identity ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pos
-&gt; NonEmpty (BindingGrp tyname name uni fun a)
-&gt; FloatTable tyname name uni fun a
forall k a. k -&gt; a -&gt; MonoidalMap k a
</span><span class="hs-identifier hs-var">MM.singleton</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680956419"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BindingGrp tyname name uni fun a
-&gt; NonEmpty (BindingGrp tyname name uni fun a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(BindingGrp tyname name uni fun a
 -&gt; NonEmpty (BindingGrp tyname name uni fun a))
-&gt; BindingGrp tyname name uni fun a
-&gt; NonEmpty (BindingGrp tyname name uni fun a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">a
-&gt; Recursivity
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; BindingGrp tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Recursivity
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; BindingGrp tyname name uni fun a
</span><a href="PlutusIR.Transform.LetFloat.html#BindingGrp"><span class="hs-identifier hs-var">BindingGrp</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956429"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><a href="#local-6989586621680956428"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621680956424"><span class="hs-identifier hs-var">bs'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span>                    </span><span class="annot"><span class="annottext">term -&gt; Writer (FloatTable tyname name uni fun a) term
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">term
</span><a href="#local-6989586621680956421"><span class="hs-identifier hs-var">tIn'</span></a></span><span>
</span><span id="line-288"></span><span>
</span><span id="line-289"></span><span>        </span><span class="hs-comment">-- descend and collect</span><span>
</span><span id="line-290"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span> </span><span id="local-6989586621680956416"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956416"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621680956415"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956415"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621680956414"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956414"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#Apply"><span class="hs-identifier hs-var">Apply</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956416"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">(Term tyname name uni fun a
 -&gt; Term tyname name uni fun a -&gt; Term tyname name uni fun a)
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Term tyname name uni fun a)
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Term tyname name uni fun a -&gt; Term tyname name uni fun a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">term -&gt; Writer (FloatTable tyname name uni fun a) term
</span><a href="#local-6989586621680956430"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">term
Term tyname name uni fun a
</span><a href="#local-6989586621680956415"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">WriterT
  (FloatTable tyname name uni fun a)
  Identity
  (Term tyname name uni fun a -&gt; Term tyname name uni fun a)
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Term tyname name uni fun a)
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Term tyname name uni fun a)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">term -&gt; Writer (FloatTable tyname name uni fun a) term
</span><a href="#local-6989586621680956430"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">term
Term tyname name uni fun a
</span><a href="#local-6989586621680956414"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-291"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#TyInst"><span class="hs-identifier hs-type">TyInst</span></a></span><span> </span><span id="local-6989586621680956411"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956411"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621680956410"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956410"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621680956409"><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621680956409"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a
-&gt; Term tyname name uni fun a
-&gt; Type tyname uni a
-&gt; Term tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Term tyname name uni fun a
-&gt; Type tyname uni a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#TyInst"><span class="hs-identifier hs-var">TyInst</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956411"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">(Term tyname name uni fun a
 -&gt; Type tyname uni a -&gt; Term tyname name uni fun a)
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Term tyname name uni fun a)
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Type tyname uni a -&gt; Term tyname name uni fun a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">term -&gt; Writer (FloatTable tyname name uni fun a) term
</span><a href="#local-6989586621680956430"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">term
Term tyname name uni fun a
</span><a href="#local-6989586621680956410"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">WriterT
  (FloatTable tyname name uni fun a)
  Identity
  (Type tyname uni a -&gt; Term tyname name uni fun a)
-&gt; WriterT
     (FloatTable tyname name uni fun a) Identity (Type tyname uni a)
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Term tyname name uni fun a)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
-&gt; WriterT
     (FloatTable tyname name uni fun a) Identity (Type tyname uni a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621680956409"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-292"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#TyAbs"><span class="hs-identifier hs-type">TyAbs</span></a></span><span> </span><span id="local-6989586621680956408"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956408"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621680956407"><span class="annot"><span class="annottext">tyname
</span><a href="#local-6989586621680956407"><span class="hs-identifier hs-var">tyname</span></a></span></span><span> </span><span id="local-6989586621680956406"><span class="annot"><span class="annottext">Kind a
</span><a href="#local-6989586621680956406"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621680956405"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956405"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a
-&gt; tyname
-&gt; Kind a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; tyname
-&gt; Kind a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#TyAbs"><span class="hs-identifier hs-var">TyAbs</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956408"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">tyname
</span><a href="#local-6989586621680956407"><span class="hs-identifier hs-var">tyname</span></a></span><span> </span><span class="annot"><span class="annottext">Kind a
</span><a href="#local-6989586621680956406"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">(Term tyname name uni fun a -&gt; Term tyname name uni fun a)
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Term tyname name uni fun a)
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Term tyname name uni fun a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">term -&gt; Writer (FloatTable tyname name uni fun a) term
</span><a href="#local-6989586621680956430"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">term
Term tyname name uni fun a
</span><a href="#local-6989586621680956405"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-293"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#LamAbs"><span class="hs-identifier hs-type">LamAbs</span></a></span><span> </span><span id="local-6989586621680956404"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956404"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621680956403"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680956403"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621680956402"><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621680956402"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621680956401"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956401"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a
-&gt; name
-&gt; Type tyname uni a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; name
-&gt; Type tyname uni a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#LamAbs"><span class="hs-identifier hs-var">LamAbs</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956404"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680956403"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621680956402"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">(Term tyname name uni fun a -&gt; Term tyname name uni fun a)
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Term tyname name uni fun a)
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Term tyname name uni fun a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">term -&gt; Writer (FloatTable tyname name uni fun a) term
</span><a href="#local-6989586621680956430"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">term
Term tyname name uni fun a
</span><a href="#local-6989586621680956401"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-294"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#IWrap"><span class="hs-identifier hs-type">IWrap</span></a></span><span> </span><span id="local-6989586621680956399"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956399"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621680956398"><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621680956398"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621680956397"><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621680956397"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span id="local-6989586621680956396"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956396"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a
-&gt; Type tyname uni a
-&gt; Type tyname uni a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Type tyname uni a
-&gt; Type tyname uni a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#IWrap"><span class="hs-identifier hs-var">IWrap</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956399"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621680956398"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621680956397"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="annot"><span class="annottext">(Term tyname name uni fun a -&gt; Term tyname name uni fun a)
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Term tyname name uni fun a)
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Term tyname name uni fun a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">term -&gt; Writer (FloatTable tyname name uni fun a) term
</span><a href="#local-6989586621680956430"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">term
Term tyname name uni fun a
</span><a href="#local-6989586621680956396"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-295"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#Unwrap"><span class="hs-identifier hs-type">Unwrap</span></a></span><span> </span><span id="local-6989586621680956394"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956394"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621680956393"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956393"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; Term tyname name uni fun a -&gt; Term tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
a -&gt; Term tyname name uni fun a -&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#Unwrap"><span class="hs-identifier hs-var">Unwrap</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956394"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">(Term tyname name uni fun a -&gt; Term tyname name uni fun a)
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Term tyname name uni fun a)
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Term tyname name uni fun a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">term -&gt; Writer (FloatTable tyname name uni fun a) term
</span><a href="#local-6989586621680956430"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">term
Term tyname name uni fun a
</span><a href="#local-6989586621680956393"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span>        </span><span class="hs-comment">-- no term inside here, nothing to do</span><span>
</span><span id="line-298"></span><span>        </span><span id="local-6989586621680956392"><span class="annot"><span class="annottext">t :: Term tyname name uni fun a
</span><a href="#local-6989586621680956392"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="PlutusIR.Core.Type.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Term tyname name uni fun a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956392"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-299"></span><span>        </span><span id="local-6989586621680956390"><span class="annot"><span class="annottext">t :: Term tyname name uni fun a
</span><a href="#local-6989586621680956390"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="PlutusIR.Core.Type.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Term tyname name uni fun a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956390"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-300"></span><span>        </span><span id="local-6989586621680956388"><span class="annot"><span class="annottext">t :: Term tyname name uni fun a
</span><a href="#local-6989586621680956388"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="PlutusIR.Core.Type.html#Builtin"><span class="hs-identifier hs-type">Builtin</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Term tyname name uni fun a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956388"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-301"></span><span>        </span><span id="local-6989586621680956386"><span class="annot"><span class="annottext">t :: Term tyname name uni fun a
</span><a href="#local-6989586621680956386"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="PlutusIR.Core.Type.html#Error"><span class="hs-identifier hs-type">Error</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Term tyname name uni fun a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956386"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-302"></span><span>
</span><span id="line-303"></span><span>    </span><span class="annot"><a href="#local-6989586621680956422"><span class="hs-identifier hs-type">goBinding</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956709"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956708"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956707"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956706"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956705"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-304"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Writer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#FloatTable"><span class="hs-identifier hs-type">FloatTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956709"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956708"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956707"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956706"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956705"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956709"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956708"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956707"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956706"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956705"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span>    </span><span id="local-6989586621680956422"><span class="annot"><span class="annottext">goBinding :: Binding tyname name uni fun a
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Binding tyname name uni fun a)
</span><a href="#local-6989586621680956422"><span class="hs-identifier hs-var hs-var">goBinding</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-306"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#TermBind"><span class="hs-identifier hs-type">TermBind</span></a></span><span> </span><span id="local-6989586621680956383"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956383"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621680956382"><span class="annot"><span class="annottext">Strictness
</span><a href="#local-6989586621680956382"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621680956381"><span class="annot"><span class="annottext">VarDecl tyname name uni fun a
</span><a href="#local-6989586621680956381"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621680956380"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956380"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a
-&gt; Strictness
-&gt; VarDecl tyname name uni fun a
-&gt; Term tyname name uni fun a
-&gt; Binding tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Strictness
-&gt; VarDecl tyname name uni fun a
-&gt; Term tyname name uni fun a
-&gt; Binding tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#TermBind"><span class="hs-identifier hs-var">TermBind</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956383"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Strictness
</span><a href="#local-6989586621680956382"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">VarDecl tyname name uni fun a
</span><a href="#local-6989586621680956381"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">(Term tyname name uni fun a -&gt; Binding tyname name uni fun a)
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Term tyname name uni fun a)
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Binding tyname name uni fun a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">term -&gt; Writer (FloatTable tyname name uni fun a) term
</span><a href="#local-6989586621680956430"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">term
Term tyname name uni fun a
</span><a href="#local-6989586621680956380"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-307"></span><span>        </span><span class="hs-comment">-- no term inside here, nothing to do</span><span>
</span><span id="line-308"></span><span>        </span><span id="local-6989586621680956379"><span class="annot"><span class="annottext">b :: Binding tyname name uni fun a
</span><a href="#local-6989586621680956379"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="PlutusIR.Core.Type.html#TypeBind"><span class="hs-identifier hs-type">TypeBind</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun a
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Binding tyname name uni fun a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun a
</span><a href="#local-6989586621680956379"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-309"></span><span>        </span><span id="local-6989586621680956377"><span class="annot"><span class="annottext">b :: Binding tyname name uni fun a
</span><a href="#local-6989586621680956377"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="PlutusIR.Core.Type.html#DatatypeBind"><span class="hs-identifier hs-type">DatatypeBind</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun a
-&gt; WriterT
     (FloatTable tyname name uni fun a)
     Identity
     (Binding tyname name uni fun a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun a
</span><a href="#local-6989586621680956377"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-310"></span><span>
</span><span id="line-311"></span><span class="hs-comment">-- | The 3rd and last pass that, given the result of 'removeLets', places the lets back (floats) at the right marked positions.</span><span>
</span><span id="line-312"></span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#floatBackLets"><span class="hs-identifier hs-type">floatBackLets</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680956700"><span class="annot"><a href="#local-6989586621680956700"><span class="hs-identifier hs-type">tyname</span></a></span></span><span> </span><span id="local-6989586621680956699"><span class="annot"><a href="#local-6989586621680956699"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621680956698"><span class="annot"><a href="#local-6989586621680956698"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621680956697"><span class="annot"><a href="#local-6989586621680956697"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621680956696"><span class="annot"><a href="#local-6989586621680956696"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621680956701"><span class="annot"><a href="#local-6989586621680956701"><span class="hs-identifier hs-type">term</span></a></span></span><span> </span><span id="local-6989586621680956695"><span class="annot"><a href="#local-6989586621680956695"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-313"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="#local-6989586621680956701"><span class="hs-identifier hs-type">term</span></a></span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956700"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956699"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956698"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956697"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956696"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-314"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621680956695"><span class="hs-identifier hs-type">m</span></a></span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span class="annot"><span class="hs-identifier hs-type">Reader</span></span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#Depth"><span class="hs-identifier hs-type">Depth</span></a></span><span>
</span><span id="line-315"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956700"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TypeUnique"><span class="hs-identifier hs-type">PLC.TypeUnique</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956699"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TermUnique"><span class="hs-identifier hs-type">PLC.TermUnique</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Semigroup</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956696"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-316"></span><span>              </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680956701"><span class="hs-identifier hs-type">term</span></a></span><span> </span><span class="hs-comment">-- ^ the cleanedup, reducted term</span><span>
</span><span id="line-317"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#FloatTable"><span class="hs-identifier hs-type">FloatTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956700"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956699"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956698"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956697"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956696"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-comment">-- ^ the lets to be floated</span><span>
</span><span id="line-318"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680956701"><span class="hs-identifier hs-type">term</span></a></span><span> </span><span class="hs-comment">-- ^ the final, floated, and correctly-scoped term</span><span>
</span><span id="line-319"></span><span id="floatBackLets"><span class="annot"><span class="annottext">floatBackLets :: term -&gt; FloatTable tyname name uni fun a -&gt; term
</span><a href="PlutusIR.Transform.LetFloat.html#floatBackLets"><span class="hs-identifier hs-var hs-var">floatBackLets</span></a></span></span><span> </span><span id="local-6989586621680956374"><span class="annot"><span class="annottext">term
</span><a href="#local-6989586621680956374"><span class="hs-identifier hs-var">term</span></a></span></span><span> </span><span id="local-6989586621680956373"><span class="annot"><span class="annottext">FloatTable tyname name uni fun a
</span><a href="#local-6989586621680956373"><span class="hs-identifier hs-var">fTable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-320"></span><span>    </span><span class="hs-comment">-- our reader context is only the depth this time.</span><span>
</span><span id="line-321"></span><span>    </span><span class="annot"><span class="annottext">(Reader Depth term -&gt; Depth -&gt; term)
-&gt; Depth -&gt; Reader Depth term -&gt; term
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">Reader Depth term -&gt; Depth -&gt; term
forall r a. Reader r a -&gt; r -&gt; a
</span><span class="hs-identifier hs-var">runReader</span></span><span> </span><span class="annot"><span class="annottext">Depth
</span><a href="PlutusIR.Transform.LetFloat.html#topDepth"><span class="hs-identifier hs-var">topDepth</span></a></span><span> </span><span class="annot"><span class="annottext">(Reader Depth term -&gt; term) -&gt; Reader Depth term -&gt; term
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">term -&gt; m term
</span><a href="#local-6989586621680956371"><span class="hs-identifier hs-var">goTop</span></a></span><span> </span><span class="annot"><span class="annottext">term
</span><a href="#local-6989586621680956374"><span class="hs-identifier hs-var">term</span></a></span><span>
</span><span id="line-322"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-323"></span><span>
</span><span id="line-324"></span><span>    </span><span class="hs-comment">-- TODO: use State for FloatTable to safeguard against any bugs where floatable-lets were not floated as they should to.</span><span>
</span><span id="line-325"></span><span>    </span><span class="annot"><a href="#local-6989586621680956371"><span class="hs-identifier hs-type">goTop</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621680956370"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621680956701"><span class="hs-identifier hs-type">term</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680956695"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956701"><span class="hs-identifier hs-type">term</span></a></span><span>
</span><span id="line-326"></span><span>
</span><span id="line-327"></span><span>    </span><span class="hs-comment">-- after traversing the cleaned term, try to float the lets that are destined for top (global lets)</span><span>
</span><span id="line-328"></span><span>    </span><span id="local-6989586621680956371"><span class="annot"><span class="annottext">goTop :: term -&gt; m term
</span><a href="#local-6989586621680956371"><span class="hs-identifier hs-var hs-var">goTop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Unique -&gt; term -&gt; m term
</span><a href="#local-6989586621680956369"><span class="hs-identifier hs-var">floatLam</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="PlutusIR.Transform.LetFloat.html#topUnique"><span class="hs-identifier hs-var">topUnique</span></a></span><span> </span><span class="annot"><span class="annottext">(term -&gt; m term) -&gt; (term -&gt; m term) -&gt; term -&gt; m term
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;=&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">term -&gt; m term
</span><a href="#local-6989586621680956370"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-329"></span><span>
</span><span id="line-330"></span><span>    </span><span id="local-6989586621680956370"><span class="annot"><span class="annottext">go :: term -&gt; m term
</span><a href="#local-6989586621680956370"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-331"></span><span>        </span><span class="hs-comment">-- lam anchor, increase depth &amp; try to float inside the lam's body</span><span>
</span><span id="line-332"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#LamAbs"><span class="hs-identifier hs-type">LamAbs</span></a></span><span> </span><span id="local-6989586621680956367"><span class="annot"><a href="#local-6989586621680956367"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621680956366"><span class="annot"><a href="#local-6989586621680956366"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621680956365"><span class="annot"><a href="#local-6989586621680956365"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621680956364"><span class="annot"><a href="#local-6989586621680956364"><span class="hs-identifier hs-var">tBody</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Depth -&gt; Depth)
-&gt; m (Term tyname name uni fun a) -&gt; m (Term tyname name uni fun a)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Depth -&gt; Depth -&gt; Depth
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">Depth
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (Term tyname name uni fun a) -&gt; m (Term tyname name uni fun a))
-&gt; m (Term tyname name uni fun a) -&gt; m (Term tyname name uni fun a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-333"></span><span>            </span><span class="annot"><span class="annottext">a
-&gt; name
-&gt; Type tyname uni a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; name
-&gt; Type tyname uni a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#LamAbs"><span class="hs-identifier hs-var">LamAbs</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956367"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680956366"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621680956365"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">(Term tyname name uni fun a -&gt; Term tyname name uni fun a)
-&gt; m (Term tyname name uni fun a) -&gt; m (Term tyname name uni fun a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unique -&gt; term -&gt; m term
</span><a href="#local-6989586621680956369"><span class="hs-identifier hs-var">floatLam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680956366"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">name -&gt; Getting Unique name Unique -&gt; Unique
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span class="annot"><span class="annottext">Getting Unique name Unique
forall name unique. HasUnique name unique =&gt; Lens' name Unique
</span><a href="PlutusCore.Name.html#theUnique"><span class="hs-identifier hs-var">PLC.theUnique</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(term -&gt; m term) -&gt; m term -&gt; m term
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">=&lt;&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">term -&gt; m term
</span><a href="#local-6989586621680956370"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">term
Term tyname name uni fun a
</span><a href="#local-6989586621680956364"><span class="hs-identifier hs-var">tBody</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-334"></span><span>        </span><span class="hs-comment">-- Lam anchor, increase depth &amp; try to float inside the Lam's body</span><span>
</span><span id="line-335"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#TyAbs"><span class="hs-identifier hs-type">TyAbs</span></a></span><span> </span><span id="local-6989586621680956361"><span class="annot"><a href="#local-6989586621680956361"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621680956360"><span class="annot"><a href="#local-6989586621680956360"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621680956359"><span class="annot"><a href="#local-6989586621680956359"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621680956358"><span class="annot"><a href="#local-6989586621680956358"><span class="hs-identifier hs-var">tBody</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Depth -&gt; Depth)
-&gt; m (Term tyname name uni fun a) -&gt; m (Term tyname name uni fun a)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Depth -&gt; Depth -&gt; Depth
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">Depth
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (Term tyname name uni fun a) -&gt; m (Term tyname name uni fun a))
-&gt; m (Term tyname name uni fun a) -&gt; m (Term tyname name uni fun a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-336"></span><span>            </span><span class="annot"><span class="annottext">a
-&gt; tyname
-&gt; Kind a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; tyname
-&gt; Kind a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#TyAbs"><span class="hs-identifier hs-var">TyAbs</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956361"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">tyname
</span><a href="#local-6989586621680956360"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Kind a
</span><a href="#local-6989586621680956359"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">(Term tyname name uni fun a -&gt; Term tyname name uni fun a)
-&gt; m (Term tyname name uni fun a) -&gt; m (Term tyname name uni fun a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unique -&gt; term -&gt; m term
</span><a href="#local-6989586621680956369"><span class="hs-identifier hs-var">floatLam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">tyname
</span><a href="#local-6989586621680956360"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">tyname -&gt; Getting Unique tyname Unique -&gt; Unique
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span class="annot"><span class="annottext">Getting Unique tyname Unique
forall name unique. HasUnique name unique =&gt; Lens' name Unique
</span><a href="PlutusCore.Name.html#theUnique"><span class="hs-identifier hs-var">PLC.theUnique</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(term -&gt; m term) -&gt; m term -&gt; m term
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">=&lt;&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">term -&gt; m term
</span><a href="#local-6989586621680956370"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">term
Term tyname name uni fun a
</span><a href="#local-6989586621680956358"><span class="hs-identifier hs-var">tBody</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-337"></span><span>        </span><span class="hs-comment">-- Unfloatable-let anchor, increase depth</span><span>
</span><span id="line-338"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621680956357"><span class="annot"><a href="#local-6989586621680956357"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621680956356"><span class="annot"><a href="#local-6989586621680956356"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621680956355"><span class="annot"><a href="#local-6989586621680956355"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#representativeBindingUnique"><span class="hs-identifier hs-type">representativeBindingUnique</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621680956354"><span class="annot"><a href="#local-6989586621680956354"><span class="hs-identifier hs-var">letU</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680956353"><span class="annot"><a href="#local-6989586621680956353"><span class="hs-identifier hs-var">tIn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Depth -&gt; Depth)
-&gt; m (Term tyname name uni fun a) -&gt; m (Term tyname name uni fun a)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Depth -&gt; Depth -&gt; Depth
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">Depth
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (Term tyname name uni fun a) -&gt; m (Term tyname name uni fun a))
-&gt; m (Term tyname name uni fun a) -&gt; m (Term tyname name uni fun a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-339"></span><span>            </span><span class="hs-comment">-- note that we do not touch the original recursivity of the unfloatable-let</span><span>
</span><span id="line-340"></span><span>            </span><span id="local-6989586621680956352"><span class="annot"><span class="annottext">BindingGrp tyname name uni fun a
</span><a href="#local-6989586621680956352"><span class="hs-identifier hs-var">unfloatableGrp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">a
-&gt; Recursivity
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; BindingGrp tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Recursivity
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; BindingGrp tyname name uni fun a
</span><a href="PlutusIR.Transform.LetFloat.html#BindingGrp"><span class="hs-identifier hs-var">BindingGrp</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956357"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><a href="#local-6989586621680956356"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">(NonEmpty (Binding tyname name uni fun a)
 -&gt; BindingGrp tyname name uni fun a)
-&gt; m (NonEmpty (Binding tyname name uni fun a))
-&gt; m (BindingGrp tyname name uni fun a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">LensLike
  m
  (NonEmpty (Binding tyname name uni fun a))
  (NonEmpty (Binding tyname name uni fun a))
  (Term tyname name uni fun a)
  (Term tyname name uni fun a)
-&gt; LensLike
     m
     (NonEmpty (Binding tyname name uni fun a))
     (NonEmpty (Binding tyname name uni fun a))
     (Term tyname name uni fun a)
     (Term tyname name uni fun a)
forall (f :: * -&gt; *) s t a b.
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-identifier hs-var">traverseOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Binding tyname name uni fun a
 -&gt; m (Binding tyname name uni fun a))
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; m (NonEmpty (Binding tyname name uni fun a))
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
</span><span class="hs-identifier hs-var">traversed</span></span><span class="annot"><span class="annottext">((Binding tyname name uni fun a
  -&gt; m (Binding tyname name uni fun a))
 -&gt; NonEmpty (Binding tyname name uni fun a)
 -&gt; m (NonEmpty (Binding tyname name uni fun a)))
-&gt; ((Term tyname name uni fun a -&gt; m (Term tyname name uni fun a))
    -&gt; Binding tyname name uni fun a
    -&gt; m (Binding tyname name uni fun a))
-&gt; LensLike
     m
     (NonEmpty (Binding tyname name uni fun a))
     (NonEmpty (Binding tyname name uni fun a))
     (Term tyname name uni fun a)
     (Term tyname name uni fun a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span class="annot"><span class="annottext">(Term tyname name uni fun a -&gt; m (Term tyname name uni fun a))
-&gt; Binding tyname name uni fun a
-&gt; m (Binding tyname name uni fun a)
forall tyname name (uni :: * -&gt; *) fun a.
Traversal'
  (Binding tyname name uni fun a) (Term tyname name uni fun a)
</span><a href="PlutusIR.Core.Plated.html#bindingSubterms"><span class="hs-identifier hs-var">bindingSubterms</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">term -&gt; m term
Term tyname name uni fun a -&gt; m (Term tyname name uni fun a)
</span><a href="#local-6989586621680956370"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621680956355"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-341"></span><span>            </span><span class="hs-comment">-- rebuild the let-group (we take the minimum bound, i.e. NonRec)</span><span>
</span><span id="line-342"></span><span>            </span><span class="annot"><span class="annottext">Recursivity
-&gt; BindingGrp tyname name uni fun a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
Recursivity
-&gt; BindingGrp tyname name uni fun a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Transform.LetFloat.html#bindingGrpToLet"><span class="hs-identifier hs-var">bindingGrpToLet</span></a></span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><a href="PlutusIR.Core.Type.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span>
</span><span id="line-343"></span><span>              </span><span class="annot"><span class="annottext">(BindingGrp tyname name uni fun a
 -&gt; Term tyname name uni fun a -&gt; Term tyname name uni fun a)
-&gt; m (BindingGrp tyname name uni fun a)
-&gt; m (Term tyname name uni fun a -&gt; Term tyname name uni fun a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="hs-comment">-- float inside the rhs of the unfloatable group, and merge the bindings</span><span>
</span><span id="line-344"></span><span>                  </span><span class="annot"><span class="annottext">Unique
-&gt; BindingGrp tyname name uni fun a
-&gt; m (BindingGrp tyname name uni fun a)
forall grp.
(grp ~ BindingGrp tyname name uni fun a) =&gt;
Unique -&gt; grp -&gt; m grp
</span><a href="#local-6989586621680956349"><span class="hs-identifier hs-var">floatRhs</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621680956354"><span class="hs-identifier hs-var">letU</span></a></span><span> </span><span class="annot"><span class="annottext">BindingGrp tyname name uni fun a
</span><a href="#local-6989586621680956352"><span class="hs-identifier hs-var">unfloatableGrp</span></a></span><span>
</span><span id="line-345"></span><span>                  </span><span class="hs-comment">-- float right inside the inTerm (similar to lam/Lam)</span><span>
</span><span id="line-346"></span><span>              </span><span class="annot"><span class="annottext">m (Term tyname name uni fun a -&gt; Term tyname name uni fun a)
-&gt; m (Term tyname name uni fun a) -&gt; m (Term tyname name uni fun a)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unique -&gt; term -&gt; m term
</span><a href="#local-6989586621680956369"><span class="hs-identifier hs-var">floatLam</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621680956354"><span class="hs-identifier hs-var">letU</span></a></span><span> </span><span class="annot"><span class="annottext">(term -&gt; m term) -&gt; m term -&gt; m term
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">=&lt;&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">term -&gt; m term
</span><a href="#local-6989586621680956370"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">term
Term tyname name uni fun a
</span><a href="#local-6989586621680956353"><span class="hs-identifier hs-var">tIn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-347"></span><span>
</span><span id="line-348"></span><span>        </span><span class="hs-comment">-- descend</span><span>
</span><span id="line-349"></span><span>        </span><span id="local-6989586621680956348"><span class="annot"><span class="annottext">term
</span><a href="#local-6989586621680956348"><span class="hs-identifier hs-var">t</span></a></span></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">term
</span><a href="#local-6989586621680956348"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">term
-&gt; (term -&gt; m (Term tyname name uni fun a))
-&gt; m (Term tyname name uni fun a)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(Term tyname name uni fun a -&gt; m (Term tyname name uni fun a))
-&gt; Term tyname name uni fun a -&gt; m (Term tyname name uni fun a)
forall tyname name (uni :: * -&gt; *) fun a.
Traversal'
  (Term tyname name uni fun a) (Term tyname name uni fun a)
</span><a href="PlutusIR.Core.Plated.html#termSubterms"><span class="hs-identifier hs-var">termSubterms</span></a></span><span> </span><span class="annot"><span class="annottext">term -&gt; m term
Term tyname name uni fun a -&gt; m (Term tyname name uni fun a)
</span><a href="#local-6989586621680956370"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-350"></span><span>
</span><span id="line-351"></span><span>    </span><span class="hs-comment">-- Make a brand new let-group comprised of all the floatable lets just inside the lam-body/Lam-body/let-InTerm</span><span>
</span><span id="line-352"></span><span>    </span><span class="annot"><a href="#local-6989586621680956369"><span class="hs-identifier hs-type">floatLam</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#Unique"><span class="hs-identifier hs-type">PLC.Unique</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680956701"><span class="hs-identifier hs-type">term</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680956695"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956701"><span class="hs-identifier hs-type">term</span></a></span><span>
</span><span id="line-353"></span><span>    </span><span id="local-6989586621680956369"><span class="annot"><span class="annottext">floatLam :: Unique -&gt; term -&gt; m term
</span><a href="#local-6989586621680956369"><span class="hs-identifier hs-var hs-var">floatLam</span></a></span></span><span> </span><span id="local-6989586621680956346"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621680956346"><span class="hs-identifier hs-var">lamU</span></a></span></span><span> </span><span id="local-6989586621680956345"><span class="annot"><span class="annottext">term
</span><a href="#local-6989586621680956345"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-354"></span><span>        </span><span id="local-6989586621680956344"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680956344"><span class="hs-identifier hs-var">herePos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Depth -&gt; Pos) -&gt; m Pos
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">((Depth -&gt; Pos) -&gt; m Pos) -&gt; (Depth -&gt; Pos) -&gt; m Pos
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680956343"><span class="annot"><span class="annottext">Depth
</span><a href="#local-6989586621680956343"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Depth -&gt; Unique -&gt; PosType -&gt; Pos
</span><a href="PlutusIR.Transform.LetFloat.html#Pos"><span class="hs-identifier hs-var">Pos</span></a></span><span> </span><span class="annot"><span class="annottext">Depth
</span><a href="#local-6989586621680956343"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621680956346"><span class="hs-identifier hs-var">lamU</span></a></span><span> </span><span class="annot"><span class="annottext">PosType
</span><a href="PlutusIR.Transform.LetFloat.html#LamBody"><span class="hs-identifier hs-var">LamBody</span></a></span><span>
</span><span id="line-355"></span><span>        </span><span class="hs-comment">-- We need to force to Rec because we might merge lets which depend on each other,</span><span>
</span><span id="line-356"></span><span>        </span><span class="hs-comment">-- but we can't tell because we don't do dependency resolution at this pass.</span><span>
</span><span id="line-357"></span><span>        </span><span class="hs-comment">-- So we have to be conservative. See Note [LetRec splitting pass]</span><span>
</span><span id="line-358"></span><span>        </span><span class="annot"><span class="annottext">Pos
-&gt; (BindingGrp tyname name uni fun a
    -&gt; Term tyname name uni fun a -&gt; Term tyname name uni fun a)
-&gt; Term tyname name uni fun a
-&gt; m (Term tyname name uni fun a)
forall c.
Pos -&gt; (BindingGrp tyname name uni fun a -&gt; c -&gt; c) -&gt; c -&gt; m c
</span><a href="#local-6989586621680956342"><span class="hs-identifier hs-var">floatAt</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680956344"><span class="hs-identifier hs-var">herePos</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Recursivity
-&gt; BindingGrp tyname name uni fun a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
Recursivity
-&gt; BindingGrp tyname name uni fun a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Transform.LetFloat.html#bindingGrpToLet"><span class="hs-identifier hs-var">bindingGrpToLet</span></a></span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><a href="PlutusIR.Core.Type.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">term
Term tyname name uni fun a
</span><a href="#local-6989586621680956345"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-359"></span><span>
</span><span id="line-360"></span><span>    </span><span id="local-6989586621680956734"><span class="annot"><a href="#local-6989586621680956349"><span class="hs-identifier hs-type">floatRhs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680956734"><span class="hs-identifier hs-type">grp</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#BindingGrp"><span class="hs-identifier hs-type">BindingGrp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956700"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956699"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956698"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956697"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956696"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span>             </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#Unique"><span class="hs-identifier hs-type">PLC.Unique</span></a></span><span>
</span><span id="line-362"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680956734"><span class="hs-identifier hs-type">grp</span></a></span><span> </span><span class="hs-comment">-- ^ the unfloatable group</span><span>
</span><span id="line-363"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680956695"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956734"><span class="hs-identifier hs-type">grp</span></a></span><span> </span><span class="hs-comment">-- ^ the result group extended with the floatable rhs'es (size(result_group) &gt;= size(unfloatable_group))</span></span><span>
</span><span id="line-364"></span><span>    </span><span id="local-6989586621680956349"><span class="annot"><span class="annottext">floatRhs :: Unique -&gt; grp -&gt; m grp
</span><a href="#local-6989586621680956349"><span class="hs-identifier hs-var hs-var">floatRhs</span></a></span></span><span> </span><span id="local-6989586621680956340"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621680956340"><span class="hs-identifier hs-var">letU</span></a></span></span><span> </span><span id="local-6989586621680956339"><span class="annot"><span class="annottext">grp
</span><a href="#local-6989586621680956339"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-365"></span><span>        </span><span id="local-6989586621680956338"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680956338"><span class="hs-identifier hs-var">herePos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Depth -&gt; Pos) -&gt; m Pos
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">((Depth -&gt; Pos) -&gt; m Pos) -&gt; (Depth -&gt; Pos) -&gt; m Pos
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680956337"><span class="annot"><span class="annottext">Depth
</span><a href="#local-6989586621680956337"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Depth -&gt; Unique -&gt; PosType -&gt; Pos
</span><a href="PlutusIR.Transform.LetFloat.html#Pos"><span class="hs-identifier hs-var">Pos</span></a></span><span> </span><span class="annot"><span class="annottext">Depth
</span><a href="#local-6989586621680956337"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621680956340"><span class="hs-identifier hs-var">letU</span></a></span><span> </span><span class="annot"><span class="annottext">PosType
</span><a href="PlutusIR.Transform.LetFloat.html#LetRhs"><span class="hs-identifier hs-var">LetRhs</span></a></span><span>
</span><span id="line-366"></span><span>        </span><span class="hs-comment">-- we don't know from which rhs the floatable-let(s) came from originally,</span><span>
</span><span id="line-367"></span><span>        </span><span class="hs-comment">-- so we instead are going to semigroup-append the floatable-let bindings together with the unfloatable let-group's bindings</span><span>
</span><span id="line-368"></span><span>        </span><span class="annot"><span class="annottext">Pos
-&gt; (BindingGrp tyname name uni fun a
    -&gt; BindingGrp tyname name uni fun a
    -&gt; BindingGrp tyname name uni fun a)
-&gt; BindingGrp tyname name uni fun a
-&gt; m (BindingGrp tyname name uni fun a)
forall c.
Pos -&gt; (BindingGrp tyname name uni fun a -&gt; c -&gt; c) -&gt; c -&gt; m c
</span><a href="#local-6989586621680956342"><span class="hs-identifier hs-var">floatAt</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680956338"><span class="hs-identifier hs-var">herePos</span></a></span><span> </span><span class="annot"><span class="annottext">BindingGrp tyname name uni fun a
-&gt; BindingGrp tyname name uni fun a
-&gt; BindingGrp tyname name uni fun a
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">(&lt;&gt;)</span></a></span><span> </span><span class="annot"><span class="annottext">grp
BindingGrp tyname name uni fun a
</span><a href="#local-6989586621680956339"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-369"></span><span>
</span><span id="line-370"></span><span>    </span><span id="local-6989586621680956731"><span class="annot"><a href="#local-6989586621680956342"><span class="hs-identifier hs-type">floatAt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span> </span><span class="hs-comment">-- ^ floating position</span><span>
</span><span id="line-371"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#BindingGrp"><span class="hs-identifier hs-type">BindingGrp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956700"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956699"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956698"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956697"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956696"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680956731"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680956731"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ how to place the unfloatable-group into the PIR result</span><span>
</span><span id="line-372"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680956731"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-comment">-- ^ term or bindings to float AROUND</span><span>
</span><span id="line-373"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680956695"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956731"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-comment">-- ^ the combined PIR result (terms or bindings)</span></span><span>
</span><span id="line-374"></span><span>    </span><span id="local-6989586621680956342"><span class="annot"><span class="annottext">floatAt :: Pos -&gt; (BindingGrp tyname name uni fun a -&gt; c -&gt; c) -&gt; c -&gt; m c
</span><a href="#local-6989586621680956342"><span class="hs-identifier hs-var hs-var">floatAt</span></a></span></span><span> </span><span id="local-6989586621680956336"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680956336"><span class="hs-identifier hs-var">herePos</span></a></span></span><span> </span><span id="local-6989586621680956335"><span class="annot"><span class="annottext">BindingGrp tyname name uni fun a -&gt; c -&gt; c
</span><a href="#local-6989586621680956335"><span class="hs-identifier hs-var">placeIntoFn</span></a></span></span><span> </span><span id="local-6989586621680956334"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621680956334"><span class="hs-identifier hs-var">termOrBindings</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-375"></span><span>        </span><span class="hs-comment">-- is there something to be floated here?</span><span>
</span><span id="line-376"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Pos
-&gt; FloatTable tyname name uni fun a
-&gt; Maybe (NonEmpty (BindingGrp tyname name uni fun a))
forall k a. Ord k =&gt; k -&gt; MonoidalMap k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">MM.lookup</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680956336"><span class="hs-identifier hs-var">herePos</span></a></span><span> </span><span class="annot"><span class="annottext">FloatTable tyname name uni fun a
</span><a href="#local-6989586621680956373"><span class="hs-identifier hs-var">fTable</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-377"></span><span>            </span><span class="hs-comment">-- nothing to float, just descend</span><span>
</span><span id="line-378"></span><span>            </span><span class="annot"><span class="annottext">Maybe (NonEmpty (BindingGrp tyname name uni fun a))
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">c -&gt; m c
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621680956334"><span class="hs-identifier hs-var">termOrBindings</span></a></span><span>
</span><span id="line-379"></span><span>            </span><span class="hs-comment">-- all the naked-lets to be floated here</span><span>
</span><span id="line-380"></span><span>            </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621680956332"><span class="annot"><span class="annottext">NonEmpty (BindingGrp tyname name uni fun a)
</span><a href="#local-6989586621680956332"><span class="hs-identifier hs-var">floatableGrps</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-381"></span><span>                </span><span class="hs-comment">-- visit the rhs'es of these floated lets for any potential floatings as well</span><span>
</span><span id="line-382"></span><span>                </span><span class="hs-comment">-- NOTE: we do not directly run `go(bgGroup)` because that would increase the depth,</span><span>
</span><span id="line-383"></span><span>                </span><span class="hs-comment">-- and the floated lets are not anchors themselves; instead we run go on the floated-let bindings' subterms.</span><span>
</span><span id="line-384"></span><span>                </span><span id="local-6989586621680956331"><span class="annot"><span class="annottext">NonEmpty (BindingGrp tyname name uni fun a)
</span><a href="#local-6989586621680956331"><span class="hs-identifier hs-var">floatableGrps'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NonEmpty (BindingGrp tyname name uni fun a)
</span><a href="#local-6989586621680956332"><span class="hs-identifier hs-var">floatableGrps</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (BindingGrp tyname name uni fun a)
-&gt; (NonEmpty (BindingGrp tyname name uni fun a)
    -&gt; m (NonEmpty (BindingGrp tyname name uni fun a)))
-&gt; m (NonEmpty (BindingGrp tyname name uni fun a))
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(BindingGrp tyname name uni fun a
 -&gt; m (BindingGrp tyname name uni fun a))
-&gt; NonEmpty (BindingGrp tyname name uni fun a)
-&gt; m (NonEmpty (BindingGrp tyname name uni fun a))
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
</span><span class="hs-identifier hs-var">traversed</span></span><span class="annot"><span class="annottext">((BindingGrp tyname name uni fun a
  -&gt; m (BindingGrp tyname name uni fun a))
 -&gt; NonEmpty (BindingGrp tyname name uni fun a)
 -&gt; m (NonEmpty (BindingGrp tyname name uni fun a)))
-&gt; ((Term tyname name uni fun a -&gt; m (Term tyname name uni fun a))
    -&gt; BindingGrp tyname name uni fun a
    -&gt; m (BindingGrp tyname name uni fun a))
-&gt; (Term tyname name uni fun a -&gt; m (Term tyname name uni fun a))
-&gt; NonEmpty (BindingGrp tyname name uni fun a)
-&gt; m (NonEmpty (BindingGrp tyname name uni fun a))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span class="annot"><span class="annottext">(NonEmpty (Binding tyname name uni fun a)
 -&gt; ReaderT
      Depth Identity (NonEmpty (Binding tyname name uni fun a)))
-&gt; BindingGrp tyname name uni fun a
-&gt; ReaderT Depth Identity (BindingGrp tyname name uni fun a)
forall tyname name (uni :: * -&gt; *) fun a tyname name
       (uni :: * -&gt; *) fun.
Lens
  (BindingGrp tyname name uni fun a)
  (BindingGrp tyname name uni fun a)
  (NonEmpty (Binding tyname name uni fun a))
  (NonEmpty (Binding tyname name uni fun a))
</span><a href="PlutusIR.Transform.LetFloat.html#bgBindings"><span class="hs-identifier hs-var">bgBindings</span></a></span><span class="annot"><span class="annottext">((NonEmpty (Binding tyname name uni fun a)
  -&gt; ReaderT
       Depth Identity (NonEmpty (Binding tyname name uni fun a)))
 -&gt; BindingGrp tyname name uni fun a
 -&gt; ReaderT Depth Identity (BindingGrp tyname name uni fun a))
-&gt; ((Term tyname name uni fun a -&gt; m (Term tyname name uni fun a))
    -&gt; NonEmpty (Binding tyname name uni fun a)
    -&gt; ReaderT
         Depth Identity (NonEmpty (Binding tyname name uni fun a)))
-&gt; (Term tyname name uni fun a -&gt; m (Term tyname name uni fun a))
-&gt; BindingGrp tyname name uni fun a
-&gt; ReaderT Depth Identity (BindingGrp tyname name uni fun a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span class="annot"><span class="annottext">(Binding tyname name uni fun a
 -&gt; ReaderT Depth Identity (Binding tyname name uni fun a))
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; ReaderT
     Depth Identity (NonEmpty (Binding tyname name uni fun a))
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
</span><span class="hs-identifier hs-var">traversed</span></span><span class="annot"><span class="annottext">((Binding tyname name uni fun a
  -&gt; ReaderT Depth Identity (Binding tyname name uni fun a))
 -&gt; NonEmpty (Binding tyname name uni fun a)
 -&gt; ReaderT
      Depth Identity (NonEmpty (Binding tyname name uni fun a)))
-&gt; ((Term tyname name uni fun a -&gt; m (Term tyname name uni fun a))
    -&gt; Binding tyname name uni fun a
    -&gt; ReaderT Depth Identity (Binding tyname name uni fun a))
-&gt; (Term tyname name uni fun a -&gt; m (Term tyname name uni fun a))
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; ReaderT
     Depth Identity (NonEmpty (Binding tyname name uni fun a))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span class="annot"><span class="annottext">(Term tyname name uni fun a -&gt; m (Term tyname name uni fun a))
-&gt; Binding tyname name uni fun a
-&gt; ReaderT Depth Identity (Binding tyname name uni fun a)
forall tyname name (uni :: * -&gt; *) fun a.
Traversal'
  (Binding tyname name uni fun a) (Term tyname name uni fun a)
</span><a href="PlutusIR.Core.Plated.html#bindingSubterms"><span class="hs-identifier hs-var">bindingSubterms</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">term -&gt; m term
Term tyname name uni fun a -&gt; m (Term tyname name uni fun a)
</span><a href="#local-6989586621680956370"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-385"></span><span>                </span><span class="hs-comment">-- fold the floatable groups into a *single* floatablegroup and combine that with some pir (term or bindings).</span><span>
</span><span id="line-386"></span><span>                </span><span class="annot"><span class="annottext">c -&gt; m c
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(c -&gt; m c) -&gt; c -&gt; m c
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (BindingGrp tyname name uni fun a)
-&gt; BindingGrp tyname name uni fun a
forall (t :: * -&gt; *) m. (Foldable1 t, Semigroup m) =&gt; t m -&gt; m
</span><span class="hs-identifier hs-var">fold1</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (BindingGrp tyname name uni fun a)
</span><a href="#local-6989586621680956331"><span class="hs-identifier hs-var">floatableGrps'</span></a></span><span> </span><span class="annot"><span class="annottext">BindingGrp tyname name uni fun a -&gt; c -&gt; c
</span><a href="#local-6989586621680956335"><span class="hs-operator hs-var">`placeIntoFn`</span></a></span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621680956334"><span class="hs-identifier hs-var">termOrBindings</span></a></span><span>
</span><span id="line-387"></span><span>
</span><span id="line-388"></span><span class="hs-comment">-- | The compiler pass of the algorithm (comprised of 3 connected passes).</span><span>
</span><span id="line-389"></span><span id="local-6989586621680956325"><span id="local-6989586621680956326"><span id="local-6989586621680956327"><span id="local-6989586621680956328"><span id="local-6989586621680956329"><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#floatTerm"><span class="hs-identifier hs-type">floatTerm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#ToBuiltinMeaning"><span class="hs-identifier hs-type">PLC.ToBuiltinMeaning</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956329"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956328"><span class="hs-identifier hs-type">fun</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-390"></span><span>            </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956327"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TypeUnique"><span class="hs-identifier hs-type">PLC.TypeUnique</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956326"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TermUnique"><span class="hs-identifier hs-type">PLC.TermUnique</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-391"></span><span>            </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956327"><span class="hs-identifier hs-type">tyname</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956326"><span class="hs-identifier hs-type">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Semigroup</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956325"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-392"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-393"></span><span>          </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956327"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956326"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956329"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956328"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956325"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956327"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956326"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956329"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956328"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956325"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span></span><span>
</span><span id="line-394"></span><span id="floatTerm"><span class="annot"><span class="annottext">floatTerm :: Term tyname name uni fun a -&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Transform.LetFloat.html#floatTerm"><span class="hs-identifier hs-var hs-var">floatTerm</span></a></span></span><span> </span><span id="local-6989586621680956324"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956324"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-395"></span><span>    </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; Scope
forall tyname name (uni :: * -&gt; *) fun a.
(Ord tyname, Ord name, HasUnique tyname TypeUnique,
 HasUnique name TermUnique, ToBuiltinMeaning uni fun) =&gt;
Term tyname name uni fun a -&gt; Scope
</span><a href="PlutusIR.Transform.LetFloat.html#mark"><span class="hs-identifier hs-var">mark</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956324"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-396"></span><span>    </span><span class="annot"><span class="annottext">Scope
-&gt; (Scope
    -&gt; (Term tyname name uni fun a, FloatTable tyname name uni fun a))
-&gt; (Term tyname name uni fun a, FloatTable tyname name uni fun a)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(Scope
 -&gt; Term tyname name uni fun a
 -&gt; (Term tyname name uni fun a, FloatTable tyname name uni fun a))
-&gt; Term tyname name uni fun a
-&gt; Scope
-&gt; (Term tyname name uni fun a, FloatTable tyname name uni fun a)
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
-&gt; Term tyname name uni fun a
-&gt; (Term tyname name uni fun a, FloatTable tyname name uni fun a)
forall tyname name (uni :: * -&gt; *) fun a term.
(term ~ Term tyname name uni fun a, HasUnique tyname TypeUnique,
 HasUnique name TermUnique) =&gt;
Scope -&gt; term -&gt; (term, FloatTable tyname name uni fun a)
</span><a href="PlutusIR.Transform.LetFloat.html#removeLets"><span class="hs-identifier hs-var">removeLets</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956324"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-397"></span><span>    </span><span class="annot"><span class="annottext">(Term tyname name uni fun a, FloatTable tyname name uni fun a)
-&gt; ((Term tyname name uni fun a, FloatTable tyname name uni fun a)
    -&gt; Term tyname name uni fun a)
-&gt; Term tyname name uni fun a
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(Term tyname name uni fun a
 -&gt; FloatTable tyname name uni fun a -&gt; Term tyname name uni fun a)
-&gt; (Term tyname name uni fun a, FloatTable tyname name uni fun a)
-&gt; Term tyname name uni fun a
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">uncurry</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
-&gt; FloatTable tyname name uni fun a -&gt; Term tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a term (m :: * -&gt; *).
(term ~ Term tyname name uni fun a, m ~ Reader Depth,
 HasUnique tyname TypeUnique, HasUnique name TermUnique,
 Semigroup a) =&gt;
term -&gt; FloatTable tyname name uni fun a -&gt; term
</span><a href="PlutusIR.Transform.LetFloat.html#floatBackLets"><span class="hs-identifier hs-var">floatBackLets</span></a></span><span>
</span><span id="line-398"></span><span>
</span><span id="line-399"></span><span class="hs-comment">-- HELPERS</span><span>
</span><span id="line-400"></span><span>
</span><span id="line-401"></span><span id="local-6989586621680956868"><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#maxPos"><span class="hs-identifier hs-type">maxPos</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="#local-6989586621680956868"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span></span><span>
</span><span id="line-402"></span><span id="maxPos"><span class="annot"><span class="annottext">maxPos :: Map k Pos -&gt; Pos
</span><a href="PlutusIR.Transform.LetFloat.html#maxPos"><span class="hs-identifier hs-var hs-var">maxPos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Pos -&gt; Pos -&gt; Pos) -&gt; Pos -&gt; Map k Pos -&gt; Pos
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Pos -&gt; Pos
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">max</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="PlutusIR.Transform.LetFloat.html#topPos"><span class="hs-identifier hs-var">topPos</span></a></span><span>
</span><span id="line-403"></span><span>
</span><span id="line-404"></span><span id="local-6989586621680956862"><span id="local-6989586621680956863"><span id="local-6989586621680956864"><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#withDepth"><span class="hs-identifier hs-type">withDepth</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680956864"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#MarkCtx"><span class="hs-identifier hs-type">MarkCtx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="#local-6989586621680956864"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956863"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-405"></span><span>          </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#Depth"><span class="hs-identifier hs-type">Depth</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#Depth"><span class="hs-identifier hs-type">Depth</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680956863"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956862"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680956863"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956862"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-406"></span><span id="withDepth"><span class="annot"><span class="annottext">withDepth :: (Depth -&gt; Depth) -&gt; m a -&gt; m a
</span><a href="PlutusIR.Transform.LetFloat.html#withDepth"><span class="hs-identifier hs-var hs-var">withDepth</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(MarkCtx -&gt; MarkCtx) -&gt; m a -&gt; m a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">((MarkCtx -&gt; MarkCtx) -&gt; m a -&gt; m a)
-&gt; ((Depth -&gt; Depth) -&gt; MarkCtx -&gt; MarkCtx)
-&gt; (Depth -&gt; Depth)
-&gt; m a
-&gt; m a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter MarkCtx MarkCtx Depth Depth
-&gt; (Depth -&gt; Depth) -&gt; MarkCtx -&gt; MarkCtx
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-identifier hs-var">over</span></span><span> </span><span class="annot"><span class="annottext">ASetter MarkCtx MarkCtx Depth Depth
Lens' MarkCtx Depth
</span><a href="PlutusIR.Transform.LetFloat.html#markCtxDepth"><span class="hs-identifier hs-var">markCtxDepth</span></a></span><span>
</span><span id="line-407"></span><span>
</span><span id="line-408"></span><span id="local-6989586621680956907"><span id="local-6989586621680956908"><span id="local-6989586621680956909"><span id="local-6989586621680956911"><span id="local-6989586621680956912"><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#withLam"><span class="hs-identifier hs-type">withLam</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680956912"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#MarkCtx"><span class="hs-identifier hs-type">MarkCtx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="#local-6989586621680956912"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956911"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956909"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956908"><span class="hs-identifier hs-type">unique</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-409"></span><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680956909"><span class="hs-identifier hs-type">name</span></a></span><span>
</span><span id="line-410"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680956911"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956907"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680956911"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956907"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span></span><span>
</span><span id="line-411"></span><span id="withLam"><span class="annot"><span class="annottext">withLam :: name -&gt; m a -&gt; m a
</span><a href="PlutusIR.Transform.LetFloat.html#withLam"><span class="hs-identifier hs-var hs-var">withLam</span></a></span></span><span> </span><span id="local-6989586621680956319"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680956319"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(MarkCtx -&gt; MarkCtx) -&gt; m a -&gt; m a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">((MarkCtx -&gt; MarkCtx) -&gt; m a -&gt; m a)
-&gt; (MarkCtx -&gt; MarkCtx) -&gt; m a -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#MarkCtx"><span class="hs-identifier hs-type">MarkCtx</span></a></span><span> </span><span id="local-6989586621680956318"><span class="annot"><span class="annottext">Depth
</span><a href="#local-6989586621680956318"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621680956317"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621680956317"><span class="hs-identifier hs-var">scope</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-412"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680956316"><span class="annot"><span class="annottext">u :: Unique
</span><a href="#local-6989586621680956316"><span class="hs-identifier hs-var hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680956319"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">name -&gt; Getting Unique name Unique -&gt; Unique
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span class="annot"><span class="annottext">Getting Unique name Unique
forall name unique. HasUnique name unique =&gt; Lens' name Unique
</span><a href="PlutusCore.Name.html#theUnique"><span class="hs-identifier hs-var">PLC.theUnique</span></a></span><span>
</span><span id="line-413"></span><span>        </span><span id="local-6989586621680956315"><span class="annot"><span class="annottext">d' :: Depth
</span><a href="#local-6989586621680956315"><span class="hs-identifier hs-var hs-var">d'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Depth
</span><a href="#local-6989586621680956318"><span class="hs-identifier hs-var">d</span></a></span><span class="annot"><span class="annottext">Depth -&gt; Depth -&gt; Depth
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">Depth
</span><span class="hs-number">1</span></span><span>
</span><span id="line-414"></span><span>        </span><span id="local-6989586621680956314"><span class="annot"><span class="annottext">pos' :: Pos
</span><a href="#local-6989586621680956314"><span class="hs-identifier hs-var hs-var">pos'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Depth -&gt; Unique -&gt; PosType -&gt; Pos
</span><a href="PlutusIR.Transform.LetFloat.html#Pos"><span class="hs-identifier hs-var">Pos</span></a></span><span> </span><span class="annot"><span class="annottext">Depth
</span><a href="#local-6989586621680956315"><span class="hs-identifier hs-var">d'</span></a></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621680956316"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">PosType
</span><a href="PlutusIR.Transform.LetFloat.html#LamBody"><span class="hs-identifier hs-var">LamBody</span></a></span><span>
</span><span id="line-415"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Depth -&gt; Scope -&gt; MarkCtx
</span><a href="PlutusIR.Transform.LetFloat.html#MarkCtx"><span class="hs-identifier hs-var">MarkCtx</span></a></span><span> </span><span class="annot"><span class="annottext">Depth
</span><a href="#local-6989586621680956315"><span class="hs-identifier hs-var">d'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unique -&gt; Pos -&gt; Scope -&gt; Scope
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621680956316"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680956314"><span class="hs-identifier hs-var">pos'</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621680956317"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-416"></span><span>
</span><span id="line-417"></span><span id="local-6989586621680956852"><span id="local-6989586621680956853"><span id="local-6989586621680956854"><span id="local-6989586621680956855"><span id="local-6989586621680956856"><span id="local-6989586621680956857"><span id="local-6989586621680956858"><span id="local-6989586621680956859"><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#withBs"><span class="hs-identifier hs-type">withBs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680956859"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#MarkCtx"><span class="hs-identifier hs-type">MarkCtx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="#local-6989586621680956859"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956858"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956857"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TermUnique"><span class="hs-identifier hs-type">PLC.TermUnique</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956856"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TypeUnique"><span class="hs-identifier hs-type">PLC.TypeUnique</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-418"></span><span>       </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">NE.NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956856"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956857"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956855"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956854"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956853"><span class="hs-identifier hs-type">a3</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-419"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#Pos"><span class="hs-identifier hs-type">Pos</span></a></span><span>
</span><span id="line-420"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680956858"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956852"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680956858"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956852"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span></span></span></span></span><span>
</span><span id="line-421"></span><span id="withBs"><span class="annot"><span class="annottext">withBs :: NonEmpty (Binding tyname name uni fun a3) -&gt; Pos -&gt; m a -&gt; m a
</span><a href="PlutusIR.Transform.LetFloat.html#withBs"><span class="hs-identifier hs-var hs-var">withBs</span></a></span></span><span> </span><span id="local-6989586621680956312"><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a3)
</span><a href="#local-6989586621680956312"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621680956311"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680956311"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(MarkCtx -&gt; MarkCtx) -&gt; m a -&gt; m a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">((MarkCtx -&gt; MarkCtx) -&gt; m a -&gt; m a)
-&gt; ((Scope -&gt; Scope) -&gt; MarkCtx -&gt; MarkCtx)
-&gt; (Scope -&gt; Scope)
-&gt; m a
-&gt; m a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter MarkCtx MarkCtx Scope Scope
-&gt; (Scope -&gt; Scope) -&gt; MarkCtx -&gt; MarkCtx
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-identifier hs-var">over</span></span><span> </span><span class="annot"><span class="annottext">ASetter MarkCtx MarkCtx Scope Scope
Lens' MarkCtx Scope
</span><a href="PlutusIR.Transform.LetFloat.html#markCtxScope"><span class="hs-identifier hs-var">markCtxScope</span></a></span><span> </span><span class="annot"><span class="annottext">((Scope -&gt; Scope) -&gt; m a -&gt; m a) -&gt; (Scope -&gt; Scope) -&gt; m a -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680956310"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621680956310"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-422"></span><span>    </span><span class="annot"><span class="annottext">[(Unique, Pos)] -&gt; Scope
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621680956308"><span class="hs-identifier hs-var">bid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621680956311"><span class="hs-identifier hs-var">pos</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621680956308"><span class="annot"><span class="annottext">Unique
</span><a href="#local-6989586621680956308"><span class="hs-identifier hs-var">bid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a3)
</span><a href="#local-6989586621680956312"><span class="hs-identifier hs-var">bs</span></a></span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a3)
-&gt; Getting
     (Endo [Unique]) (NonEmpty (Binding tyname name uni fun a3)) Unique
-&gt; [Unique]
forall s a. s -&gt; Getting (Endo [a]) s a -&gt; [a]
</span><span class="hs-operator hs-var">^..</span></span><span class="annot"><span class="annottext">(Binding tyname name uni fun a3
 -&gt; Const (Endo [Unique]) (Binding tyname name uni fun a3))
-&gt; NonEmpty (Binding tyname name uni fun a3)
-&gt; Const
     (Endo [Unique]) (NonEmpty (Binding tyname name uni fun a3))
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
</span><span class="hs-identifier hs-var">traversed</span></span><span class="annot"><span class="annottext">((Binding tyname name uni fun a3
  -&gt; Const (Endo [Unique]) (Binding tyname name uni fun a3))
 -&gt; NonEmpty (Binding tyname name uni fun a3)
 -&gt; Const
      (Endo [Unique]) (NonEmpty (Binding tyname name uni fun a3)))
-&gt; ((Unique -&gt; Const (Endo [Unique]) Unique)
    -&gt; Binding tyname name uni fun a3
    -&gt; Const (Endo [Unique]) (Binding tyname name uni fun a3))
-&gt; Getting
     (Endo [Unique]) (NonEmpty (Binding tyname name uni fun a3)) Unique
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span class="annot"><span class="annottext">(Unique -&gt; Const (Endo [Unique]) Unique)
-&gt; Binding tyname name uni fun a3
-&gt; Const (Endo [Unique]) (Binding tyname name uni fun a3)
forall tyname name (uni :: * -&gt; *) fun a.
(HasUnique tyname TypeUnique, HasUnique name TermUnique) =&gt;
Traversal1' (Binding tyname name uni fun a) Unique
</span><a href="PlutusIR.Core.Plated.html#bindingIds"><span class="hs-identifier hs-var">bindingIds</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Scope -&gt; Scope -&gt; Scope
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621680956310"><span class="hs-identifier hs-var">scope</span></a></span><span>
</span><span id="line-423"></span><span>
</span><span id="line-424"></span><span class="hs-comment">-- A helper to apply a function iff recursive</span><span>
</span><span id="line-425"></span><span id="local-6989586621680956882"><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#ifRec"><span class="hs-identifier hs-type">ifRec</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Recursivity"><span class="hs-identifier hs-type">Recursivity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680956882"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680956882"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680956882"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680956882"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-426"></span><span id="ifRec"><span class="annot"><span class="annottext">ifRec :: Recursivity -&gt; (a -&gt; a) -&gt; a -&gt; a
</span><a href="PlutusIR.Transform.LetFloat.html#ifRec"><span class="hs-identifier hs-var hs-var">ifRec</span></a></span></span><span> </span><span id="local-6989586621680956307"><span class="annot"><span class="annottext">Recursivity
</span><a href="#local-6989586621680956307"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621680956306"><span class="annot"><span class="annottext">a -&gt; a
</span><a href="#local-6989586621680956306"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621680956305"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956305"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><a href="#local-6989586621680956307"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-427"></span><span>    </span><span class="annot"><span class="annottext">Recursivity
</span><a href="PlutusIR.Core.Type.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; a
</span><a href="#local-6989586621680956306"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956305"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-428"></span><span>    </span><span class="annot"><span class="annottext">Recursivity
</span><a href="PlutusIR.Core.Type.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956305"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-429"></span><span>
</span><span id="line-430"></span><span id="local-6989586621680956887"><span id="local-6989586621680956888"><span id="local-6989586621680956889"><span id="local-6989586621680956891"><span id="local-6989586621680956892"><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#floatable"><span class="hs-identifier hs-type">floatable</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#ToBuiltinMeaning"><span class="hs-identifier hs-type">PLC.ToBuiltinMeaning</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956892"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956891"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#BindingGrp"><span class="hs-identifier hs-type">BindingGrp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956889"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956888"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956892"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956891"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956887"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span></span></span></span></span></span><span>
</span><span id="line-431"></span><span id="floatable"><span class="annot"><span class="annottext">floatable :: BindingGrp tyname name uni fun a -&gt; Bool
</span><a href="PlutusIR.Transform.LetFloat.html#floatable"><span class="hs-identifier hs-var hs-var">floatable</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#BindingGrp"><span class="hs-identifier hs-type">BindingGrp</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680956304"><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621680956304"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Binding tyname name uni fun a -&gt; Bool)
-&gt; NonEmpty (Binding tyname name uni fun a) -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">all</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun a -&gt; Bool
forall (uni :: * -&gt; *) fun tyname name a.
ToBuiltinMeaning uni fun =&gt;
Binding tyname name uni fun a -&gt; Bool
</span><a href="PlutusIR.Transform.LetFloat.html#hasNoEffects"><span class="hs-identifier hs-var">hasNoEffects</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621680956304"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-432"></span><span>
</span><span id="line-433"></span><span class="hs-comment">{-| Returns if a binding has absolutely no effects  (see Value.hs)
See Note [Purity, strictness, and variables]
An extreme alternative implementation is to treat *all strict* bindings as unfloatable, e.g.:
`hasNoEffects = \case {TermBind _ Strict _  _ -&gt; False; _ -&gt; True}`
-}</span><span>
</span><span id="line-438"></span><span id="local-6989586621680956657"><span id="local-6989586621680956658"><span id="local-6989586621680956659"><span id="local-6989586621680956660"><span id="local-6989586621680956661"><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#hasNoEffects"><span class="hs-identifier hs-type">hasNoEffects</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#ToBuiltinMeaning"><span class="hs-identifier hs-type">PLC.ToBuiltinMeaning</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956661"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956660"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956659"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956658"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956661"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956660"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956657"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span></span></span></span></span></span><span>
</span><span id="line-439"></span><span id="hasNoEffects"><span class="annot"><span class="annottext">hasNoEffects :: Binding tyname name uni fun a -&gt; Bool
</span><a href="PlutusIR.Transform.LetFloat.html#hasNoEffects"><span class="hs-identifier hs-var hs-var">hasNoEffects</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-440"></span><span>    </span><span class="annot"><a href="PlutusIR.Core.Type.html#TypeBind"><span class="hs-identifier hs-type">TypeBind</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-441"></span><span>    </span><span class="annot"><a href="PlutusIR.Core.Type.html#DatatypeBind"><span class="hs-identifier hs-type">DatatypeBind</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-442"></span><span>    </span><span class="annot"><a href="PlutusIR.Core.Type.html#TermBind"><span class="hs-identifier hs-type">TermBind</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Strictness
</span><a href="PlutusIR.Core.Type.html#NonStrict"><span class="hs-identifier hs-var">NonStrict</span></a></span><span> </span><span class="annot"><span class="annottext">VarDecl tyname name uni fun a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-443"></span><span>    </span><span class="hs-comment">-- have to check for purity</span><span>
</span><span id="line-444"></span><span>    </span><span class="hs-comment">-- TODO: We could maybe do better here, but not worth it at the moment</span><span>
</span><span id="line-445"></span><span>    </span><span class="annot"><a href="PlutusIR.Core.Type.html#TermBind"><span class="hs-identifier hs-type">TermBind</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Strictness
</span><a href="PlutusIR.Core.Type.html#Strict"><span class="hs-identifier hs-var">Strict</span></a></span><span> </span><span class="annot"><span class="annottext">VarDecl tyname name uni fun a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680956299"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956299"><span class="hs-identifier hs-var">t</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(name -&gt; Strictness) -&gt; Term tyname name uni fun a -&gt; Bool
forall (uni :: * -&gt; *) fun name tyname a.
ToBuiltinMeaning uni fun =&gt;
(name -&gt; Strictness) -&gt; Term tyname name uni fun a -&gt; Bool
</span><a href="PlutusIR.Purity.html#isPure"><span class="hs-identifier hs-var">isPure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Strictness -&gt; name -&gt; Strictness
forall a b. a -&gt; b -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Strictness
</span><a href="PlutusIR.Core.Type.html#NonStrict"><span class="hs-identifier hs-var">NonStrict</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956299"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-446"></span><span>
</span><span id="line-447"></span><span class="hs-comment">-- | Breaks down linear let nonrecs by</span><span>
</span><span id="line-448"></span><span class="hs-comment">-- the rule: {let nonrec (b:bs) in t} === {let nonrec b in let nonrec bs in t}</span><span>
</span><span id="line-449"></span><span id="local-6989586621680956920"><span id="local-6989586621680956921"><span id="local-6989586621680956922"><span id="local-6989586621680956923"><span id="local-6989586621680956924"><span class="annot"><a href="PlutusIR.Transform.LetFloat.html#breakNonRec"><span class="hs-identifier hs-type">breakNonRec</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956924"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956923"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956922"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956921"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956920"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956924"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956923"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956922"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956921"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956920"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span></span><span>
</span><span id="line-450"></span><span id="breakNonRec"><span class="annot"><span class="annottext">breakNonRec :: Term tyname name uni fun a -&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Transform.LetFloat.html#breakNonRec"><span class="hs-identifier hs-var hs-var">breakNonRec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-451"></span><span>    </span><span class="annot"><a href="PlutusIR.Core.Type.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621680956297"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956297"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><a href="PlutusIR.Core.Type.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
-&gt; (Binding tyname name uni fun a,
    Maybe (NonEmpty (Binding tyname name uni fun a)))
forall a. NonEmpty a -&gt; (a, Maybe (NonEmpty a))
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">NE.uncons</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680956295"><span class="annot"><span class="annottext">Binding tyname name uni fun a
</span><a href="#local-6989586621680956295"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621680956294"><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621680956294"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621680956293"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956293"><span class="hs-identifier hs-var">tIn</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-452"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
-&gt; Recursivity
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Recursivity
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956297"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><a href="PlutusIR.Core.Type.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Binding tyname name uni fun a
-&gt; NonEmpty (Binding tyname name uni fun a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun a
</span><a href="#local-6989586621680956295"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Term tyname name uni fun a -&gt; Term tyname name uni fun a)
-&gt; Term tyname name uni fun a -&gt; Term tyname name uni fun a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">a
-&gt; Recursivity
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Recursivity
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680956297"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><a href="PlutusIR.Core.Type.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621680956294"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956293"><span class="hs-identifier hs-var">tIn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-453"></span><span>    </span><span id="local-6989586621680956292"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956292"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680956292"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-454"></span><span>
</span><span id="line-455"></span><span class="hs-comment">{- Note [Floating rhs-nested lets]

A nested let inside a let-rhs that depends on that rhs is for example:

let rec parent = (let (rec|nonrec) child = parent in ...)  in ...
OR
let rec grandparent = (let rec parent = (let (rec|nonrec) child = grandparent in ...) in ...) in ...

If such a child is floatable and its calculated float marker (maximum position)
is another let's position (e.g. parent or grandparent),
we have to float right inside the let-rhs and not right inside the let-interm.
However we lost the information in which specific rhs from the group of rhse's)of the (grand)parent let-group,
the dependent let came from.

Squeezing with such a parent, unfloatable let means that the parent let *must* be recursive.
Since the child let is depending on the parent let --- uses some parent-introduced variable(s) ---,
it is implied that the parent was originally rec, to begin with; we do not touch the original recursivity of an unfloatable let.

Note about squeezing order:
(floatable&lt;&gt;unfloatable) VERSUS (unfloatable&lt;&gt;floatable) does not matter, because it does not change the meaning.

The end result is that no nested, floatable let will appear anymore inside another let's rhs at the algorithm's output,
(e.g. invalid output:  let x=1+(let y=3 in y) in ...)
*EXCEPT* if the nested let is intercepted by a lam/Lam anchor (depends on a lam/Lam that is located inside the parent-let's rhs)
e.g. valid output: let x= \z -&gt; (let y = 3+z in y) in ...
-}</span><span>
</span><span id="line-481"></span></pre></body></html>