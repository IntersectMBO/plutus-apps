<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span id="%24con2tag_7onHlZ5lg2sCewNOqkNjbq"></span><span class="hs-pragma">{-# LANGUAGE ConstraintKinds  #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE GADTs            #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase       #-}</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- | Functions for computing the dependency graph of variables within a term or type. A &quot;dependency&quot; between</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- two nodes &quot;A depends on B&quot; means that B cannot be removed from the program without also removing A.</span><span>
</span><span id="line-7"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">PlutusIR.Analysis.Dependencies</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#Node"><span class="hs-identifier">Node</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#DepGraph"><span class="hs-identifier">DepGraph</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#StrictnessMap"><span class="hs-identifier">StrictnessMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#runTermDeps"><span class="hs-identifier">runTermDeps</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#runTypeDeps"><span class="hs-identifier">runTypeDeps</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.html"><span class="hs-identifier">PlutusCore</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PLC</span></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.html"><span class="hs-identifier">PlutusCore.Builtin</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PLC</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Name.html"><span class="hs-identifier">PlutusCore.Name</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PLC</span></span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusIR.html"><span class="hs-identifier">PlutusIR</span></a></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusIR.Analysis.Usages.html"><span class="hs-identifier">PlutusIR.Analysis.Usages</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Usages</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusIR.Purity.html"><span class="hs-identifier">PlutusIR.Purity</span></a></span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Strict</span></span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State</span></span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Algebra.Graph.Class</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">G</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.List.NonEmpty</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NE</span></span><span>
</span><span id="line-26"></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Foldable</span></a></span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span class="hs-keyword">type</span><span> </span><span id="DepCtx"><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#DepCtx"><span class="hs-identifier hs-var">DepCtx</span></a></span></span><span> </span><span id="local-6989586621680959463"><span class="annot"><a href="#local-6989586621680959463"><span class="hs-identifier hs-type">term</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#Node"><span class="hs-identifier hs-type">Node</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">type</span><span> </span><span id="StrictnessMap"><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#StrictnessMap"><span class="hs-identifier hs-var">StrictnessMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map.Map</span></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#Unique"><span class="hs-identifier hs-type">PLC.Unique</span></a></span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Strictness"><span class="hs-identifier hs-type">Strictness</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">type</span><span> </span><span id="DepState"><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#DepState"><span class="hs-identifier hs-var">DepState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#StrictnessMap"><span class="hs-identifier hs-type">StrictnessMap</span></a></span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="hs-comment">-- | A node in a dependency graph. Either a specific 'PLC.Unique', or a specific</span><span>
</span><span id="line-34"></span><span class="hs-comment">-- node indicating the root of the graph. We need the root node because when computing the</span><span>
</span><span id="line-35"></span><span class="hs-comment">-- dependency graph of, say, a term, there will not be a binding for the term itself which</span><span>
</span><span id="line-36"></span><span class="hs-comment">-- we can use to represent it in the graph.</span><span>
</span><span id="line-37"></span><span class="hs-keyword">data</span><span> </span><span id="Node"><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#Node"><span class="hs-identifier hs-var">Node</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Variable"><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#Variable"><span class="hs-identifier hs-var">Variable</span></a></span></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#Unique"><span class="hs-identifier hs-type">PLC.Unique</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="Root"><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#Root"><span class="hs-identifier hs-var">Root</span></a></span></span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680959454"><span id="local-6989586621680959456"><span id="local-6989586621680959458"><span class="annot"><span class="annottext">Int -&gt; Node -&gt; ShowS
[Node] -&gt; ShowS
Node -&gt; String
(Int -&gt; Node -&gt; ShowS)
-&gt; (Node -&gt; String) -&gt; ([Node] -&gt; ShowS) -&gt; Show Node
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Node] -&gt; ShowS
$cshowList :: [Node] -&gt; ShowS
show :: Node -&gt; String
$cshow :: Node -&gt; String
showsPrec :: Int -&gt; Node -&gt; ShowS
$cshowsPrec :: Int -&gt; Node -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680959449"><span id="local-6989586621680959451"><span class="annot"><span class="annottext">Node -&gt; Node -&gt; Bool
(Node -&gt; Node -&gt; Bool) -&gt; (Node -&gt; Node -&gt; Bool) -&gt; Eq Node
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: Node -&gt; Node -&gt; Bool
$c/= :: Node -&gt; Node -&gt; Bool
== :: Node -&gt; Node -&gt; Bool
$c== :: Node -&gt; Node -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680959433"><span id="local-6989586621680959435"><span id="local-6989586621680959437"><span id="local-6989586621680959439"><span id="local-6989586621680959441"><span id="local-6989586621680959443"><span id="local-6989586621680959445"><span class="annot"><span class="annottext">Eq Node
Eq Node
-&gt; (Node -&gt; Node -&gt; Ordering)
-&gt; (Node -&gt; Node -&gt; Bool)
-&gt; (Node -&gt; Node -&gt; Bool)
-&gt; (Node -&gt; Node -&gt; Bool)
-&gt; (Node -&gt; Node -&gt; Bool)
-&gt; (Node -&gt; Node -&gt; Node)
-&gt; (Node -&gt; Node -&gt; Node)
-&gt; Ord Node
Node -&gt; Node -&gt; Bool
Node -&gt; Node -&gt; Ordering
Node -&gt; Node -&gt; Node
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
min :: Node -&gt; Node -&gt; Node
$cmin :: Node -&gt; Node -&gt; Node
max :: Node -&gt; Node -&gt; Node
$cmax :: Node -&gt; Node -&gt; Node
&gt;= :: Node -&gt; Node -&gt; Bool
$c&gt;= :: Node -&gt; Node -&gt; Bool
&gt; :: Node -&gt; Node -&gt; Bool
$c&gt; :: Node -&gt; Node -&gt; Bool
&lt;= :: Node -&gt; Node -&gt; Bool
$c&lt;= :: Node -&gt; Node -&gt; Bool
&lt; :: Node -&gt; Node -&gt; Bool
$c&lt; :: Node -&gt; Node -&gt; Bool
compare :: Node -&gt; Node -&gt; Ordering
$ccompare :: Node -&gt; Node -&gt; Ordering
$cp1Ord :: Eq Node
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></a></span></span></span></span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span class="hs-comment">-- | A constraint requiring @g@ to be a 'G.Graph' (so we can compute e.g. a @Relation@ from it), whose</span><span>
</span><span id="line-40"></span><span class="hs-comment">-- vertices are 'Node's.</span><span>
</span><span id="line-41"></span><span class="hs-keyword">type</span><span> </span><span id="DepGraph"><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#DepGraph"><span class="hs-identifier hs-var">DepGraph</span></a></span></span><span> </span><span id="local-6989586621680959431"><span class="annot"><a href="#local-6989586621680959431"><span class="hs-identifier hs-type">g</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">G.Graph</span></span><span> </span><span class="annot"><a href="#local-6989586621680959431"><span class="hs-identifier hs-type">g</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">G.Vertex</span></span><span> </span><span class="annot"><a href="#local-6989586621680959431"><span class="hs-identifier hs-type">g</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-type">~</span></a></span><span> </span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#Node"><span class="hs-identifier hs-type">Node</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span id="local-6989586621680959587"><span id="local-6989586621680959588"><span id="local-6989586621680959589"><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#varStrictnessFun"><span class="hs-identifier hs-type">varStrictnessFun</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-44"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#DepState"><span class="hs-identifier hs-type">DepState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959589"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959588"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959587"><span class="hs-identifier hs-type">u</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680959589"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680959588"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Strictness"><span class="hs-identifier hs-type">Strictness</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-46"></span><span id="varStrictnessFun"><span class="annot"><span class="annottext">varStrictnessFun :: m (name -&gt; Strictness)
</span><a href="PlutusIR.Analysis.Dependencies.html#varStrictnessFun"><span class="hs-identifier hs-var hs-var">varStrictnessFun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-47"></span><span>    </span><span id="local-6989586621680959429"><span class="annot"><span class="annottext">Map Unique Strictness
</span><a href="#local-6989586621680959429"><span class="hs-identifier hs-var">strictnessMap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Map Unique Strictness)
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-48"></span><span>    </span><span class="annot"><span class="annottext">(name -&gt; Strictness) -&gt; m (name -&gt; Strictness)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">((name -&gt; Strictness) -&gt; m (name -&gt; Strictness))
-&gt; (name -&gt; Strictness) -&gt; m (name -&gt; Strictness)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680959427"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680959427"><span class="hs-identifier hs-var">n'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Strictness -&gt; Unique -&gt; Map Unique Strictness -&gt; Strictness
forall k a. Ord k =&gt; a -&gt; k -&gt; Map k a -&gt; a
</span><span class="hs-identifier hs-var">Map.findWithDefault</span></span><span> </span><span class="annot"><span class="annottext">Strictness
</span><a href="PlutusIR.Core.Type.html#NonStrict"><span class="hs-identifier hs-var">NonStrict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680959427"><span class="hs-identifier hs-var">n'</span></a></span><span> </span><span class="annot"><span class="annottext">name -&gt; Getting Unique name Unique -&gt; Unique
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting Unique name Unique
forall name unique. HasUnique name unique =&gt; Lens' name Unique
</span><a href="PlutusCore.Name.html#theUnique"><span class="hs-identifier hs-var">PLC.theUnique</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Unique Strictness
</span><a href="#local-6989586621680959429"><span class="hs-identifier hs-var">strictnessMap</span></a></span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="hs-comment">-- | Compute the dependency graph of a 'Term'. The 'Root' node will correspond to the term itself.</span><span>
</span><span id="line-51"></span><span class="hs-comment">--</span><span>
</span><span id="line-52"></span><span class="hs-comment">-- For example, the graph of @[(let (nonrec) (vardecl x t) y) [x z]]@ is</span><span>
</span><span id="line-53"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-54"></span><span class="hs-comment">--     ROOT -&gt; x</span><span>
</span><span id="line-55"></span><span class="hs-comment">--     ROOT -&gt; z</span><span>
</span><span id="line-56"></span><span class="hs-comment">--     x -&gt; y</span><span>
</span><span id="line-57"></span><span class="hs-comment">--     x -&gt; t</span><span>
</span><span id="line-58"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-59"></span><span id="local-6989586621680959417"><span id="local-6989586621680959418"><span id="local-6989586621680959419"><span id="local-6989586621680959420"><span id="local-6989586621680959421"><span id="local-6989586621680959422"><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#runTermDeps"><span class="hs-identifier hs-type">runTermDeps</span></a></span><span>
</span><span id="line-60"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#DepGraph"><span class="hs-identifier hs-type">DepGraph</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959422"><span class="hs-identifier hs-type">g</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959421"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TypeUnique"><span class="hs-identifier hs-type">PLC.TypeUnique</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959420"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TermUnique"><span class="hs-identifier hs-type">PLC.TermUnique</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-61"></span><span>       </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#ToBuiltinMeaning"><span class="hs-identifier hs-type">PLC.ToBuiltinMeaning</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959419"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959418"><span class="hs-identifier hs-type">fun</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959421"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959420"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959419"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959418"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959417"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-63"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680959422"><span class="hs-identifier hs-type">g</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#StrictnessMap"><span class="hs-identifier hs-type">StrictnessMap</span></a></span><span class="hs-special">)</span></span></span></span></span></span></span><span>
</span><span id="line-64"></span><span id="runTermDeps"><span class="annot"><span class="annottext">runTermDeps :: Term tyname name uni fun a -&gt; (g, Map Unique Strictness)
</span><a href="PlutusIR.Analysis.Dependencies.html#runTermDeps"><span class="hs-identifier hs-var hs-var">runTermDeps</span></a></span></span><span> </span><span id="local-6989586621680959416"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680959416"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State (Map Unique Strictness) g
 -&gt; Map Unique Strictness -&gt; (g, Map Unique Strictness))
-&gt; Map Unique Strictness
-&gt; State (Map Unique Strictness) g
-&gt; (g, Map Unique Strictness)
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">State (Map Unique Strictness) g
-&gt; Map Unique Strictness -&gt; (g, Map Unique Strictness)
forall s a. State s a -&gt; s -&gt; (a, s)
</span><span class="hs-identifier hs-var">runState</span></span><span> </span><span class="annot"><span class="annottext">Map Unique Strictness
forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">(State (Map Unique Strictness) g -&gt; (g, Map Unique Strictness))
-&gt; State (Map Unique Strictness) g -&gt; (g, Map Unique Strictness)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT Node (StateT (Map Unique Strictness) Identity) g
 -&gt; Node -&gt; State (Map Unique Strictness) g)
-&gt; Node
-&gt; ReaderT Node (StateT (Map Unique Strictness) Identity) g
-&gt; State (Map Unique Strictness) g
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">ReaderT Node (StateT (Map Unique Strictness) Identity) g
-&gt; Node -&gt; State (Map Unique Strictness) g
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">Node
</span><a href="PlutusIR.Analysis.Dependencies.html#Root"><span class="hs-identifier hs-var">Root</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT Node (StateT (Map Unique Strictness) Identity) g
 -&gt; State (Map Unique Strictness) g)
-&gt; ReaderT Node (StateT (Map Unique Strictness) Identity) g
-&gt; State (Map Unique Strictness) g
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
-&gt; ReaderT Node (StateT (Map Unique Strictness) Identity) g
forall g term (m :: * -&gt; *) tyname name (uni :: * -&gt; *) fun a.
(DepGraph g, MonadReader Node m,
 MonadState (Map Unique Strictness) m, HasUnique tyname TypeUnique,
 HasUnique name TermUnique, ToBuiltinMeaning uni fun) =&gt;
Term tyname name uni fun a -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#termDeps"><span class="hs-identifier hs-var">termDeps</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680959416"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span class="hs-comment">-- | Compute the dependency graph of a 'Type'. The 'Root' node will correspond to the type itself.</span><span>
</span><span id="line-67"></span><span class="hs-comment">--</span><span>
</span><span id="line-68"></span><span class="hs-comment">-- This graph will always be simply a star from 'Root', since types have no internal let-bindings.</span><span>
</span><span id="line-69"></span><span class="hs-comment">--</span><span>
</span><span id="line-70"></span><span class="hs-comment">-- For example, the graph of @(all a (type) [f a])@ is:</span><span>
</span><span id="line-71"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-72"></span><span class="hs-comment">--     ROOT -&gt; f</span><span>
</span><span id="line-73"></span><span class="hs-comment">--     ROOT -&gt; a</span><span>
</span><span id="line-74"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-75"></span><span class="hs-comment">--</span><span>
</span><span id="line-76"></span><span id="local-6989586621680959408"><span id="local-6989586621680959409"><span id="local-6989586621680959410"><span id="local-6989586621680959411"><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#runTypeDeps"><span class="hs-identifier hs-type">runTypeDeps</span></a></span><span>
</span><span id="line-77"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#DepGraph"><span class="hs-identifier hs-type">DepGraph</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959411"><span class="hs-identifier hs-type">g</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959410"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TypeUnique"><span class="hs-identifier hs-type">PLC.TypeUnique</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Core.Type.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959410"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959409"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959408"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680959411"><span class="hs-identifier hs-type">g</span></a></span></span></span></span></span><span>
</span><span id="line-80"></span><span id="runTypeDeps"><span class="annot"><span class="annottext">runTypeDeps :: Type tyname uni a -&gt; g
</span><a href="PlutusIR.Analysis.Dependencies.html#runTypeDeps"><span class="hs-identifier hs-var hs-var">runTypeDeps</span></a></span></span><span> </span><span id="local-6989586621680959407"><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621680959407"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Reader Node g -&gt; Node -&gt; g) -&gt; Node -&gt; Reader Node g -&gt; g
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">Reader Node g -&gt; Node -&gt; g
forall r a. Reader r a -&gt; r -&gt; a
</span><span class="hs-identifier hs-var">runReader</span></span><span> </span><span class="annot"><span class="annottext">Node
</span><a href="PlutusIR.Analysis.Dependencies.html#Root"><span class="hs-identifier hs-var">Root</span></a></span><span> </span><span class="annot"><span class="annottext">(Reader Node g -&gt; g) -&gt; Reader Node g -&gt; g
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a -&gt; Reader Node g
forall g term (m :: * -&gt; *) tyname (uni :: * -&gt; *) a.
(DepGraph g, MonadReader Node m, HasUnique tyname TypeUnique) =&gt;
Type tyname uni a -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#typeDeps"><span class="hs-identifier hs-var">typeDeps</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621680959407"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span class="hs-comment">-- | Record some dependencies on the current node.</span><span>
</span><span id="line-83"></span><span id="local-6989586621680959579"><span id="local-6989586621680959580"><span id="local-6989586621680959581"><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#currentDependsOn"><span class="hs-identifier hs-type">currentDependsOn</span></a></span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#DepGraph"><span class="hs-identifier hs-type">DepGraph</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959581"><span class="hs-identifier hs-type">g</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#DepCtx"><span class="hs-identifier hs-type">DepCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959579"><span class="hs-identifier hs-type">term</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680959580"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="PlutusCore.Name.html#Unique"><span class="hs-identifier hs-type">PLC.Unique</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680959580"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959581"><span class="hs-identifier hs-type">g</span></a></span></span></span></span><span>
</span><span id="line-87"></span><span id="currentDependsOn"><span class="annot"><span class="annottext">currentDependsOn :: [Unique] -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#currentDependsOn"><span class="hs-identifier hs-var hs-var">currentDependsOn</span></a></span></span><span> </span><span id="local-6989586621680959403"><span class="annot"><span class="annottext">[Unique]
</span><a href="#local-6989586621680959403"><span class="hs-identifier hs-var">us</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-88"></span><span>    </span><span id="local-6989586621680959402"><span class="annot"><span class="annottext">Node
</span><a href="#local-6989586621680959402"><span class="hs-identifier hs-var">current</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Node
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-89"></span><span>    </span><span class="annot"><span class="annottext">g -&gt; m g
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(g -&gt; m g) -&gt; g -&gt; m g
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">g -&gt; g -&gt; g
forall g. Graph g =&gt; g -&gt; g -&gt; g
</span><span class="hs-identifier hs-var">G.connect</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Vertex g] -&gt; g
forall g. Graph g =&gt; [Vertex g] -&gt; g
</span><span class="hs-identifier hs-var">G.vertices</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Vertex g
Node
</span><a href="#local-6989586621680959402"><span class="hs-identifier hs-var">current</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Vertex g] -&gt; g
forall g. Graph g =&gt; [Vertex g] -&gt; g
</span><span class="hs-identifier hs-var">G.vertices</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Unique -&gt; Node) -&gt; [Unique] -&gt; [Node]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">Unique -&gt; Node
</span><a href="PlutusIR.Analysis.Dependencies.html#Variable"><span class="hs-identifier hs-var">Variable</span></a></span><span> </span><span class="annot"><span class="annottext">[Unique]
</span><a href="#local-6989586621680959403"><span class="hs-identifier hs-var">us</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="hs-comment">-- | Process the given action with the given name as the current node.</span><span>
</span><span id="line-92"></span><span id="local-6989586621680959590"><span id="local-6989586621680959591"><span id="local-6989586621680959592"><span id="local-6989586621680959593"><span id="local-6989586621680959594"><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#withCurrent"><span class="hs-identifier hs-type">withCurrent</span></a></span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#DepCtx"><span class="hs-identifier hs-type">DepCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959590"><span class="hs-identifier hs-type">term</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680959594"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959593"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959592"><span class="hs-identifier hs-type">u</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680959593"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680959594"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959591"><span class="hs-identifier hs-type">g</span></a></span><span>
</span><span id="line-96"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680959594"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959591"><span class="hs-identifier hs-type">g</span></a></span></span></span></span></span></span><span>
</span><span id="line-97"></span><span id="withCurrent"><span class="annot"><span class="annottext">withCurrent :: n -&gt; m g -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#withCurrent"><span class="hs-identifier hs-var hs-var">withCurrent</span></a></span></span><span> </span><span id="local-6989586621680959397"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621680959397"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Node -&gt; Node) -&gt; m g -&gt; m g
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">((Node -&gt; Node) -&gt; m g -&gt; m g) -&gt; (Node -&gt; Node) -&gt; m g -&gt; m g
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Node
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Unique -&gt; Node
</span><a href="PlutusIR.Analysis.Dependencies.html#Variable"><span class="hs-identifier hs-var">Variable</span></a></span><span> </span><span class="annot"><span class="annottext">(Unique -&gt; Node) -&gt; Unique -&gt; Node
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621680959397"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">n -&gt; Getting Unique n Unique -&gt; Unique
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting Unique n Unique
forall name unique. HasUnique name unique =&gt; Lens' name Unique
</span><a href="PlutusCore.Name.html#theUnique"><span class="hs-identifier hs-var">PLC.theUnique</span></a></span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span class="hs-comment">{- Note [Strict term bindings and dependencies]
A node inside a strict let binding can incur a dependency on it even if the defined variable is unused.

Consider:

let strict x = error in y

This evaluates to error, because the RHS of a strict binding is evaluated when we evaluate the let-term.

We only care about this for its *effects*: the variable itself is still unused. So we only need to
worry in the case where the RHS is not a value. If it *is* a value, then evaluating it is a noop, so there
can be no effects that we're missing. Essentially we are using &quot;is a value&quot; as an under-approximation of
&quot;is pure&quot;.

From the point of view of our algorithm, we handle the dependency by treating it as though there was an
reference to the newly bound variable alongside the binding, but only in the cases where it matters.
-}</span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span class="hs-comment">{- Note [Dependencies for datatype bindings, and pruning them]
At face value, all the names introduced by datatype bindings should depend on each other.
Given our meaning of &quot;A depends on B&quot;, since we cannot remove any part of the datatype binding without
removing the whole thing, they all depend on each other

However, there are some circumstances in which we *can* prune datatype bindings.

In particular, if the datatype is only used at the type-level (i.e. all the term-level parts
(constructors and destructor) are dead), then we are free to completely replace the binding
with one for a trivial type with the same kind.

This is because there are *no* term-level effects, and types are erased in the end, so
in this case rest of the datatype binding really is superfluous.

But how do we represent this in the dependency graph? We still need to have proper dependencies
so that we don't make the wrong decisions wrt transitively used values, e.g.

let U :: * = ...
let datatype T = T1 | T2 U
in T1

Here we need to not delete U, even though T2 is &quot;dead&quot;!

The solution is to focus on the meaning of &quot;dependency&quot;: with the pruning that we can do, we *can*
remove all the term level bits en masse, but only en-mass. So we need to make *them* into a clique,
so that this is visible to the dependency analysis.
-}</span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span id="local-6989586621680959497"><span id="local-6989586621680959498"><span id="local-6989586621680959499"><span id="local-6989586621680959500"><span id="local-6989586621680959501"><span id="local-6989586621680959502"><span id="local-6989586621680959503"><span id="local-6989586621680959504"><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#bindingDeps"><span class="hs-identifier hs-type">bindingDeps</span></a></span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#DepGraph"><span class="hs-identifier hs-type">DepGraph</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959504"><span class="hs-identifier hs-type">g</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#DepCtx"><span class="hs-identifier hs-type">DepCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959497"><span class="hs-identifier hs-type">term</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680959503"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#DepState"><span class="hs-identifier hs-type">DepState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959503"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959502"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TypeUnique"><span class="hs-identifier hs-type">PLC.TypeUnique</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959501"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TermUnique"><span class="hs-identifier hs-type">PLC.TermUnique</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-147"></span><span>       </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#ToBuiltinMeaning"><span class="hs-identifier hs-type">PLC.ToBuiltinMeaning</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959500"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959499"><span class="hs-identifier hs-type">fun</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959502"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959501"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959500"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959499"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959498"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-149"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680959503"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959504"><span class="hs-identifier hs-type">g</span></a></span></span></span></span></span></span></span></span></span><span>
</span><span id="line-150"></span><span id="bindingDeps"><span class="annot"><span class="annottext">bindingDeps :: Binding tyname name uni fun a -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#bindingDeps"><span class="hs-identifier hs-var hs-var">bindingDeps</span></a></span></span><span> </span><span id="local-6989586621680959394"><span class="annot"><span class="annottext">Binding tyname name uni fun a
</span><a href="#local-6989586621680959394"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun a
</span><a href="#local-6989586621680959394"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-151"></span><span>    </span><span class="annot"><a href="PlutusIR.Core.Type.html#TermBind"><span class="hs-identifier hs-type">TermBind</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680959392"><span class="annot"><span class="annottext">Strictness
</span><a href="#local-6989586621680959392"><span class="hs-identifier hs-var">strictness</span></a></span></span><span> </span><span id="local-6989586621680959391"><span class="annot"><span class="annottext">d :: VarDecl tyname name uni fun a
</span><a href="#local-6989586621680959391"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Core.Type.html#VarDecl"><span class="hs-identifier hs-type">VarDecl</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680959389"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680959389"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680959388"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680959388"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-152"></span><span>        </span><span id="local-6989586621680959387"><span class="annot"><span class="annottext">g
</span><a href="#local-6989586621680959387"><span class="hs-identifier hs-var">vDeps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VarDecl tyname name uni fun a -&gt; m g
forall g term (m :: * -&gt; *) tyname name (uni :: * -&gt; *) fun a.
(DepGraph g, MonadReader Node m, HasUnique tyname TypeUnique,
 HasUnique name TermUnique) =&gt;
VarDecl tyname name uni fun a -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#varDeclDeps"><span class="hs-identifier hs-var">varDeclDeps</span></a></span><span> </span><span class="annot"><span class="annottext">VarDecl tyname name uni fun a
</span><a href="#local-6989586621680959391"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-153"></span><span>        </span><span id="local-6989586621680959385"><span class="annot"><span class="annottext">g
</span><a href="#local-6989586621680959385"><span class="hs-identifier hs-var">tDeps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">name -&gt; m g -&gt; m g
forall term (m :: * -&gt; *) n u g.
(MonadReader Node m, HasUnique n u) =&gt;
n -&gt; m g -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#withCurrent"><span class="hs-identifier hs-var">withCurrent</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680959389"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">(m g -&gt; m g) -&gt; m g -&gt; m g
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; m g
forall g term (m :: * -&gt; *) tyname name (uni :: * -&gt; *) fun a.
(DepGraph g, MonadReader Node m,
 MonadState (Map Unique Strictness) m, HasUnique tyname TypeUnique,
 HasUnique name TermUnique, ToBuiltinMeaning uni fun) =&gt;
Term tyname name uni fun a -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#termDeps"><span class="hs-identifier hs-var">termDeps</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680959388"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span>        </span><span class="hs-comment">-- See Note [Strict term bindings and dependencies]</span><span>
</span><span id="line-156"></span><span>        </span><span id="local-6989586621680959384"><span class="annot"><span class="annottext">name -&gt; Strictness
</span><a href="#local-6989586621680959384"><span class="hs-identifier hs-var">strictnessFun</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (name -&gt; Strictness)
forall (m :: * -&gt; *) name u.
(MonadState (Map Unique Strictness) m, HasUnique name u) =&gt;
m (name -&gt; Strictness)
</span><a href="PlutusIR.Analysis.Dependencies.html#varStrictnessFun"><span class="hs-identifier hs-var">varStrictnessFun</span></a></span><span>
</span><span id="line-157"></span><span>        </span><span id="local-6989586621680959383"><span class="annot"><span class="annottext">g
</span><a href="#local-6989586621680959383"><span class="hs-identifier hs-var">evalDeps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Strictness
</span><a href="#local-6989586621680959392"><span class="hs-identifier hs-var">strictness</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-158"></span><span>            </span><span class="annot"><span class="annottext">Strictness
</span><a href="PlutusIR.Core.Type.html#Strict"><span class="hs-identifier hs-var">Strict</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(name -&gt; Strictness) -&gt; Term tyname name uni fun a -&gt; Bool
forall (uni :: * -&gt; *) fun name tyname a.
ToBuiltinMeaning uni fun =&gt;
(name -&gt; Strictness) -&gt; Term tyname name uni fun a -&gt; Bool
</span><a href="PlutusIR.Purity.html#isPure"><span class="hs-identifier hs-var">isPure</span></a></span><span> </span><span class="annot"><span class="annottext">name -&gt; Strictness
</span><a href="#local-6989586621680959384"><span class="hs-identifier hs-var">strictnessFun</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680959388"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Unique] -&gt; m g
forall g term (m :: * -&gt; *).
(DepGraph g, MonadReader Node m) =&gt;
[Unique] -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#currentDependsOn"><span class="hs-identifier hs-var">currentDependsOn</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680959389"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">name -&gt; Getting Unique name Unique -&gt; Unique
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting Unique name Unique
forall name unique. HasUnique name unique =&gt; Lens' name Unique
</span><a href="PlutusCore.Name.html#theUnique"><span class="hs-identifier hs-var">PLC.theUnique</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-159"></span><span>            </span><span class="annot"><span class="annottext">Strictness
</span><span class="hs-identifier">_</span></span><span>                                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">g -&gt; m g
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">g
forall g. Graph g =&gt; g
</span><span class="hs-identifier hs-var">G.empty</span></span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span>        </span><span class="annot"><span class="annottext">g -&gt; m g
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(g -&gt; m g) -&gt; g -&gt; m g
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[g] -&gt; g
forall g. Graph g =&gt; [g] -&gt; g
</span><span class="hs-identifier hs-var">G.overlays</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">g
</span><a href="#local-6989586621680959387"><span class="hs-identifier hs-var">vDeps</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">g
</span><a href="#local-6989586621680959385"><span class="hs-identifier hs-var">tDeps</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">g
</span><a href="#local-6989586621680959383"><span class="hs-identifier hs-var">evalDeps</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-162"></span><span>    </span><span class="annot"><a href="PlutusIR.Core.Type.html#TypeBind"><span class="hs-identifier hs-type">TypeBind</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680959376"><span class="annot"><span class="annottext">d :: TyVarDecl tyname a
</span><a href="#local-6989586621680959376"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Core.Type.html#TyVarDecl"><span class="hs-identifier hs-type">TyVarDecl</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680959374"><span class="annot"><span class="annottext">tyname
</span><a href="#local-6989586621680959374"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="annottext">Kind a
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680959373"><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621680959373"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-163"></span><span>        </span><span id="local-6989586621680959372"><span class="annot"><span class="annottext">g
</span><a href="#local-6989586621680959372"><span class="hs-identifier hs-var">vDeps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyVarDecl tyname a -&gt; m g
forall g term (m :: * -&gt; *) tyname a.
(Graph g, MonadReader Node m) =&gt;
TyVarDecl tyname a -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#tyVarDeclDeps"><span class="hs-identifier hs-var">tyVarDeclDeps</span></a></span><span> </span><span class="annot"><span class="annottext">TyVarDecl tyname a
</span><a href="#local-6989586621680959376"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-164"></span><span>        </span><span id="local-6989586621680959370"><span class="annot"><span class="annottext">g
</span><a href="#local-6989586621680959370"><span class="hs-identifier hs-var">tDeps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">tyname -&gt; m g -&gt; m g
forall term (m :: * -&gt; *) n u g.
(MonadReader Node m, HasUnique n u) =&gt;
n -&gt; m g -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#withCurrent"><span class="hs-identifier hs-var">withCurrent</span></a></span><span> </span><span class="annot"><span class="annottext">tyname
</span><a href="#local-6989586621680959374"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">(m g -&gt; m g) -&gt; m g -&gt; m g
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a -&gt; m g
forall g term (m :: * -&gt; *) tyname (uni :: * -&gt; *) a.
(DepGraph g, MonadReader Node m, HasUnique tyname TypeUnique) =&gt;
Type tyname uni a -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#typeDeps"><span class="hs-identifier hs-var">typeDeps</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621680959373"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-165"></span><span>        </span><span class="annot"><span class="annottext">g -&gt; m g
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(g -&gt; m g) -&gt; g -&gt; m g
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">g -&gt; g -&gt; g
forall g. Graph g =&gt; g -&gt; g -&gt; g
</span><span class="hs-identifier hs-var">G.overlay</span></span><span> </span><span class="annot"><span class="annottext">g
</span><a href="#local-6989586621680959372"><span class="hs-identifier hs-var">vDeps</span></a></span><span> </span><span class="annot"><span class="annottext">g
</span><a href="#local-6989586621680959370"><span class="hs-identifier hs-var">tDeps</span></a></span><span>
</span><span id="line-166"></span><span>    </span><span class="annot"><a href="PlutusIR.Core.Type.html#DatatypeBind"><span class="hs-identifier hs-type">DatatypeBind</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#Datatype"><span class="hs-identifier hs-type">Datatype</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680959366"><span class="annot"><span class="annottext">TyVarDecl tyname a
</span><a href="#local-6989586621680959366"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621680959365"><span class="annot"><span class="annottext">[TyVarDecl tyname a]
</span><a href="#local-6989586621680959365"><span class="hs-identifier hs-var">tvs</span></a></span></span><span> </span><span id="local-6989586621680959364"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680959364"><span class="hs-identifier hs-var">destr</span></a></span></span><span> </span><span id="local-6989586621680959363"><span class="annot"><span class="annottext">[VarDecl tyname name uni fun a]
</span><a href="#local-6989586621680959363"><span class="hs-identifier hs-var">constrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-167"></span><span>        </span><span class="hs-comment">-- See Note [Dependencies for datatype bindings, and pruning them]</span><span>
</span><span id="line-168"></span><span>        </span><span id="local-6989586621680959362"><span class="annot"><span class="annottext">g
</span><a href="#local-6989586621680959362"><span class="hs-identifier hs-var">vDeps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TyVarDecl tyname a -&gt; m g
forall g term (m :: * -&gt; *) tyname a.
(Graph g, MonadReader Node m) =&gt;
TyVarDecl tyname a -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#tyVarDeclDeps"><span class="hs-identifier hs-var">tyVarDeclDeps</span></a></span><span> </span><span class="annot"><span class="annottext">TyVarDecl tyname a
</span><a href="#local-6989586621680959366"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-169"></span><span>        </span><span id="local-6989586621680959361"><span class="annot"><span class="annottext">[g]
</span><a href="#local-6989586621680959361"><span class="hs-identifier hs-var">tvDeps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TyVarDecl tyname a -&gt; m g) -&gt; [TyVarDecl tyname a] -&gt; m [g]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="annot"><span class="annottext">TyVarDecl tyname a -&gt; m g
forall g term (m :: * -&gt; *) tyname a.
(Graph g, MonadReader Node m) =&gt;
TyVarDecl tyname a -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#tyVarDeclDeps"><span class="hs-identifier hs-var">tyVarDeclDeps</span></a></span><span> </span><span class="annot"><span class="annottext">[TyVarDecl tyname a]
</span><a href="#local-6989586621680959365"><span class="hs-identifier hs-var">tvs</span></a></span><span>
</span><span id="line-170"></span><span>        </span><span id="local-6989586621680959359"><span class="annot"><span class="annottext">[g]
</span><a href="#local-6989586621680959359"><span class="hs-identifier hs-var">cstrDeps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(VarDecl tyname name uni fun a -&gt; m g)
-&gt; [VarDecl tyname name uni fun a] -&gt; m [g]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="annot"><span class="annottext">VarDecl tyname name uni fun a -&gt; m g
forall g term (m :: * -&gt; *) tyname name (uni :: * -&gt; *) fun a.
(DepGraph g, MonadReader Node m, HasUnique tyname TypeUnique,
 HasUnique name TermUnique) =&gt;
VarDecl tyname name uni fun a -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#varDeclDeps"><span class="hs-identifier hs-var">varDeclDeps</span></a></span><span> </span><span class="annot"><span class="annottext">[VarDecl tyname name uni fun a]
</span><a href="#local-6989586621680959363"><span class="hs-identifier hs-var">constrs</span></a></span><span>
</span><span id="line-171"></span><span>        </span><span class="hs-comment">-- Destructors depend on the datatype and the argument types of all the constructors, because e.g. a destructor for Maybe looks like:</span><span>
</span><span id="line-172"></span><span>        </span><span class="hs-comment">-- forall a . Maybe a -&gt; (a -&gt; r) -&gt; r -&gt; r</span><span>
</span><span id="line-173"></span><span>        </span><span class="hs-comment">-- i.e. the argument type of the Just constructor appears as the argument to the branch.</span><span>
</span><span id="line-174"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-175"></span><span>        </span><span class="hs-comment">-- We can get the effect of that by having it depend on all the constructor types (which also include the datatype).</span><span>
</span><span id="line-176"></span><span>        </span><span class="hs-comment">-- This is more diligent than currently necessary since we're going to make all the term-level</span><span>
</span><span id="line-177"></span><span>        </span><span class="hs-comment">-- parts depend on each other later, but it's good practice and will be useful if we ever stop doing that.</span><span>
</span><span id="line-178"></span><span>        </span><span id="local-6989586621680959358"><span class="annot"><span class="annottext">g
</span><a href="#local-6989586621680959358"><span class="hs-identifier hs-var">destrDeps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[g] -&gt; g
forall g. Graph g =&gt; [g] -&gt; g
</span><span class="hs-identifier hs-var">G.overlays</span></span><span> </span><span class="annot"><span class="annottext">([g] -&gt; g) -&gt; m [g] -&gt; m g
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">name -&gt; m [g] -&gt; m [g]
forall term (m :: * -&gt; *) n u g.
(MonadReader Node m, HasUnique n u) =&gt;
n -&gt; m g -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#withCurrent"><span class="hs-identifier hs-var">withCurrent</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680959364"><span class="hs-identifier hs-var">destr</span></a></span><span> </span><span class="annot"><span class="annottext">(m [g] -&gt; m [g]) -&gt; m [g] -&gt; m [g]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(VarDecl tyname name uni fun a -&gt; m g)
-&gt; [VarDecl tyname name uni fun a] -&gt; m [g]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type tyname uni a -&gt; m g
forall g term (m :: * -&gt; *) tyname (uni :: * -&gt; *) a.
(DepGraph g, MonadReader Node m, HasUnique tyname TypeUnique) =&gt;
Type tyname uni a -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#typeDeps"><span class="hs-identifier hs-var">typeDeps</span></a></span><span> </span><span class="annot"><span class="annottext">(Type tyname uni a -&gt; m g)
-&gt; (VarDecl tyname name uni fun a -&gt; Type tyname uni a)
-&gt; VarDecl tyname name uni fun a
-&gt; m g
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">VarDecl tyname name uni fun a -&gt; Type tyname uni a
forall tyname name (uni :: * -&gt; *) k (fun :: k) ann.
VarDecl tyname name uni fun ann -&gt; Type tyname uni ann
</span><a href="PlutusCore.Core.Type.html#_varDeclType"><span class="hs-identifier hs-var hs-var">_varDeclType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VarDecl tyname name uni fun a]
</span><a href="#local-6989586621680959363"><span class="hs-identifier hs-var">constrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-179"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680959354"><span class="annot"><span class="annottext">tus :: [Unique]
</span><a href="#local-6989586621680959354"><span class="hs-identifier hs-var hs-var">tus</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(name -&gt; Unique) -&gt; [name] -&gt; [Unique]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Getting Unique name Unique -&gt; name -&gt; Unique
forall s (m :: * -&gt; *) a. MonadReader s m =&gt; Getting a s a -&gt; m a
</span><span class="hs-identifier hs-var">view</span></span><span> </span><span class="annot"><span class="annottext">Getting Unique name Unique
forall name unique. HasUnique name unique =&gt; Lens' name Unique
</span><a href="PlutusCore.Name.html#theUnique"><span class="hs-identifier hs-var">PLC.theUnique</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680959364"><span class="hs-identifier hs-var">destr</span></a></span><span> </span><span class="annot"><span class="annottext">name -&gt; [name] -&gt; [name]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">(VarDecl tyname name uni fun a -&gt; name)
-&gt; [VarDecl tyname name uni fun a] -&gt; [name]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">VarDecl tyname name uni fun a -&gt; name
forall tyname name (uni :: * -&gt; *) k (fun :: k) ann.
VarDecl tyname name uni fun ann -&gt; name
</span><a href="PlutusCore.Core.Type.html#_varDeclName"><span class="hs-identifier hs-var hs-var">_varDeclName</span></a></span><span> </span><span class="annot"><span class="annottext">[VarDecl tyname name uni fun a]
</span><a href="#local-6989586621680959363"><span class="hs-identifier hs-var">constrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>        </span><span class="hs-comment">-- See Note [Dependencies for datatype bindings, and pruning them]</span><span>
</span><span id="line-181"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680959351"><span class="annot"><span class="annottext">nonDatatypeClique :: g
</span><a href="#local-6989586621680959351"><span class="hs-identifier hs-var hs-var">nonDatatypeClique</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Vertex g] -&gt; g
forall g. Graph g =&gt; [Vertex g] -&gt; g
</span><span class="hs-identifier hs-var">G.clique</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Unique -&gt; Node) -&gt; [Unique] -&gt; [Node]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">Unique -&gt; Node
</span><a href="PlutusIR.Analysis.Dependencies.html#Variable"><span class="hs-identifier hs-var">Variable</span></a></span><span> </span><span class="annot"><span class="annottext">[Unique]
</span><a href="#local-6989586621680959354"><span class="hs-identifier hs-var">tus</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span>        </span><span class="annot"><span class="annottext">g -&gt; m g
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(g -&gt; m g) -&gt; g -&gt; m g
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[g] -&gt; g
forall g. Graph g =&gt; [g] -&gt; g
</span><span class="hs-identifier hs-var">G.overlays</span></span><span> </span><span class="annot"><span class="annottext">([g] -&gt; g) -&gt; [g] -&gt; g
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">g
</span><a href="#local-6989586621680959362"><span class="hs-identifier hs-var">vDeps</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[g] -&gt; [g] -&gt; [g]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[g]
</span><a href="#local-6989586621680959361"><span class="hs-identifier hs-var">tvDeps</span></a></span><span> </span><span class="annot"><span class="annottext">[g] -&gt; [g] -&gt; [g]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[g]
</span><a href="#local-6989586621680959359"><span class="hs-identifier hs-var">cstrDeps</span></a></span><span> </span><span class="annot"><span class="annottext">[g] -&gt; [g] -&gt; [g]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">g
</span><a href="#local-6989586621680959358"><span class="hs-identifier hs-var">destrDeps</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[g] -&gt; [g] -&gt; [g]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">g
</span><a href="#local-6989586621680959351"><span class="hs-identifier hs-var">nonDatatypeClique</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-183"></span><span>
</span><span id="line-184"></span><span id="local-6989586621680959505"><span id="local-6989586621680959506"><span id="local-6989586621680959507"><span id="local-6989586621680959508"><span id="local-6989586621680959509"><span id="local-6989586621680959510"><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#bindingStrictness"><span class="hs-identifier hs-type">bindingStrictness</span></a></span><span>
</span><span id="line-185"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#DepState"><span class="hs-identifier hs-type">DepState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959510"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959509"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TermUnique"><span class="hs-identifier hs-type">PLC.TermUnique</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959508"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959509"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959507"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959506"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959505"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-187"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680959510"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span></span></span></span><span>
</span><span id="line-188"></span><span id="bindingStrictness"><span class="annot"><span class="annottext">bindingStrictness :: Binding tyname name uni fun a -&gt; m ()
</span><a href="PlutusIR.Analysis.Dependencies.html#bindingStrictness"><span class="hs-identifier hs-var hs-var">bindingStrictness</span></a></span></span><span> </span><span id="local-6989586621680959348"><span class="annot"><span class="annottext">Binding tyname name uni fun a
</span><a href="#local-6989586621680959348"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun a
</span><a href="#local-6989586621680959348"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-189"></span><span>    </span><span class="annot"><a href="PlutusIR.Core.Type.html#TermBind"><span class="hs-identifier hs-type">TermBind</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680959347"><span class="annot"><span class="annottext">Strictness
</span><a href="#local-6989586621680959347"><span class="hs-identifier hs-var">strictness</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Core.Type.html#VarDecl"><span class="hs-identifier hs-type">VarDecl</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680959346"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680959346"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Map Unique Strictness -&gt; Map Unique Strictness) -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unique
-&gt; Strictness -&gt; Map Unique Strictness -&gt; Map Unique Strictness
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680959346"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">name -&gt; Getting Unique name Unique -&gt; Unique
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting Unique name Unique
forall name unique. HasUnique name unique =&gt; Lens' name Unique
</span><a href="PlutusCore.Name.html#theUnique"><span class="hs-identifier hs-var">PLC.theUnique</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Strictness
</span><a href="#local-6989586621680959347"><span class="hs-identifier hs-var">strictness</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>    </span><span class="annot"><a href="PlutusIR.Core.Type.html#TypeBind"><span class="hs-identifier hs-type">TypeBind</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>    </span><span class="annot"><a href="PlutusIR.Core.Type.html#DatatypeBind"><span class="hs-identifier hs-type">DatatypeBind</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#Datatype"><span class="hs-identifier hs-type">Datatype</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TyVarDecl tyname a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[TyVarDecl tyname a]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680959343"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680959343"><span class="hs-identifier hs-var">destr</span></a></span></span><span> </span><span id="local-6989586621680959342"><span class="annot"><span class="annottext">[VarDecl tyname name uni fun a]
</span><a href="#local-6989586621680959342"><span class="hs-identifier hs-var">constrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-192"></span><span>        </span><span class="hs-comment">-- Constructors and destructor are bound strictly</span><span>
</span><span id="line-193"></span><span>        </span><span class="annot"><span class="annottext">[VarDecl tyname name uni fun a]
-&gt; (VarDecl tyname name uni fun a -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">for_</span></a></span><span> </span><span class="annot"><span class="annottext">[VarDecl tyname name uni fun a]
</span><a href="#local-6989586621680959342"><span class="hs-identifier hs-var">constrs</span></a></span><span> </span><span class="annot"><span class="annottext">((VarDecl tyname name uni fun a -&gt; m ()) -&gt; m ())
-&gt; (VarDecl tyname name uni fun a -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Core.Type.html#VarDecl"><span class="hs-identifier hs-type">VarDecl</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680959340"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680959340"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Map Unique Strictness -&gt; Map Unique Strictness) -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unique
-&gt; Strictness -&gt; Map Unique Strictness -&gt; Map Unique Strictness
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680959340"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">name -&gt; Getting Unique name Unique -&gt; Unique
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting Unique name Unique
forall name unique. HasUnique name unique =&gt; Lens' name Unique
</span><a href="PlutusCore.Name.html#theUnique"><span class="hs-identifier hs-var">PLC.theUnique</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Strictness
</span><a href="PlutusIR.Core.Type.html#Strict"><span class="hs-identifier hs-var">Strict</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span>        </span><span class="annot"><span class="annottext">(Map Unique Strictness -&gt; Map Unique Strictness) -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unique
-&gt; Strictness -&gt; Map Unique Strictness -&gt; Map Unique Strictness
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680959343"><span class="hs-identifier hs-var">destr</span></a></span><span> </span><span class="annot"><span class="annottext">name -&gt; Getting Unique name Unique -&gt; Unique
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting Unique name Unique
forall name unique. HasUnique name unique =&gt; Lens' name Unique
</span><a href="PlutusCore.Name.html#theUnique"><span class="hs-identifier hs-var">PLC.theUnique</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Strictness
</span><a href="PlutusIR.Core.Type.html#Strict"><span class="hs-identifier hs-var">Strict</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span>
</span><span id="line-196"></span><span id="local-6989586621680959595"><span id="local-6989586621680959596"><span id="local-6989586621680959597"><span id="local-6989586621680959598"><span id="local-6989586621680959599"><span id="local-6989586621680959600"><span id="local-6989586621680959601"><span id="local-6989586621680959602"><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#varDeclDeps"><span class="hs-identifier hs-type">varDeclDeps</span></a></span><span>
</span><span id="line-197"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#DepGraph"><span class="hs-identifier hs-type">DepGraph</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959602"><span class="hs-identifier hs-type">g</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#DepCtx"><span class="hs-identifier hs-type">DepCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959595"><span class="hs-identifier hs-type">term</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680959601"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959600"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TypeUnique"><span class="hs-identifier hs-type">PLC.TypeUnique</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959599"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TermUnique"><span class="hs-identifier hs-type">PLC.TermUnique</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-198"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Core.Type.html#VarDecl"><span class="hs-identifier hs-type">VarDecl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959600"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959599"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959598"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959597"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959596"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-199"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680959601"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959602"><span class="hs-identifier hs-type">g</span></a></span></span></span></span></span></span></span></span></span><span>
</span><span id="line-200"></span><span id="varDeclDeps"><span class="annot"><span class="annottext">varDeclDeps :: VarDecl tyname name uni fun a -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#varDeclDeps"><span class="hs-identifier hs-var hs-var">varDeclDeps</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Core.Type.html#VarDecl"><span class="hs-identifier hs-type">VarDecl</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680959339"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680959339"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621680959338"><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621680959338"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">name -&gt; m g -&gt; m g
forall term (m :: * -&gt; *) n u g.
(MonadReader Node m, HasUnique n u) =&gt;
n -&gt; m g -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#withCurrent"><span class="hs-identifier hs-var">withCurrent</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680959339"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">(m g -&gt; m g) -&gt; m g -&gt; m g
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a -&gt; m g
forall g term (m :: * -&gt; *) tyname (uni :: * -&gt; *) a.
(DepGraph g, MonadReader Node m, HasUnique tyname TypeUnique) =&gt;
Type tyname uni a -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#typeDeps"><span class="hs-identifier hs-var">typeDeps</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621680959338"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span class="hs-comment">-- Here for completeness, but doesn't do much</span><span>
</span><span id="line-203"></span><span id="local-6989586621680959571"><span id="local-6989586621680959572"><span id="local-6989586621680959573"><span id="local-6989586621680959574"><span id="local-6989586621680959575"><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#tyVarDeclDeps"><span class="hs-identifier hs-type">tyVarDeclDeps</span></a></span><span>
</span><span id="line-204"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">G.Graph</span></span><span> </span><span class="annot"><a href="#local-6989586621680959575"><span class="hs-identifier hs-type">g</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#DepCtx"><span class="hs-identifier hs-type">DepCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959571"><span class="hs-identifier hs-type">term</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680959574"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-205"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Core.Type.html#TyVarDecl"><span class="hs-identifier hs-type">TyVarDecl</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959573"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959572"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-206"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680959574"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959575"><span class="hs-identifier hs-type">g</span></a></span></span></span></span></span></span><span>
</span><span id="line-207"></span><span id="tyVarDeclDeps"><span class="annot"><span class="annottext">tyVarDeclDeps :: TyVarDecl tyname a -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#tyVarDeclDeps"><span class="hs-identifier hs-var hs-var">tyVarDeclDeps</span></a></span></span><span> </span><span class="annot"><span class="annottext">TyVarDecl tyname a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">g -&gt; m g
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">g
forall g. Graph g =&gt; g
</span><span class="hs-identifier hs-var">G.empty</span></span><span>
</span><span id="line-208"></span><span>
</span><span id="line-209"></span><span class="hs-comment">-- | Compute the dependency graph of a term. Takes an initial 'Node' indicating what the term itself depends on</span><span>
</span><span id="line-210"></span><span class="hs-comment">-- (usually 'Root' if it is the real term you are interested in).</span><span>
</span><span id="line-211"></span><span id="local-6989586621680959641"><span id="local-6989586621680959642"><span id="local-6989586621680959644"><span id="local-6989586621680959645"><span id="local-6989586621680959647"><span id="local-6989586621680959649"><span id="local-6989586621680959651"><span id="local-6989586621680959653"><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#termDeps"><span class="hs-identifier hs-type">termDeps</span></a></span><span>
</span><span id="line-212"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#DepGraph"><span class="hs-identifier hs-type">DepGraph</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959653"><span class="hs-identifier hs-type">g</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#DepCtx"><span class="hs-identifier hs-type">DepCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959641"><span class="hs-identifier hs-type">term</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680959651"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#DepState"><span class="hs-identifier hs-type">DepState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959651"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959649"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TypeUnique"><span class="hs-identifier hs-type">PLC.TypeUnique</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959647"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TermUnique"><span class="hs-identifier hs-type">PLC.TermUnique</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-213"></span><span>       </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#ToBuiltinMeaning"><span class="hs-identifier hs-type">PLC.ToBuiltinMeaning</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959645"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959644"><span class="hs-identifier hs-type">fun</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959649"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959647"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959645"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959644"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959642"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-215"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680959651"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959653"><span class="hs-identifier hs-type">g</span></a></span></span></span></span></span></span></span></span></span><span>
</span><span id="line-216"></span><span id="termDeps"><span class="annot"><span class="annottext">termDeps :: Term tyname name uni fun a -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#termDeps"><span class="hs-identifier hs-var hs-var">termDeps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-217"></span><span>    </span><span class="annot"><a href="PlutusIR.Core.Type.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680959336"><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621680959336"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621680959335"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680959335"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-218"></span><span>        </span><span class="hs-comment">-- Need to do this before processing the RHSs of the bindings, as recursive bindings may need to know about</span><span>
</span><span id="line-219"></span><span>        </span><span class="hs-comment">-- the strictnesses of other variables.</span><span>
</span><span id="line-220"></span><span>        </span><span class="annot"><span class="annottext">(Binding tyname name uni fun a -&gt; m ())
-&gt; NonEmpty (Binding tyname name uni fun a) -&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse_</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun a -&gt; m ()
forall (m :: * -&gt; *) name tyname (uni :: * -&gt; *) fun a.
(MonadState (Map Unique Strictness) m,
 HasUnique name TermUnique) =&gt;
Binding tyname name uni fun a -&gt; m ()
</span><a href="PlutusIR.Analysis.Dependencies.html#bindingStrictness"><span class="hs-identifier hs-var">bindingStrictness</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621680959336"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-221"></span><span>        </span><span id="local-6989586621680959333"><span class="annot"><span class="annottext">NonEmpty g
</span><a href="#local-6989586621680959333"><span class="hs-identifier hs-var">bGraphs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Binding tyname name uni fun a -&gt; m g)
-&gt; NonEmpty (Binding tyname name uni fun a) -&gt; m (NonEmpty g)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun a -&gt; m g
forall g term (m :: * -&gt; *) tyname name (uni :: * -&gt; *) fun a.
(DepGraph g, MonadReader Node m,
 MonadState (Map Unique Strictness) m, HasUnique tyname TypeUnique,
 HasUnique name TermUnique, ToBuiltinMeaning uni fun) =&gt;
Binding tyname name uni fun a -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#bindingDeps"><span class="hs-identifier hs-var">bindingDeps</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621680959336"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-222"></span><span>        </span><span id="local-6989586621680959332"><span class="annot"><span class="annottext">g
</span><a href="#local-6989586621680959332"><span class="hs-identifier hs-var">bodyGraph</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; m g
forall g term (m :: * -&gt; *) tyname name (uni :: * -&gt; *) fun a.
(DepGraph g, MonadReader Node m,
 MonadState (Map Unique Strictness) m, HasUnique tyname TypeUnique,
 HasUnique name TermUnique, ToBuiltinMeaning uni fun) =&gt;
Term tyname name uni fun a -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#termDeps"><span class="hs-identifier hs-var">termDeps</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680959335"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-223"></span><span>        </span><span class="annot"><span class="annottext">g -&gt; m g
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(g -&gt; m g) -&gt; (NonEmpty g -&gt; g) -&gt; NonEmpty g -&gt; m g
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[g] -&gt; g
forall g. Graph g =&gt; [g] -&gt; g
</span><span class="hs-identifier hs-var">G.overlays</span></span><span> </span><span class="annot"><span class="annottext">([g] -&gt; g) -&gt; (NonEmpty g -&gt; [g]) -&gt; NonEmpty g -&gt; g
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty g -&gt; [g]
forall a. NonEmpty a -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">NE.toList</span></a></span><span> </span><span class="annot"><span class="annottext">(NonEmpty g -&gt; m g) -&gt; NonEmpty g -&gt; m g
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">g
</span><a href="#local-6989586621680959332"><span class="hs-identifier hs-var">bodyGraph</span></a></span><span> </span><span class="annot"><span class="annottext">g -&gt; NonEmpty g -&gt; NonEmpty g
forall a. a -&gt; NonEmpty a -&gt; NonEmpty a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">NE.&lt;|</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty g
</span><a href="#local-6989586621680959333"><span class="hs-identifier hs-var">bGraphs</span></a></span><span>
</span><span id="line-224"></span><span>    </span><span class="annot"><a href="PlutusIR.Core.Type.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680959328"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680959328"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Unique] -&gt; m g
forall g term (m :: * -&gt; *).
(DepGraph g, MonadReader Node m) =&gt;
[Unique] -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#currentDependsOn"><span class="hs-identifier hs-var">currentDependsOn</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680959328"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">name -&gt; Getting Unique name Unique -&gt; Unique
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting Unique name Unique
forall name unique. HasUnique name unique =&gt; Lens' name Unique
</span><a href="PlutusCore.Name.html#theUnique"><span class="hs-identifier hs-var">PLC.theUnique</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-225"></span><span>    </span><span class="annot"><a href="PlutusIR.Core.Type.html#LamAbs"><span class="hs-identifier hs-type">LamAbs</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680959326"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680959326"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621680959325"><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621680959325"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621680959324"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680959324"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-226"></span><span>        </span><span class="hs-comment">-- Record that lambda-bound variables are strict</span><span>
</span><span id="line-227"></span><span>        </span><span class="annot"><span class="annottext">(Map Unique Strictness -&gt; Map Unique Strictness) -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Unique
-&gt; Strictness -&gt; Map Unique Strictness -&gt; Map Unique Strictness
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621680959326"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">name -&gt; Getting Unique name Unique -&gt; Unique
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting Unique name Unique
forall name unique. HasUnique name unique =&gt; Lens' name Unique
</span><a href="PlutusCore.Name.html#theUnique"><span class="hs-identifier hs-var">PLC.theUnique</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Strictness
</span><a href="PlutusIR.Core.Type.html#Strict"><span class="hs-identifier hs-var">Strict</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-228"></span><span>        </span><span id="local-6989586621680959323"><span class="annot"><span class="annottext">g
</span><a href="#local-6989586621680959323"><span class="hs-identifier hs-var">tds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; m g
forall g term (m :: * -&gt; *) tyname name (uni :: * -&gt; *) fun a.
(DepGraph g, MonadReader Node m,
 MonadState (Map Unique Strictness) m, HasUnique tyname TypeUnique,
 HasUnique name TermUnique, ToBuiltinMeaning uni fun) =&gt;
Term tyname name uni fun a -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#termDeps"><span class="hs-identifier hs-var">termDeps</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680959324"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-229"></span><span>        </span><span id="local-6989586621680959322"><span class="annot"><span class="annottext">g
</span><a href="#local-6989586621680959322"><span class="hs-identifier hs-var">tyds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type tyname uni a -&gt; m g
forall g term (m :: * -&gt; *) tyname (uni :: * -&gt; *) a.
(DepGraph g, MonadReader Node m, HasUnique tyname TypeUnique) =&gt;
Type tyname uni a -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#typeDeps"><span class="hs-identifier hs-var">typeDeps</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621680959325"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-230"></span><span>        </span><span class="annot"><span class="annottext">g -&gt; m g
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(g -&gt; m g) -&gt; g -&gt; m g
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[g] -&gt; g
forall g. Graph g =&gt; [g] -&gt; g
</span><span class="hs-identifier hs-var">G.overlays</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">g
</span><a href="#local-6989586621680959323"><span class="hs-identifier hs-var">tds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">g
</span><a href="#local-6989586621680959322"><span class="hs-identifier hs-var">tyds</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-231"></span><span>    </span><span id="local-6989586621680959321"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680959321"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-232"></span><span>        </span><span id="local-6989586621680959320"><span class="annot"><span class="annottext">[g]
</span><a href="#local-6989586621680959320"><span class="hs-identifier hs-var">tds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Term tyname name uni fun a -&gt; m g)
-&gt; [Term tyname name uni fun a] -&gt; m [g]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; m g
forall g term (m :: * -&gt; *) tyname name (uni :: * -&gt; *) fun a.
(DepGraph g, MonadReader Node m,
 MonadState (Map Unique Strictness) m, HasUnique tyname TypeUnique,
 HasUnique name TermUnique, ToBuiltinMeaning uni fun) =&gt;
Term tyname name uni fun a -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#termDeps"><span class="hs-identifier hs-var">termDeps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680959321"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
-&gt; Getting
     (Endo [Term tyname name uni fun a])
     (Term tyname name uni fun a)
     (Term tyname name uni fun a)
-&gt; [Term tyname name uni fun a]
forall s a. s -&gt; Getting (Endo [a]) s a -&gt; [a]
</span><span class="hs-operator hs-var">^..</span></span><span> </span><span class="annot"><span class="annottext">Getting
  (Endo [Term tyname name uni fun a])
  (Term tyname name uni fun a)
  (Term tyname name uni fun a)
forall tyname name (uni :: * -&gt; *) fun a.
Traversal'
  (Term tyname name uni fun a) (Term tyname name uni fun a)
</span><a href="PlutusIR.Core.Plated.html#termSubterms"><span class="hs-identifier hs-var">termSubterms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-233"></span><span>        </span><span id="local-6989586621680959317"><span class="annot"><span class="annottext">[g]
</span><a href="#local-6989586621680959317"><span class="hs-identifier hs-var">tyds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Type tyname uni a -&gt; m g) -&gt; [Type tyname uni a] -&gt; m [g]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a -&gt; m g
forall g term (m :: * -&gt; *) tyname (uni :: * -&gt; *) a.
(DepGraph g, MonadReader Node m, HasUnique tyname TypeUnique) =&gt;
Type tyname uni a -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#typeDeps"><span class="hs-identifier hs-var">typeDeps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621680959321"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
-&gt; Getting
     (Endo [Type tyname uni a])
     (Term tyname name uni fun a)
     (Type tyname uni a)
-&gt; [Type tyname uni a]
forall s a. s -&gt; Getting (Endo [a]) s a -&gt; [a]
</span><span class="hs-operator hs-var">^..</span></span><span> </span><span class="annot"><span class="annottext">Getting
  (Endo [Type tyname uni a])
  (Term tyname name uni fun a)
  (Type tyname uni a)
forall tyname name (uni :: * -&gt; *) fun a.
Traversal' (Term tyname name uni fun a) (Type tyname uni a)
</span><a href="PlutusIR.Core.Plated.html#termSubtypes"><span class="hs-identifier hs-var">termSubtypes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-234"></span><span>        </span><span class="annot"><span class="annottext">g -&gt; m g
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(g -&gt; m g) -&gt; g -&gt; m g
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[g] -&gt; g
forall g. Graph g =&gt; [g] -&gt; g
</span><span class="hs-identifier hs-var">G.overlays</span></span><span> </span><span class="annot"><span class="annottext">([g] -&gt; g) -&gt; [g] -&gt; g
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[g]
</span><a href="#local-6989586621680959320"><span class="hs-identifier hs-var">tds</span></a></span><span> </span><span class="annot"><span class="annottext">[g] -&gt; [g] -&gt; [g]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[g]
</span><a href="#local-6989586621680959317"><span class="hs-identifier hs-var">tyds</span></a></span><span>
</span><span id="line-235"></span><span>
</span><span id="line-236"></span><span class="hs-comment">-- | Compute the dependency graph of a type. Takes an initial 'Node' indicating what the type itself depends on</span><span>
</span><span id="line-237"></span><span class="hs-comment">-- (usually 'Root' if it is the real type you are interested in).</span><span>
</span><span id="line-238"></span><span id="local-6989586621680959627"><span id="local-6989586621680959628"><span id="local-6989586621680959629"><span id="local-6989586621680959630"><span id="local-6989586621680959631"><span id="local-6989586621680959632"><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#typeDeps"><span class="hs-identifier hs-type">typeDeps</span></a></span><span>
</span><span id="line-239"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#DepGraph"><span class="hs-identifier hs-type">DepGraph</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959632"><span class="hs-identifier hs-type">g</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Analysis.Dependencies.html#DepCtx"><span class="hs-identifier hs-type">DepCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959627"><span class="hs-identifier hs-type">term</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680959631"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959630"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TypeUnique"><span class="hs-identifier hs-type">PLC.TypeUnique</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-240"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Core.Type.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959630"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959629"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959628"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-241"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680959631"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680959632"><span class="hs-identifier hs-type">g</span></a></span></span></span></span></span></span></span><span>
</span><span id="line-242"></span><span id="typeDeps"><span class="annot"><span class="annottext">typeDeps :: Type tyname uni a -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#typeDeps"><span class="hs-identifier hs-var hs-var">typeDeps</span></a></span></span><span> </span><span id="local-6989586621680959315"><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621680959315"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-243"></span><span>    </span><span class="hs-comment">-- The dependency graph of a type is very simple since it doesn't have any internal let-bindings. So we just</span><span>
</span><span id="line-244"></span><span>    </span><span class="hs-comment">-- need to find all the used variables and mark them as dependencies of the current node.</span><span>
</span><span id="line-245"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680959314"><span class="annot"><span class="annottext">used :: Set Unique
</span><a href="#local-6989586621680959314"><span class="hs-identifier hs-var hs-var">used</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Usages -&gt; Set Unique
</span><a href="PlutusIR.Analysis.Usages.html#allUsed"><span class="hs-identifier hs-var">Usages.allUsed</span></a></span><span> </span><span class="annot"><span class="annottext">(Usages -&gt; Set Unique) -&gt; Usages -&gt; Set Unique
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a -&gt; Usages
forall tyname (uni :: * -&gt; *) a.
HasUnique tyname TypeUnique =&gt;
Type tyname uni a -&gt; Usages
</span><a href="PlutusIR.Analysis.Usages.html#runTypeUsages"><span class="hs-identifier hs-var">Usages.runTypeUsages</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621680959315"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-246"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[Unique] -&gt; m g
forall g term (m :: * -&gt; *).
(DepGraph g, MonadReader Node m) =&gt;
[Unique] -&gt; m g
</span><a href="PlutusIR.Analysis.Dependencies.html#currentDependsOn"><span class="hs-identifier hs-var">currentDependsOn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set Unique -&gt; [Unique]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">Set Unique
</span><a href="#local-6989586621680959314"><span class="hs-identifier hs-var">used</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span></pre></body></html>